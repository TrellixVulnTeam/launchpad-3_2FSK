== Package Diff ==

'Available diffs' page section is only presented when there is, at
least, one `PackageDiff` recorded in the database for a context
SourcePackageRelease.

It's exposed in the following pages:

 * Ubuntu sources (`DistributionSourcePackage`);
 * Ubuntu source release (`DistributionSourcePackageRelease`);
 * PPA sources (PPA Overview).

The section is rendered based on the `SourcePackageRelease` content
class, so, theoretically is can be displayed in any page that has
access to one or more objects of nature.

The available diffs, as the pages mentioned are accessible to anyone
using Launchpad.

See further information about `PackageDiff` documentation in
doc/package-diff.txt.


== Testable diff setup ==

We will create a set of `PackageDiff` so we can precisely test how
they show up in the UI.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.database.component import (
    ...     ComponentSelection)
    >>> from canonical.launchpad.interfaces import (
    ...     IComponentSet, IDistributionSet)

    >>> login('foo.bar@canonical.com')

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> hoary = ubuntu.getSeries('hoary')
    >>> universe = getUtility(IComponentSet)['universe']
    >>> selection = ComponentSelection(
    ...     distroseries=hoary, component=universe)

    >>> from canonical.launchpad.testing.fakepackager import FakePackager
    >>> packager = FakePackager(
    ...     'biscuit', '1.0', 'foo.bar@canonical.com-passwordless.sec')

Upload a series of 'biscuit' source to ubuntu primary archive.

    >>> packager.buildUpstream()
    >>> packager.buildSource(signed=False)
    >>> biscuit_one_pub = packager.uploadSourceVersion(
    ...     '1.0-1', policy='sync')

    >>> packager.buildVersion('1.0-2', changelog_text="I can haz diff")
    >>> packager.buildSource(signed=False)
    >>> biscuit_two_pub_id = packager.uploadSourceVersion(
    ...     '1.0-2', policy='sync').id

    >>> packager.buildVersion('1.0-3', changelog_text="I can haz diff too")
    >>> packager.buildSource(signed=False)
    >>> biscuit_three_pub_id = packager.uploadSourceVersion(
    ...     '1.0-3', policy='sync').id

Activate Foo Bar's PPA and upload another 'biscuit' version.

    >>> from canonical.launchpad.ftests import import_public_test_keys
    >>> import_public_test_keys()

    >>> from canonical.launchpad.interfaces import (
    ...     ArchivePurpose, IArchiveSet, IPersonSet)
    >>> foobar = getUtility(IPersonSet).getByName('name16')
    >>> ppa = getUtility(IArchiveSet).new(
    ...     owner=foobar, distribution=ubuntu, purpose=ArchivePurpose.PPA)

    >>> packager.buildVersion(
    ...     '1.0-4', changelog_text="PPA can haz diff, as well")
    >>> packager.buildSource()
    >>> biscuit_four_pub_id = packager.uploadSourceVersion(
    ...     '1.0-4', archive=foobar.archive).id

Quickly check the pending `PackageDiff`s recorded.

    >>> from canonical.launchpad.interfaces import IPackageDiffSet
    >>> diff_set = getUtility(IPackageDiffSet)
    >>> diffs = list(diff_set.getPendingDiffs())
    >>> for diff in diffs:
    ...     print diff.title
    Package diff for biscuit from 1.0-1 to 1.0-2
    Package diff for biscuit from 1.0-2 to 1.0-3
    Package diff for biscuit from 1.0-3 to 1.0-4

We have to commit in order to have the source files just-uploaded
available in librarian.

    >>> import transaction
    >>> transaction.commit()

Perform some diffs in advance, the first diff in ubuntu and the diff
in PPA will be performed, the second diff in ubuntu will be performed
later.

    >>> diff_one, diff_two, diff_three = diffs

    >>> diff_one.performDiff()
    >>> diff_three.performDiff()

Commit again, so the diffs will be available, and log out, we
are done here.

    >>> from canonical.database.sqlbase import flush_database_updates
    >>> flush_database_updates()
    >>> transaction.commit()
    >>> logout()


== Ubuntu sources ==

All diffs are visible in the 'biscuit source in ubuntu' page, right
below the changelog text for each uploaded version.

    >>> anon_browser.open("http://launchpad.dev/ubuntu/+source/biscuit")
    >>> changes = find_tags_by_class(anon_browser.contents, 'boardComment')
    >>> for change in changes:
    ...     print 30 * '='
    ...     print extract_text(change)
    ==============================
    1.0-3
    Pending in hoary-release
    ...
    Available diffs
    Package diff for biscuit from 1.0-2 to 1.0-3
    ==============================
    1.0-2
    Pending in hoary-release
    ...
    Available diffs
    Package diff for biscuit from 1.0-1 to 1.0-2
    ==============================
    1.0-1
    Pending in hoary-release
    ...

Diffs already performed are rendered as link to the librarian file.

    >>> print anon_browser.getLink(
    ...     'Package diff for biscuit from 1.0-1 to 1.0-2').url
    http://.../biscuit_1.0-1_1.0-2.diff.gz

On the other hand, diffs not yet performed are rendered as plain text.

    >>> anon_browser.getLink(
    ...     'Package diff for biscuit from 1.0-2 to 1.0-3')
    Traceback (most recent call last):
    ...
    LinkNotFoundError

When the remaining pending diff is perform and the page is reloaded
the missing link is rendered.

    >>> login('foo.bar@canonical.com')
    >>> diff_set = getUtility(IPackageDiffSet)
    >>> [diff] = diff_set.getPendingDiffs()
    >>> diff.performDiff()
    >>> flush_database_updates()
    >>> transaction.commit()
    >>> logout()

    >>> anon_browser.reload()
    >>> print anon_browser.getLink(
    ...     'Package diff for biscuit from 1.0-2 to 1.0-3').url
    http://.../biscuit_1.0-2_1.0-3.diff.gz

The same page section is presented in the in the corresponding
`DistributionSourcePackageRelease` pages

    >>> anon_browser.getLink('1.0-3').click()

    >>> diff_section = find_tag_by_id(
    ...     anon_browser.contents, 'diff-for-1.0-3')
    >>> print extract_text(diff_section)
    Available diffs
    Package diff for biscuit from 1.0-2 to 1.0-3

    >>> print anon_browser.getLink(
    ...     'Package diff for biscuit from 1.0-2 to 1.0-3').url
    http://.../biscuit_1.0-2_1.0-3.diff.gz


== PPA diffs ==

PPA `PackageDiff` are exposed exactly in the same way ubuntu ones
are. They are presented in the expandable area right below the
corresponding source row in the PPA overview page.

    >>> anon_browser.open("http://launchpad.dev/~name16/+archive")
    >>> biscuit_row_id = "pub%s" % biscuit_four_pub_id
    >>> biscuit_row = find_tag_by_id(
    ...     anon_browser.contents, biscuit_row_id)
    >>> print extract_text(biscuit_row)
    Publishing details
    ...
    Available diffs
      Package diff for biscuit from 1.0-3 to 1.0-4
    ...

The text also link to the librarian file containing the diff.

    >>> print anon_browser.getLink(
    ...     'Package diff for biscuit from 1.0-3 to 1.0-4').url
    http://.../biscuit_1.0-3_1.0-4.diff.gz
