IEntitlementAPI
---------------

    >>> import xmlrpclib
    >>> from zope.interface.verify import verifyObject
    >>> from canonical.functional import XMLRPCTestTransport
    >>> from canonical.lp.dbschema import EntitlementState, EntitlementType
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> from canonical.launchpad.xmlrpc import EntitlementAPI, IEntitlementAPI
    >>> from canonical.launchpad.ftests import login
    >>> foobar = getUtility(IPersonSet).getByEmail('foo.bar@canonical.com')
    >>> login("foo.bar@canonical.com")
    >>> entitlement_view = EntitlementAPI('somecontext', 'someview')
    >>> verifyObject(IEntitlementAPI, entitlement_view)
    True
    
== Test directly ==

Calling the interfaces directly is useful to show the methods work
without involving the XML-RPC complexity.

Create a new entitlement directly.

Attempting to create an entitlement on a non-existent person returns a fault.
    >>> entitlement_id = entitlement_view.create(
    ...     'fredflintstone',
    ...     EntitlementType.PRIVATE_BUGS.value,
    ...     100,
    ...     EntitlementState.ACTIVE.value)
    >>> print entitlement_id
    <Fault 25: 'Invalid Person or Team: No person or team with the name "fredflintstone" was found'>

    >>> entitlement_id = entitlement_view.create(
    ...     foobar.name,
    ...     EntitlementType.PRIVATE_BUGS.value,
    ...     100,
    ...     EntitlementState.ACTIVE.value)

    >>> params = dict(id=entitlement_id,
    ...               person_name=foobar.name,
    ...               quota=120)
    >>> res = entitlement_view.update(params)
    >>> print res
    True

    >>> entitlement = entitlement_view.get(entitlement_id)
    >>> print entitlement.get('quota')
    120

    >>> entitlements = entitlement_view.getByPersonOrTeam('fredflintstone')
    >>> print entitlements
    <Fault 25: 'Invalid Person or Team: No person or team with the name "fredflintstone" was found'>

    >>> entitlements = entitlement_view.getByPersonOrTeam(foobar.name)
    >>> print len(entitlements)
    1

    >>> entitlements = entitlement_view.getDirty()
    >>> print len(entitlements)
    4

== Test via XML-RPC ==

Create server proxy for XML-RPC calls.

    >>> entitlement_api = xmlrpclib.ServerProxy(
    ...     'http://foo.bar@canonical.com:test@xmlrpc.launchpad.dev/+entitlements/',
    ...     transport=XMLRPCTestTransport())

Create a new entitlement via XML-RPC.  Note that all parameters must
be passed positionally, not as name=value pairs.  Optional parameters
may be omitted but all optional parameters before the one of interest
must be supplied.

    >>> entitlement_id = entitlement_api.create(
    ...     'fredflintstone',
    ...     EntitlementType.PRIVATE_BUGS.value,
    ...     100,
    ...     EntitlementState.ACTIVE.value)
    Traceback (most recent call last):
    ...
    Fault: <Fault 25: 'Invalid Person or Team: No person or team with the name "fredflintstone" was found'>

    >>> entitlement_id = entitlement_api.create(
    ...     foobar.name, # person_name
    ...     EntitlementType.PRIVATE_BRANCHES.value, # entitlement_type
    ...     101, # quota
    ...     EntitlementState.ACTIVE.value) # state
    >>> print entitlement_id
    7

An existing entitlement can be updated.
    
    >>> params = dict(id=entitlement_id,
    ...               person_name=foobar.name,
    ...               quota=200)
    >>> res = entitlement_api.update(params)
    >>> print res
    True

The newly changed entitlement can be retrieved with the new values.

    >>> entitlement = entitlement_api.get(entitlement_id)
    >>> print entitlement.get('quota')
    200
    >>> print entitlement.get('is_dirty')
    False

Entitlements can be retrieved by name of the person or team.

If the person doesn't exist a fault is returned.

    >>> entitlements = None
    >>> entitlements = entitlement_api.getByPersonOrTeam('fredflintstone')
    Traceback (most recent call last):
    ...
    Fault: <Fault 25: 'Invalid Person or Team: No person or team with the name "fredflintstone" was found'>


    >>> entitlements = entitlement_api.getByPersonOrTeam(foobar.name)
    >>> print len(entitlements)
    2    

    >>> entitlements = entitlement_api.getDirty()
    >>> print len(entitlements)
    4

    >>> entitlement = entitlements[0]
    >>> params = dict(id=entitlement['id'],
    ...               person_name=entitlement['person_name'],
    ...               is_dirty=False)
    >>> res = entitlement_api.update(params)
    >>> print res
    True
    
    >>> entitlements = entitlement_api.getDirty()
    >>> print len(entitlements)
    3

