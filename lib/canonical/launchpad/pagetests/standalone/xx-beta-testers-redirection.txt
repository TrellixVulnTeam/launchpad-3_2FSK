= Redirection of Beta Testers =

Launchpad occasionally runs private beta tests of large
changes. During these times, members of the launchpad-beta-testers
team have access to a separate web app running off the same database.

To encourage members of this team to use the beta UI, we automatically
redirect them to the beta site when they use the main site.

For these tests, we will use the user 'launchpad-beta-owner', who is
on the beta testers team.  First, create a browser object for this
person:

    >>> from zope.testbrowser.testing import Browser
    >>> beta_browser = Browser()
    >>> beta_browser.handleErrors = False
    >>> beta_browser.addHeader('Authorization',
    ...                        'Basic beta-admin@launchpad.net:test')


  XXX 20070131 jamesh:
  I couldn't get testbrowser to tell me where it redirected to in the
  case of a URL that could not be displayed, so I am using old pagetest
  syntax here.

If a normal user goes to a page on the site, it will load as normal:

    >>> print http('''
    ... GET /ubuntu HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic test@canonical.com:test
    ... ''')
    HTTP/1.1 200 Ok
    ...

In contrast, members of the beta testers get redirected:

    >>> print http('''
    ... GET /ubuntu HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 303 See Other
    Content-Length: 0
    Content-Type: text/plain
    Location: http://beta.launchpad.dev/ubuntu
    <BLANKLINE>

The redirection is controlled by the beta_testers_redirection_host
config item.  If it is set to None, no redirection occurs:

    >>> from canonical.config import config
    >>> print config.launchpad.beta_testers_redirection_host
    beta.launchpad.dev
    >>> config.launchpad.beta_testers_redirection_host = None

    >>> print http('''
    ... GET /ubuntu HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 200 Ok
    ...

Set the redirection host back for the rest of the tests:

    >>> config.launchpad.beta_testers_redirection_host = 'beta.launchpad.dev'


So that beta testers can still access the production site, the front
page of Launchpad does not redirect.  They will also see a message
explaining why they get redirected, and provide a link to disable the
redirection for 2 hours:

    >>> print http('''
    ... GET / HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 200 Ok
    ...
    <div class="informational message">
    <script type="text/javascript">
      function inhibit_beta_redirect() {
         var expire = new Date()
         expire.setTime(expire.getTime() + 2 * 60 * 60 * 1000)
         document.cookie = ('inhibit_beta_redirect=1; Path=/; Domain=.launchpad.dev; Expires=' +
                            expire.toGMTString())
      }</script>
    <p>As a member of the Launchpad Beta Testers team, you will be
    redirected to the beta site when viewing Launchpad pages other than
    the front page.</p>
    <p>To disable this redirection for 2 hours, click <a
    href="javascript:inhibit_beta_redirect()">here</a>.</p>
    </div>
    ...

This is so that the user can make use of some client side JS on that
page that sets a cookie to inhibit the redirection:

    >>> print http('''
    ... GET /ubuntu HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... Cookie: inhibit_beta_redirect="1"
    ... ''')
    HTTP/1.1 200 Ok
    ...


The redirection also works for URLs below the root, and with query
parameters:

    >>> print http('''
    ... GET /products?text=bazaar HTTP/1.1
    ... Host: launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 303 See Other
    Content-Length: 0
    Content-Type: text/plain
    Location: http://beta.launchpad.dev/products?text=bazaar
    <BLANKLINE>


The redirection also works for other Launchpad subdomains:

    >>> print http('''
    ... GET /launchpad/+bugs?orderby=-datecreated HTTP/1.1
    ... Host: bugs.launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 303 See Other
    Content-Length: 0
    Content-Type: text/plain
    Location: http://bugs.beta.launchpad.dev/launchpad/+bugs?orderby=-datecreated
    <BLANKLINE>

    >>> print http('''
    ... GET /~name12 HTTP/1.1
    ... Host: answers.launchpad.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 303 See Other
    Content-Length: 0
    Content-Type: text/plain
    Location: http://answers.beta.launchpad.dev/~name12
    <BLANKLINE>


However, domains not under the main site (such as shipit) will not be
redirected:

    >>> print http('''
    ... GET / HTTP/1.1
    ... Host: shipit.ubuntu.dev
    ... Authorization: Basic beta-admin@launchpad.net:test
    ... ''')
    HTTP/1.1 200 Ok
    ...

