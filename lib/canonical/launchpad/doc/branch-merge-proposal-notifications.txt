= Email Notifications for Branch Merge Proposals =

Subscribers to any of the branches involved in the merge proposal get
notifications.


== Subscription ==

When subscribers subscribe to branches, they can specify what level of
notification they would like to receive.

    >>> from canonical.launchpad.testing import LaunchpadObjectFactory
    >>> from canonical.launchpad.interfaces import (
    ...     BranchSubscriptionDiffSize, BranchSubscriptionNotificationLevel,
    ...     CodeReviewNotificationLevel)
    >>> from canonical.launchpad.tests.mail_helpers import pop_notifications
    >>> factory = LaunchpadObjectFactory()
    >>> login('test@canonical.com')
    >>> bmp = factory.makeBranchMergeProposal()
    >>> source_subscriber = factory.makePerson(email='foo@bar.com',
    ...     password='baz')
    >>> _unused = bmp.source_branch.subscribe(source_subscriber,
    ...     BranchSubscriptionNotificationLevel.NOEMAIL,
    ...     BranchSubscriptionDiffSize.NODIFF,
    ...     CodeReviewNotificationLevel.STATUS)
    >>> target_subscriber = factory.makePerson()
    >>> target_subscription = bmp.target_branch.subscribe(target_subscriber,
    ...     BranchSubscriptionNotificationLevel.NOEMAIL,
    ...     BranchSubscriptionDiffSize.NODIFF,
    ...     CodeReviewNotificationLevel.FULL)

The owners of the branches are subscribed when the branches are created.

    >>> source_owner = bmp.source_branch.owner
    >>> target_owner = bmp.target_branch.owner


== Notification Recipients ==

Recipients are determined using getNotificationRecipients.

    >>> recipients = bmp.getNotificationRecipients(
    ...     CodeReviewNotificationLevel.STATUS)

Subscribers to all related branches are candidates.

    >>> all_subscribers = set([
    ...     source_owner, target_owner, source_subscriber, target_subscriber])
    >>> all_subscribers == set(recipients.keys())
    True

Only subscribers whose level is >= the minimum level are selected.

    >>> full_subscribers = set([
    ...     source_owner, target_owner, target_subscriber])
    >>> recipients = bmp.getNotificationRecipients(
    ...     CodeReviewNotificationLevel.FULL)
    >>> full_subscribers == set(recipients.keys())
    True

Now we will unsubscribe the branch owners to simplify the rest of the test.

    >>> bmp.source_branch.unsubscribe(source_owner)
    >>> bmp.target_branch.unsubscribe(target_owner)
    >>> recipients = bmp.getNotificationRecipients(
    ...     CodeReviewNotificationLevel.FULL)

The value assigned to the recipient is a machine-readable explanation why they
were chosen, and their subscription

    >>> [(target_subscription, 'Subscriber')] == recipients.values()
    True


== E-mail ==

Notifications are automagically generated by creating a branch merge
proposal.

    >>> #clear any existing notifications
    >>> notifications = pop_notifications()
    >>> bmp = factory.makeBranchMergeProposal(
    ...     dependent_branch=bmp.source_branch)
    >>> notifications = pop_notifications()
    >>> notification = notifications[0]
    >>> print notification['To']
    Person-... <foo@bar.com>
    >>> print notification['From']
    Sample Person <test@canonical.com>
    >>> print notification['Subject']
    Merge of ~person-name... into ~person-name... proposed
    >>> print notification['X-Launchpad-Branch']
    ~person-name...
    >>> print notification['X-Launchpad-Message-Rationale']
    Subscriber
    >>> body = notification.get_payload()
    >>> print body.replace('=\n', '')
    Person-name... has proposed merging ~person-name... into ~person-name...
    --
    http://code.launchpad.dev/~person-name...
    You are subscribed to branch ...
