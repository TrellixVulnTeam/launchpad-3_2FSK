= Direct user-to-user contact =

A Launchpad user can contact another Launchpad user via a form accessible from
the recipient's user page.  Let's say for example, that No Privileges Person
wants to contact Salgado.

    >>> from canonical.launchpad.mail import stub
    >>> del stub.test_emails[:]

    >>> user_browser.open('http://launchpad.dev/~salgado')
    >>> user_browser.getLink('Contact this user').click()
    >>> print user_browser.title
    Contact this user

    >>> user_browser.getControl('Subject').value = 'Hi Salgado'
    >>> user_browser.getControl('Message').value = 'Just saying hello'
    >>> user_browser.getControl('Send').click()
    >>> print user_browser.title
    Guilherme Salgado in Launchpad

Salgado receives the email message from No Priv.

    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> print from_addr
    bounces@canonical.com
    >>> len(to_addrs)
    1
    >>> print to_addrs[0]
    Guilherme Salgado <guilherme.salgado@canonical.com>
    >>> print raw_msg
    Content-Type: text/plain; charset="us-ascii"
    MIME-Version: 1.0
    Content-Transfer-Encoding: 7bit
    From: No Privileges Person <no-priv@canonical.com>
    To: Guilherme Salgado <guilherme.salgado@canonical.com>
    Subject: Hi Salgado
    Message-ID: ...
    Date: ...
    Reply-To: No Privileges Person <no-priv@canonical.com>
    Sender: bounces@canonical.com
    Errors-To: bounces@canonical.com
    Return-Path: bounces@canonical.com
    Precedence: bulk
    X-Generated-By: Launchpad (canonical.com); Revision="...";
        Instance="launchpad-lazr.conf"
    X-Launchpad-Hash: ...
    <BLANKLINE>
    Just saying hello

No Priv starts to send another message to Salgado, but then changes her mind.

    >>> user_browser.getLink('Contact this user').click()
    >>> user_browser.getControl('Subject').value = 'Hi Salgado'
    >>> user_browser.getControl('Message').value = 'Hello again'
    >>> user_browser.getLink('Cancel').click()
    >>> print user_browser.title
    Guilherme Salgado in Launchpad


== Choosing a From: address ==

Sample Person has multiple registered and validated email addresses.

    >>> browser = setupBrowser(auth='Basic test@canonical.com:test')
    >>> browser.open('http://launchpad.dev/~salgado/+contactuser')
    >>> browser.getControl('Subject').value = 'Hi Salgado'
    >>> browser.getControl('Message').value = 'Hello again'

By default, Sample can use her preferred email address.

    >>> print browser.getControl('From').value
    ['test@canonical.com']

But she doesn't have to use her preferred address, she can use one of her
alternative addresses.

    >>> del stub.test_emails[:]
    >>> browser.getControl('From').value = ['testing@canonical.com']
    >>> browser.getControl('Send').click()

    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> print raw_msg
    Content-Type: text/plain; charset="us-ascii"
    MIME-Version: 1.0
    Content-Transfer-Encoding: 7bit
    From: Sample Person <testing@canonical.com>
    To: Guilherme Salgado <guilherme.salgado@canonical.com>
    Subject: Hi Salgado
    Message-ID: ...
    Date: ...
    Reply-To: Sample Person <testing@canonical.com>
    Sender: bounces@canonical.com
    Errors-To: bounces@canonical.com
    Return-Path: bounces@canonical.com
    Precedence: bulk
    X-Generated-By: Launchpad (canonical.com); Revision="...";
        Instance="launchpad-lazr.conf"
    X-Launchpad-Hash: ...
    <BLANKLINE>
    Hello again


== Bypassing the quota ==

Salgado is the Launchpad Community Help Rotation expert for the day and he
needs to contact several people.  As a convenience, he opens multiple browser
pages for each person he wants to contact.  Then he fills out the text and
begins to send the messages.

However, Salgado has a quota limit of 3 so while he can open four +contactuser
pages, when he tries to submit the fourth one, the submission fails.

    >>> browser_1 = setupBrowser(auth='Basic salgado@ubuntu.com:zeca')
    >>> browser_2 = setupBrowser(auth='Basic salgado@ubuntu.com:zeca')
    >>> browser_3 = setupBrowser(auth='Basic salgado@ubuntu.com:zeca')
    >>> browser_4 = setupBrowser(auth='Basic salgado@ubuntu.com:zeca')

    >>> browser_1.open('http://launchpad.dev/~no-priv/+contactuser')
    >>> browser_2.open('http://launchpad.dev/~carlos/+contactuser')
    >>> browser_3.open('http://launchpad.dev/~daf/+contactuser')
    >>> browser_4.open('http://launchpad.dev/~name12/+contactuser')

    >>> browser_1.getControl('Subject').value = 'One'
    >>> browser_1.getControl('Message').value = 'One'

    >>> browser_2.getControl('Subject').value = 'Two'
    >>> browser_2.getControl('Message').value = 'Two'

    >>> browser_3.getControl('Subject').value = 'Three'
    >>> browser_3.getControl('Message').value = 'Three'

    >>> browser_4.getControl('Subject').value = 'Four'
    >>> browser_4.getControl('Message').value = 'Four'

    >>> browser_1.getControl('Send').click()
    >>> print_errors(browser_1.contents)

    >>> browser_2.getControl('Send').click()
    >>> print_errors(browser_2.contents)

    >>> browser_3.getControl('Send').click()
    >>> print_errors(browser_3.contents)

    >>> browser_4.getControl('Send').click()
    >>> print_errors(browser_4.contents)
    Your message was not sent because you have exceeded your daily quota of 3
    messages to contact users. Try again in ... hours.
