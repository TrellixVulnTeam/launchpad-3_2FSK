= Restricted OpenID Simple Registration Extension support =

The Launchpad OpenID server has restricted support for the OpenID
Simple Registration Extension.  It will only provide a full set of
registration details to certain known trust roots.  The user's
launchpad username is share with all roots.

This is done in order to share the user details among the various
Canonical/Ubuntu sites participating in single sign-on.  The user's
nickname is published to every site, which is useful things like
weblog comments.


== Behaviour for unknown trust roots ==

If a relying party attempts to request user details via the
openid.sreg extension and Launchpad does not have a particular policy
configured, then only the user's nickname is returned in the response.

We will perform an OpenID authentication request asking for a few user
details:

    >>> from openid.consumer.consumer import Consumer
    >>> from openid.fetchers import setDefaultFetcher
    >>> from openid.extensions.sreg import SRegRequest, SRegResponse
    >>> from openid.store.memstore import MemoryStore
    >>> from canonical.ssoserver.testing.openidhelpers import (
    ...     complete_from_browser, make_endpoint, PublisherFetcher)
    >>> setDefaultFetcher(PublisherFetcher())

    >>> openid_store = MemoryStore()
    >>> consumer = Consumer(session={}, store=openid_store)

    >>> endpoint = make_endpoint(
    ...     PROTOCOL_URI, 'http://openid.launchpad.dev/+id/sabdfl_oid')

    >>> request = consumer.beginWithoutDiscovery(endpoint)
    >>> request.addExtension(SRegRequest(
    ...     required=['email', 'country'],
    ...     optional=['fullname', 'nickname']))

    >>> redirect_url = request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer')
    >>> print redirect_url
    http://openid.launchpad.dev/+openid?...

    >>> sabdfl_browser = setupBrowser('Basic mark@hbd.com:test')
    >>> sabdfl_browser.open(redirect_url)
    >>> sabdfl_browser.getControl('Sign In', index=0).click()
    >>> print sabdfl_browser.url
    http://launchpad.dev/+openid-consumer?...

We have authenticated successfully:

    >>> info = complete_from_browser(consumer, sabdfl_browser)
    >>> print info.status
    success
    >>> print info.endpoint.claimed_id
    http://openid.launchpad.dev/+id/sabdfl_oid

But only the nickname is returned:

    >>> sreg_response = SRegResponse.fromSuccessResponse(info)
    >>> print sreg_response.items()
    [('nickname', 'sabdfl')]


== Behaviour for known trust roots ==

If we create a Relying Party configuration for the trust root, things
play out a bit differently:

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.interfaces import IOpenIDRPConfigSet

    >>> login('foo.bar@canonical.com')
    >>> rpconfig = getUtility(IOpenIDRPConfigSet).new(
    ...     trust_root='http://launchpad.dev/',
    ...     displayname='Test RP', description='A test RP',
    ...     allowed_sreg=['fullname', 'nickname', 'email', 'timezone'])
    >>> logout()

Now begin another identical OpenID authentication request:

    >>> request = consumer.beginWithoutDiscovery(endpoint)
    >>> request.addExtension(SRegRequest(
    ...     required=['email', 'country'],
    ...     optional=['fullname', 'nickname']))

    >>> redirect_url = request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer')
    >>> print redirect_url
    http://openid.launchpad.dev/+openid?...

    >>> sabdfl_browser.open(redirect_url)
    >>> sabdfl_browser.getControl('Sign In', index=0).click()
    >>> print sabdfl_browser.url
    http://launchpad.dev/+openid-consumer?...

Again, the authentication request is successful:

    >>> info = complete_from_browser(consumer, sabdfl_browser)
    >>> print info.status
    success
    >>> print info.endpoint.claimed_id
    http://openid.launchpad.dev/+id/sabdfl_oid

But now we have some user details.  Note that the user's country is
not returned because it was not permitted by the RP configuration.
Also, while the RP was allowed to request the time zone, it was not
sent:

    >>> sreg_response = SRegResponse.fromSuccessResponse(info)
    >>> for key, value in sorted(sreg_response.items()):
    ...     print '%s:%s' % (key, value)
    email:mark@hbd.com
    fullname:Mark Shuttleworth
    nickname:sabdfl


== Cleanup ==

    >>> login('foo.bar@canonical.com')
    >>> rpconfig = getUtility(IOpenIDRPConfigSet).getByTrustRoot(
    ...     'http://launchpad.dev/')
    >>> rpconfig.destroySelf()
    >>> logout()

    >>> setDefaultFetcher(None)
