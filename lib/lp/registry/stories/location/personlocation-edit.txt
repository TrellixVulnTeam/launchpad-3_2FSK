== Edit person location information ==

The location information is editable by anybody (like a wiki), until the
person provides location data for themselves. At that point it is only
editable by people who have launchpad.Edit on the person, which is that
person and admins.

    >>> login('test@canonical.com')
    >>> zzz = factory.makePerson(
    ...     name='zzz', time_zone='Africa/Maseru', email='zzz@foo.com',
    ...     latitude=None, longitude=None, password='test')
    >>> logout()

Anybody logged in can see the Location widget for a person who has no
location set.

    >>> nopriv_browser = setupBrowser(auth="Basic no-priv@canonical.com:test")
    >>> nopriv_browser.open('http://launchpad.dev/~zzz/+editlocation')
    >>> find_tag_by_id(nopriv_browser.contents, "field.location.latitude")
    <input...name="field.location.latitude" type="hidden"...

Not only can we see the widgets, but anybody logged in can actually provide
new location information.  Here we need to provide the location and time
zone, but when accessed through a real browser the page will use Javascript
to infer the time zone based on the location given.

    >>> nopriv_browser.getControl(name='field.location.latitude').value = (
    ...     '13.0')
    >>> nopriv_browser.getControl(name='field.location.longitude').value = (
    ...     '17.0')
    >>> nopriv_browser.getControl(name='field.location.time_zone').value = [
    ...     'Europe/Madrid']
    >>> nopriv_browser.getControl('Update').click()
    >>> login('test@canonical.com')
    >>> zzz.latitude
    13.0
    >>> zzz.longitude
    17.0
    >>> zzz.time_zone
    u'Europe/Madrid'
    >>> logout()

If the person provides his own location information, then the data is
locked, and random people can no longer edit it.

    >>> self_browser = setupBrowser(auth="Basic zzz@foo.com:test")
    >>> self_browser.open('http://launchpad.dev/~zzz/+editlocation')
    >>> self_browser.getControl(name='field.location.latitude').value = (
    ...     '39.48')
    >>> self_browser.getControl(name='field.location.longitude').value = (
    ...     '-0.40')
    >>> self_browser.getControl(name='field.location.time_zone').value = [
    ...     'Europe/Madrid']
    >>> self_browser.getControl('Update').click()

    >>> nopriv_browser.open('http://launchpad.dev/~zzz/+editlocation')
    Traceback (most recent call last):
    ...
    Unauthorized:...

Of course, the person himself can continue to edit it:

    >>> self_browser.open('http://launchpad.dev/~zzz/+editlocation')
    >>> self_browser.getControl(name='field.location.latitude').value
    '39.48'

And so can a Launchpad admin:

    >>> admin_browser.open('http://launchpad.dev/~zzz/+editlocation')
    >>> admin_browser.getControl(name='field.location.latitude').value
    '39.48'

The +editlocation page also allows a person to change his location
visibility, that is, whether or not others can see it. Unlike the actual
location (which can be changed by anybody until the person himself sets
it), the visibility can only be changed by the person himself.

    >>> name12_browser = setupBrowser(auth="Basic test@canonical.com:test")
    >>> name12_browser.open('http://launchpad.dev/~no-priv/+editlocation')
    >>> name12_browser.getControl('Hide my location details from others.')
    Traceback (most recent call last):
    ...
    LookupError:...

    >>> nopriv_browser.open('http://launchpad.dev/~no-priv/+editlocation')
    >>> nopriv_browser.getControl(
    ...     'Hide my location details from others.').selected = True
    >>> nopriv_browser.getControl('Update').click()
    >>> nopriv_browser.url
    'http://launchpad.dev/~no-priv'

Once hidden, other users can't see nor change it.

    >>> name12_browser.open('http://launchpad.dev/~no-priv')
    >>> print str(find_tag_by_id(name12_browser.contents, 'person_map_div'))
    None
    >>> name12_browser.open('http://launchpad.dev/~no-priv/+editlocation')
    Traceback (most recent call last):
    ...
    Unauthorized:...

The person himself can still see and change it, though.

    >>> nopriv_browser.open('http://launchpad.dev/~no-priv')
    >>> print str(find_tag_by_id(nopriv_browser.contents, 'portlet-map'))
    <div...
    <h2>Location</h2>
    ...

    >>> nopriv_browser.open('http://launchpad.dev/~no-priv/+editlocation')
    >>> nopriv_browser.getControl(
    ...     'Hide my location details from others.').selected = False
    >>> nopriv_browser.getControl('Update').click()
    >>> nopriv_browser.url
    'http://launchpad.dev/~no-priv'
