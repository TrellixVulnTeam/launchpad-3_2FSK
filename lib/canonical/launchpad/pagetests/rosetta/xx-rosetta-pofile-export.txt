Exporting Single PO Files through the Web
-----------------------------------------

Not logged in users can't access the +export page.

  >>> anon_browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary'
  ...     '/+source/evolution/+pots/evolution-2.2/es/')
  >>> anon_browser.getLink('Download').click()
  Traceback (most recent call last):
  ...
  Unauthorized:...

Logged in as a regular user, the +export page is accessible.

  >>> user_browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary'
  ...     '/+source/evolution/+pots/evolution-2.2/es')
  >>> user_browser.getLink('Download').click()

  >>> user_browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+export'

  >>> print user_browser.title
  Download translation for “Spanish (es) translation of evolution-2.2 in
  Ubuntu Hoary package "evolution"”

  >>> print user_browser.contents
  <...
  ...Download Spanish translation...
  Export process would be quite slow and thus, most of the time, you
  will need to wait until the system process your request and sends you
  a notification email to
  <code>no-priv@canonical.com</code>
  with a link where you will be able to get the exported file...

If we POST the page, it should add the request to the queue.

  >>> user_browser.getControl(name='format').value = ['PO']
  >>> user_browser.getControl('Confirm Download').click()

  >>> user_browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es'

  >>> for tag in find_tags_by_class(user_browser.contents, 'informational'):
  ...     tag.renderContents()
  'Your request has been received. Expect to receive an email shortly.'

Let's be sure that we can request po files without translations as the
No Privileges Person.

  >>> from zope.testbrowser.testing import Browser
  >>> no_priv_browser = Browser()
  >>> no_priv_browser.handleErrors = False
  >>> no_priv_browser.addHeader(
  ...     'Authorization', 'Basic no-priv@canonical.com:test')

  >>> no_priv_browser.open(
  ...    'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/cy')
  >>> no_priv_browser.url
  'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/cy'
  >>> no_priv_browser.getLink('Download').click()
  >>> no_priv_browser.url
  'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/cy/+export'

  >>> no_priv_browser.getControl(name='format').value = ['PO']
  >>> no_priv_browser.getControl('Confirm Download').click()

  >>> no_priv_browser.url
  'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/cy'

  >>> for tag in find_tags_by_class(no_priv_browser.contents, 'informational'):
  ...     print tag.renderContents()
  Your request has been received. Expect to receive an email shortly.
  ...

Since no-privileges person isn't a valid translator for Welsh (cy) language, the
ownership of the newly created pofile is set to Rosetta Admins.

  >>> anon_browser.open(
  ...     'http://launchpad.dev/evolution'
  ...     '/trunk/+pots/evolution-2.2/cy')
  >>> translation_portlet = find_portlet(
  ...     anon_browser.contents, 'Translation file details')
  >>> t = extract_text(translation_portlet.firstText('Creator:').findNext('a'))
  >>> u'Rosetta Administrators' in t
  True

But if we request an export from a valid translator, he gets the ownership.
We test using the Swedish (sv) language which doesn't have a pofile for
evolution yet; it will be created at the moment the export is requested.

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open(
  ...     'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/sv')
  >>> browser.getLink('Download').click()

  >>> browser.getControl(name='format').value = ['PO']
  >>> browser.getControl('Confirm Download').click()

  >>> browser.url
  'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/sv'

  >>> for tag in find_tags_by_class(browser.contents, 'informational'):
  ...     tag.renderContents()
  'Your request has been received. Expect to receive an email shortly.'
  ...

  >>> translation_portlet = find_portlet(
  ...     browser.contents, 'Translation file details')
  >>> carlos = u'Carlos Perell\xf3 Mar\xedn'
  >>> creator = extract_text(
  ...     translation_portlet.firstText('Creator:').findNext('a'))
  >>> carlos in creator
  True

Request the same pofile again won't crash. (See bug
https://launchpad.net/rosetta/+bug/1558).

  >>> browser.getLink('Download').click()

  >>> browser.getControl(name='format').value = ['PO']
  >>> browser.getControl('Confirm Download').click()

  >>> browser.url
  'http://launchpad.dev/evolution/trunk/+pots/evolution-2.2/sv'

  >>> for tag in find_tags_by_class(browser.contents, 'informational'):
  ...     tag.renderContents()
  'Your request has been received. Expect to receive an email shortly.'
  ...
