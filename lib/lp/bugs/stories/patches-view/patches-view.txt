Patches View
============

Patches View by Product
-----------------------

We have a view listing patches attached to bugs that target a given
product.  At first, the product is new and has no bugs.

    >>> def make_thing(factory_method, **thing_args):
    ...    login('foo.bar@canonical.com')
    ...    result = factory_method(**thing_args)
    ...    transaction.commit()
    ...    logout()
    ...    return result

    >>> product1 = make_thing(factory.makeProduct, name='patchy-product-1')

We don't see any patches when we open the patches view.

    >>> def show_patches_view(expected_contents):
    ...     for tag in find_tags_by_class(
    ...         expected_contents, 'listing'):
    ...         print extract_text(tag)

    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After the product has a bug, it still doesn't show up in the patches
view, because that bug has no patch attachments.

    >>> from lp.bugs.interfaces.bugtask import (
    ...     BugTaskImportance, BugTaskStatus)
    >>> def make_bug(
    ...     title, product, importance=BugTaskImportance.UNDECIDED,
    ...     status=BugTaskStatus.NEW):
    ...     bug = factory.makeBug(title=title, product=product)
    ...     bug.default_bugtask.transitionToImportance(
    ...         importance, product.owner)
    ...     bug.default_bugtask.transitionToStatus(
    ...         status, product.owner)
    ...     return bug

    >>> bug_a = make_thing(
    ...     make_bug, title="bug_a title", product=product1)
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After we add a non-patch attachment to that bug, the patches view
still shows no patches.

    >>> make_thing(factory.makeBugAttachment, bug=bug_a, is_patch=False)
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After we add a patch attachment that's one day old, we should see it
in the patches view.

    >>> patch_submitter = make_thing(
    ...    factory.makePerson, name="patchy-person",
    ...    displayname="Patchy Person")
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch a",
    ...     filename="patch_a.diff", owner=patch_submitter,
    ...     description="description of patch a", bug=bug_a, is_patch=True)
    >>> 
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

After creating some more bugs, with some non-patch and some patch
attachments...

    >>> bug_b = make_thing(
    ...     make_bug, title="bug_b title", product=product1,
    ...     importance=BugTaskImportance.CRITICAL,      
    ...     status=BugTaskStatus.CONFIRMED)
    >>> bug_c = make_thing(
    ...     make_bug, title="bug_c title", product=product1,
    ...     importance=BugTaskImportance.WISHLIST,
    ...     status=BugTaskStatus.FIXCOMMITTED)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch b",
    ...     filename="patch_b.diff", owner=patch_submitter,
    ...     description="description of patch b", bug=bug_b, is_patch=True)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch c",
    ...     filename="patch_c.diff", owner=patch_submitter,
    ...     description="description of patch c", bug=bug_b, is_patch=True)
    >>> make_thing(factory.makeBugAttachment, bug=bug_c, is_patch=False)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch d",
    ...     filename="patch_d.diff", owner=patch_submitter,
    ...     description="description of patch d", bug=bug_c, is_patch=True)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch e",
    ...     filename="patch_e.diff", owner=patch_submitter,
    ...     description="description of patch e", bug=bug_c, is_patch=True)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch f",
    ...     filename="patch_f.diff", owner=patch_submitter,
    ...     description="description of patch f", bug=bug_c, is_patch=True)

...the youngest patch on each bug is visible is the patch report.

    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

We can sort patches by importance and status.

    >>> user_browser.getControl(name="orderby").value = ['-importance']
    >>> user_browser.getControl("sort").click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/patchy-product-1/+patches?orderby=-importance'
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

    >>> user_browser.getControl(name="orderby").value = ['status']
    >>> user_browser.getControl("sort").click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/patchy-product-1/+patches?orderby=status'
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f

Patches View by Distro
----------------------

The patches view also works for distributions, and it shows the target
package when viewed via a distribution.

    >>> from zope.component import getUtility
    >>> from lp.registry.interfaces.distribution import IDistributionSet
    >>> def make_bugtask(
    ...     bug, source_package_name,
    ...     importance=BugTaskImportance.UNDECIDED,
    ...     status=BugTaskStatus.NEW):
    ...     ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    ...     spkg = ubuntu.getSourcePackage(source_package_name)
    ...     bugtask = factory.makeBugTask(bug=bug, target=spkg)
    ...     bugtask.transitionToImportance(importance, ubuntu.owner)
    ...     bugtask.transitionToStatus(status, ubuntu.owner)
    >>> make_thing(
    ...     make_bugtask, bug=bug_a, source_package_name='evolution',
    ...     importance=BugTaskImportance.MEDIUM,
    ...     status=BugTaskStatus.FIXRELEASED)
    >>> make_thing(
    ...     make_bugtask, bug=bug_c, source_package_name='a52dec',
    ...     importance=BugTaskImportance.HIGH,
    ...     status=BugTaskStatus.TRIAGED)

    >>> user_browser.open('http://bugs.launchpad.dev/ubuntu/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status    Package    Patch Age
    Bug #18: bug_c title       High       Triaged    a52dec  ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title       Medium   Fix Released   evolution  ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a
