Distro Arch Release Binary Package
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

  >>> from canonical.launchpad.database.binarypackagename import (
  ...     BinaryPackageName)
  >>> from canonical.launchpad.database.distroarchseries import (
  ...     DistroArchSeries)
  >>> from canonical.launchpad.database.distroarchseriesbinarypackage import (
  ...     DistroArchSeriesBinaryPackage)
  >>> hoary_i386 = DistroArchSeries.get(6)
  >>> pmount_name = BinaryPackageName.selectOneBy(name="pmount")
  >>> firefox_name = BinaryPackageName.selectOneBy(name="mozilla-firefox")
  >>> pmount_hoary_i386 = DistroArchSeriesBinaryPackage(hoary_i386,
  ...                                                    pmount_name)

First, we create a new version of pmount, and a version of
mozilla-firefox that coincides with pmount's. We're hitch-hiking on two
existing builds that are in sampledata!

  >>> from canonical.launchpad.database.binarypackagerelease import (
  ...     BinaryPackageRelease)
  >>> from canonical.launchpad.database.publishing import (
  ...     SecureBinaryPackagePublishingHistory)
  >>> from canonical.launchpad.database.build import Build
  >>> from canonical.launchpad.database.component import Component
  >>> from canonical.launchpad.database.section import Section
  >>> from canonical.database.constants import UTC_NOW

  >>> main_component = Component.selectOneBy(name="main")
  >>> misc_section = Section.selectOneBy(name="base")
  >>> from canonical.launchpad.interfaces import BinaryPackageFormat
  >>> binpackageformat = BinaryPackageFormat.DEB
  >>> from canonical.launchpad.interfaces import (
  ...     PackagePublishingPriority, PackagePublishingStatus,
  ...     PackagePublishingPocket)
  >>> priority = PackagePublishingPriority.STANDARD

  >>> bpr = Build.get(9).createBinaryPackageRelease(
  ...   binarypackagename=firefox_name.id,
  ...   version="120.6-0",
  ...   summary="Firefox loves lollies",
  ...   description="Lolly-pop loving application",
  ...   binpackageformat=binpackageformat,
  ...   component=main_component.id,
  ...   section=misc_section.id,
  ...   priority=priority,
  ...   shlibdeps=None,
  ...   depends=None,
  ...   recommends=None,
  ...   suggests=None,
  ...   conflicts=None,
  ...   replaces=None,
  ...   provides=None,
  ...   pre_depends=None,
  ...   enhances=None,
  ...   breaks=None,
  ...   essential=False,
  ...   installedsize=0,
  ...   architecturespecific=False)

  >>> pe = SecureBinaryPackagePublishingHistory(
  ...   binarypackagerelease=bpr.id,
  ...   component=main_component.id,
  ...   section=misc_section.id,
  ...   priority=priority,
  ...   distroarchseries=hoary_i386.id,
  ...   status=PackagePublishingStatus.PUBLISHED,
  ...   datecreated=UTC_NOW,
  ...   datepublished=UTC_NOW,
  ...   pocket=PackagePublishingPocket.RELEASE,
  ...   datesuperseded=None,
  ...   supersededby=None,
  ...   datemadepending=None,
  ...   dateremoved=None,
  ...   archive=hoary_i386.main_archive)


  >>> bpr = Build.get(8).createBinaryPackageRelease(
  ...   binarypackagename=pmount_name.id,
  ...   version="cr98.34",
  ...   summary="Pmount bakes cakes",
  ...   description="Phat cake-baker application",
  ...   binpackageformat=binpackageformat,
  ...   component=main_component.id,
  ...   section=misc_section.id,
  ...   priority=priority,
  ...   shlibdeps=None,
  ...   depends=None,
  ...   recommends=None,
  ...   suggests=None,
  ...   conflicts=None,
  ...   replaces=None,
  ...   provides=None,
  ...   pre_depends=None,
  ...   enhances=None,
  ...   breaks=None,
  ...   essential=False,
  ...   installedsize=0,
  ...   architecturespecific=False)

  >>> pe = SecureBinaryPackagePublishingHistory(
  ...   binarypackagerelease=bpr.id,
  ...   component=main_component.id,
  ...   section=misc_section.id,
  ...   priority=priority,
  ...   distroarchseries=hoary_i386.id,
  ...   status=PackagePublishingStatus.PUBLISHED,
  ...   datecreated=UTC_NOW,
  ...   datepublished=UTC_NOW,
  ...   pocket=PackagePublishingPocket.RELEASE,
  ...   datesuperseded=None,
  ...   supersededby=None,
  ...   datemadepending=None,
  ...   dateremoved=None,
  ...   archive=hoary_i386.main_archive)

Then, we ensure that grabbing the current release of pmount and the old release
both are sane.

  >>> current_release = pmount_hoary_i386.currentrelease
  >>> current_release.version
  u'cr98.34'
  >>> current_release.name
  u'pmount'

  >>> old_release = pmount_hoary_i386['0.1-1']
  >>> old_release.version
  u'0.1-1'
  >>> old_release.name
  u'pmount'

Check the publishing record of packages returned by 'currentrelease' and
'__getitem__', which are different and in 'Published' state. We compare
the IDs below because pe is a SecureBinaryPackagePublishingHistory,
whereas the publishing record is a BinaryPackagePublishingHistory -- an
artifact of how these objects are fetched are done. The ID column on the
latter view comes from SBPPH, though.

  >>> pe.id == current_release.current_publishing_record.id
  True
  >>> (pe.status.title,
  ...  pe.distroarchseries.architecturetag)
  ('Published', u'i386')

  >>> old_pubrec = old_release.current_publishing_record
  >>> (old_pubrec.id , old_pubrec.status.title,
  ...  old_pubrec.distroarchseries.architecturetag)
  (12, 'Published', u'i386')

Note that it is only really possible to have two packages in the
"Published" status if domination hasn't run yet.

== Package caches and DARBP summaries ==

Bug 208233 teaches us that DistroArchSeriesBinaryPackage summaries use
package caches to generate their output, and unfortunately that means
they can interact poorly with PPA-published packages which live in the
same cache table. Here's a test that ensures that the code that fetches
summaries works.

XXX: this is really too complicated, and the code in
DistroArchSeriesBinaryPackage.summary should be simplified.
    -- kiko, 2008-03-28

  >>> from canonical.launchpad.interfaces import (
  ...   IDistributionSet, IPersonSet)
  >>> ubuntu = getUtility(IDistributionSet)['ubuntu']
  >>> cprov = getUtility(IPersonSet).getByName('cprov')
  >>> warty = ubuntu['warty']

First, update the cache tables for Celso's PPA:

  >>> from canonical.testing import LaunchpadZopelessLayer
  >>> from canonical.config import config
  >>> LaunchpadZopelessLayer.switchDbUser(config.statistician.dbuser)

  >>> class TestLog:
  ...     def debug(self, msg):
  ...         print 'DEBUG: %s' % msg

  >>> ubuntu.updateCompleteSourcePackageCache(
  ...    archive=cprov.archive, ztm=LaunchpadZopelessLayer.txn, log=TestLog())
  DEBUG: Considering source 'pmount'
  ...

  >>> warty.updateCompletePackageCache(
  ...    archive=cprov.archive, ztm=LaunchpadZopelessLayer.txn, log=TestLog())
  DEBUG: Considering binary 'mozilla-firefox'
  ...

  >>> cprov.archive.updateArchiveCache()
  >>> from canonical.database.sqlbase import commit
  >>> commit()
  >>> flush_database_updates()

Then, supersede all pmount publications in warty for pmount (this sets
us up to demonstrate bug 208233).

  >>> LaunchpadZopelessLayer.switchDbUser('lucille')
  >>> from canonical.launchpad.database import (
  ...   DistroArchSeries, DistroArchSeriesBinaryPackage,
  ...   BinaryPackageName, BinaryPackagePublishingHistory)
  >>> from canonical.launchpad.interfaces import PackagePublishingStatus
  >>> warty_i386 = DistroArchSeries.get(1)
  >>> pmount_name = BinaryPackageName.selectOneBy(name="pmount")
  >>> pmount_warty_i386 = DistroArchSeriesBinaryPackage(warty_i386,
  ...                                                   pmount_name)
  >>> pubs = BinaryPackagePublishingHistory.selectBy(
  ...       archive=1,
  ...       distroarchseries=warty_i386,
  ...       status=PackagePublishingStatus.PUBLISHED)
  >>> for p in pubs:
  ...   if p.binarypackagerelease.binarypackagename == pmount_name:
  ...       s = p.supersede()
  >>> commit()
  >>> flush_database_updates()
  >>> LaunchpadZopelessLayer.switchDbUser(config.statistician.dbuser)

Now, if that bug is actually fixed, this works:

  >>> pmount_warty_i386.summary
  u'pmount shortdesc'

  >>> pmount_warty_i386.description
  u'pmount description'

Yay!
