<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  xml:lang="en"
  lang="en"
  dir="ltr"
  metal:use-macro="context/@@main_template/master"
  i18n:domain="launchpad"
>

<body>

  <div metal:fill-slot="body">

    <tal:block condition="request/previous|nothing">
      <p class="informational message">
        The request #<span tal:replace="request/previous" />
        <span tal:condition="request/approved|nothing">was approved.</span>
        <span tal:condition="request/denied|nothing">was denied.</span>
        <span tal:condition="request/changed|nothing">was changed.</span>
      </p>
    </tal:block>

    <h1>
      <span tal:replace="context/distroseries/name/capitalize" />
      Request #<span tal:replace="context/id" />
    </h1>

    <table>
    <tbody>
    <tr>
    <td width="80%">

    <div tal:condition="context/addressIsDuplicated"
         tal:define="dupe_requests context/getRequestsWithSameAddressFromOtherUsers"
         class="informational message">
      <p>
        There are other requests for CDs of this same version made by other
        users with this shipping address.
      </p>
      <table class="listing lesser" id="dupe-address-reuqests">
        <thead>
          <tr>
            <th>Date</th>
            <th>Recipient</th>
            <th>Requested</th>
            <th>Approved</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          <tr tal:repeat="dupe_request dupe_requests">
            <td>
              <a tal:attributes="href dupe_request/fmt:url">
                <span tal:replace="dupe_request/daterequested/fmt:date" />
              </a>
            </td>
            <td tal:content="dupe_request/recipientdisplayname" />
            <td>
              <span tal:replace="dupe_request/getTotalCDs" />
              (<tal:flavours repeat="flavour dupe_request/getContainedFlavours"
                ><span tal:replace="flavour/title"
                  >Ubuntu</span><span tal:condition="not: repeat/flavour/end"
                    >,</span></tal:flavours>)
            </td>
            <td tal:content="dupe_request/getTotalApprovedCDs" />
            <td tal:content="dupe_request/status_desc" />
          </tr>
        </tbody>
      </table>
    </div>

    <div tal:condition="view/recipientHasOtherShippedRequests"
         tal:define="shipped_requests
                     context/recipient/shippedShipItRequestsOfCurrentSeries"
         class="informational message">
     <p>This person has other requests already sent to the shipping company.
     </p>
      <ul>
        <tal:block repeat="shipped_request shipped_requests">
          <li tal:condition="python: shipped_request != context">
            <a tal:attributes="href shipped_request/fmt:url">
              <span
                tal:attributes="
                  title shipped_request/daterequested/fmt:datetime"
                tal:content="
                  shipped_request/daterequested/fmt:approximatedate" />:
              <span tal:replace="shipped_request/getTotalCDs" />
              <tal:flavours repeat="flavour shipped_request/getContainedFlavours">
                <span tal:replace="flavour/title" /><span
                    tal:condition="not: repeat/flavour/end">/</span>
              </tal:flavours>
              CDs requested and 
              <span tal:replace="shipped_request/getTotalApprovedCDs" />
              CDs approved.
            </a>
          </li>
        </tal:block>
      </ul>
    </div>

    <p class="informational message">
      Status: <span tal:replace="context/status_desc" />
    </p>

    <h2>Requested quantities</h2>

    <table class="listing" style="width: auto; margin-left: 0"
           tal:attributes="cols view/ordered_architectures/count:len">
      <thead>
        <tr>
          <th>&nbsp;</th>
          <tal:headers repeat="arch view/ordered_architectures">
            <th tal:content="arch/title" />
          </tal:headers>
        </tr>
      </thead>
      <tbody>
        <tr tal:repeat="row view/quantities_matrix">
          <tal:block repeat="cell row">
            <tal:is-header condition="repeat/cell/start">
              <th tal:content="cell" />
            </tal:is-header>
            <tal:is-not-header condition="not: repeat/cell/start">
              <td style="text-align: right">
                <span tal:replace="cell" />
              </td>
            </tal:is-not-header>
          </tal:block>
        </tr>
      </tbody>
    </table>

    <tal:can-be-changed condition="view/contextCanBeModified">
      <div style="text-align: right;" tal:condition="context/canBeDenied">
        <form name="denyrequest" method="post"
              tal:attributes="action request/URL">
          <input type="submit" value="Deny &amp; Continue" name="DENY" />
        </form>
      </div>
    </tal:can-be-changed>

    <h2>Approved quantities</h2>

    <p>These are the quantities that will actually be shipped.</p>

    <form method="post" name="approverequest"
          tal:attributes="action request/URL">

      <tal:block define="widgets_matrix view/widgetsMatrixWithFlavours">
        <metal:quantity_widgets
            use-macro="context/@@+shipit-macros/quantity_widgets" />
      </tal:block>

      <br />
      <label tal:attributes="for view/highpriority_widget/name">
        <span tal:replace="structure view/highpriority_widget" />
        High priority
      </label>

      <br />
      <div style="text-align: right;" 
           tal:condition="view/contextCanBeModified">
        <tal:block condition="context/canBeApproved">
          <input type="submit" value="Approve &amp; Continue" name="APPROVE" />
        </tal:block>
        <tal:block condition="context/isApproved">
          <input type="submit" value="Change Approved Totals" name="CHANGE" />
        </tal:block>
      </div>
    </form>

    <h2>Shipping details</h2>
    <table>
      <tr>
        <td align="right"><strong>Recipient:</strong></td>
        <td tal:condition="context/recipientdisplayname">
          <span tal:replace="context/recipientdisplayname" />
          (<a tal:attributes="href string:mailto:${context/recipient_email}"
            ><span tal:replace="context/recipient_email" 
            /></a>)
        </td>
      </tr>
      <tr tal:condition="context/organization">
        <td align="right"><strong>Organization:</strong></td>
        <td><span tal:replace="context/organization" /></td>
      </tr>
      <tr>
        <td align="right"><strong>Country:</strong></td>
        <td><span tal:replace="context/country/name" /></td>
      </tr>
      <tr>
        <td align="right"><strong>City:</strong></td>
        <td><span tal:replace="context/city" /></td>
      </tr>
      <tr tal:condition="context/province">
        <td align="right"><strong>Province:</strong></td>
        <td><span tal:replace="context/province" /></td>
      </tr>
      <tr>
        <td align="right"><strong>Address:</strong></td>
        <td><span tal:replace="context/addressline1" /></td>
      </tr>
      <tr tal:condition="context/addressline2">
        <td align="right"></td>
        <td><span tal:replace="context/addressline2" /></td>
      </tr>
      <tr tal:condition="context/postcode">
        <td align="right"><strong>Postcode:</strong></td>
        <td><span tal:replace="context/postcode" /></td>
      </tr>
      <tr tal:condition="context/phone">
        <td align="right"><strong>Phone:</strong></td>
        <td><span tal:replace="context/phone" /></td>
      </tr>
      <tr>
        <td align="right"><strong>Date:</strong></td>
        <td><span
              tal:attributes="title context/daterequested/fmt:datetime"
              tal:content="context/daterequested/fmt:approximatedate" /></td>
      </tr>
      <tr tal:condition="context/reason">
        <td align="right"><strong>Reason:</strong></td>
        <td><span tal:replace="context/reason" /></td>
      </tr>
    </table>

    <ul tal:condition="view/contextCanBeModified">
      <li class="edit">
        <a tal:attributes="href string:/adminrequest?order=${context/id}">
          Edit shipping details
        </a>
      </li>
    </ul>

    </td>
    <td
      width="20%"
      style="vertical-align: top;"
      tal:content="structure context/@@+portlet-navigation"
    />
    </tr>
    </tbody>
    </table>  
  
  </div>

</body>
</html>
