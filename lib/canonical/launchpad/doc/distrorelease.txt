Distro Releases
===============

From the DerivationOverview spec[1]:

    A distribution of GNU/Linux comprises a set of packages, an installer,
    possibly a live-CD, some amount of metadata associated with the arrangement
    of those elements and also a lot of information on managing it.

A distro release is a given version of a distribution. So, for Ubuntu, there
are releases (or planned releases) like "warty", "hoary" and "bendy".

Distro releases are retrieved with the IDistroReleaseSet utility, much like
people are retrieved with the IPersonSet utility, or bug tasks are retrieved
with the IBugTaskSet utility.

The IDistroReleaseSet utility is accessed in the usual fashion:

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.interfaces import (
    ...     IDistroReleaseSet, IDistributionSet)
    >>> distroreleaseset = getUtility(IDistroReleaseSet)

To retrieve a specific release of a distribution, use IDistroReleaseSet.get:

    >>> warty = distroreleaseset.get(1)
    >>> print warty.name
    warty
    >>> print warty.fullreleasename
    Ubuntu Warty

Or IDistroReleaseSet.findByName:

    >>> for distrorelease in distroreleaseset.findByName("warty"):
    ...     print distrorelease.name
    warty

To get one specific release by name, use queryByName:

    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")

    >>> warty = distroreleaseset.queryByName(ubuntu, "warty")
    >>> warty.name
    u'warty'

If the release by that name doesn't exist, None will be returned:

    >>> foobar = distroreleaseset.queryByName(ubuntu, "foobar")
    >>> print foobar
    None

Or IDistroReleaseSet.findByVersion:

    >>> for distrorelease in distroreleaseset.findByVersion("5.04"):
    ...     print distrorelease.name
    hoary

To search the set of IDistroReleases, use IDistroReleaseSet.search:

    >>> ubuntu_releases = distroreleaseset.search(
    ...     distribution=ubuntu, isreleased=True, orderBy="-datereleased")
    >>> [release.name for release in ubuntu_releases]
    [u'warty']

    >>> all_ubuntu_releases = distroreleaseset.search(distribution=ubuntu)
    >>> all_ubuntu_releases.count()
    3

DistroRelease.getPublishedReleases:

    >>> from canonical.launchpad.database import SourcePackageName, DistroRelease
    >>> warty2 = DistroRelease.get(1)
    >>> prs = warty2.getPublishedReleases(SourcePackageName.byName('mozilla-firefox'))
    >>> print len(prs)
    1
    >>> print prs[0].sourcepackagerelease.sourcepackagename.name
    mozilla-firefox


CVE BugTasks on a Distro Release
--------------------------------

A distro release should know what CVE-related bug tasks exist on it, and
what state they are in. We should be able to find open, and closed,
bugtasks, using this API. Based on the sample data we know the following
about Debian:

    >>> woody = distroreleaseset.get(6)
    >>> tasks = woody.open_cve_bugtasks
    >>> for task in tasks:
    ...     print task.id
    20

There should be NO resolved CVE tasks:

    >>> tasks = woody.resolved_cve_bugtasks
    >>> print len(tasks)
    0

DistroReleases have components and sections
-------------------------------------------

A distrorelease has some number of components and/or sections which
are valid for that distrorelease. These selections are used by (among
other things) the uploader for validating incoming uploads.

   >>> hoary = distroreleaseset.get(3)
   >>> for c in hoary.real_components:
   ...     print c.name
   main
   >>> for s in hoary.real_sections:
   ...     print s.name
   editors

[1] https://wiki.launchpad.canonical.com/DerivationOverview

DistroReleases can be initialised from their parents
----------------------------------------------------

When a distrorelease is derived from another distrorelease (be it a
derivative distribution, or simply the next release in a sequence from
Ubuntu) we need to initialise the new release with quite a lot of
information. Not least of which is the section and component
selections and the publishing information for the distrorelease.

DistroRelease provides us with a method for doing this which carefully
goes behind the back of sqlobject to copy potentially tens of
thousands of rows around in order to set up a distrorelease.

IDistroRelease lists a series of preconditions for performing an
initialisation. In particular the initialiser won't overwrite
publishing records etc. Essentially this is a "Do not push this button
again" type set of assertions.

   >>> login("foo.bar@canonical.com")
   >>> humpy = distroreleaseset.new(ubuntu, 'humpy', 'Humpy Hippo',
   ...                              'The Humpy Hippo', 'Fat', 'Yo Momma',
   ...                              '99.2', hoary.components,
   ...                              hoary.sections, hoary, hoary.owner)
   >>> humpy_i386 = humpy.newArch('i386', hoary['i386'].processorfamily, 
   ...                            True, humpy.owner)
   >>> humpy.nominatedarchindep = humpy_i386
   >>> humpy.initialiseFromParent()
   >>> len(humpy.getPublishedReleases(SourcePackageName.byName('pmount')))
   1
   >>> len(humpy_i386.getReleasedPackages('pmount'))
   1
