= Importing translation files =

We are using gettext PO file to document how our translation files
are being imported into our database, showing how translations are
overridden or not, depending on the type of the import.

We'll be going through usual steps of the PO file lifetime:
 * importing a template
 * importing a translation from package
 * importing updated translation from a translator
 * importing an updated translation from a package
 * importing update from a translator again

== Helper imports ==

    >>> from canonical.database.sqlbase import flush_database_caches
    >>> from lp.registry.interfaces.person import IPersonSet
    >>> from lp.registry.interfaces.product import IProductSet
    >>> from lp.translations.model.potemplate import POTemplateSubset
    >>> import datetime
    >>> import pytz
    >>> UTC = pytz.timezone('UTC')
    >>> def ISO_FORMATTED_DATE(): return datetime.datetime.now(UTC).isoformat()

To ease the pain of importing many files during testing, we use this
helper function to import either a PO file or a PO template from a
string with the contents of the file.

    >>> from lp.translations.utilities.tests.helpers import (
    ...     import_pofile_or_potemplate)

And lets define a nice printout function for PO files.

    >>> def print_pofile(pofile):
    ...     # We are using length=18 for msgid, translation and
    ...     # imported translation to be able to fit them with two
    ...     # fuzzy flags into a single line for nicer and more
    ...     # readable diffs in the test.
    ...     def strip_to_length(string, length=18):
    ...         if string is None: return None
    ...         if len(string)>length:
    ...             return string[:length-3]+'...'
    ...         else:
    ...             return string
    ...
    ...     print "%2s. %-18s %-18s %-18s" % (
    ...         "no", "msgid", "translation", "imported")
    ...     for potmsgset in pofile.potemplate.getPOTMsgSets():
    ...         msgid = potmsgset.singular_text
    ...         current = potmsgset.getCurrentTranslationMessage(
    ...             pofile.potemplate, pofile.language)
    ...         imported = potmsgset.getImportedTranslationMessage(
    ...             pofile.potemplate, pofile.language)
    ...         imported_translation = translation = None
    ...         if imported is not None:
    ...             imported_translation = imported.msgstr0.translation
    ...         if current is not None:
    ...             translation = current.msgstr0.translation
    ...         print "% 2d. %-18s %-18s %-18s *" % (
    ...             potmsgset.sequence,
    ...             strip_to_length(msgid),
    ...             strip_to_length(translation),
    ...             strip_to_length(imported_translation))

We need to print out stats for the pofile as well.

    >>> # We are indenting those counts which are contained in the parent
    >>> # one.  Thus, 'translated' count is the sum of 'imported' and 'new'.
    >>> # 'imported' also includes the 'changed' entries.
    >>> def print_pofile_stats(pofile):
    ...     pofile.updateStatistics()
    ...     print "total:", pofile.messageCount()
    ...     print "translated:", pofile.translatedCount()
    ...     print "  imported:", pofile.currentCount()
    ...     print "    changed:", pofile.updatesCount()
    ...     print "  new:", pofile.rosettaCount()

We'll be doing all our imports into Firefox trunk as
carlos@canonical.com.

    >>> carlos = getUtility(IPersonSet).getByEmail('carlos@canonical.com')
    >>> login('carlos@canonical.com')

    >>> firefox = getUtility(IProductSet).getByName('firefox')
    >>> firefox_trunk = firefox.getSeries('trunk')
    >>> firefox_potsubset = POTemplateSubset(productseries=firefox_trunk)

    >>> firefox_potemplate = firefox_potsubset.new(
    ...     name='firefox',
    ...     translation_domain='firefox',
    ...     path='po/firefox.pot',
    ...     owner=carlos)

== Importing a template ==

To avoid using sample data, we import a template into Firefox here, to
be able to import translations later on.

    >>> test_template = r'''
    ... msgid ""
    ... msgstr ""
    ... "POT-Creation-Date: 2004-07-11 16:16+0900\n"
    ... "Content-Type: text/plain; charset=CHARSET\n"
    ... "Plural-Forms: nplurals=INTEGER; plural=EXPRESSION;\n"
    ...
    ... msgid "first"
    ... msgstr ""
    ...
    ... msgid "second"
    ... msgstr ""
    ...
    ... msgid "third"
    ... msgstr ""
    ...
    ... msgid "fourth"
    ... msgstr ""
    ...
    ... msgid "fifth"
    ... msgstr ""
    ...
    ... msgid "sixth"
    ... msgstr ""
    ... '''
    >>> entry = import_pofile_or_potemplate(test_template, carlos,
    ...                                     potemplate=firefox_potemplate)
    >>> print entry.status.name
    IMPORTED
    >>> flush_database_caches()

Usually, the first import we get is imported (i.e. coming from a
package upload in Ubuntu).

    # fifth and sixth are untranslated
    >>> test_translation_imported = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "X-Launchpad-Export-Date: 2005-05-03 20:40+0100\n"
    ...
    ... msgid "first"
    ... msgstr "a"
    ...
    ... msgid "second"
    ... msgstr "b"
    ...
    ... #, fuzzy
    ... msgid "third"
    ... msgstr "c"
    ...
    ... #, fuzzy
    ... msgid "fourth"
    ... msgstr "d"
    ... ''' % ISO_FORMATTED_DATE()

    >>> firefox_serbian = firefox_potemplate.newPOFile('sr')
    >>> firefox_serbian.path='sr.po'
    >>> entry = import_pofile_or_potemplate(test_translation_imported,
    ...                                     carlos, pofile=firefox_serbian)
    >>> print entry.status.name
    IMPORTED
    >>> flush_database_caches()

When this file is imported, we notice that all the messages are
imported as expected: current translation is set to the same imported
one, and fuzzy messages are ignored (treated as empty messages).

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b                  b                  *
     3. third              None               None               *
     4. fourth             None               None               *
     5. fifth              None               None               *
     6. sixth              None               None               *

If we look at the statistics, only non-fuzzy imported messages are counted
as valid translations.

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 2
      imported: 2
        changed: 0
      new: 0

After initial translation import from the package, it's common for
translators to work either directly in Launchpad or to upload PO files
with their updates.  This is a file where the "second" and "fourth"
message are updated with new translations, the fuzzy flag is removed
from the "fourth" message, and the "fifth" message is newly translated.

    >>> test_translation_update1 = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "X-Launchpad-Export-Date: %s\n"
    ...
    ... # stays as imported
    ... msgid "first"
    ... msgstr "a"
    ...
    ... # changes imported translation
    ... msgid "second"
    ... msgstr "b-from-LP"
    ...
    ... # same as already imported one
    ... #, fuzzy
    ... msgid "third"
    ... msgstr "c"
    ...
    ... # takes the fuzzy flag off and updates the translation
    ... msgid "fourth"
    ... msgstr "d-from-LP"
    ...
    ... # translates untranslated message
    ... msgid "fifth"
    ... msgstr "e-from-LP"
    ... ''' % (ISO_FORMATTED_DATE(), ISO_FORMATTED_DATE())

    >>> entry = import_pofile_or_potemplate(test_translation_update1,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=False)
    >>> print entry.status.name
    IMPORTED
    >>> flush_database_caches()

Again, PO file in the database reflects the changes: translations for
"second", "fourth" and "fifth" are updated (and now different from
imported translations). Fuzzy flag is ignored on "fourth" as well.

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP          b                  *
     3. third              None               None               *
     4. fourth             d-from-LP          None               *
     5. fifth              e-from-LP          None               *
     6. sixth              None               None               *

We can notice that we have 4 translations (fuzzy messages are not considered
translated), with "second" imported one now considered 'changed in LP', and
two new translations through Launchpad ("d-from-LP" and "e-from-LP"):

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 4
      imported: 1
        changed: 1
      new: 3

Common next step is having a new package upload which provides us with
updated translations upstream.  The "second" message translation is changed,
a fuzzy flag is removed from the "fourth" message, and both "fifth" and
"sixth" are translated.

    >>> test_translation_imported_update = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "X-Launchpad-Export-Date: %s\n"
    ...
    ... msgid "first"
    ... msgstr "a"
    ...
    ... msgid "second"
    ... msgstr "b-updated"
    ...
    ... #, fuzzy
    ... msgid "third"
    ... msgstr "c"
    ...
    ... # removes the fuzzy flag on the imported translation
    ... msgid "fourth"
    ... msgstr "d"
    ...
    ... # translate remaining messages
    ... msgid "fifth"
    ... msgstr "e"
    ...
    ... msgid "sixth"
    ... msgstr "f"
    ... ''' % (ISO_FORMATTED_DATE(), ISO_FORMATTED_DATE())

    >>> entry = import_pofile_or_potemplate(test_translation_imported_update,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=True)
    >>> print entry.status.name
    IMPORTED
    >>> flush_database_caches()

We can see that the imported fuzzy flag has been removed from the
"fourth" message in the database, and that imported translations for
"fifth" and "sixth" have been updated.  Also note how the current
translations for "fourth" and "fifth" messages have been reverted
to imported ones.

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP          b-updated          *
     3. third              None               None               *
     4. fourth             d                  d                  *
     5. fifth              e                  e                  *
     6. sixth              f                  f                  *

With this latest import, we've got five non-fuzzy messages, which are all
considered 'translated'. Since we are reverting to imported translations
when there's only a Launchpad-done translation, only a single message is
marked as 'changed in LP':

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 5
      imported: 4
        changed: 1
      new: 1

A new translation for "second" message through Launchpad is added.  We also
do another translator (i.e. not from a package) update, where we remove the
fuzzy flag from the imported translation for "third", and revert "fourth"
to the imported translation.  Finally, "fifth" translation is updated with
a new translation.

    >>> test_translation_update2 = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "X-Launchpad-Export-Date: %s\n"
    ...
    ... # stays as imported
    ... msgid "first"
    ... msgstr "a"
    ...
    ... msgid "second"
    ... msgstr "b-from-LP-two"
    ...
    ... # same as already imported one, removes the fuzzy flag
    ... msgid "third"
    ... msgstr "c"
    ...
    ... # revert to imported translation
    ... msgid "fourth"
    ... msgstr "d"
    ...
    ... # updates current translation
    ... msgid "fifth"
    ... msgstr "e-from-LP-two"
    ...
    ... # sixth message is not being updated at all
    ... msgid "sixth"
    ... msgstr "f"
    ... ''' % (ISO_FORMATTED_DATE(), ISO_FORMATTED_DATE())

    >>> entry = import_pofile_or_potemplate(test_translation_update2,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=False)
    >>> print entry.status.name
    IMPORTED
    >>> flush_database_caches()

We can see that "third" message has fuzzy flag removed from the current
translation (but not from the imported one), "fourth" is reverted to
the same translation as imported, and "fifth" has an updated
translation.

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP-two      b-updated          *
     3. third              c                  None               *
     4. fourth             d                  d                  *
     5. fifth              e-from-LP-two      e                  *
     6. sixth              f                  f                  *

Removing a fuzzy flag from imported translation for "third" actually makes
a 'new' translation, which is reflected in the statistics below, and
reverting a "fourth" translation to the imported one is shown by the decreased
'changed' count:

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 6
      imported: 3
        changed: 2
      new: 3

Finally, we make sure that adding another suggestion to the "second" message
works properly, even if it makes us have two non-current and non-imported
suggestions.

    >>> test_translation_update3 = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "X-Launchpad-Export-Date: %s\n"
    ...
    ... # stays as imported
    ... msgid "first"
    ... msgstr "a"
    ...
    ... msgid "second"
    ... msgstr "b-from-LP-three"
    ...
    ... # same as already imported one, removes the fuzzy flag
    ... msgid "third"
    ... msgstr "c"
    ...
    ... # revert to imported translation
    ... msgid "fourth"
    ... msgstr "d"
    ...
    ... # updates current translation
    ... msgid "fifth"
    ... msgstr "e-from-LP-two"
    ...
    ... # sixth message is not being updated at all
    ... msgid "sixth"
    ... msgstr "f"
    ... ''' % (ISO_FORMATTED_DATE(), ISO_FORMATTED_DATE())

    >>> entry = import_pofile_or_potemplate(test_translation_update3,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=False)
    >>> print entry.status.name
    IMPORTED

Notice that "second" message is indeed updated properly.  We are making sure
we don't get any problems with too many non-current suggestions for that
one ("b-from-LP", "b-from-LP-two").

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP-three    b-updated          *
     3. third              c                  None               *
     4. fourth             d                  d                  *
     5. fifth              e-from-LP-two      e                  *
     6. sixth              f                  f                  *

Statistics have not changed from the previous, since translation for "second"
was already 'changed':

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 6
      imported: 3
        changed: 2
      new: 3

If a translation actually uses a different plural expression from the
one we default to in Launchpad, non-plural messages are not reordered
(this is mostly a regression test).  The specific problematic case
occured when formula required reordering messages (i.e. a first form
was moved to another place), thus ending up with None for non-plural
messages.  The PO file contents below are no different from the above
one except for the plural expression definition.

    >>> test_translation_update3 = r'''
    ... msgid ""
    ... msgstr ""
    ... "PO-Revision-Date: %s\n"
    ... "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
    ... "Content-Type: text/plain; charset=UTF-8\n"
    ... "Plural-Forms: nplurals=3; plural=n%%10==1 && n%%100!=11 ? 1 : "
    ... "n%%10>=2 && n%%10<=4 && (n%%100<10 || n%%100>=20) ? 2 : 0\n"
    ... "X-Launchpad-Export-Date: %s\n"
    ...
    ... # stays as imported
    ... msgid "first"
    ... msgstr "a"
    ...
    ... msgid "second"
    ... msgstr "b-from-LP-three"
    ...
    ... # same as already imported one, removes the fuzzy flag
    ... msgid "third"
    ... msgstr "c"
    ...
    ... # revert to imported translation
    ... msgid "fourth"
    ... msgstr "d"
    ...
    ... # updates current translation
    ... msgid "fifth"
    ... msgstr "e-from-LP-two"
    ...
    ... # sixth message is not being updated at all
    ... msgid "sixth"
    ... msgstr "f"
    ... ''' % (ISO_FORMATTED_DATE(), ISO_FORMATTED_DATE())

    >>> entry = import_pofile_or_potemplate(test_translation_update3,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=False)
    >>> print entry.status.name
    IMPORTED

Neither contents nor statistics have changed, so we've got the same output.

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP-three    b-updated          *
     3. third              c                  None               *
     4. fourth             d                  d                  *
     5. fifth              e-from-LP-two      e                  *
     6. sixth              f                  f                  *

    >>> print_pofile_stats(firefox_serbian)
    total: 6
    translated: 6
      imported: 3
        changed: 2
      new: 3

Sometimes, people will send back their translations to upstream, which will
be back with next automatic sync from upstream:

    >>> entry = import_pofile_or_potemplate(test_translation_update3,
    ...                                     carlos, pofile=firefox_serbian,
    ...                                     is_imported=True)
    >>> print entry.status.name
    IMPORTED

Imported strings match the ones translated in Launchpad.

    >>> print_pofile(firefox_serbian)
    no. msgid              translation        imported
     1. first              a                  a                  *
     2. second             b-from-LP-three    b-from-LP-three    *
     3. third              c                  c                  *
     4. fourth             d                  d                  *
     5. fifth              e-from-LP-two      e-from-LP-two      *
     6. sixth              f                  f                  *
