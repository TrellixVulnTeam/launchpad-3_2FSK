Here we are going to check the basic behaviour of the translation form when we
render just one message with all available information for it.

Let's identify us first.

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')

The main page for a pomsgset object should redirect us to the translation form.

  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1')
  >>> browser.url
  'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate'

When we are on the first message, we should be 100% sure that the 'First' and
'Previous' links are hidden and 'Next' and 'Last' are the right ones.

  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1/+translate')
  >>> browser.url
  'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate'

  >>> browser.getLink('First')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Prev')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> next = browser.getLink('Next')
  >>> print next.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/2/+translate
  >>> print browser.getLink('Last').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=0

when we choose the next entry, all links should appear.

  >>> next.click()
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/2/+translate

  >>> print browser.getLink('First').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Next').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/3/+translate
  >>> last = browser.getLink('Last')
  >>> print last.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=1

And the last one.

  >>> last.click()
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

  >>> print browser.getLink('First').url
  http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> prev = browser.getLink('Previous')
  >>> print prev.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/21/+translate

  >>> browser.getLink('Next')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Last')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=21

Let's test the ones at the end of the form.

  >>> prev.click()
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/21/+translate

  >>> print browser.getLink('First').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/20/+translate
  >>> print browser.getLink('Next').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate
  >>> print browser.getLink('Last').url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

Now, we are going to check a message submission.

  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate

Check that the message #13 is without translation.

  >>> browser.getControl(name='msgset_142_es_translation_0').value
  ''

And also, we don't get anyone as the Last translator because there is no
translation at all ;-)

  >>> 'Translated by:' in browser.contents
  False

Let's submit an invalid value for this message #13.

  >>> browser.getControl(name='msgset_142_es_translation_0').value = 'foo %i'
  >>> browser.getControl(name='submit_translations').click()
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate
  >>> 'There is an error in the translation you provided' in browser.contents
  True
  >>> "format specifications in 'msgid' and 'msgstr' for argument 1 are not the same" in browser.contents
  True
  >>> browser.getControl(name='msgset_142_es_translation_0').value == 'foo %i'
  True

And now a good submit.

  >>> browser.getControl(name='msgset_142_es_translation_0').value = 'foo %s'
  >>> browser.getControl(name='submit_translations').click()

We moved to the next message, that means this submission worked.

  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate

Now, it has the submitted value.

  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate

Check that the message #13 has the new value we submitted.

  >>> browser.getControl(name='msgset_142_es_translation_0').value
  'foo %s'

And now, we get someone as the Translator and also, we have a reviewer (in
this case, it's the same):

  >>> print browser.contents
  <!DOCTYPE...
  Translated by:
  ...Carlos...
  on
  ...
  Reviewed by:
  ...Carlos...
  on
  ...

Now, we will check suggestions in this form.

  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate

Check that suggestions come in from other contexts:

  >>> "<label>Suggested elsewhere:</label>" in browser.contents
  True
  >>> suggested = '<div lang="es" dir="ltr">This is a suggestion added by a non-editor for a multiline entry, and it happens to have a very long first line.'
  >>> suggested in browser.contents
  True

Check that no other suggestions are presented (since no others are
relevant for this message):

  >>> "<label>Suggestion" not in browser.contents
  True
  >>> "<label>Used elsewhere:</label>" not in browser.contents
  True

Check for the translator note:

  >>> "This is an example of commenttext for a multiline msgset" in browser.contents
  True

  ...Suggested elsewhere:...
  ...No Privileges Person...
  ...name="msgset_143_es_needsreview"...
  ...Translator note:...

Also check that the alternative language selection is working:

  >>> browser.getControl(name='field.alternative_language').value = ['ja']
  >>> browser.getControl(name='select_alternate_language').click()
  >>> print browser.url
  http://.../ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate?field.alternative_language=ja&field.alternative_language-empty-marker=1&select_alternate_language=Change

If we specify more than one alternative language in the URL, we get an
UnexpectedFormData exception:

  >>> browser.open(
  ...  'http://localhost/ubuntu/hoary/+source/evolution/'
  ...  '+pots/evolution-2.2/es/14/+translate?field.alternative_language=ja&field.alternative_language=aj')
  Traceback (most recent call last):
    ...
  UnexpectedFormData: You specified...

(And this happens when we try and do this for the main translation page
as well!)

  >>> browser.open(
  ...  'http://localhost/ubuntu/hoary/+source/evolution/'
  ...  '+pots/evolution-2.2/es/+translate?field.alternative_language=ja&field.alternative_language=aj')
  Traceback (most recent call last):
    ...
  UnexpectedFormData: You specified...

Let's see what happens when we do a submission with a lock_timestamp older
than the review date for current translation.

First, we get a browser instance that will be the last one submitting the
changes.

  >>> from zope.testbrowser.testing import Browser
  >>> slow_submission = Browser()
  >>> slow_submission.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> slow_submission.open(
  ...     'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> slow_submission.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'
  >>> import transaction
  >>> transaction.commit()

Now, we get another instance that will be submitted before 'slow_submission'.

  >>> fast_submission = Browser()
  >>> fast_submission.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> fast_submission.open(
  ...     'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> fast_submission.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'

Let's change the translation.

  >>> fast_submission.getControl(name='msgset_143_es_translation_0').value = u'\nblah'

And submit it.

  >>> fast_submission.getControl(name='submit_translations').click()
  >>> fast_submission.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/15/+translate'

Now, we check that the translation we are going to add is not yet in the
form, so we can check later that it's added as a suggestion:

  >>> 'foo!!' in fast_submission.contents
  False

Now, we update the translation in slow_submission.

  >>> slow_submission.getControl(name='msgset_143_es_translation_0').value = u'foo!!'

We submit it

  >>> slow_submission.getControl(name='submit_translations').click()
  >>> slow_submission.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'

And, as expected, we see the error message:

  >>> 'Somebody else changed this translation since you started.' in slow_submission.contents
  True

Also, we should still have previous translation:

  >>> slow_submission.getControl(name='msgset_143_es_translation_0').value == u'\nblah'
  True

But also, the new one should appear in the form.

  >>> 'foo!!' in slow_submission.contents
  True
