  >>> import datetime
  >>> import pytz
  >>> from zope.component import getUtility
  >>> from canonical.launchpad.database import POMsgID
  >>> from canonical.launchpad.database import POTemplate
  >>> from canonical.launchpad.interfaces import IPersonSet
  >>> UTC = pytz.timezone('UTC')

Get the PO msgid we will be working with.

  >>> pomsgid = POMsgID.byMsgid('evolution addressbook')

Carlos is the one that will do the uploads.

  >>> carlos = getUtility(IPersonSet).getByName('carlos')

Now find the po template.

  >>> upstream_evo = POTemplate.get(1)
  >>> upstream_evo.productseries is not None
  True
  >>> upstream_evo.productseries.product.name
  u'evolution'

And the Spanish translation.

  >>> pofile_es = upstream_evo.getPOFileByLang('es')

This method will only overwrite translations in Launchpad with upstream
ones if the previous upstream translation matches the translation used in
Launchpad or there is no complete translation.

  >>> potmsgset = pofile_es.potemplate.getPOTMsgSetByMsgIDText(
  ...     u'EncFS Password: ')

We can see that this is actually the case:

  >>> from canonical.launchpad.database.language import LanguageSet
  >>> spanish = LanguageSet().getLanguageByCode('es')
  >>> message = potmsgset.getCurrentTranslationMessage(spanish)
  >>> message.msgstr0.translation
  u'Contrase\xf1a de EncFS: '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_imported
  True
  >>> message.was_fuzzy_in_last_import
  False

We change the published one, and thus, the one in Launchpad will be changed
too at the same time.

  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {0: u'foo '}, is_fuzzy=False, is_imported=True,
  ...     lock_timestamp=datetime.datetime.now(UTC))

  >>> message.msgstr0.translation
  u'foo '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_imported
  True
  >>> message.was_fuzzy_in_last_import
  False

If the translation in Launchpad is fuzzy, we keep update it.

  >>> message.is_fuzzy = True
  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {0: u'bar '}, is_fuzzy=False, is_imported=True,
  ...     lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0.translation
  u'bar '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_published
  True

Even more, if there is no translation at all in Launchpad, we still get
the update from upstream.

  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {}, is_fuzzy=False, is_import=False,
  ...     lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0
  None
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  False
  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {0: u'foobar '}, is_fuzzy=False,
  ...     is_imported=True, lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0.translation
  u'foobar '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_imported
  True

Now, is turn to do the oposite, the system should prevent that,
when a translation coming from upstream with the fuzzy flag is imported, we
revert a valid translation in Launchpad.

  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {0: u'foos '}, is_fuzzy=True, is_imported=True,
  ...     lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0.translation
  u'foobar '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_imported
  True

Even when the upstream translation is the same as current translation
in Launchpad, if the only difference is the fuzzy flag, the one
in Launchpad should not get the fuzzy flag because otherwise, we will
be losing translations.

  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {0: u'foobar '}, is_fuzzy=True,
  ...     is_imported=True, lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0.translation
  u'foobar '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_published
  True

When we get no translations at all, Launchpad should keep its active
translation.

  >>> message = potmsgset.updateTranslation(
  ...     pofile_es, carlos, {}, is_fuzzy=False, is_imported=True,
  ...     lock_timestamp=datetime.datetime.now(UTC))
  >>> message.msgstr0.translation
  u'foobar '
  >>> message.is_fuzzy
  False
  >>> message.is_complete
  True
  >>> message.is_published
  False

And finally, now that published and active translations diverged,
if we get a new upstream translation, the one in Launchpad will be keep
untouched.

  >>> pomsgset.updateTranslationSet(
  ...     carlos, {0: u'bars '}, fuzzy=False, published=True,
  ...     lock_timestamp=datetime.datetime.now(UTC))
  >>> pomsgset.active_texts
  [u'foobar ']
  >>> pomsgset.isfuzzy
  False
  >>> pomsgset.iscomplete
  True
  >>> pomsgset.published_texts
  [u'bars ']
  >>> pomsgset.publishedfuzzy
  False
  >>> pomsgset.publishedcomplete
  True
