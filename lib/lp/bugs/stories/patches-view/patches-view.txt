Patches View
============

Patches View by Product
-----------------------

We have a view listing patches attached to bugs that target a given
product.  At first, the product is new and has no bugs.

    >>> def make_thing(factory_method, **thing_args):
    ...    login('foo.bar@canonical.com')
    ...    result = factory_method(**thing_args)
    ...    transaction.commit()
    ...    logout()
    ...    return result

    >>> patchy_product = make_thing(factory.makeProduct, name='patchy-product-1')

We don't see any patches when we open the patches view.

    >>> def show_patches_view(expected_contents):
    ...     for tag in find_tags_by_class(
    ...         expected_contents, 'listing'):
    ...         print extract_text(tag)

    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After the product has a bug, it still doesn't show up in the patches
view, because that bug has no patch attachments.

    >>> from lp.bugs.interfaces.bugtask import (
    ...     BugTaskImportance, BugTaskStatus)
    >>> def make_bug(
    ...     title, product, importance=BugTaskImportance.UNDECIDED,
    ...     status=BugTaskStatus.NEW):
    ...     bug = factory.makeBug(title=title, product=product)
    ...     bug.default_bugtask.transitionToImportance(
    ...         importance, product.owner)
    ...     bug.default_bugtask.transitionToStatus(
    ...         status, product.owner)
    ...     return bug

    >>> bug_a = make_thing(
    ...     make_bug, title="bug_a title", product=patchy_product)
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After we add a non-patch attachment to that bug, the patches view
still shows no patches.

    >>> make_thing(factory.makeBugAttachment, bug=bug_a, is_patch=False)
    <BugAttachment at...
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug Importance Status Patch Age

After we add a patch attachment that's one day old, we see it in the
patches view.

    >>> patch_submitter = make_thing(
    ...    factory.makePerson, name="patchy-person",
    ...    displayname="Patchy Person")
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch a",
    ...     filename="patch_a.diff", owner=patch_submitter,
    ...     description="description of patch a", bug=bug_a, is_patch=True)
    <BugAttachment at...
    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

After creating some more bugs, with some non-patch and some patch
attachments...

    >>> bug_b = make_thing(
    ...     make_bug, title="bug_b title", product=patchy_product,
    ...     importance=BugTaskImportance.CRITICAL,
    ...     status=BugTaskStatus.CONFIRMED)
    >>> bug_c = make_thing(
    ...     make_bug, title="bug_c title", product=patchy_product,
    ...     importance=BugTaskImportance.WISHLIST,
    ...     status=BugTaskStatus.FIXCOMMITTED)
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch b",
    ...     filename="patch_b.diff", owner=patch_submitter,
    ...     description="description of patch b", bug=bug_b, is_patch=True)
    <BugAttachment at...
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch c",
    ...     filename="patch_c.diff", owner=patch_submitter,
    ...     description="description of patch c", bug=bug_b, is_patch=True)
    <BugAttachment at...
    >>> make_thing(factory.makeBugAttachment, bug=bug_c, is_patch=False)
    <BugAttachment at...
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch d",
    ...     filename="patch_d.diff", owner=patch_submitter,
    ...     description="description of patch d", bug=bug_c, is_patch=True)
    <BugAttachment at...
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch e",
    ...     filename="patch_e.diff", owner=patch_submitter,
    ...     description="description of patch e", bug=bug_c, is_patch=True)
    <BugAttachment at...
    >>> make_thing(
    ...     factory.makeBugAttachment, comment="comment about patch f",
    ...     filename="patch_f.diff", owner=patch_submitter,
    ...     description="description of patch f", bug=bug_c, is_patch=True)
    <BugAttachment at...

...the youngest patch on each bug is visible is the patch report.

    >>> user_browser.open('http://bugs.launchpad.dev/patchy-product-1/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

We can sort patches by importance and status.

    >>> user_browser.getControl(name="orderby").value = ['-importance']
    >>> user_browser.getControl("sort").click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/patchy-product-1/+patches?orderby=-importance'
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

    >>> user_browser.getControl(name="orderby").value = ['status']
    >>> user_browser.getControl("sort").click()
    >>> user_browser.url
    'http://bugs.launchpad.dev/patchy-product-1/+patches?orderby=status'
    >>> show_patches_view(user_browser.contents)
    Bug                                 Importance   Status    Patch Age
    Bug #16: bug_a title                  Undecided     New     ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a
    Bug #17: bug_b title                  Critical    Confirmed ...second...
    From: Patchy Person
    Link: patch_c.diff description of patch c
    Bug #18: bug_c title                  Wishlist  Fix Committed ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f

To nominate a bug for a series, we need to be able to make bugtasks.
It helps to have a meta-factory for this.  The meta-factory defaults
to the 'ubuntu' distro, for all instances where a distro is needed.

    >>> from zope.component import getUtility
    >>> from lp.registry.interfaces.distribution import IDistributionSet
    >>> def make_bugtask(
    ...     bug, target, target_is_spkg_name=False,
    ...     importance=None, status=None):
    ...     ubuntu_distro = getUtility(IDistributionSet).getByName('ubuntu')
    ...     if target_is_spkg_name:
    ...         target = ubuntu_distro.getSourcePackage(target)
    ...     bugtask = factory.makeBugTask(bug=bug, target=target)
    ...     if importance is not None:
    ...         bugtask.transitionToImportance(importance, ubuntu_distro.owner)
    ...     if status is not None:
    ...         bugtask.transitionToStatus(status, ubuntu_distro.owner)

Bugs in a product series show up in the patches view for that series.

    >>> patchy_product_series = patchy_product.getSeries('trunk')
    >>> make_thing(
    ...     make_bugtask, bug=bug_a,
    ...     target=patchy_product_series)
    >>> make_thing(
    ...     make_bugtask, bug=bug_c,
    ...     target=patchy_product_series)
    >>> user_browser.open('https://launchpad.dev/patchy-product-1/trunk/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance     Status      Patch Age
    Bug #18: bug_c title       Wishlist  Fix Committed   ... seconds
    From: Patchy Person
    Link: patch_f.diff
    description of patch f
    Bug #16: bug_a title       Undecided      New        ... seconds
    From: Patchy Person
    Link: patch_a.diff
    description of patch a

Patches View by Distro
----------------------

The patches view also works for distributions, and it shows the target
package when viewed via a distribution.

    >>> make_thing(
    ...     make_bugtask, bug=bug_a,
    ...     target='evolution', target_is_spkg_name=True,
    ...     importance=BugTaskImportance.MEDIUM,
    ...     status=BugTaskStatus.FIXRELEASED)
    >>> make_thing(
    ...     make_bugtask, bug=bug_c,
    ...     target='a52dec', target_is_spkg_name=True,
    ...     importance=BugTaskImportance.HIGH,
    ...     status=BugTaskStatus.TRIAGED)

    >>> user_browser.open('http://bugs.launchpad.dev/ubuntu/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status    Package    Patch Age
    Bug #18: bug_c title       High       Triaged    a52dec  ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    Bug #16: bug_a title       Medium   Fix Released   evolution  ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a

Patches View by Distro Series
-----------------------------

The patches view works for distro series.

    >>> user_browser.open('https://launchpad.dev/ubuntu/hoary/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status   Package    Patch Age
    >>> user_browser.open('https://launchpad.dev/ubuntu/warty/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status   Package    Patch Age

Patches View by Source Package
------------------------------

The patches view works for source packages too.  The view doesn't show
target package column in that case, because the package is implied.

    >>> user_browser.open('http://bugs.launchpad.dev/ubuntu/+source/a52dec/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status     Patch Age
    Bug #18: bug_c title       High       Triaged     ...second...
    From: Patchy Person
    Link: patch_f.diff description of patch f
    >>> user_browser.open('http://bugs.launchpad.dev/ubuntu/+source/evolution/+patches')
    >>> show_patches_view(user_browser.contents)
    Bug                       Importance   Status     Patch Age
    Bug #16: bug_a title       Medium   Fix Released  ...second...
    From: Patchy Person
    Link: patch_a.diff description of patch a
