= Launchpad Single-Signon Workflow: Switching Users =

If a user is making use of a public or shared computer, and wants to
log into a Launchpad-SSO website, they may find that someone else has
logged into Launchpad.  In this case, the user can log out and then
back in as part of the authentication process.

First we will set up the helper view that lets us test the final
portion of the authentication process:

    >>> from canonical.launchpad.ftests.openid import (
    ...     install_consumer, uninstall_consumer)
    >>> install_consumer()

We will first authenticate as Mark Shuttleworth:

    >>> from urllib import urlencode
    >>> args = urlencode({
    ...     'openid.mode': 'checkid_setup',
    ...     'openid.identity':
    ...         'http://specs.openid.net/auth/2.0/identifier_select',
    ...     'openid.return_to': 'http://launchpad.dev/+openid-consumer',
    ...     'openid.trust_root': 'http://launchpad.dev/+openid-consumer',
    ...     })
    >>> setup_url = 'http://openid.launchpad.dev/+openid?%s' % args
    >>> browser.open(setup_url)
    >>> print browser.title
    Launchpad Login Service
    >>> browser.getControl('email address?').value = 'mark@hbd.com'
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl('Continue').click()
    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...

Now lets imagine that test@canonical.com starts using the computer and
wishes to log into a Launchpad-SSO web site.  They will be asked if
they want to authenticate as Mark Shuttleworth:

    >>> browser.open(setup_url)
    >>> print browser.title
    Authenticate to http://launchpad.dev/+openid-consumer
    >>> print extract_text(find_main_content(browser.contents).find('h3'))
    Sign in as Mark Shuttleworth

At this point, the user says that they are not Mark Shuttleworth,
which presents them with a login page:

    >>> browser.getControl("No, I'm not this person").click()
    >>> print browser.title
    Launchpad Login Service

They can now log in as test@canonical.com, and the appropriate
identity URL will be sent to the relying party:

    >>> browser.getControl('email address?').value = 'test@canonical.com'
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl('Continue').click()
    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...
    >>> print browser.contents
    Consumer received GET
    ...
    openid.identity:http://openid.launchpad.dev/+id/name12_oid
    openid.mode:id_res
    openid.return_to:http://launchpad.dev/+openid-consumer
    ...


== Cleanup ==

    >>> uninstall_consumer()

