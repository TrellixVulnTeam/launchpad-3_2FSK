= Launchpad Single-Signon Workflow: Password Reset =

If a user wants to use a Launchpad-SSO web site, but has forgotten
their password, they can ask for it to be emailed to them from the
login page.

First we will set up the helper view that lets us test the final
portion of the authentication process:

    >>> from openid.consumer.consumer import Consumer
    >>> from openid.consumer.discover import OPENID_1_1_TYPE
    >>> from openid.fetchers import setDefaultFetcher
    >>> from openid.sreg import SRegRequest, SRegResponse
    >>> from openid.store.memstore import MemoryStore
    >>> from canonical.launchpad.ftests.openidhelpers import (
    ...     complete_from_browser, install_consumer,
    ...     make_identifier_select_endpoint, uninstall_consumer,
    ...     PublisherFetcher)
    >>> install_consumer()
    >>> setDefaultFetcher(PublisherFetcher())

The authentication process is started by the relying party issuing a
checkid_setup request, sending the user to Launchpad:

    >>> openid_store = MemoryStore()
    >>> consumer = Consumer(session={}, store=openid_store)

    >>> request = consumer.beginWithoutDiscovery(
    ...     make_identifier_select_endpoint(OPENID_1_1_TYPE))
    >>> browser.open(request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer'))

At this point, we are at the login page.  Lets try to recover a
password for an unregistered email.  This will result in an error:

    >>> print browser.title
    Launchpad Login Service
    >>> browser.getControl(name='field.email').value = 'no-account@example.com'
    >>> browser.getControl("I've forgotten my password").click()
    >>> browser.getControl('Continue').click()

    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    Your account details have not been found. Please check your
    subscription email address and try again.

If the user tries to recover a password registered to a team, that
will fail too:

    >>> browser.getControl(name='field.email').value = 'support@ubuntu.com'
    >>> browser.getControl('Continue').click()
    >>> print browser.title
    Launchpad Login Service
    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print extract_text(tag)
    The email address support@ubuntu.com can not be used to log in as
    it belongs to a team.

Finally, lets try and recover the password for a test@canonical.com:

    >>> browser.getControl(name='field.email').value = 'test@canonical.com'
    >>> browser.getControl('Continue').click()
    >>> soup = find_main_content(browser.contents)
    >>> print soup.find('h1').renderContents()
    Forgotten your password?

The user would then check their email, and find a message:

    >>> import email, re
    >>> from canonical.launchpad.mail import stub
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> len(stub.test_emails)
    0
    >>> msg = email.message_from_string(raw_msg)
    >>> print from_addr
    bounces@canonical.com
    >>> print to_addrs
    ['test@canonical.com']
    >>> print msg.get_payload(decode=True) #doctest: -NORMALIZE_WHITESPACE
    Hello
    <BLANKLINE>
    You have requested a new password for your Launchpad Login Service account.
    <BLANKLINE>
    To change your password:
    <BLANKLINE>
        http://openid.launchpad.dev/token/...
    <BLANKLINE>
    If you don't know what this is about, then someone else has entered
    your e-mail address at the Launchpad Login Service. Sorry about
    that. You don't need to do anything further, just delete this message.
    <BLANKLINE>
    Regards,
    The Launchpad Login Service team
    <BLANKLINE>

Let's extract the URL from the email and follow the link:

    >>> link = re.findall(r'http.*/token/.*', msg.get_payload())[0]
    >>> browser.open(link)
    >>> print browser.url
    http://openid.launchpad.dev/token/.../+resetpassword

The user can now enter a new password:

    >>> browser.getControl('Email').value = 'test@canonical.com'
    >>> browser.getControl('Password').value = 'new password'
    >>> browser.getControl(name='field.password_dupe').value = 'new password'
    >>> browser.getControl('Continue').click()

Now the user is logged in, and has been directed back to the original
site:

    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...
    >>> print browser.contents
    Consumer received GET
    ...
    >>> info = complete_from_browser(
    ...     consumer, browser, 'http://openid.launchpad.dev/+id/name12_oid')
    >>> print info.status
    success
    >>> print info.identity_url
    http://openid.launchpad.dev/+id/name12_oid

== Cleanup ==

    >>> setDefaultFetcher(None)
    >>> uninstall_consumer()

