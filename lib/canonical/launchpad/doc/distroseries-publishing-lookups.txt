= DistroSeries source publishing lookups =

IDistroSeries allows source publishing lookup via
getReleasedPackages method which returns a shortlist of
ISourcePackagePublishingHistory ordered by descending ID.

In order to test its behavior we will create a bunch of sample
publishing records with different (status, pocket, archive) in
ubuntu/breezy-autotest, which is empty:

    >>> from canonical.launchpad.interfaces import (
    ...    IDistributionSet, IPersonSet, PackagePublishingPocket,
    ...    PackagePublishingStatus)

    >>> ubuntu = getUtility(IDistributionSet)['ubuntu']
    >>> breezy_autotest = ubuntu['breezy-autotest']
    >>> cprov_archive = getUtility(IPersonSet).getByName('cprov').archive

We will use a 'cnews' sourcepackage because it's not published yet in
the distroseries we want to test, this will help to make the tests as clear
as possible.

    >>> hoary = ubuntu['hoary']
    >>> cnews_hoary = hoary.getSourcePackage('cnews')
    >>> sample_spr = cnews_hoary.currentrelease.sourcepackagerelease

    >>> from canonical.launchpad.database.publishing import (
    ...    SecureSourcePackagePublishingHistory)

    >>> SecureSourcePackagePublishingHistory.selectBy(
    ...     distroseries=breezy_autotest,
    ...     sourcepackagerelease=sample_spr).count()
    0

Create and collect several binary publishing records in a variety of
states, pockets and archives:

    >>> from canonical.launchpad.ftests.soyuz import SoyuzTestHelper

    >>> soyuz_helper = SoyuzTestHelper()
    >>> sample_pub = soyuz_helper.createPublishingForDistroSeries(
    ...      sample_spr, breezy_autotest)

    >>> [pub_main_release_pending, pub_main_release_published,
    ...  pub_main_updates_pending, pub_main_proposed_published,
    ...  pub_ppa_release_pending, pub_ppa_release_published,
    ...  pub_ppa_updates_pending, pub_ppa_proposed_published] = sample_pub


Looking for all PUBLISHED publications in main_archive and all
pockets:

    >>> all_published_main_pubs = [
    ...     pub_main_proposed_published,
    ...     pub_main_release_published,
    ...     ]
    >>> result = breezy_autotest.getPublishedReleases('cnews')
    >>> soyuz_helper.checkPubList(all_published_main_pubs, result)
    True

Looking for all PUBLISHED or PENDING publications in main_archive and all
pockets.

    >>> all_main_pubs = [
    ...     pub_main_proposed_published,
    ...     pub_main_updates_pending,
    ...     pub_main_release_published,
    ...     pub_main_release_pending,
    ...     ]
    >>> result = breezy_autotest.getPublishedReleases(
    ...     'cnews', include_pending=True)
    >>> soyuz_helper.checkPubList(all_main_pubs, result)
    True

Using 'pocket' filter:

    >>> updates_main_pubs = [
    ...     pub_main_updates_pending,
    ...     ]

    >>> result = breezy_autotest.getPublishedReleases(
    ...     'cnews', include_pending=True,
    ...     pocket=PackagePublishingPocket.UPDATES)

    >>> soyuz_helper.checkPubList(updates_main_pubs, result)
    True

Using 'exclude_pocket' filter, to exclude publications to RELEASE pocket:

    >>> non_release_main_pubs = [
    ...     pub_main_proposed_published,
    ...     pub_main_updates_pending,
    ...     ]

    >>> result = breezy_autotest.getPublishedReleases(
    ...     'cnews', include_pending=True,
    ...     exclude_pocket=PackagePublishingPocket.RELEASE)

    >>> soyuz_helper.checkPubList(non_release_main_pubs, result)
    True

Looking for all PUBLISHED or PENDING publications in cprov PPA and all
pockets.

    >>> all_ppa_pubs = [
    ...     pub_ppa_proposed_published,
    ...     pub_ppa_updates_pending,
    ...     pub_ppa_release_published,
    ...     pub_ppa_release_pending,
    ...     ]
    >>> result = breezy_autotest.getPublishedReleases(
    ...    'cnews', include_pending=True, archive=cprov_archive)
    >>> soyuz_helper.checkPubList(all_ppa_pubs, result)
    True

