= Closing bugs from changelogs =

When a package is uploaded to a distribution, a bug number can be
specified in the Launchpad-bugs-fixed header of the changes file.

    >>> changes_template = """
    ... Format: 1.7
    ... Launchpad-bugs-fixed: %s
    ... """

The package uploads are associated with specific releases of the
package, but the bugs they reference may be filed on the generic
distribution package.

    >>> from canonical.launchpad.interfaces import (
    ...     CreateBugParams, IDistributionSet)
    >>> login('no-priv@canonical.com')
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> pmount_ubuntu = ubuntu.getSourcePackage('pmount')
    >>> bug_params = CreateBugParams(
    ...     getUtility(ILaunchBag).user, "Test bug", "Test bug.")
    >>> pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'UNCONFIRMED'

The package source uploads are represented as DistroReleaseQueue items
that are associated with DistroReleaseQueueSource items and a changes
file. The only thing in the changes file that is used to close the bug
is the Launchpad-bugs-fixed header.

    >>> from StringIO import StringIO
    >>> from canonical.launchpad.database import DistroReleaseQueue
    >>> from canonical.librarian.interfaces import ILibrarianClient
    >>> from canonical.lp.dbschema import (
    ...     DistroReleaseQueueStatus, PackagePublishingPocket)

    >>> ubuntu_hoary = ubuntu.getRelease('hoary')
    >>> changes = changes_template % pmount_bug.id
    >>> changes_file = getUtility(ILibrarianClient).addFile(
    ...     'pmount.changes', len(changes), StringIO(changes), 'text/plain')
    >>> queue_item = DistroReleaseQueue(
    ...     status=DistroReleaseQueueStatus.DONE,
    ...     distrorelease=ubuntu_hoary,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)


The DistroReleaseQueueSource items are linke to SourcePackageRelease
items, but for closing bugs the only thing that mattters is who uploaded
it, what package name is it, and to what distribution release it was
uploaded to.


    >>> from canonical.launchpad.database import (
    ...     DistroReleaseQueueSource, SourcePackageRelease)
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> sabdfl = getUtility(IPersonSet).getByName('sabdfl')
    >>> pmount_release = SourcePackageRelease.get(20)
    >>> pmount_release.sourcepackagename.name
    u'pmount'
    >>> pmount_release.uploaddistrorelease.name
    u'hoary'
    >>> source_queue = DistroReleaseQueueSource(
    ...     distroreleasequeue=queue_item,
    ...     sourcepackagerelease=pmount_release)

    # Need to commit the transaction so that the changes file can be
    # downloaded from the Librarian.
    >>> import transaction
    >>> transaction.commit()

Right after the queue items have been processed by the publishing
scripts, close_bugs() is called with a list of queue item ids that have
been published. Passing a queue item with a Launchpad-bugs-fixed header
will close the specified bug.

    >>> from canonical.launchpad.scripts.processaccepted import close_bugs
    >>> close_bugs([queue_item.id])
    >>> pmount_task.status.name
    'FIXRELEASED'

The changelog associated with the SourcePackageRelease is automatically
added as a comment from the uploader.

    >>> last_comment = pmount_bug.messages[-1]
    >>> print pmount_release.creator.displayname
    Mark Shuttleworth
    >>> print last_comment.owner.displayname
    Mark Shuttleworth

    >>> print pmount_release.changelog
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

    >>> print last_comment.text_contents
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

A bug notification is sent for both the status change, and for the
comment addition.

    >>> from canonical.launchpad.database import BugNotification
    >>> notifications = BugNotification.select(orderBy='id')
    >>> for notification in notifications[-2:]:
    ...     print "From %s:\n%s\n" % (
    ...         notification.message.owner.displayname,
    ...         notification.message.text_contents)
    From Mark Shuttleworth:
    ** Changed in: pmount (Ubuntu)
           Status: Unconfirmed => Fix Released
    <BLANKLINE>
    From Mark Shuttleworth:
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

It's possible to specify more than one bug in the Launchpad-bugs-fixed
header, each will be marked as Fix Released. If a nonexistent bug is
specified, it's ignored.

    >>> pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'UNCONFIRMED'
    >>> another_pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> [another_pmount_task] = another_pmount_bug.bugtasks
    >>> another_pmount_task.status.name
    'UNCONFIRMED'

    >>> changes = changes_template % "%d nonexistent %d" % (
    ...     pmount_bug.id, another_pmount_bug.id)
    >>> changes_file = getUtility(ILibrarianClient).addFile(
    ...     'pmount.changes', len(changes), StringIO(changes), 'text/plain')
    >>> queue_item = DistroReleaseQueue(
    ...     status=DistroReleaseQueueStatus.DONE,
    ...     distrorelease=ubuntu_hoary,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)
    >>> source_queue = DistroReleaseQueueSource(
    ...     distroreleasequeue=queue_item,
    ...     sourcepackagerelease=pmount_release)

    # Need to commit the transaction so that the changes file can be
    # downloaded from the Librarian.
    >>> import transaction
    >>> transaction.commit()

    >>> close_bugs([queue_item.id])
    >>> pmount_task.status.name
    'FIXRELEASED'
    >>> another_pmount_task.status.name
    'FIXRELEASED'
