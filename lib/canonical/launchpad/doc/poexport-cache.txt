
Caching of Exported PO Files
============================

This test demonstrates how the PO file export caching mechanism works.

All the setup stuff:

    >>> from canonical.launchpad.ftests.harness import LaunchpadFunctionalTestSetup
    >>> from canonical.librarian.ftests.harness import LibrarianTestSetup
    >>> LaunchpadFunctionalTestSetup().setUp()
    >>> LibrarianTestSetup().setUp()

Get hold of a PO file which has never been exported.

    >>> from canonical.launchpad.database import POFile
    >>> pofile = POFile.get(1)

Because it has never been exported, it doesn't have a Librarian file
containing a cached export.

    >>> pofile.exportfile is None
    True

And if we ask it, it will tell us that it doesn't have a valid cache.

    >>> pofile.validExportCache()
    False

Now ask it to export itself.

    >>> export = pofile.export()
    >>> export.split('\n')[0]
    '# traducci\xc3\xb3n de es.po al Spanish'

Now, because of a SQLObject quirk, we need to call .sync() on the PO file.
This is because calling .export() has set pofile.exporttime to the magic
constant UTC_NOW. This would normally be fine, as the attribute would not
normally be accessed again in the same SQLObject session, and it would appear
as a datetime value the next time around. However, in this case, we need to
access it immediately, so we need to write it to the database and read it back
again.

    >>> pofile.sync()

Because we exported a PO file, it will have updated the cache.

    >>> pofile.validExportCache()
    True

Now let's add a translation to the PO file.

    >>> from canonical.launchpad.database import Person
    >>> person = Person.get(1)

    >>> msgid = u"Failed to authenticate with LDAP server."
    >>> msgset = pofile.messageSet(msgid)
    >>> print msgset.active_texts
    [None]
    >>> msgset.updateTranslationSet(person, {0: 'Blah.'}, False, False, True)
    >>> print msgset.active_texts
    [u'Blah.']

We need to sync the changed objects for the same reason as before.

    >>> txt = msgset.active_texts[0]
    >>> msgset.sync()

Because we modified the PO file, the cache should now no longer be valid.

    >>> pofile.validExportCache()
    False

This is a regression test: PO files with no submissions.

This tests two specific things:

 - That a PO file with no translations can be exported.
 - The situation where there is a cached export for a file with no
   translations, and there is no submission which we can use to check the
   cache's validity.

    >>> empty_pofile = pofile.potemplate.getOrCreatePOFile('cy')
    >>> empty_pofile.latest_submission is None
    True
    >>> empty_pofile.validExportCache()
    False
    >>> len(empty_pofile.export()) > 0
    True
    >>> empty_pofile.validExportCache()
    True

    >>> LibrarianTestSetup().tearDown()
    >>> LaunchpadFunctionalTestSetup().tearDown()

