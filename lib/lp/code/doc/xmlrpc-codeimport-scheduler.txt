= The CodeImportScheduler =

The code import scheduler is an XMLRPC service that provides (ids of)
CodeImportJobs for code import slaves to run.  It is available as the
codeimportscheduler attribute of our private XMLRPC instance.

    >>> from lp.code.interfaces.codeimportscheduler import (
    ...     ICodeImportSchedulerApplication)
    >>> from canonical.launchpad.interfaces import IPrivateApplication
    >>> from canonical.launchpad.webapp.testing import verifyObject

    >>> private_root = getUtility(IPrivateApplication)
    >>> verifyObject(
    ...     ICodeImportSchedulerApplication, private_root.codeimportscheduler)
    True

The CodeImportSchedulerAPI view provides the ICodeImportScheduler
XML-RPC API:

    >>> from zope.publisher.xmlrpc import TestRequest
    >>> from lp.code.interfaces.codeimportscheduler import (
    ...     ICodeImportScheduler)
    >>> from lp.code.xmlrpc.codeimportscheduler import (
    ...     CodeImportSchedulerAPI)

    >>> codeimportscheduler_api = CodeImportSchedulerAPI(
    ...     private_root.codeimportscheduler, TestRequest())
    >>> verifyObject(ICodeImportScheduler, codeimportscheduler_api)
    True

The ICodeImportScheduler interface defines a single method,
getJobForMachine(), that returns the id of the job that the code
import slave should next run.

    >>> codeimportscheduler_api.getJobForMachine('bazaar-importer')
    1

    >>> from canonical.database.sqlbase import flush_database_updates
    >>> flush_database_updates()

The method just calls the 'getJobForMachine' method from the
ICodeImportJobSet interface, and tests all the details of what it does
can be found in the tests for ICodeImportJobSet.

The point of all this is for it to be accessed over XMLRPC.

    >>> import xmlrpclib
    >>> from canonical.functional import XMLRPCTestTransport
    >>> codeimportscheduler = xmlrpclib.ServerProxy(
    ...     'http://xmlrpc-private.launchpad.dev:8087/codeimportscheduler',
    ...     transport=XMLRPCTestTransport())
    >>> codeimportscheduler.getJobForMachine('bazaar-importer')
    0

This includes the behaviour of auto-creating machine rows for
previously unseen hostnames.

    >>> from lp.code.interfaces.codeimportmachine import (
    ...     ICodeImportMachineSet)
    >>> print getUtility(ICodeImportMachineSet).getByHostname(
    ...     'doesnt-exist-yet')
    None
    >>> codeimportscheduler.getJobForMachine('doesnt-exist-yet')
    0
    >>> new_machine = getUtility(ICodeImportMachineSet).getByHostname(
    ...     'doesnt-exist-yet')
    >>> new_machine.hostname
    u'doesnt-exist-yet'
    >>> new_machine.state.name
    'ONLINE'
