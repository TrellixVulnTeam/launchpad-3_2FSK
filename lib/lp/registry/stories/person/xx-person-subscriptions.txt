Subscriptions View
==================

XXX: bdmurray 2010-09-24 bug=628411 This story is complete until we publish
the link that leads to the +subscriptions page.

Any user can view the direct subscriptions that a person or team has to
blueprints, branches, bugs, merge proposals and questions.

    >>> anon_browser.open('http://launchpad.dev/~ubuntu-team/+subscriptions')
    >>> print anon_browser.title
    Subscriptions : “Ubuntu Team” team

The user can see that the Ubuntu Team does not have any direct bug
subscriptions.

    >>> page_text = extract_text(find_main_content(anon_browser.contents))
    >>> "does not have any direct bug subscriptions" in page_text
    True

To test bug subscriptions we are going to create two products, Affluenza and
Scofflaw, and a user Webster who will be subscribed to bugs about both of
those.

    >>> login('foo.bar@canonical.com')
    >>> scofflaw = factory.makeProduct(name='scofflaw')
    >>> bugA = factory.makeBug(product=scofflaw,
    ...     title='Word needs more popularity')
    >>> affluenza = factory.makeProduct(name='affluenza')
    >>> bugB = factory.makeBug(product=affluenza,
    ...     title='A terrible affliction')
    >>> subscriber = factory.makePerson(name='webster',
    ...     password='g00dpassword')
    >>> subscriptionA = bugA.subscribe(subscriber, subscriber)
    >>> subscriptionB = bugB.subscribe(subscriber, subscriber)
    >>> logout()

Any user can see Webster's bug subscriptions.  The bug subscriptions table
includes the bug number, title and location.

    >>> anon_browser.open('http://launchpad.dev/~webster/+subscriptions')
    >>> print extract_text(find_tag_by_id(
    ...     anon_browser.contents, 'bug_subscriptions'))
    Summary
    In
    ...
    Word needs more popularity
    Scofflaw
    ...
    A terrible affliction
    Affluenza

The bug subscriptions table also includes an unsubscribe link, if the user has
permission to remove the subscription, for bugs to which the person or team is
subscribed.

Webster can see and manage his direct bug subscriptions using the page too.
He chooses to view the bug about Scofflaw.

    >>> login('foo.bar@canonical.com')
    >>> subscriber_browser = setupBrowser(
    ...     auth='Basic %s:g00dpassword' %
    ...         subscriber.preferredemail.email)
    >>> logout()
    >>> subscriber_browser.open('http://bugs.launchpad.dev/~webster/+subscriptions')
    >>> unsub_link = subscriber_browser.getLink(
    ...     id='unsubscribe-subscriber-%s' % subscriber.id)
    >>> unsub_link.click()
    >>> page_text = extract_text(find_tag_by_id(
    ...     subscriber_browser.contents, 'nonportlets'))
    >>> "Unsubscribe me from this bug" in page_text
    True

After viewing the +subscribe page Webster decides that he still wants to be
subscribed to the bug.  He clicks cancel which takes him back to his
+subscription page.

    >>> cancel_link = subscriber_browser.getLink('Cancel')
    >>> cancel_link.click()
    >>> print subscriber_browser.title
    Subscriptions : Webster

He chooses to unsubscribe from the bug about Affluenza.

    >>> subscriber_browser.getLink(url='/affluenza/+bug/%s/+subscribe'
    ...     % bugB.id).click()
    >>> subscriber_browser.getControl("Unsubscribe me from this bug").selected = True
    >>> subscriber_browser.getControl("Continue").click()
    >>> print subscriber_browser.title
    Subscriptions : Webster

Webster can see that the bug about Affluenza is no longer listed in his direct
bug subscriptions.

    >>> subscriber_browser.open('http://bugs.launchpad.dev/~webster/+subscriptions')
    >>> print extract_text(find_tag_by_id(
    ...     subscriber_browser.contents, 'bug_subscriptions'))
    Summary
    In
    ...
    Word needs more popularity
    Scofflaw

Webster adds a bug subscription for a team, team America, of which he is a
member.

    >>> login('foo.bar@canonical.com')
    >>> team = factory.makeTeam(name='america')
    >>> bugC = factory.makeBug(product=scofflaw,
    ...     title="Word came from a contest")
    >>> membership = team.addMember(subscriber, subscriber)
    >>> subscriptionC = bugC.subscribe(team, subscriber)
    >>> logout()

Webster chooses to review the subscriptions for his team America.

    >>> subscriber_browser.open('https://bugs.launchpad.dev/~america/+subscriptions')
    >>> print subscriber_browser.title
    Subscriptions : “America” team

    >>> print extract_text(find_tag_by_id(
    ...     subscriber_browser.contents, 'bug_subscriptions'))
    Summary
    In
    ...
    Word came from a contest
    Scofflaw

Webster now chooses to unsubscribe team America from the bug about Scofflaw.

    >>> subscriber_browser.getLink(id='unsubscribe-subscriber-%s' %
    ...     team.id).click()
    >>> print extract_text(find_tags_by_class(
    ...     subscriber_browser.contents, 'value')[0])
    Subscribe me to this bug
    Unsubscribe America from this bug

    >>> subscriber_browser.getControl(
    ...     'Unsubscribe America from this bug').selected = True
    >>> subscriber_browser.getControl('Continue').click()

    >>> subscriber_browser.open('https://launchpad.dev/~america/+subscriptions')
    >>> page_text = extract_text(
    ...     find_main_content(subscriber_browser.contents))
    >>> "does not have any direct bug subscriptions" in page_text
    True
