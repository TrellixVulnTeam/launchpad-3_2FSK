= IStructuralSubscriptionTarget =

Structural subscriptions allow users to subscribe to notifications about
new items and changes to existing items for a Launchpad structure such as
Product, ProjectGroup, Distribution, Milestone and series.

    >>> from canonical.launchpad.interfaces import (
    ...     IStructuralSubscriptionTarget)
    >>> from canonical.launchpad.webapp.testing import verifyObject
    >>> verifyObject(IStructuralSubscriptionTarget, target)
    True

== Bug Subscriptions ==

Bug subscriptions are structural subscriptions to notifications about
bug activity.

    >>> target.bug_subscriptions
    []

First, we try to create a new subscription.

    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> personset = getUtility(IPersonSet)
    >>> no_priv = personset.getByName("no-priv")

Only authenticated users can create subscriptions.

    >>> target.addBugSubscription(no_priv, no_priv)
    Traceback (most recent call last):
      ...
    Unauthorized: ...

Let's login then to add a subscription:

    >>> from canonical.launchpad.ftests import login
    >>> login("foo.bar@canonical.com")

    >>> target.addBugSubscription(no_priv, no_priv)
    <StructuralSubscription ...>
    >>> [sub.subscriber.name for sub in target.bug_subscriptions]
    [u'no-priv']

Trying to add a subscription to a target when that person
or team is already subscribed to that target will return
the existing subscription.

    >>> target.addBugSubscription(no_priv, no_priv)
    <StructuralSubscription ...>

People can only be subscribed by themselves, and only the team admins may
subscribe a team.

no-priv, who has no relationship to ubuntu-team, cannot subscribe it.

    >>> ubuntu_team = personset.getByName("ubuntu-team")
    >>> target.addBugSubscription(ubuntu_team, no_priv)
    Traceback (most recent call last):
      ...
    UserCannotSubscribePerson: no-priv does not have permission to subscribe ubuntu-team.

But kamion, an admin of the team, can.

    >>> kamion = personset.getByName("kamion")
    >>> target.addBugSubscription(ubuntu_team, kamion)
    <StructuralSubscription ...>

    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'no-priv', u'ubuntu-team']

foobar, a Launchpad administrator, can as well.

    >>> foobar = personset.getByName("name16")
    >>> target.addBugSubscription(ubuntu_team, foobar)
    <StructuralSubscription ...>

A non-admin cannot subscribe a person other than themselves.

    >>> target.addBugSubscription(kamion, no_priv)
    Traceback (most recent call last):
      ...
    UserCannotSubscribePerson: no-priv does not have permission to subscribe kamion.
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'no-priv', u'ubuntu-team']

But again, an admin can.

    >>> target.addBugSubscription(kamion, foobar)
    <StructuralSubscription ...>
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'kamion', u'no-priv', u'ubuntu-team']

To remove a bug subscription, use
IStructuralSubscriptionTarget.removeBugSubscription:

    >>> target.removeBugSubscription(no_priv, no_priv)
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'kamion', u'ubuntu-team']

The subscription rules apply to unsubscription as well.

An unprivileged user cannot unsubscribe a team.

    >>> target.removeBugSubscription(ubuntu_team, no_priv)
    Traceback (most recent call last):
      ...
    UserCannotSubscribePerson: no-priv does not have permission to unsubscribe ubuntu-team.
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'kamion', u'ubuntu-team']

But a team admin can.

    >>> target.removeBugSubscription(ubuntu_team, kamion)
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'kamion']

An unprivileged user also cannot unsubscribe another user.

    >>> target.removeBugSubscription(kamion, no_priv)
    Traceback (most recent call last):
      ...
    UserCannotSubscribePerson: no-priv does not have permission to unsubscribe kamion.
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    [u'kamion']

But the user themselves can.

    >>> target.removeBugSubscription(kamion, kamion)
    >>> sorted([sub.subscriber.name for sub in target.bug_subscriptions])
    []

Trying to remove a subscription that doesn't exist on a target raises a
DeleteSubscriptionError.

    >>> target.removeBugSubscription(foobar, foobar)
    Traceback (most recent call last):
      ...
    DeleteSubscriptionError: ...

Let's subscribe ubuntu-team again.

    >>> target.addBugSubscription(ubuntu_team, foobar)
    <StructuralSubscription ...>

Trying to remove a bug subscription when notification levels for other
applications are set, doesn't remove the subscription. Instead the
notification level for bugs is set to NOTHING.

    >>> def print_subscriptions_list(subscriptions):
    ...     for subscription in subscriptions:
    ...         print '%s %s %s' % (
    ...               subscription.subscriber.name,
    ...               subscription.bug_notification_level.name,
    ...               subscription.blueprint_notification_level.name)

    >>> from canonical.launchpad.interfaces import (
    ...     BlueprintNotificationLevel)

    >>> subscription = target.addBugSubscription(foobar, foobar)
    >>> subscription.blueprint_notification_level = (
    ...     BlueprintNotificationLevel.LIFECYCLE)
    >>> print_subscriptions_list(target.getSubscriptions())
    name16 COMMENTS LIFECYCLE
    ubuntu-team COMMENTS NOTHING
    >>> target.removeBugSubscription(foobar, foobar)
    >>> print_subscriptions_list(target.getSubscriptions())
    name16 NOTHING LIFECYCLE
    ubuntu-team COMMENTS NOTHING

To get a user's subscription to the target, use
IStructuralSubscriptionTarget.getSubscription.

    >>> target.getSubscription(ubuntu_team)
    <StructuralSubscription ...>
    >>> print target.getSubscription(no_priv)
    None

To search for subscriptions with certain level settings on a structure
we use getSubscriptions.

    >>> from canonical.launchpad.interfaces import SubscriptionNotificationLevel
    >>> subscription = target.addSubscription(no_priv, no_priv)
    >>> subscription.bug_notification_level = SubscriptionNotificationLevel.METADATA
    >>> print_subscriptions_list(target.bug_subscriptions)
    no-priv METADATA NOTHING
    ubuntu-team COMMENTS NOTHING
    >>> subscriptions = target.getSubscriptions(min_bug_notification_level=
    ...                         SubscriptionNotificationLevel.COMMENTS)
    >>> print_subscriptions_list(subscriptions)
    ubuntu-team COMMENTS NOTHING


=== Structural subscriptions and indirect bug subscriptions ===
 
    >>> bug = filebug(target, 'test bug one')
    >>> indirect_subscribers = set(
    ...     subscriber.name for subscriber in bug.getIndirectSubscribers())
    >>> structural_subscribers = set(
    ...     sub.subscriber.name for sub in target.bug_subscriptions)
    >>> structural_subscribers.difference(indirect_subscribers)
    set([])
