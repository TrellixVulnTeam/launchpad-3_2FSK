= Bug branch links =

It is possible to link bugs and branches from both the bug page and the branch
page.


== From the branch page ==

There is a "Link to a bug report" item in the actions menu that is visible
to everybody but which links to a page restricted with the
launchpad.AnyPerson permission.

There is an action link to "Link to bug report" that is visible to all bug
if the user is not logged in, they will be asked to log in.

    >>> anon_browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> anon_browser.getLink('Link to a bug report').click()
    Traceback (most recent call last):
    ...
    Unauthorized: (...launchpad.AnyPerson')

    >>> def printBugBranchLinks(browser):
    ...     tags = find_tags_by_class(browser.contents, 'bug-branch-summary')
    ...     if len(tags) == 0:
    ...         print 'No bug branch links'
    ...     else:
    ...         for tag in tags:
    ...             print extract_text(tag)

    >>> def print_notifications(browser):
    ...     tags = find_tags_by_class(
    ...         browser.contents, 'informational message')
    ...     if len(tags) == 0:
    ...         print 'No messages.'
    ...     else:
    ...         for tag in tags:
    ...             print extract_text(tag)

    >>> browser = setupBrowser(auth="Basic test@canonical.com:test")
    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> printBugBranchLinks(browser)
    No bug branch links

    >>> browser.getLink('Link to a bug report').click()
    >>> browser.title
    'Link branch \xe2\x80\x9c~name12/gnome-terminal/klingon\xe2\x80\x9d to a bug report'

When linking from a branch to a bug, the bug widget is used.  This
requires the user to enter a bug number.

    >>> browser.getControl('The bug that is linked to.').value = "9"
    >>> browser.getControl('Continue').click()
    >>> printBugBranchLinks(browser)
    Bug #9: Thunderbird crashes (Unknown &ndash; Unknown)

Attempting to link to the same bug again gives an error.

    >>> browser.getLink('Link to another bug report').click()
    >>> browser.getControl('The bug that is linked to.').value = "9"
    >>> browser.getControl('Continue').click()
    >>> for message in get_feedback_messages(browser.contents):
    ...     print message
    There is 1 error.
    Bug #9 is already linked to this branch

The bug-branch link is also shown on the bug page.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> browser.getLink('Thunderbird crashes').click()

    >>> printBugBranchLinks(browser)
    ~name12/gnome-terminal/klingon (Experimental)

If the bug is private, then the bug branch link isn't shows on the
branch page for people that are not able to see it.  Get an admin
to mark the bug private.

    >>> admin_browser.open('http://launchpad.dev/bugs/9')
    >>> admin_browser.getLink('This report is public').click()
    >>> admin_browser.getControl('This bug report should be private').click()
    >>> admin_browser.getControl('Change').click()
    >>> print extract_text(find_tag_by_id(admin_browser.contents, 'privacy'))
    This report is private

Sample person can see it...

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> printBugBranchLinks(browser)
    Bug #9: Thunderbird crashes (Unknown &ndash; Unknown)

... but an anonymous user cannot.

    >>> anon_browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> printBugBranchLinks(anon_browser)
    No bug branch links


== From the bug page ==

The action link on the bug page is "Link a related branch".  Again this
links to a page restricted with the launchpad.AnyPerson permission.

    >>> anon_browser.open(
    ...     'http://launchpad.dev/bugs/11')
    >>> anon_browser.getLink('Link a related branch').click()
    Traceback (most recent call last):
    ...
    Unauthorized: (...launchpad.AnyPerson')

    >>> browser.open(
    ...     'http://launchpad.dev/bugs/11')
    >>> printBugBranchLinks(browser)
    No bug branch links

    >>> browser.getLink('Link a related branch').click()

    >>> browser.getControl('Branch').value = (
    ...     "~name12/gnome-terminal/scanned")
    >>> browser.getControl('Continue').click()

    >>> printBugBranchLinks(browser)
    ~name12/gnome-terminal/scanned (Development)

    >>> browser.getLink('~name12/gnome-terminal/scanned').click()
    >>> printBugBranchLinks(browser)
    Bug #11: Make Jokosher use autoaudiosink (Undecided &ndash; New)


=== Quick branch registration ===

You can also register a branch at the same time as registering a bug-branch
link. Instead of entering the unique name of a branch, you can enter a URL:

    >>> browser.open('http://bugs.launchpad.dev/thunderbird/+bug/15')
    >>> printBugBranchLinks(browser)
    No bug branch links

If we go to register a branch and change our mind, there is a cancel
link that points back to the bug page:

    >>> browser.getLink('Link a related branch').click()
    >>> cancel_link = browser.getLink('Cancel')
    >>> cancel_link.url
    'http://bugs.launchpad.dev/thunderbird/+bug/15'

But we're here to register a branch:

    >>> browser.getControl('Branch').value = (
    ...     "http://example.org/branch")
    >>> browser.getControl('Continue').click()

This registers a branch and links it to the bug:

    >>> print_notifications(browser)
    Registered ~name12/thunderbird/branch
    ...
    >>> printBugBranchLinks(browser)
    ~name12/thunderbird/branch (Development)

However, if the bug isn't on a project, we don't (can't!) register a branch.

    >>> browser.open('http://launchpad.dev/bugs/10')
    >>> printBugBranchLinks(browser)
    No bug branch links

Here we use 'http://example.org/branch2' as the URL. We have to use a
different URL, since using an already-registered URL will just find that
branch.

    >>> browser.getLink('Link a related branch').click()
    >>> browser.getControl('Branch').value = (
    ...     "http://example.org/branch2")
    >>> browser.getControl('Continue').click()

No bug-branch link is registered:

    >>> browser.open('http://launchpad.dev/bugs/10')
    >>> printBugBranchLinks(browser)
    No bug branch links


== Deleting bug branch links ==

The edit view for the bug branch also now has a delete button to unlink
the bug from the branch.

    >>> browser.open('http://bugs.launchpad.dev/thunderbird/+bug/15')

    >>> browser.getControl('Delete').click()
    >>> printBugBranchLinks(browser)
    No bug branch links
