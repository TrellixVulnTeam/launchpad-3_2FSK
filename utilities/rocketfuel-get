#! /bin/bash

LP_PROJECT_ROOT=${LP_PROJECT_ROOT:=~/canonical}
LP_BRANCHES_DIR=${LP_BRANCHES_DIR:=lp-branches}
LP_PROJECT_PATH=$LP_PROJECT_ROOT/$LP_BRANCHES_DIR
LP_TRUNK_NAME=trunk
LP_TRUNK_PATH=$LP_PROJECT_PATH/$LP_TRUNK_NAME

LP_SOURCEDEPS_DIR=lp-sourcedeps
LP_SOURCEDEPS_PATH=$LP_PROJECT_ROOT/$LP_SOURCEDEPS_DIR/sourcecode

# Force tilde expansion
LP_SOURCEDEPS_PATH=$(eval echo ${LP_SOURCEDEPS_PATH})

DEVPAD="devpad.canonical.com"
ROCKETFUELDEPS="/code/rocketfuel-built/launchpad/sourcecode/*"
RSYNCOPTIONS="-avp --partial --progress --delete"

# Make sure we have an ssh key primed
ssh-add -l
if [ $? -gt 0 ]; then ssh-add; fi

# Pull from devpad trunk
cd $LP_TRUNK_PATH
INITIAL_REV=$(bzr revno)
bzr pull
FINAL_REV=$(bzr revno)

# Exit if there are no new revisions
if [ $FINAL_REV = $INITIAL_REV ]; then exit 0; fi


# Update the source dependencies
if [ ! -d $LP_SOURCEDEPS_PATH ]; then mkdir -p $LP_SOURCEDEPS_PATH; fi

rsync $RSYNCOPTIONS $DEVPAD:$ROCKETFUELDEPS $LP_SOURCEDEPS_PATH/

cd $LP_PROJECT_PATH
for branch in *; do
  if [ -d $branch/sourcecode ]
  then
    echo "Updating sourcecode dependencies for ${branch}"
    $LP_TRUNK_NAME/utilities/link-external-sourcecode --target=$branch --parent=../$LP_SOURCEDEPS_DIR
  fi
done

cd $LP_TRUNK_NAME
make
