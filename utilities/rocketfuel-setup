#! /bin/bash

#
# This script will setup a brand new Ubuntu machine as a LP developer
# workstation, from scratch. The script lives in the LP codebase itself,
# as utilities/rocketfuel-setup
#

LP_PROJECT_ROOT=${LP_PROJECT_ROOT:=~/canonical}
LP_BRANCHES_DIR=${LP_BRANCHES_DIR:=lp-branches}
LP_PROJECT_PATH=$LP_PROJECT_ROOT/$LP_BRANCHES_DIR
LP_TRUNK_NAME=trunk
LP_TRUNK_PATH=$LP_PROJECT_PATH/$LP_TRUNK_NAME

# load up Ubuntu release details so we know which repos to enable
source /etc/lsb-release

# Establish Canonical username
whoami=`whoami`
printf "What is your username on Canonical servers? [$whoami] "
read canusrname
if [ ! -z ${canusrname} ]; then
  whoami=${canusrname};
fi

# Test that we can access Canonical servers
ssh ${whoami}@chinstrap.canonical.com pwd > /dev/null
if [ $? -ne 0 ]; then
  echo "
ERROR: Unable to login to chinstrap, please check your Canonical account
details.
"
  exit 1
fi

# Make sure you have all the needed virtual hosts

dev_host() {
  grep -q "^127.0.0.88.*${hostname}" /etc/hosts
  if [ $? -ne 0 ]; then
    sudo sed -i "s/^127.0.0.88.*$/&\ ${hostname}/" /etc/hosts
    echo "${hostname} added to /etc/hosts"
  fi
  }

grep -q "^127.0.0.88" /etc/hosts
if [ $? -ne 0 ]; then
  echo "Adding development hosts on local machine"
  echo "
# Launchpad virtual domains. This should be on one line.
127.0.0.88      launchpad.dev
" | sudo tee -a /etc/hosts > /dev/null
  echo "launchpad.dev added to /etc/hosts"
fi

for hostname in code.launchpad.dev answers.launchpad.dev blueprints.launchpad.dev bugs.launchpad.dev translations.launchpad.dev xmlrpc.launchpad.dev bazaar.launchpad.dev shipit.ubuntu.dev shipit.kubuntu.dev shipit.edubuntu.dev feeds.launchpad.dev openid.launchpad.dev; do
  dev_host;
done

# Enable relevant Ubuntu package repositories
grep -q "^deb http:.* ${DISTRIB_CODENAME} .*universe" /etc/apt/sources.list
if [ $? -ne 0 ]; then
    echo "Please enable the 'universe' component in /etc/apt/source.list'"
    exit 1
fi
grep -q "^deb http:.* ${DISTRIB_CODENAME} .*multiverse" /etc/apt/sources.list
if [ $? -ne 0 ]; then
    echo "Please enable the 'multiverse' component in /etc/apt/source.list'"
    exit 1
fi

if [ ! -e ~/.ssh/config ]; then
    touch ~/.ssh/config
fi

grep -q "^GSSAPIAuthentication" ~/.ssh/config
if [ $? -ne 0 ]; then
  echo "Please add the following directive to your ~/.ssh/config:
------------------------------------------------------------
GSSAPIAuthentication no
------------------------------------------------------------
"
  read
fi

grep -q "^Host .*chinstrap" ~/.ssh/config
if [ $? -ne 0 ]; then
  echo "Please add the following directives to your ~/.ssh/config:
------------------------------------------------------------
Host chinstrap chinstrap.canonical.com chinstrap.ubuntu.com
    ForwardAgent yes
    Hostname chinstrap.canonical.com
    ProxyCommand none
    User ${whoami}
------------------------------------------------------------
"
  read
fi

grep -q "^Host.*\*\.canonical.com" ~/.ssh/config
if [ $? -ne 0 ]; then
  echo "Please add the following directives to your ~/.ssh/config:
------------------------------------------------------------
Host *.canonical.com *.ubuntu.com
    ForwardAgent yes
    ProxyCommand ssh chinstrap.canonical.com nc -q0 %h %p
    User ${whoami}
------------------------------------------------------------
"
  read
fi

grep -q "^Host .*devpad" ~/.ssh/config
if [ $? -ne 0 ]; then
  echo "Please add the following directives to your ~/.ssh/config:
------------------------------------------------------------
Host devpad devpad.canonical.com
    ForwardAgent yes
    Hostname devpad.canonical.com
    ProxyCommand ssh chinstrap.canonical.com nc -q0 %h %p
    User ${whoami}
------------------------------------------------------------
"
  read
fi

grep -q "^Host .*bazaar.launchpad.dev" ~/.ssh/config
if [ $? -ne 0 ]; then
  echo "Please add the following directives to your ~/.ssh/config:
------------------------------------------------------------
Host bazaar.launchpad.dev
    Hostname launchpad.dev
    HostKeyAlias bazaar.launchpad.dev
    User sabdfl
    Port 5022
    IdentityFile ~/.ssh/launchpad_id_dsa
------------------------------------------------------------
"
  read
fi

echo "Testing ssh to devpad..."
ssh devpad.canonical.com pwd > /dev/null
if [ $? -ne 0 ]; then
  echo "
ERROR: Unable to verify capability to ssh to devpad. Please check
~/.ssh/config and check the User configuration item.  ['${whoami}']"
  exit 1
fi

sudo apt-key list | grep -q "2048g/CA6E8A17"
if [ $? -ne 0 ]; then
  echo "Retrieving signing-key for LP package repository."
  scp devpad.canonical.com:/code/lp-maintainers.pub /tmp/
  if [ $? -ne 0 ]; then
    echo "Unable to fetch key for LP package repository"
    exit 1
  fi
  [ `sha1sum /tmp/lp-maintainers.pub | cut -d " " -f 1` = \
     f1714a57bd8c481f45b2a64e2eb9131176c8922e ] \
  && sudo apt-key add /tmp/lp-maintainers.pub
  if [ $? -ne 0 ]; then
    echo "Unable to add key for LP package repository"
    exit 1
  fi
fi


grep -q "^deb http://lpdebs.canonical.com/" /etc/apt/sources.list
if [ $? -ne 0 ]; then
  echo "Adding LP package respository to package source list."
  echo "deb http://lpdebs.canonical.com/${DISTRIB_CODENAME} ./" | sudo tee -a /etc/apt/sources.list > /dev/null
  sudo aptitude update
fi


dpkg -s launchpad-developer-dependencies | grep -q "^Status:.*installed"
if [ $? -ne 0 ]; then
  echo "Installing launchpad-developer-dependencies package..."
  sudo aptitude install launchpad-developer-dependencies
  if [ $? -ne 0 ]; then
    echo "Unable to install LP developer dependencies"
    exit 1
  fi
fi

# Create the document root to avoid Apache warnings
mkdir -p /var/tmp/bazaar.launchpad.dev/mirrors

# Create an empty rewritemap file so that Apache will start.
mkdir -p /var/tmp/bazaar.launchpad.dev/config
touch /var/tmp/bazaar.launchpad.dev/config/launchpad-lookup.txt

sudo a2enmod proxy > /dev/null
if [ $? -ne 0 ]; then
  echo "ERROR: Unable to enable proxy module in Apache2"
  exit 1
fi

sudo a2enmod proxy_http > /dev/null
if [ $? -ne 0 ]; then
  echo "ERROR: Unable to enable proxy_http module in Apache2"
  exit 1
fi

sudo a2enmod rewrite > /dev/null
if [ $? -ne 0 ]; then
  echo "ERROR: Unable to enable rewrite module in Apache2"
  exit 1
fi


echo "Setting up devpad repository..."
ssh devpad.canonical.com /code/rocketfuel-built/launchpad/utilities/devpad-setup


# Create the local branch structure we will use for managing Launchpad code
mkdir -p $LP_PROJECT_ROOT
cd $LP_PROJECT_ROOT
if [ ! -d $LP_BRANCHES_DIR ]; then
  bzr init-repo --trees $LP_BRANCHES_DIR
  if [ $? -ne 0 ]; then
    echo "ERROR: Unable to setup local LP repository"
    exit 1
  fi
fi
if [ ! -d $LP_BRANCHES_DIR/.bzr -a -d $LP_BRANCHES_DIR/.bzr/repository ]; then
  echo "ERROR: LP repository not found in $LP_PROJECT_PATH"
  exit 1
fi

cd $LP_BRANCHES_DIR
if [ ! -d trunk ]; then
  echo "Making local branch of Launchpad trunk, this will take a while..."
  # bzr up to 1.6b2 has a bug that causes this to oom.
  #bzr branch bzr+ssh://devpad.canonical.com/code/rocketfuel/launchpad/devel $LP_TRUNK_NAME
  bzr branch sftp://devpad.canonical.com/code/rocketfuel/launchpad/devel $LP_TRUNK_NAME
  if [ $? -ne 0 ]; then
    echo "ERROR: Unable to create local copy of Rocketfuel trunk"
    exit 1
  fi
fi

cd trunk
if [ ! `bzr info | grep -i "parent branch" | cut -d: -f3` = \
  "//devpad.canonical.com/code/rocketfuel/launchpad/devel/" ]; then
  echo "ERROR: Your trunk branch in $LP_TRUNK_PATH has an
       incorrect pull location, correcting now..."
  bzr pull --remember bzr+ssh://devpad.canonical.com/code/rocketfuel/launchpad/devel
  if [ $? -ne 0 ]; then
    echo "ERROR: Unable to set trunk pull location to
       bzr+ssh://devpad.canonical.com/code/rocketfuel/launchpad/devel"
    exit 1
  fi
fi

sudo make install > /dev/null
if [ $? -ne 0 ]; then
  echo "ERROR: Unable to install apache config appropriately"
  exit 1
fi



# Setup Bazaar locations configuration
if [ ! -d ~/.bazaar ]; then
  mkdir ~/.bazaar
  if [ $? -ne 0 ]; then
    echo "Unable to create ~/.bazaar/ directory"
    exit 1
  fi
fi
if [ ! -e ~/.bazaar/locations.conf ]; then
  touch ~/.bazaar/locations.conf
fi
bn=$(basename $LP_PROJECT_ROOT)
grep -q "$bn\/$LP_BRANCHES_DIR" ~/.bazaar/locations.conf
if [ $? -ne 0 ]; then
  branchloc=$(eval echo "$LP_PROJECT_PATH")
  echo "
[${branchloc}]
pqm_email = Launchpad PQM <launchpad@pqm.canonical.com>
pqm_branch = sftp://devpad.canonical.com/code/rocketfuel/launchpad/devel
public_branch = bzr+ssh://devpad.canonical.com/code/${whoami}/launchpad
public_branch:policy = appendpath
smtp_server = localhost
push_location = bzr+ssh://devpad.canonical.com/code/${whoami}/launchpad
push_location:policy = appendpath
" | tee -a ~/.bazaar/locations.conf > /dev/null
  echo "Bazaar branch configuration updated. You may need to set smtp_server
in ~/.bazaar/locations.conf to something other than localhost"
fi

# Setup access to the local supermirror
if [ ! -e ~/.ssh/launchpad_id_dsa ]; then
  cp $LP_TRUNK_PATH/lib/canonical/codehosting/tests/id_dsa ~/.ssh/launchpad_id_dsa
  chmod 600 ~/.ssh/launchpad_id_dsa
  echo "Setup ssh key for local supermirror ssh access."
fi

# Setup scripts in /usr/local/bin
cd /usr/local/bin
if [ ! -e rocketfuel-get ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-get
fi
ls -l rocketfuel-get | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-get should be deleted so I can
         recreate it."
fi
if [ ! -e rocketfuel-flakes ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-flakes
fi
ls -l rocketfuel-flakes | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-flakes should be deleted so I can
         recreate it."
fi
if [ ! -e rocketfuel-branch ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-branch
fi
ls -l rocketfuel-branch | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-branch should be deleted so I can
         recreate it."
fi
if [ ! -e rocketfuel-setup ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-setup
fi
ls -l rocketfuel-setup | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-setup should be deleted so I can
         recreate it."
fi
if [ ! -e rocketfuel-status ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-status
fi
ls -l rocketfuel-status | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-status should be deleted so I can
         recreate it."
fi
if [ ! -e rocketfuel-push ]; then
  sudo ln -s $LP_TRUNK_PATH/utilities/rocketfuel-push
fi
ls -l rocketfuel-push | cut -d">" -f2 | grep -q "$LP_TRUNK_NAME\/utilities\/rocketfuel"
if [ $? -ne 0 ]; then
  echo "WARNING: /usr/local/bin/rocketfuel-push should be deleted so I can
         recreate it."
fi


# Make sure we have all the right code in place for source dependencies
/usr/local/bin/rocketfuel-get

echo "
Thank you for using this script. You can improve it for everyone by
committing changes to LP in utilities/rocketfuel-setup.

You should use the following commands to manage your Rocketfuel:

 rocketfuel-get
    Update your copy of trunk and the necessary source dependencies, and
    make sure all source dependencies are properly linked in to all the
    branches you are working on.
    *** DO THIS NEXT! ***

 rocketfuel-branch foo
    Create a new branch of LP called "foo" in $LP_PROJECT_PATH/foo,
    with all the source dependencies properly linked in.

 rocketfuel-status
    Check each of the branches in $LP_PROJECT_PATH and show which of them have
    uncommitted changes, also check which ones have revisions that have not
    yet landed on trunk.

 rocketfuel-push
    Push all of your branches to devpad, so that you have a server-side
    backup of everything.

Happy hacking!
"
