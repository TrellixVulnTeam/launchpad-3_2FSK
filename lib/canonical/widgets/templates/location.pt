%(latitude_widget)s
%(longitude_widget)s
<p class="formHelp">
  You can drag the marker to change the location, and zoom into the map to
  see more details and verify the location's accuracy.
  If your mouse has a scroll wheel, use it to more quickly zoom the
  map in and out. Double-clicking will also zoom in and move the
  marker. Please <strong>do not disclose sensitive information such
  as a specific home location</strong> without the permission of
  the person involved - rather just indicate a city so that the time
  zone is correct.
</p>
<p id="%(div)s"
     style="width: 100%%; height: 300px; border: 1px; float: left;"
     ></p>
<script type="text/javascript">

//<![CDATA[

function setLocation(lat, lng, field_name, latname, lngname) {

    document.getElementById(latname).value = lat;
    document.getElementById(lngname).value = lng;

    var request = new JSONScriptRequest();
    var url = "%(tz_ws_url)s"+"?username=launchpad&lat="+lat.toString()+"&lng="+lng.toString();

    document.getElementById(field_name+".spinner").src = "/@@/spin";
    request.open("GET", url);

    request.onreadystatechange = function() {
      if (request.readyState == 4) {
        if (request.responseText) {
          tz = request.responseJSON.timezoneId;
          document.getElementById(field_name).value = tz;
          document.getElementById(field_name+".spinner").src = "/@@/nospin";
        }
      }
    };
    request.send(null);
}


if (GBrowserIsCompatible()) {
    var width_and_height = getWindowWidthAndHeight();
    var myWidth = width_and_height[0];
    var myHeight = width_and_height[1];
    var mapdiv = document.getElementById("%(div)s");
    var mapheight = (parseInt(mapdiv.offsetWidth) / 16 * 9);
    mapheight = Math.min(mapheight, myHeight - 180);
    mapheight = Math.max(mapheight, 400);
    mapdiv.style.height = mapheight + 'px';

    var %(map)s = new GMap2(mapdiv);
    center = new GLatLng(%(center_lat)s, %(center_long)s);
    %(map)s.setCenter(center, %(zoom)s);
    %(map)s.setMapType(G_HYBRID_MAP);
    %(map)s.addControl(new GLargeMapControl());
    %(map)s.addControl(new GMapTypeControl());
    %(map)s.addControl(new GOverviewMapControl());
    %(map)s.addControl(new GScaleControl());
    %(map)s.enableScrollWheelZoom();

    var marker = new GMarker(center, {draggable: true});
    var myHTML = '<div align="center">'
    myHTML = myHTML + '<strong>%(displayname)s</strong><br />'
    myHTML = myHTML + '%(logo_html)s<br />'
    myHTML = myHTML + '(%(name)s)'+ '</div>'
    marker.bindInfoWindowHtml(myHTML, {maxWidth: 120});

    GEvent.addListener(marker, "dragend", function() {
      point = marker.getLatLng();
      setLocation(
        point.lat(), point.lng(), "%(tz_name)s",
        "%(latname)s", "%(lngname)s");
    });

    GEvent.addListener(marker, "dragstart", function() {
      marker.closeInfoWindow();
    });

    %(map)s.addOverlay(marker);
    if (!%(show_marker)s) {
      marker.hide();
      };

    GEvent.addListener(%(map)s, "zoomend", function() {
      marker.closeInfoWindow();
      });

    GEvent.addListener(%(map)s, "click", function(overlay, point) {
      marker.setPoint(point);
      if (marker.isHidden()) {
        marker.show();
        %(map)s.panTo(point);
        };
      setLocation(
        point.lat(), point.lng(), "%(tz_name)s",
        "%(latname)s", "%(lngname)s");
     });

  }

//]]>
</script>

<p>
  <label>Time zone:
  <img id="%(tz_name)s.spinner" src="/@@/nospin" width="14" height="14" />
  </label>
  %(tz_widget)s
</p>

<p class="formHelp">
  Once the time zone is correctly set, events in Launchpad will be
  displayed in local time.
</p>
