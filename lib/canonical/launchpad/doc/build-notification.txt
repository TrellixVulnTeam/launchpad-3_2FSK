= Build Notification System =

IBuild instance implements the 'notify' method which sends and status
report about the current record to the ISPR.creator.preferred email.

The report is based on the emailtemplate/build-notification.txt.

All build states are supported by the current implementation, however
only failures should be reported this time.

  >>> from canonical.launchpad.interfaces import IBuildSet
  >>> from canonical.launchpad.mail import stub
  >>> import transaction

  >>> buildset = getUtility(IBuildSet)

To avoid consequeces of modified sampledata, specially if we add
more builds for test we are going to pick a specific build record
in a known state to perform the tests.

Notification for a FAILEDTOBUILD (failed) build record:

  >>> failed_candidate = buildset.getByBuildID(17)
  >>> failed_candidate.notify()
  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> to_addrs
  ['Mark Shuttleworth <mark@hbd.com>']
  >>> print raw_msg
  Content-Type: text/plain; charset="utf-8"
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  X-LAUNCHPAD-BUILDD: FAILEDTOBUILD
  Bcc: Launchpad Buildd <lp_buildd@localhost>
  To: Mark Shuttleworth <mark@hbd.com>
  From: Launchpad Buildd System <noreply@launchpad.net>
  Subject: [Build #17] i386 build of pmount 0.1-1 in ubuntu breezy-autotest RELEASE
  ...
  Reply-To: Launchpad Buildd System <noreply@launchpad.net>
  Sender: bounces@canonical.com
  Errors-To: bounces@canonical.com
  Return-Path: bounces@canonical.com
  X-Generated-By: Launchpad (canonical.com)
  <BLANKLINE>
  Hello,
  <BLANKLINE>
  This package has been failed to build in the in the Launchpad Build
  System.
  <BLANKLINE>
   * SourcePackageRelease: pmount - 0.1-1
   * Architecture: i386
   * State: Failed to build
   * Duration: three minutes
   * Build Log: http://localhost:58000/1/netapplet-1.0.0.tar.gz
   * Builder: http://launchpad.dev/+builds/bob
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of pmount 0.1-1 in ubuntu breezy-autotest
  http://launchpad.dev/+builds/+build/17
  <BLANKLINE>

Notification for a pending (NEEDSBUILD) build record:

  >>> pending_candidate = buildset.getByBuildID(11)
  >>> pending_candidate.notify()

  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> to_addrs
  ['Mark Shuttleworth <mark@hbd.com>']
  >>> print raw_msg
  Content-Type: text/plain; charset="utf-8"
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  X-LAUNCHPAD-BUILDD: NEEDSBUILD
  Bcc: Launchpad Buildd <lp_buildd@localhost>
  To: Mark Shuttleworth <mark@hbd.com>
  From: Launchpad Buildd System <noreply@launchpad.net>
  Subject: [Build #11] i386 build of alsa-utils 1.0.9a-4ubuntu1 in ubuntu hoary RELEASE
  ...
  Reply-To: Launchpad Buildd System <noreply@launchpad.net>
  Sender: bounces@canonical.com
  Errors-To: bounces@canonical.com
  Return-Path: bounces@canonical.com
  X-Generated-By: Launchpad (canonical.com)
  <BLANKLINE>
  Hello,
  <BLANKLINE>
  This package has been failed to build in the in the Launchpad Build
  System.
  <BLANKLINE>
   * SourcePackageRelease: alsa-utils - 1.0.9a-4ubuntu1
   * Architecture: i386
   * State: Needs building
   * Duration: not available
   * Build Log: not available
   * Builder: not available
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of alsa-utils 1.0.9a-4ubuntu1 in ubuntu hoary
  http://launchpad.dev/+builds/+build/11
  <BLANKLINE>


Notification for a BUILDING build record:

  >>> building_candidate = buildset.getByBuildID(8)
  >>> building_candidate.notify()
  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> to_addrs
  ['Mark Shuttleworth <mark@hbd.com>']
  >>> print raw_msg
  Content-Type: text/plain; charset="utf-8"
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  X-LAUNCHPAD-BUILDD: BUILDING
  Bcc: Launchpad Buildd <lp_buildd@localhost>
  To: Mark Shuttleworth <mark@hbd.com>
  From: Launchpad Buildd System <noreply@launchpad.net>
  Subject: [Build #8] i386 build of mozilla-firefox 0.9 in ubuntu hoary RELEASE
  ...
  Reply-To: Launchpad Buildd System <noreply@launchpad.net>
  Sender: bounces@canonical.com
  Errors-To: bounces@canonical.com
  Return-Path: bounces@canonical.com
  X-Generated-By: Launchpad (canonical.com)
  <BLANKLINE>
  Hello,
  <BLANKLINE>
  This package has been failed to build in the in the Launchpad Build
  System.
  <BLANKLINE>
   * SourcePackageRelease: mozilla-firefox - 0.9
   * Architecture: i386
   * State: Currently building
   * Duration: not finished
   * Build Log: see builder page
   * Builder: http://launchpad.dev/+builds/bob
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of mozilla-firefox 0.9 in ubuntu hoary
  http://launchpad.dev/+builds/+build/8
  <BLANKLINE>


Notification for a SUPERSEDED build record:

  >>> superseeded_candidate = buildset.getByBuildID(15)
  >>> superseeded_candidate.notify()
  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> to_addrs
  ['Mark Shuttleworth <mark@hbd.com>']
  >>> print raw_msg
  Content-Type: text/plain; charset="utf-8"
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  X-LAUNCHPAD-BUILDD: SUPERSEDED
  Bcc: Launchpad Buildd <lp_buildd@localhost>
  To: Mark Shuttleworth <mark@hbd.com>
  From: Launchpad Buildd System <noreply@launchpad.net>
  Subject: [Build #15] i386 build of at 0.00 in ubuntu warty RELEASE
  ...
  Reply-To: Launchpad Buildd System <noreply@launchpad.net>
  Sender: bounces@canonical.com
  Errors-To: bounces@canonical.com
  Return-Path: bounces@canonical.com
  X-Generated-By: Launchpad (canonical.com)
  <BLANKLINE>
  Hello,
  <BLANKLINE>
  This package has been failed to build in the in the Launchpad Build
  System.
  <BLANKLINE>
   * SourcePackageRelease: at - 0.00
   * Architecture: i386
   * State: Build for superseded Source
   * Duration: not available
   * Build Log: not available
   * Builder: not available
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of at 0.00 in ubuntu warty
  http://launchpad.dev/+builds/+build/15
  <BLANKLINE>


Check if the 'build_notification' config option really suppress
notification as promised:

  >>> from canonical.config import config
  >>> config.builddmaster.build_notification = False
  >>> superseeded_candidate = buildset.getByBuildID(15)
  >>> superseeded_candidate.notify()
  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  Traceback (most recent call last):
  ...
  IndexError: pop from empty list


Check if 'notify_owner' config option really suppress email to
the SPR owner, but still sending it to the default recipient:

  >>> config.builddmaster.build_notification = True
  >>> config.builddmaster.notify_owner = False
  >>> superseeded_candidate = buildset.getByBuildID(15)
  >>> superseeded_candidate.notify()
  >>> transaction.commit()
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> to_addrs
  ['Launchpad Buildd <lp_buildd@localhost>']
  >>> print raw_msg
  Content-Type: text/plain; charset="utf-8"
  MIME-Version: 1.0
  Content-Transfer-Encoding: quoted-printable
  X-LAUNCHPAD-BUILDD: SUPERSEDED
  To: Launchpad Buildd <lp_buildd@localhost>
  From: Launchpad Buildd System <noreply@launchpad.net>
  Subject: [Build #15] i386 build of at 0.00 in ubuntu warty RELEASE
  ...
  Reply-To: Launchpad Buildd System <noreply@launchpad.net>
  Sender: bounces@canonical.com
  Errors-To: bounces@canonical.com
  Return-Path: bounces@canonical.com
  X-Generated-By: Launchpad (canonical.com)
  <BLANKLINE>
  Hello,
  <BLANKLINE>
  This package has been failed to build in the in the Launchpad Build
  System.
  <BLANKLINE>
   * SourcePackageRelease: at - 0.00
   * Architecture: i386
   * State: Build for superseded Source
   * Duration: not available
   * Build Log: not available
   * Builder: not available
  <BLANKLINE>
  If you want further information about this situation, feel free to
  contact a member of the Launchpad Buildd Administrators team.
  <BLANKLINE>
  --
  i386 build of at 0.00 in ubuntu warty
  http://launchpad.dev/+builds/+build/15
  <BLANKLINE>


Just to keep the config sane, as it was before:

  >>> config.builddmaster.notify_owner = True