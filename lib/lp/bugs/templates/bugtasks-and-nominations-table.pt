<!-- Copyright 2009 Canonical Ltd.  This software is licensed under the
     GNU Affero General Public License version 3 (see the file LICENSE).
-->

<tal:root
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  omit-tag="">
<script type="text/javascript">
  function toggleFormVisibility(row_id) {
    row = document.getElementById(row_id)
    edit_icon = document.getElementById(row_id + "-edit")
    if (row.style.display=="none") {
      row.style.display = "table-row";
    } else {
      row.style.display = "none";
    }
    return false;
  }
</script>

<table
  id="affected-software"
  tal:attributes="class python: context.duplicateof and 'duplicate listing' or 'listing'"
>
  <thead>
    <tr>
      <th colspan="2">Affects</th>
      <th>Status</th>
      <th>Importance</th>
      <th colspan="2">Assigned to</th>
      <th>Milestone</th>
    </tr>
  </thead>

  <tbody>
    <tal:bugtask-or-nomination
        repeat="task_or_nom_view view/getBugTaskAndNominationViews">
      <tal:block replace="structure task_or_nom_view" />
    </tal:bugtask-or-nomination>
  </tbody>

</table>

<div
  class="actions"
  tal:define="current_bugtask view/current_bugtask"

        tal:condition="view/displayAlsoAffectsLinks">
    <tal:also-affects-links define="context_menu context/menu:context">
      <tal:addupstream
        define="link context_menu/addupstream"
        condition="link/enabled"
        replace="structure link/render" />
      <tal:adddistro
        define="link context_menu/adddistro"
        condition="link/enabled"
        replace="structure link/render" />
      <tal:nominate
        define="link context_menu/nominate"
        condition="link/enabled"
        replace="structure link/render" />
      <form
        id="affectsmetooform"
        name="affectsmetooform"
        method="post"
        enctype="multipart/form-data"
        accept-charset="UTF-8"
        tal:define="link context_menu/affectsmetoo"
        tal:condition="link/enabled"
        tal:attributes="action link/url"
        style="display: inline">
        <input
          name="field.affects"
          type="hidden"
          tal:attributes="value view/affects_form_value" />
        <input
          type="hidden"
          name="field.actions.change"
          value="" />
        <tal:affected condition="view/current_user_affected_status">
          <img width="14" height="14" src="/@@/flame-icon" alt="" />
          This bug affects me too
        </tal:affected>
        <tal:affected condition="not: view/current_user_affected_status">
          This bug doesn't affect me
        </tal:affected>
        (<tal:affectsmetoo
        define="link context_menu/affectsmetoo"
        condition="link/enabled"
        replace="structure link/render" />)
        <tal:nothing condition="nothing">
          The following is a trick to allow users to mark
          themselves as affected by a bug with only one click.
          If Javascript is available, we submit the form and
          immediately go back to the same page, saving them the
          need to go to a new page.
        </tal:nothing>
        <script type="text/javascript">
            function sendMeTooForm(e) {
                $('affectsmetooform').submit();
                e.preventDefault();
            }
            function connectMeTooLink() {
                var me_too_link = getFirstElementByTagAndClassName(
                'a', 'menu-link-affectsmetoo');
                connect(me_too_link, 'onclick', sendMeTooForm);
            }
            registerLaunchpadFunction(connectMeTooLink);
        </script>
      </form>
    </tal:also-affects-links>

</div>
</tal:root>
