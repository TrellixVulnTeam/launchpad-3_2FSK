Person Pages
============

In every person page, the 'Bugs' facet has a series of bug listings for
that person. These pages provide simple and advanced search forms.

    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> name16 = getUtility(IPersonSet).get(16)

Let's define a helper function to make it easier to construct a view.

    >>> from zope.component import getView
    >>> from zope.publisher.browser import TestRequest
    >>> def create_view(context, name, request=None):
    ...     request = request or TestRequest()
    ...     view = getView(context, name, request)
    ...     view.initialize()
    ...     return view

Assigned bugs
-------------

All bug tasks assigned to this person.

By default, only bugtasks with any of the statuses listed in
canonical.launchpad.interfaces.UNRESOLVED_BUGTASK_STATUSES are included:

    >>> assigned_bugtaks_view = create_view(name16, '+assignedbugs')
    >>> assigned_bugtasks = list(assigned_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name)
    ...         for bugtask in assigned_bugtasks])
    [(7, 'UNCONFIRMED')]

The advanced search allows us to change this behaviour. Let's search for
bug tasks with status UNCONFIRMED and FIXCOMMITTED.

    >>> form = {
    ...     'orderby': u'-priority',
    ...     'field.status': [u'Unconfirmed', u'Fix Released'],
    ...     'field.status-empty-marker': u'1', 'search': u'Search'}
    >>> request = TestRequest(form=form)
    >>> assigned_bugtaks_view = create_view(name16, '+assignedbugs', request)
    >>> assigned_bugtasks = list(assigned_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name)
    ...         for bugtask in assigned_bugtasks])
    [(7, 'UNCONFIRMED'), (8, 'FIXRELEASED')]


Reported bugs
-------------

All bug tasks reported by someone. By default we'll get assigned and
unassigned bug tasks.

    >>> reported_bugtaks_view = create_view(name16, '+reportedbugs')
    >>> reported_bugtasks = list(reported_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name,
    ...          getattr(bugtask.assignee, 'name', None))
    ...         for bugtask in reported_bugtasks])
    [(1, 'UNCONFIRMED', None), (3, 'UNCONFIRMED', None), (7, 'UNCONFIRMED', u'name16')]

But the advanced search allows us to query only the bug tasks that aren't
assigned.

    >>> form = {'orderby': u'-priority', 'field.unassigned': u'on'}
    >>> request = TestRequest(form=form)
    >>> reported_bugtaks_view = create_view(name16, '+reportedbugs', request)
    >>> reported_bugtasks = list(reported_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name,
    ...          getattr(bugtask.assignee, 'name', None))
    ...         for bugtask in reported_bugtasks])
    [(1, 'UNCONFIRMED', None), (3, 'UNCONFIRMED', None)]


Subscribed bugs
---------------

All bug tasks someone is subscribed to. By default we'll get bug tasks
with any severity.

    >>> name12 = getUtility(IPersonSet).get(12)
    >>> subscribed_bugtaks_view = create_view(name12, '+subscribedbugs')
    >>> subscribed_bugtasks = list(subscribed_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name, bugtask.severity.name)
    ...         for bugtask in subscribed_bugtasks])
    [(1, 'CONFIRMED', 'MINOR'), (1, 'UNCONFIRMED', 'MINOR'),
     (1, 'UNCONFIRMED', 'NORMAL'), (4, 'UNCONFIRMED', 'NORMAL')]

The advanced search allows us to query only the bug tasks with severity
Normal, Major and Critical.

    >>> form = {'orderby': u'-priority',
    ...         u'field.severity': [u'Normal', u'Major', u'Critical']}
    >>> request = TestRequest(form=form)
    >>> subscribed_bugtaks_view = create_view(name12, '+subscribedbugs', request)
    >>> subscribed_bugtasks = list(subscribed_bugtaks_view.search().batch)
    >>> sorted([(bugtask.bug.id, bugtask.status.name, bugtask.severity.name)
    ...         for bugtask in subscribed_bugtasks])
    [(1, 'UNCONFIRMED', 'NORMAL'), (4, 'UNCONFIRMED', 'NORMAL')]

Bugs for Bug Contact
--------------------

Overview and searchable bug listings for bugs reported on packages that
the person is getting bugmail from. The Person context is used only to
get a list of packages that the user has chosen to subscribe to, but any
package could be searched from these reports, simply by hacking the URL.

    >>> form = {
    ...     'search': "Search", 'field.distribution': "debian",
    ...     'field.sourcepackagename': "mozilla-firefox"}

    >>> request = TestRequest(form=form)
    >>> packagebugs_search_view = create_view(
    ...     name12, name="+packagebugs-search", request=request)

Let's look at some example searches:

No search criteria:

    >>> bugtask_batch_navigator = packagebugs_search_view.search()
    >>> [bugtask.bug.id for bugtask in bugtask_batch_navigator.batch]
    [8, 1, 2, 3]

Simple keyword searching:

    >>> form = {
    ...     'search': "Search",
    ...     'field.distribution': "debian",
    ...     'field.sourcepackagename': "mozilla-firefox",
    ...     'field.searchtext': "trash"}

    >>> request = TestRequest(form=form)
    >>> packagebugs_search_view = create_view(
    ...     name12, name="+packagebugs-search", request=request)

    >>> bugtask_batch_navigator = packagebugs_search_view.search()
    >>> [bugtask.bug.id for bugtask in bugtask_batch_navigator.batch]
    [2]

Searching for all open bugs on Debian mozilla-firefox:

    >>> from canonical.launchpad.interfaces.bugtask import UNRESOLVED_BUGTASK_STATUSES

    >>> form = {
    ...     'search': "Search",
    ...     'field.distribution': "debian",
    ...     'field.sourcepackagename': "mozilla-firefox",
    ...     'field.status': [s.title for s in UNRESOLVED_BUGTASK_STATUSES]}

    >>> request = TestRequest(form=form)
    >>> packagebugs_search_view = create_view(
    ...     name12, name="+packagebugs-search", request=request)

    >>> bugtask_batch_navigator = packagebugs_search_view.search()
    >>> [bugtask.bug.id for bugtask in bugtask_batch_navigator.batch]
    [1, 2, 3]

Searching for all unassigned bugs on Debian mozilla-firefox:

    >>> form = {
    ...     'search': "Search",
    ...     'field.distribution': "debian",
    ...     'field.sourcepackagename': "mozilla-firefox",
    ...     'field.unassigned': True}

    >>> request = TestRequest(form=form)
    >>> packagebugs_search_view = create_view(
    ...     name12, name="+packagebugs-search", request=request)

    >>> bugtask_batch_navigator = packagebugs_search_view.search()
    >>> [bugtask.bug.id for bugtask in bugtask_batch_navigator.batch]
    [1, 3]

There are helper methods to calculate links to the Open, Critical,
Unassigned, and In Progress bug lists.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.interfaces import IDistributionSet

    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")
    >>> ubuntu_mozilla_firefox = ubuntu.getSourcePackage("mozilla-firefox")

    >>> packagebugs_search_view.getOpenBugsURL(ubuntu_mozilla_firefox)
    u'.../people/name12/+packagebugs-search?field.distribution=ubuntu&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Unconfirmed&amp;field.status=Confirmed&amp;field.status=In+Progress&amp;search=Search'

    >>> packagebugs_search_view.getCriticalBugsURL(ubuntu_mozilla_firefox)
    u'.../people/name12/+packagebugs-search?field.distribution=ubuntu&amp;field.severity=Critical&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Unconfirmed&amp;field.status=Confirmed&amp;field.status=In+Progress&amp;search=Search'

    >>> packagebugs_search_view.getUnassignedBugsURL(ubuntu_mozilla_firefox)
    u'.../people/name12/+packagebugs-search?field.distribution=ubuntu&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Unconfirmed&amp;field.status=Confirmed&amp;field.status=In+Progress&amp;field.unassigned=on&amp;search=Search'

    >>> packagebugs_search_view.getInProgressBugsURL(ubuntu_mozilla_firefox)
    u'.../people/name12/+packagebugs-search?field.distribution=ubuntu&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=In+Progress&amp;search=Search'

A helper method is used to calculate package bug search URL for the "My
other packages" portlet:

    >>> packagebugs_search_view.getBugContactPackageSearchURL(ubuntu_mozilla_firefox)
    u'.../people/name12/+packagebugs-search?field.distribution=ubuntu&amp;field.sourcepackagename=mozilla-firefox&amp;search=Search'

Search Filter Links
-------------------

The package bug report displays the current search filter, with each
part of the filter being links to that specific part of the filter. For
example, if you search for mozilla-firefox (Ubuntu) bugs, that are
unassigned, and targeted for dapper, you are presented with links like:

1 - 40 of 40 bugs matching _mozilla-firefox (Ubuntu)_, _unassigned_,
_targeted for dapper_.

Use the getSearchFilterLinks method to get a dict of these links.

    >>> form = {
    ...     'search': "Search",
    ...     'field.distribution': "debian",
    ...     'field.sourcepackagename': "mozilla-firefox",
    ...     'field.searchtext': "foo",
    ...     'field.unassigned': 'on'}

    >>> request = TestRequest(form=form)
    >>> packagebugs_search_view = create_view(
    ...     name12, name="+packagebugs-search", request=request)

    >>> filter_links = packagebugs_search_view.getSearchFilterLinks()
    >>> len(filter_links)
    2

    >>> filter_links[0]
    ('mozilla-firefox in debian',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.sourcepackagename=mozilla-firefox&amp;search=Search')

    >>> filter_links[1]
    ('unassigned',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Unconfirmed&amp;field.status=Confirmed&amp;field.status=In+Progress&amp;field.unassigned=on&amp;search=Search')

There is a separate method for status filter links, because they are
displayed slightly differently than other filter links, to communicate
that the status is an "OR" match.

When no statuses are explicitly specified, the default is
canonical.launchpad.interfaces.bugtask.UNRESOLVED_BUGTASK_STATUSES. The
links are sorted by numerical values of the statuses. (See the
BugTaskStatus vocabulary for more.)

    >>> status_filter_links = packagebugs_search_view.getStatusFilterLinks()
    >>> len(status_filter_links)
    3
    >>> status_filter_links[0]
    ('unconfirmed',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Unconfirmed&amp;search=Search')
    >>> status_filter_links[1]
    ('confirmed',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=Confirmed&amp;search=Search')
    >>> status_filter_links[2]
    ('in progress',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.sourcepackagename=mozilla-firefox&amp;field.status=In+Progress&amp;search=Search')

There is also a separate method for the search text link, because that's
displayed slightly differently too, so that the user knows what fields
it searches:

    >>> packagebugs_search_view.getSearchTextFilterLink()
    ('foo',
    u'.../people/name12/+packagebugs-search?field.distribution=debian&amp;field.searchtext=foo&amp;field.sourcepackagename=mozilla-firefox&amp;search=Search')
