= Code Import Machines =

As an import operator, it is often desirable to see what the
import machines are doing.

At this stage, the page isn't linked from any other page, and has to
be entered manually (or from a bookmark).  Given that this is a view
that is more interesting to import operators, and not so much to
individual users, this seems like a fair compromise.

    >>> browser = setupBrowser(auth="Basic test@canonical.com:test")
    >>> browser.open('http://code.launchpad.dev/+code-imports/+machines')
    >>> def print_table(browser):
    ...    table = find_tag_by_id(
    ...        browser.contents, 'code-import-machine-listing')
    ...    print extract_text(table)

Initially only the machine in sample data is shown.

    >>> print_table(browser)
    Machine           Status
    bazaar-importer   Online

If we create some jobs that are running, then we can see the currently
running jobs in the table.

    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.testing import LaunchpadObjectFactory
    >>> factory = LaunchpadObjectFactory()
    >>> login('david.allouche@canonical.com')

    >>> apollo, odin, saturn = (
    ...     factory.makeCodeImportMachine(set_online=True, hostname='apollo'),
    ...     factory.makeCodeImportMachine(set_online=True, hostname='odin'),
    ...     factory.makeCodeImportMachine(hostname='saturn'))

    >>> from canonical.launchpad.testing.codeimporthelpers import (
    ...     make_running_import)
    >>> ignored = make_running_import(factory=factory, machine=apollo)
    >>> ignored = make_running_import(factory=factory, machine=apollo)
    >>> ignored = make_running_import(factory=factory, machine=odin)

    >>> # XXX thumper 2008-04-08, bug 3989
    >>> # flush_database_updates needed for test browser to see changes.
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> flush_database_updates()
    >>> logout()

    >>> browser.open('http://code.launchpad.dev/+code-imports/+machines')
    >>> print_table(browser)
    Machine          Status
    apollo           Online
        ~vcs-imports/.../...
            Started: ... ago      Last heartbeat: ... ago
        ~vcs-imports/.../...
            Started: ... ago      Last heartbeat: ... ago
    bazaar-importer  Online
    odin             Online
        ~vcs-imports/.../...
            Started: ... ago      Last heartbeat: ... ago
    saturn           Offline
