<tal:root
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  omit-tag="">

  <metal:form-picker define-macro="form-picker">
    <tal:input replace="structure view/inputField" />

    <tal:search_results tal:condition="not: view/hasValidInput">
      <select tal:condition="view/matches">
        <option
            tal:repeat="match view/matches"
            tal:attributes="value match/token;
                selected python:path('match/token') == path('view/formToken');
                onclick string:this.form['${view/name}'].value = this.value"
            tal:content="string:${match/token}: ${match/title}"
            />
      </select>
    </tal:search_results>

    <tal:chooseLink replace="structure view/chooseLink" />
    <script tal:content="structure string:
    LPS.use('node', 'lp.app.picker', 'plugin', function(Y) {
        if (Y.UA.ie) {
            return;
        }

        // The vocabulary picker, created when used for the first time.
        var picker = null;
        function make_picker() {
            var config = {
                header: ${view/header_text},
                step_title: ${view/step_title_text},
                extra_no_results_message: ${view/extra_no_results_message}
            };
            var picker = Y.lp.app.picker.create('${view/vocabulary_name}', config);
            if (config.extra_no_results_message !== null) {
                picker.before('resultsChange', function (e) {
                    var new_results = e.details[0].newVal;
                    if (new_results.length === 0) {
                        picker.set('footer_slot',
                                   Y.Node.create(config.extra_no_results_message));
                    }
                    else {
                        picker.set('footer_slot', null);
                    }
                });
            }
            picker.plug(Y.lazr.TextFieldPickerPlugin,
                        {input_element: '[id=\x22${view/input_id}\x22]'});
            return picker;
        }

        Y.on('domready', function(e) {
            // Sort out the Choose... link.
            var show_widget_node = Y.one('#${view/show_widget_id}');

            show_widget_node.set('innerHTML', 'Choose&hellip;');
            show_widget_node.addClass('js-action');
            show_widget_node.get('parentNode').removeClass('unseen');
            show_widget_node.on('click', function (e) {
                if (picker === null) {
                    picker = make_picker();
                }
                picker.show();
                e.preventDefault();
            });
        });
    });
    "/>
  </metal:form-picker>
</tal:root>
