Bug Links
=========

CVE report can be linked to bugs. Users will do that when a bug exposes
the vulnerability in the report.


Adding Links
------------

Let say that Malone Bug #5 records the vulnerability described in
CVE-2005-2737. A user that wants to document that relationship goes to
the CVE report and click the 'Link to Bug'.

This link is only available to registered user:

    >>> anon_browser.open('http://launchpad.dev/malone/cve/2005-2737')
    >>> anon_browser.getLink(url='+linkbug').click()
    Traceback (most recent call last):
      ...
    Unauthorized: ...

    >>> user_browser.open('http://launchpad.dev/malone/cve/2005-2737')
    >>> user_browser.getLink('Link to Bug').click()

To link the bug, the user enters the bug ID and click the 'Link'
button.

    >>> user_browser.getControl('Bug ID').value = '5'
    >>> user_browser.getControl('Link').click()

The bug is now listed under the 'Related Bugs' heading:

    >>> from BeautifulSoup import BeautifulSoup
    >>> soup = BeautifulSoup(user_browser.contents)
    >>> header = soup.first('h2')
    >>> header.findNext('b')
    <b>Bug #5:...Firefox install instructions should be complete</b>

It is also possible to link a bug using its nickname. For example,
bug #2 has 'blackhole' as its nickname:

    >>> user_browser.getLink('Link to Bug').click()
    >>> user_browser.getControl('Bug ID').value = 'blackholes'
    >>> user_browser.getControl('Link').click()

An error message is displayed when user enters a non-existent nickname:

    >>> soup = BeautifulSoup(user_browser.contents)
    >>> bug_field = soup.first('div', 'field')
    >>> bug_field.first('div', 'message')
    <div class="message">Not a valid bug number or nickname.</div>

The user can correct his error and submit the form again.

    >>> user_browser.getControl('Bug ID').value = 'blackhole'
    >>> user_browser.getControl('Link').click()

A notification is displayed telling the user which bug he just linked:

    >>> soup = BeautifulSoup(user_browser.contents)
    >>> soup.first('div', 'informational message')
    <div class="informational message">Added link to bug #2:
    ...Blackhole Trash folder...</div>

It is also possible for the user to change its mind. Using the 'Cancel'
button on the 'Link to Bug' page, will bring him back to the main view:

    >>> user_browser.getLink('Link to Bug').click()
    >>> user_browser.getControl('Cancel').click()
    >>> user_browser.url
    '.../malone/cve/2005-2737'


Removing Links
--------------

To remove bug links, the user would use the 'Remove Bug Link' action.
He can select the bug reports, he wants to unlink from the CVE.

    >>> user_browser.getLink('Remove Bug Link').click()
    >>> user_browser.getControl('#2: Blackhole').selected = True
    >>> user_browser.getControl('#5: Firefox').selected = True
    >>> user_browser.getControl('Remove').click()

The bug was removed from the CVE report page:

    >>> soup = BeautifulSoup(user_browser.contents)
    >>> soup('div', 'informational message')
    [<div class="informational message">Removed link to bug #5.</div>,
    <div class="informational message">Removed link to bug #2.</div>]

    >>> 'No related bugs.' in user_browser.contents
    True


Linking CVEs to Bugs
====================

Similarly, we should be able to unlink and re-link a CVE to a bug. Let's
look at Bug #1. We should see that it is linked to CVE 1999-8979.

  >>> print http(r"""
  ... GET /products/firefox/+bug/1 HTTP/1.1
  ... """)
  HTTP/1.1 200 Ok
  ...1999-8979...

Let's remove that link. First, make sure we can see the page.We'll use
Sample Person again.

  >>> print http(r"""
  ... GET /products/firefox/+bug/1/+unlinkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... """)
  HTTP/1.1 200 Ok
  ...

And that we can POST to it.

  >>> print http(r"""
  ... POST /products/firefox/+bug/1/+unlinkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 317
  ... Content-Type: multipart/form-data; boundary=---------------------------192921188714487939411191642790
  ...
  ... -----------------------------192921188714487939411191642790
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... 1999-8979
  ... -----------------------------192921188714487939411191642790
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------192921188714487939411191642790--
  ... """)
  HTTP/1.1 303 See Other
  Content-Length: 0
  ...
  Location: http://.../products/firefox/+bug/1

And add it back. Make sure we can see the "Link CVE" page.

  >>> print http(r"""
  ... GET /products/firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... """)
  HTTP/1.1 200 Ok
  ...

And check if the CVE validator is working.

  >>> print http(r"""
  ... POST /products/firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 314
  ... Content-Type: multipart/form-data; boundary=---------------------------10715549571845379851634356273
  ...
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... invalid
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------10715549571845379851634356273--
  ... """)
  HTTP/1.1 200 Ok
  ...
  ...Please fix the problems below and try again...
  ...invalid is not a valid CVE number...
  ...

And POST to it.

  >>> print http(r"""
  ... POST /products/firefox/+bug/1/+linkcve HTTP/1.1
  ... Authorization: Basic dGVzdEBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 314
  ... Content-Type: multipart/form-data; boundary=---------------------------10715549571845379851634356273
  ...
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="field.sequence"
  ...
  ... 1999-8979
  ... -----------------------------10715549571845379851634356273
  ... Content-Disposition: form-data; name="FORM_SUBMIT"
  ...
  ... Continue
  ... -----------------------------10715549571845379851634356273--
  ... """)
  HTTP/1.1 303 See Other
  Content-Length: 0
  ...
  Location: http://.../products/firefox/+bug/1


