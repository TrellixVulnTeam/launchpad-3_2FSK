= Ubuntu (copy) archives =

First create a copy archive for us to see:

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet)
    >>> login('foo.bar@canonical.com')
    >>> ubuntu = getUtility(IDistributionSet)['ubuntu']

    >>> joe = factory.makePerson(displayname='Joe Bloggs')
    >>> copy_location = factory.makeCopyArchiveLocation(
    ...     distribution=ubuntu, owner=joe,
    ...     name="intrepid-security-rebuild")
    >>> copy_archive = copy_location.archive
    >>> package_copy_request = ubuntu.main_archive.requestPackageCopy(
    ...     copy_location, copy_archive.owner)

    >>> marty = factory.makePerson(displayname='Marty Jupiter')
    >>> disabled_location = factory.makeCopyArchiveLocation(
    ...     distribution=ubuntu, owner=marty,
    ...     name="disabled-security-rebuild")
    >>> disabled_archive = disabled_location.archive
    >>> disabled_archive.enabled = False

And add some published packages so that this archive is considered
an active one:

    >>> from lp.soyuz.tests.test_publishing import (
    ...     SoyuzTestPublisher)
    >>> stp = SoyuzTestPublisher()
    >>> hoary = ubuntu['hoary']
    >>> unused = stp.setUpDefaultDistroSeries(distroseries=hoary)
    >>> stp.addFakeChroots(distroseries=hoary)
    >>> pub_src = stp.getPubSource(
    ...     archive=copy_archive, architecturehintlist='any')
    >>> pub_bins = stp.getPubBinaries(pub_source=pub_src)

    >>> logout()

Currently (until we get some UI input) there is no link to the archives
page, but it exists at:

    >>> anon_browser.open("http://launchpad.dev/ubuntu/+archives")
    >>> anon_browser.title
    'Ubuntu Linux Copy Archives'

This index of /ubuntu/+archives provides an overview describing
what the viewer can expect to find here

    >>> main_content = find_main_content(anon_browser.contents)
    >>> print extract_text(main_content)
    Details...
    ...
    Copy Archives related to Ubuntu Linux
    'Copy' archives containing packages copied from other archives
    (the main archive or PPAs) for a distribution.
    ...
    intrepid-security-rebuild
    ...

Each copy archive includes a link to a page displaying the archive
details:

    >>> link = anon_browser.getLink("intrepid-security-rebuild")
    >>> print link
    <Link text='intrepid-security-rebuild'
    url='http://launchpad.dev/ubuntu/+archive/intrepid-security-rebuild'>

    >>> link.click()
    >>> print anon_browser.title
    Copy archive intrepid-security-rebuild for Joe Bloggs

Copy archives only have minor differences from PPAs in their presentation.
In particular, the source.list entries are not displayed for a copy
archive:

    >>> print find_tag_by_id(anon_browser.contents, 'sources-list-entries')
    None

The package counters are not displayed for a copy archive:

    >>> print find_tag_by_id(anon_browser.contents, 'package-counters')
    None

Neither is the repository-size javascript present:

    >>> print find_tag_by_id(anon_browser.contents, 'repository-size-update')
    None

Whereas, for a PPA which uses the same template, the sources list is
present:

    >>> anon_browser.open("http://launchpad.dev/~cprov/+archive")
    >>> print find_tag_by_id(anon_browser.contents, 'sources-list-entries')
    <pre id="sources-list-entries"...
    ...
    deb-src ...</pre>

The list of copy archives for a distribution may also include private
copy archives. These should not be displayed unless the user has
permission to view them.

First, create a private copy archive:

    >>> login('foo.bar@canonical.com')
    >>> copy_location = factory.makeCopyArchiveLocation(
    ...     distribution=ubuntu,
    ...     name="intrepid-private-security-rebuild")
    >>> copy_archive = copy_location.archive
    >>> copy_archive.buildd_secret = 'really secret'
    >>> copy_archive.private = True
    >>> copy_archive.owner.displayname = "Harry Potter"
    >>> package_copy_request = ubuntu.main_archive.requestPackageCopy(
    ...     copy_location, copy_archive.owner)
    >>> pub_src = stp.getPubSource(
    ...     archive=copy_archive, architecturehintlist='any')
    >>> pub_bins = stp.getPubBinaries(pub_source=pub_src)
    >>> logout()

Now viewing the index page anonymously should not display the private
archive:

    >>> anon_browser.open("http://launchpad.dev/ubuntu/+archives")
    >>> main_content = find_main_content(anon_browser.contents)
    >>> 'intrepid-private-security-rebuild' in extract_text(main_content)
    False

But when logged in as the owner or admin, the private archive does display
For example:

    >>> admin_browser.open("http://launchpad.dev/ubuntu/+archives")
    >>> main_content = find_main_content(admin_browser.contents)
    >>> 'intrepid-private-security-rebuild' in extract_text(main_content)
    True

Disabled copy archives have the title rendered in gray colour
(class="disabled") and a warning message stating that the archive
is disabled.

    >>> anon_browser.open(
    ...     "http://launchpad.dev/ubuntu/+archive/disabled-security-rebuild")
    >>> print anon_browser.title
    Copy archive disabled-security-rebuild for Marty Jupiter

    >>> main_content = find_main_content(anon_browser.contents)
    >>> print main_content.h1['class']
    disabled

    >>> tag = first_tag_by_class(anon_browser.contents, 'warning message')
    >>> print extract_text(tag)
    This archive has been disabled.

