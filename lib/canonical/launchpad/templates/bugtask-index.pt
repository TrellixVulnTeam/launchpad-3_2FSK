<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  xml:lang="en"
  lang="en"
  dir="ltr"
  metal:use-macro="view/macro:page/onecolumn"
>
  <body>
    <metal:block fill-slot="head_epilogue">
      <script type='text/javascript' tal:content="string:var yui_base='${yui}';" />
      <script type='text/javascript' id='available-official-tags-js'
              tal:content="view/available_official_tags_js" />
      <js tal:replace="structure string:<script type='text/javascript'>
YUI({base: yui_base + '/'}).use(
    'io-base', 'node', 'lazr.formoverlay', 'lazr.anim', function(Y) {

/*
 * The lazr.FormOverlay object.
 */
var duplicate_form_overlay;

/*
 * The url of the page used to update bug duplicates.
 */
var update_dupe_url;

/*
 * The launchpad js client that will be used to update the duplicate.
 */
var lp_client;

/*
 * The launchpad client entry for the current bug.
 */
var lp_bug_entry;

/*
 * Check the page for 'Mark as duplicate' links and request the HTML
 * for the form.
 */
Y.on('domready', function() {
    if (Y.UA.ie) {
       return;
    }

    // If the user is not logged in, then we need to defer to the
    // default behaviour.
    if (LP.client.links['me'] === undefined){
        return;
    }
    // First look for 'Mark as duplicate' links.
    var update_dupe_links = Y.all('.menu-link-mark-dupe');

    // If there are none, check for any 'change duplicate bug' links.
    if (!update_dupe_links){
        update_dupe_links = Y.all('#change_duplicate_bug');
    }

    if (update_dupe_links) {
        // First things first, pre-load the mark-dupe form.
        update_dupe_url = update_dupe_links.item(0).getAttribute('href');
        var mark_dupe_form_url = update_dupe_url + '/++form++';
        Y.on('io:complete', function(id, response_object) {
            createBugDuplicateFormOverlay(response_object.responseText);
            }, this);
        Y.io(mark_dupe_form_url);

        // Add an on-click handler to any links found that displays
        // the form overlay.
        update_dupe_links.on('click', function(e){
            // Only go ahead if we have received the form content by the
            // time the user clicks:
            if (duplicate_form_overlay){
                e.preventDefault();
                duplicate_form_overlay.show();
            }
        });
        // Add a class denoting them as js-action links.
        update_dupe_links.addClass('js-action');
    }
});

/*
 * Creates the duplicate form overlay using the passed form content.
 */
function createBugDuplicateFormOverlay(form_content) {
    duplicate_form_overlay = new Y.lazr.FormOverlay({
        headerContent: '<h2>Mark bug report as duplicate</h2>',
        form_content: 'Marking the bug as a duplicate will, by default, ' +
                      'hide it from search results listings.' + form_content,
        form_submit_button: Y.Node.create(
            '<button type=\'submit\' name=\'field.actions.change\' ' +
            'value=\'Change\' class=\'lazr-pos lazr-btn\' >OK</button>'),
        form_cancel_button: Y.Node.create(
            '<button type=\'button\' name=\'field.actions.cancel\' ' +
            'class=\'lazr-neg lazr-btn\' >Cancel</button>'),
        centered: true,
        form_submit_callback: update_bug_duplicate,
        visible: false
    });
    duplicate_form_overlay.render();
}

/*
 * Update the bug duplicate via the LP API
 */
function update_bug_duplicate(data) {
    // Hide the formoverlay:
    duplicate_form_overlay.hide();

    // Add the spinner...
    var dupe_span = Y.get('#mark-duplicate-text');
    dupe_span.addClass('update-in-progress-message');

    // Create the lp client and bug entry if we haven't done so already.
    if (lp_client === undefined) {
        lp_client = new LP.client.Launchpad();
    }

    if (lp_bug_entry === undefined) {
        var bug_repr = LP.client.cache['bug'];
        lp_bug_entry = new LP.client.Entry(
            lp_client, bug_repr, bug_repr.self_link);
    }

    // Set the new duplicate link on the bug entry.
    var new_dup_url = null;
    var new_dup_id = data['field.duplicateof'];
    if (new_dup_id != '') {
        var self_link = lp_bug_entry.get('self_link')
        var last_slash_index = self_link.lastIndexOf('/');
        new_dup_url = self_link.slice(0, last_slash_index+1) + new_dup_id;
    }
    var old_dup_url = lp_bug_entry.get('duplicate_of_link');
    lp_bug_entry.set('duplicate_of_link', new_dup_url);

    // Create a config for the lp_save method
    config = {
        on: {
            success: function(updated_entry) {
                dupe_span.removeClass('update-in-progress-message');
                lp_bug_entry = updated_entry;

                // XXX noodles 2009-03-17 bug=336866 It seems the etag
                // returned by lp_save() is incorrect. Remove it for now
                // so that the second save does not result in a '412
                // precondition failed' error.
                lp_bug_entry.removeAtt('http_etag');

                if (new_dup_url !== null) {
                    dupe_span.set('innerHTML', [
                        'Duplicate of <a href=\'/bugs/' + new_dup_id + '\'>',
                        'bug #' + new_dup_id +'</a> ',
                        '<a class=\'menu-link-mark-dupe js-action\' ',
                        'href=\'' + update_dupe_url + '\'>',
                        '<img src=\'/@@/edit\' /></a>'
                        ].join(''));
                } else {
                    dupe_span.set('innerHTML',
                        '<a class=\'menu-link-mark-dupe js-action\' href=\'' +
                        update_dupe_url + '\'>' +
                        '<img src=\'/@@/bug-dupe-icon\' /> ' +
                        'Mark as duplicate</a>');
                }
                Y.lazr.anim.green_flash({node: dupe_span}).run();
                // ensure the new link is hooked up correctly:
                dupe_span.query('a.menu-link-mark-dupe').on(
                    'click', function(e){
                        e.preventDefault();
                        duplicate_form_overlay.show();
                    });
            },
            failure: function(id, request) {
                dupe_span.removeClass('update-in-progress-message');
                if (request.status == 400) {
                    duplicate_form_overlay.showError(
                        new_dup_id + ' is not a valid bug number or' +
                        ' nickname.');
                } else {
                    duplicate_form_overlay.showError(request.responseText);
                }
                duplicate_form_overlay.show();

                // Reset the lp_bug_entry.duplicate_of_link as it wasn't
                // updated.
                lp_bug_entry.set('duplicate_of_link', old_dup_url);

            }
        }
    };

    // And save the updated entry.
    lp_bug_entry.lp_save(config);
}

});
      </script>" />
    </metal:block>

    <div metal:fill-slot="main" tal:define="context_menu context/menu:context">
      <p class="object timestamp">

          Bug #<tal:block content="context/bug/id"/> reported
          by <tal:reporter replace="structure context/bug/owner/fmt:link" />
          <span
              tal:attributes="title context/bug/datecreated/fmt:datetime"
              tal:content="context/bug/datecreated/fmt:displaydate" />
          <tal:activitylog
            define="link context_menu/activitylog"
            condition="link/enabled"
          >(<tal:link replace="structure link/render" />)</tal:activitylog>

      </p>
      <div class="object identifier">

          <a tal:attributes="href context/bug/fmt:url">
            <tal:icon replace="structure context/image:icon" />
            Bug #<span tal:content="context/bug/id"
            >12345</span><tal:nickname
                          condition="context/bug/name">
          (<tal:nicknametext replace="context/bug/name" />)</tal:nickname>:</a>

      </div>
      <tal:privacy replace="structure context/bug/@@+portlet-privacy" />
      <h1 tal:replace="structure view/bug_title_edit_widget">
        Bug title
      </h1>

      <tal:block condition="view/reportBugInContext" />

      <p class="informational message"
         tal:condition="view/notices"
         tal:repeat="notice view/notices"
         tal:content="notice">
        Reported this bug as also occurring in upstream firefox
      </p>

      <p
         id="can-expire"
         tal:condition="context/bug/can_expire"
         >
        <tal:expiration_message replace="view/expiration_message" />
        (<a href="https://help.launchpad.net/BugExpiry">find out why</a>)
      </p>

      <p id="bug-is-question" class="informational message"
         tal:condition="context/bug/getQuestionCreatedFromBug"
         tal:define="question context/bug/getQuestionCreatedFromBug">
        This bug report was converted into a question:
        question #<tal:question-id replace="question/id" />:
        <a href=""
           tal:attributes="href question/fmt:url"
           tal:content="question/title">%s</a>.
        <tal:XXX condition="nothing">
          # XXX mpt 20080716 bug=249094: This should be an alert only when
          # you have just now converted the report into a question.
        </tal:XXX>
      </p>
      <form
          tal:condition="not:view/isReportedInContext"
          class="error message"
          name="alsooccursin"
          method="POST"
          >

        This bug isn't linked to
        <strong><a
           tal:attributes="href string:${context/target/fmt:url}"
           tal:content="context/bugtargetdisplayname"
           >Mozilla Firefox</a></strong>.  Would you like to report it here as
           well?<br/>

        <tal:loggedin condition="request/lp:person">

          <center><input
              type="submit"
              name="reportbug"
              value=""
              tal:attributes="value string:Yes, report in ${context/bugtargetdisplayname}"
              /></center>
        </tal:loggedin>
        <tal:notloggedin condition="not:request/lp:person">
          If you want to report it in <tal:block
          content="context/bugtargetdisplayname" />,
          you must <a href="+login">log in</a> first.
        </tal:notloggedin>

      </form>

      <table style="width: 100%; margin-bottom: 0.33em;">
        <tr>
          <td style="text-align: left; width: 50%;">
            <span id="mark-duplicate-text"
                tal:define="link context_menu/markduplicate"
                tal:condition="python: link.enabled and not
                              context.bug.duplicateof"
            >
            <a
              tal:attributes="href link/url"
              class="menu-link-mark-dupe">
              <img src="/@@/bug-dupe-icon" /> Mark as duplicate</a>
            </span>
            <tal:block
              tal:condition="context/bug/duplicates"
              tal:define="number_of_dupes context/bug/duplicates/count"
            ><span id="number_of_dupes">(This bug has
            <tal:num-dupes condition="python:number_of_dupes == 1">1
            duplicate)</tal:num-dupes>
            <tal:num-dupes condition="python:number_of_dupes > 1"
            content="string:${number_of_dupes} duplicates)"
            >2 duplicates</tal:num-dupes></span>
            </tal:block>
            <tal:block
              tal:define="duplicateof context/bug/duplicateof"
              tal:condition="duplicateof"
            >
              <span id="mark-duplicate-text">Duplicate of
              <a
                tal:condition="duplicateof/required:launchpad.View"
                tal:attributes="href duplicateof/fmt:url; title
                   duplicateof/title; style string:margin-right: 4px;
                   id string:duplicate-of;"
                tal:content="string:bug #${duplicateof/id}"
              >bug #42</a>
                <span
                  tal:condition="not:duplicateof/required:launchpad.View"
                  tal:replace="string:bug #${duplicateof/id}" />
            <a
              tal:define="link context_menu/markduplicate"
              tal:condition="python: link.enabled"
              id="change_duplicate_bug"
              title="Edit or remove linked duplicate bug"
              tal:attributes="href link/url">
              <img src="/@@/edit" />
            </a>
            </span>
            </tal:block>
          </td>

          <td style="text-align: right; width: 50%;">
            <tal:createquestion
              define="link context_menu/createquestion"
              condition="link/enabled"
              replace="structure link/render" />

            <tal:removequestion
              define="link context_menu/removequestion"
              condition="link/enabled"
              replace="structure link/render" />
          </td>
        </tr>
      </table>

      <div tal:replace="structure context/bug/@@+bugtasks-and-nominations-table" />

      <div id="maincontentsub">
        <div id="nonportlets">

      <div class="report">
        <tal:description
            define="global description context/bug/description/fmt:obfuscate-email/fmt:text-to-html" />

        <div id="bug-description" tal:content="structure description" />

          <div id="bug-tags" tal:condition="context/bug/tags"
               style="width: 45%: text-align: left; float: right;">
            Tags:
            <a tal:repeat="tag view/official_tags"
               tal:content="tag"
               class="official-tag"
               tal:attributes="href string:${context/target/fmt:url}/+bugs?field.tag=${tag}">tag</a>
            <a tal:repeat="tag view/unofficial_tags"
               tal:content="tag"
               class="unofficial-tag"
               tal:attributes="href string:${context/target/fmt:url}/+bugs?field.tag=${tag}">tag</a>
          </div>

          <div style="width: 45%: text-align: right; float: left;" class="clearfix">
            <tal:editdescription
                define="link context_menu/editdescription"
                condition="link/enabled"
                replace="structure link/render" />
            <span tal:condition="view/wasDescriptionModified" class="discreet"
            >(see <a href="comments/0">original description</a>)</span>
          </div>

        <div class="clearfix"></div>
      </div>

      <tal:branches define="bug_branches view/bug_branches"
                    condition="bug_branches">

        <h2>Related branches</h2>

        <tal:bug-branches repeat="bug_branch bug_branches">
          <div tal:define="show_edit bug_branch/required:launchpad.Edit"
               tal:condition="bug_branch/branch/required:launchpad.View">
            <div class="bug-branch-summary">
              <tal:branch-ref replace="structure bug_branch/branch/fmt:link"/>
              (<span tal:content="bug_branch/branch/lifecycle_status/title"
              tal:attributes="class string:branchstatus${bug_branch/branch/lifecycle_status/name}"
              >Experimental</span>)
              <tal:bug_branch_status condition="not: show_edit|nothing"
                                     replace="bug_branch/status/title"/>
              <a tal:condition="show_edit"
                 tal:attributes="href string:${bug_branch/branch/fmt:url}/+bug/${bug_branch/bug/id}/+edit;
                                 onclick string:return switchBugBranchFormAndWhiteboard('${bug_branch/id}')">
                <img src="/@@/bug-status-expand"/>
              </a>
              <dl tal:condition="bug_branch/whiteboard"
                  tal:attributes="id string:bugbranch${bug_branch/id}-wb">
                <dd>
                  <tal:whiteboard content="structure bug_branch/whiteboard/fmt:text-to-html">
                    The whiteboard.
                  </tal:whiteboard>
                </dd>
              </dl>
            </div>
            <div tal:condition="show_edit|nothing"
                 tal:attributes="id string:bugbranch${bug_branch/id}"
                 style="display: none"
                 >
              <dl><dd>
                <tal:edit-form replace="structure bug_branch/@@+bug-edit"/>
              </dd></dl>
            </div>
          </div>
        </tal:bug-branches>
      </tal:branches>

      <p>
        <tal:addbranch
            define="link context_menu/addbranch"
            condition="link/enabled"
            replace="structure link/render" />
      </p>

      <div tal:condition="context/bug/cves">
        <h2>CVE References</h2>
        <ul>
          <li class="cve" tal:repeat="cve context/bug/cves">
            <a tal:attributes="href cve/fmt:url;
                               title cve/description/fmt:shorten/40"
               tal:content="cve/sequence"
               >2002-1342</a>
          </li>
        </ul>
      </div>
      <div class="actions">
        <tal:linktocve
            define="link context_menu/linktocve"
            condition="link/enabled"
            replace="structure link/render" />
        <tal:unlinkcve
            define="link context_menu/unlinkcve"
            condition="link/enabled"
            replace="structure link/render" />
      </div>

      <tal:comments>
        <tal:comment repeat="comment_or_activity view/activity_and_comments">
          <tal:is-comment
              define="comment comment_or_activity/comment|nothing"
              condition="comment">
            <tal:comment-box condition="python: comment.can_be_shown and
                                       (view.user_is_admin or
                                       comment.visible)">
              <metal:comment-box
                  metal:use-macro="context/@@bugcomment-macros/comment-box" />
            </tal:comment-box>
          </tal:is-comment>

          <tal:is-activity
              define="activity_list comment_or_activity/activity|nothing;
                      activity_date comment_or_activity/date|nothing;
                      activity_person comment_or_activity/person|nothing"
              condition="activity_list">
              <metal:comment-box
                  metal:use-macro="context/@@bugcomment-macros/activity-box" />
          </tal:is-activity>
        </tal:comment>

        <tal:comment-list-complete
            tal:condition="not:view/visible_comments_truncated_for_display">
          <tal:logged-in condition="view/user">
            <fieldset class="collapsible collapsed" id="add-comment-form">
              <legend><a href="+addcomment">Add a comment/attachment</a></legend>
              <div tal:content="structure context/@@+addcomment-form" />
            </fieldset>
          </tal:logged-in>

          <tal:not-logged-in condition="not: view/user">
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a
              href="+login?comments=all">log in</a>.
            </div>
          </tal:not-logged-in>
        </tal:comment-list-complete>
        <tal:comment-list-truncated
            tal:condition="view/visible_comments_truncated_for_display">
          <div class="informational message">
            Displaying first <span
            tal:replace="view/visible_comments_for_display/count:len" />
            comments.
            <tal:what-next
                define="view_all_href
                        string:${context/fmt:url}?comments=all">
              <a href="#" tal:attributes="href view_all_href">
                View all <span
                tal:replace="view/visible_comments/count:len" />
                comments</a> or <a href="#" tal:attributes="href
                view_all_href">add a comment</a>.
            </tal:what-next>
          </div>
        </tal:comment-list-truncated>
      </tal:comments>

      <div id="mentoring" style="margin-top: 2em;">
        <tal:mentors define="mentoring_offers context/bug/mentoring_offers"
                     condition="mentoring_offers">
          <p>
            <b>Mentors:</b>
            <tal:block repeat="mentoring_offer mentoring_offers">
              <a tal:replace="structure mentoring_offer/owner/fmt:link">foobar</a>
            </tal:block>
          </p>
          <tal:block condition="not: context/bug/is_complete">
            <div tal:condition="view/userIsMentor" class="actions">
              <img class="inlineLinkIcon" src="/@@/remove" alt=""/><a href="+retractmentoring">Retract my offer of mentorship</a>
            </div>
          </tal:block>
        </tal:mentors>
        <p tal:define="link context_menu/offermentoring"
             tal:condition="link/enabled"
             tal:content="structure link/render"
        />
      </div>
      <div class="related">
        <h2>What next?</h2>
        <ul>
          <li>
            <a
                tal:attributes="href string:${context/target/fmt:url}/+filebug"
                >Report another bug</a>
            about <tal:context replace="context/target/displayname" />
          </li>
          <li>
            <a
                tal:attributes="href string:${context/target/fmt:url}/+bugs"
                >List open bugs</a>
            for <tal:context replace="context/target/displayname" />
          </li>
        </ul>
      </div>

        </div><!-- id="nonportlets"-->
      </div><!--- id="maincontentsub"-->
      <div id="portlets">
        <div tal:replace="structure context/bug/@@+portlet-duplicates" />
        <div tal:replace="structure context/bug/@@+portlet-subscribers" />
        <div tal:replace="structure context/bug/@@+portlet-questions" />
        <div tal:replace="structure context/bug/@@+portlet-specs" />
        <div tal:replace="structure context/bug/@@+portlet-attachments" />
        <div tal:replace="structure context/bug/@@+portlet-watch" />
        <div tal:replace="structure context/@@+portlet-search" />
      </div>
    </div>
  </body>
</html>
