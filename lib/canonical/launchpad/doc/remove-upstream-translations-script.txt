This test checks the admin script 'remove-upstream-translations-script.py'.
That script allows us to remove all translations comming from upstream
to fix broken data that would pollute our suggestions database.

It was developed to fix bug #32610.

First we do some needed initializations.

    >>> from canonical.launchpad.ftests.harness import LaunchpadTestSetup
    >>> LaunchpadTestSetup(dbuser='rosettaadmin').setUp()
    >>> import subprocess, sys

Now, we must be sure that we don't break if the user doesn't give us the
required arguments.

    >>> process = subprocess.Popen([
    ...     sys.executable,
    ...     'scripts/rosetta/remove-upstream-translations.py',
    ...     '-p', 'evolution', '-vvv'],
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.STDOUT
    ...     )
    >>> (output, empty) = process.communicate()
    >>> print output
    WARNING Nothing to do. Exiting...
    <BLANKLINE>

We can remove all translations from a concrete potemplate.

    >>> process = subprocess.Popen([
    ...     sys.executable,
    ...     'scripts/rosetta/remove-upstream-translations.py',
    ...     '-d', 'ubuntu', '-r', 'hoary', '-n', 'evolution', '-vvv'],
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.STDOUT
    ...     )
    >>> (output, empty) = process.communicate()
    >>> print output
    DEBUG   Processing Spanish (es) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Before the removal, latest submission came from: Valentina Commissari
    DEBUG   Removed 12 submissions
    DEBUG   After the removal, latest submission came from: Foo Bar
    DEBUG   Processing Japanese (ja) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Before the removal, latest submission came from: Carlos Perelló Marín
    DEBUG   Removed 0 submissions
    DEBUG   After the removal, latest submission came from: Carlos Perelló Marín
    DEBUG   Processing Xhosa (xh) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Removed 0 submissions
    DEBUG   Removed 12 submissions in total.
    <BLANKLINE>

We need to force a DB reset because the changes are done from an external
script and the test system is not able to detect the database changes.

    >>> LaunchpadTestSetup().force_dirty_database()
    >>> LaunchpadTestSetup().tearDown()

Or with a concrete language.

    >>> LaunchpadTestSetup(dbuser='rosettaadmin').setUp()

    >>> process = subprocess.Popen([
    ...     sys.executable,
    ...     'scripts/rosetta/remove-upstream-translations.py',
    ...     '-d', 'ubuntu', '-r', 'hoary', '-n', 'evolution', '-l', 'es',
    ...     '-vvv'],
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.STDOUT
    ...     )
    >>> (output, empty) = process.communicate()
    >>> print output
    DEBUG   Processing Spanish (es) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Before the removal, latest submission came from: Valentina Commissari
    DEBUG   Removed 12 submissions
    DEBUG   After the removal, latest submission came from: Foo Bar
    DEBUG   Removed 12 submissions in total.
    <BLANKLINE>

We need to force a DB reset because the changes are done from an external
script and the test system is not able to detect the database changes.

    >>> LaunchpadTestSetup().force_dirty_database()
    >>> LaunchpadTestSetup().tearDown()

Or even with a concrete IPOTemplateName.

    >>> LaunchpadTestSetup(dbuser='rosettaadmin').setUp()

    >>> process = subprocess.Popen([
    ...     sys.executable,
    ...     'scripts/rosetta/remove-upstream-translations.py',
    ...     '-d', 'ubuntu', '-r', 'hoary', '-n', 'evolution', '-t', 'evolution-2.2',
    ...     '-vvv'],
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.STDOUT
    ...     )
    >>> (output, empty) = process.communicate()
    >>> print output
    DEBUG   Processing Spanish (es) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Before the removal, latest submission came from: Valentina Commissari
    DEBUG   Removed 12 submissions
    DEBUG   After the removal, latest submission came from: Foo Bar
    DEBUG   Processing Japanese (ja) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Before the removal, latest submission came from: Carlos Perelló Marín
    DEBUG   Removed 0 submissions
    DEBUG   After the removal, latest submission came from: Carlos Perelló Marín
    DEBUG   Processing Xhosa (xh) translation of evolution-2.2 in Ubuntu Hoary package "evolution"...
    DEBUG   Removed 0 submissions
    DEBUG   Removed 12 submissions in total.
    <BLANKLINE>

We need to force a DB reset because the changes are done from an external
script and the test system is not able to detect the database changes.

    >>> LaunchpadTestSetup().force_dirty_database()
    >>> LaunchpadTestSetup().tearDown()

And it also works for products!

    >>> LaunchpadTestSetup(dbuser='rosettaadmin').setUp()

    >>> import subprocess, sys
    >>> process = subprocess.Popen([
    ...     sys.executable,
    ...     'scripts/rosetta/remove-upstream-translations.py',
    ...     '-p', 'evolution', '-s', 'trunk', '-vvv'],
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.STDOUT
    ...     )
    >>> (output, empty) = process.communicate()
    >>> print output
    DEBUG   Processing Spanish (es) translation of evolution-2.2 in Evolution trunk...
    DEBUG   Before the removal, latest submission came from: Mark Shuttleworth
    DEBUG   Removed 12 submissions
    DEBUG   After the removal, latest submission came from: Carlos Perelló Marín
    DEBUG   Removed 12 submissions in total.
    <BLANKLINE>

We need to force a DB reset because the changes are done from an external
script and the test system is not able to detect the database changes.

    >>> LaunchpadTestSetup().force_dirty_database()
    >>> LaunchpadTestSetup().tearDown()

