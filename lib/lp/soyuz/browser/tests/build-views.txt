= Build Pages =

For the subsequent tests we will use a specific 'pmount' build record
from the sampledata which happens to be in FAILEDTOBUILD status.

    >>> from zope.component import getUtility
    >>> from lp.soyuz.interfaces.build import BuildStatus
    >>> from lp.registry.interfaces.distribution import IDistributionSet

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> hoary = ubuntu.getSeries('hoary')
    >>> hoary_pmount = hoary.getSourcePackage('pmount')

    >>> hoary_failed_build = hoary_pmount.getBuildRecords(
    ...      build_state=BuildStatus.FAILEDTOBUILD)[0]


== Build Menu ==

The menu presented in the build page depends on the targeted archive.
For instance the 'PPA' action-menu link is not enabled for builds
targeted to the PRIMARY archive.

    >>> from canonical.launchpad.browser import BuildContextMenu
    >>> build_menu = BuildContextMenu(hoary_failed_build)

    >>> print build_menu.links
    ['ppa', 'records', 'retry', 'rescore']

    >>> build_menu.is_ppa_build
    False

    >>> build_menu.ppa().enabled
    False

The 'PPA' action-menu item will be enabled if we target the build to
Celso's PPA.

    >>> from canonical.launchpad.interfaces import IPersonSet

    >>> cprov = getUtility(IPersonSet).getByName('cprov')
    >>> cprov_failed_build = cprov.archive.getBuildRecords(
    ...      build_state=BuildStatus.FAILEDTOBUILD)[0]

    >>> build_menu = BuildContextMenu(cprov_failed_build)

    >>> print build_menu.links
    ['ppa', 'records', 'retry', 'rescore']

    >>> build_menu.is_ppa_build
    True

    >>> build_menu.ppa().enabled
    True


== Build +index page ==

Setup an 'empty' request:

    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> empty_request = LaunchpadTestRequest(form={})

Let's instantiate the view for +index:

    >>> from zope.component import getMultiAdapter
    >>> hoary_failed_build_view = getMultiAdapter(
    ...     (hoary_failed_build, empty_request), name="+index")

'BuildView.user_can_retry_build' property checks not only the
user's permissions to retry but also if a build is in a status that it
can be retried.

The build cannot be retried (see IBuild) because it's targeted to a
stable distroseries.

    >>> hoary_failed_build.can_be_retried
    False

    >>> hoary_failed_build_view.user_can_retry_build
    False

The Celso's PPA failed-to-build build record can be retried, since PPA
distroseries never freeze.

    >>> cprov_failed_build.can_be_retried
    True

While the build is now in a state to be rebuilt, the view property
still checks to ensure the user has the proper permission. Anonymous
users, obviously, don't have 'launchpad.Edit' permission on this
build.

    >>> cprov_failed_build_view = getMultiAdapter(
    ...     (cprov_failed_build, empty_request), name="+index")

    >>> cprov_failed_build_view.user_can_retry_build
    False

If accessed by an user with the required permission, Foo Bar in this
case, the 'user_can_retry_build' property finally returns True.

    >>> login("foo.bar@canonical.com")

    >>> cprov_failed_build_view = getMultiAdapter(
    ...     (cprov_failed_build, empty_request), name="+index")

    >>> cprov_failed_build_view.user_can_retry_build
    True

Buildd admins can retry any build as long is it's in a state that
permits it to be re-tried.  FAILEDTOBUILD is one of those states:

    >>> from lp.soyuz.tests.test_publishing import (
    ...      SoyuzTestPublisher)
    >>> from lp.soyuz.interfaces.publishing import (
    ...     PackagePublishingStatus)
    >>> test_publisher = SoyuzTestPublisher()
    >>> test_publisher.prepareBreezyAutotest()
    >>> test_source = test_publisher.getPubSource(
    ...     status=PackagePublishingStatus.PUBLISHED,
    ...     sourcename='sourceone')
    >>> [failed_build] = test_source.createMissingBuilds()
    >>> failed_build.buildstate = BuildStatus.FAILEDTOBUILD

    >>> failed_build.can_be_retried
    True

Mr "no privileges" has no rights to retry the build:

    >>> login("no-priv@canonical.com")
    >>> failed_build_view = getMultiAdapter(
    ...     (failed_build, empty_request), name="+index")
    >>> failed_build_view.user_can_retry_build
    False

If he is put in the buildd-admins group, however, he is now able to
retry it.

    >>> buildd_admins = getUtility(IPersonSet).getByName(
    ...     "launchpad-buildd-admins")
    >>> nopriv = getUtility(IPersonSet).getByName("no-priv")
    >>> login("foo.bar@canonical.com")
    >>> buildd_admins.addMember(nopriv, nopriv)

    >>> login("no-priv@canonical.com")
    >>> failed_build_view = getMultiAdapter(
    ...     (failed_build, empty_request), name="+index")
    >>> failed_build_view.user_can_retry_build
    True

See pagetests/soyuz/xx-build-record.txt for further information about
the build-retry permission system.

=== BuildView.has_done_upload property ===

The build view provides the property BuildView.has_done_upload
that returns whether the build has a package upload that has been
accepted and processed. The builds that we are using for testing do
not even have a package upload, so will return False:

    >>> cprov_failed_build_view.has_done_upload
    False

First lets create a package upload for this build:
XXX: noodles 2009-01-16 bug 317863: move this into the STP.

    >>> from lp.soyuz.interfaces.publishing import (
    ...     PackagePublishingPocket)
    >>> from lp.soyuz.model.queue import PackageUploadBuild
    >>> build = cprov_failed_build_view.context
    >>> package_upload = build.distroseries.createQueueEntry(
    ...     PackagePublishingPocket.UPDATES, 'changes.txt', 'my changes',
    ...     build.archive)
    >>> package_upload_build = PackageUploadBuild(
    ...     packageupload =package_upload,
    ...     build=cprov_failed_build_view.context)

The status of the package upload will, by default, be NEW:

    >>> print package_upload.status.name
    NEW

Now, even though our build has a package upload, because the status is
not DONE, has_done_upload is still False:

    >>> cprov_failed_build_view.has_done_upload
    False

But once the upload has been accepted and processed, has_done_upload
is True:

    >>> login('foo.bar@canonical.com')
    >>> package_upload.setDone()
    >>> login("no-priv@canonical.com")

    >>> cprov_failed_build_view.has_done_upload
    True

= BuildRecordsView =

The BuildRecordsView can also be used to filter by architecture tag.

    >>> view = create_initialized_view(
    ...     hoary, name="+builds", form={'build_state': 'all'})
    >>> view.setupBuildList()
    >>> for build in view.complete_builds:
    ...     print build.arch_tag
    i386
    ...
    hppa
    ...

    >>> view = create_initialized_view(
    ...     hoary, name="+builds", form={
    ...         'build_state': 'all',
    ...         'arch_tag': 'hppa',
    ...         })
    >>> view.setupBuildList()
    >>> for build in view.complete_builds:
    ...     print build.arch_tag
    hppa

The architecture_options property iterates through the available
architectures of the context constructing a distinct, sorted list
of options for the template.

    >>> view = create_initialized_view(
    ...     ubuntu, name="+builds", form={
    ...         'build_state': 'all',
    ...         'arch_tag': 'hppa',
    ...         })
    >>> for option in view.architecture_options:
    ...     option_str = option['name']
    ...     if option['selected'] is not None:
    ...         option_str += " (selected)"
    ...     print option_str
    All architectures
    hppa (selected)
    i386


