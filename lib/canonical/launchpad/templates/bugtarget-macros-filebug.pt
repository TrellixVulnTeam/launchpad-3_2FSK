<tal:root
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  omit-tag="">
<metal:basic_filebug_widgets define-macro="basic_filebug_widgets">

  <tal:bugtarget
      tal:define="widget nocall:view/widgets/bugtarget|nothing"
      tal:condition="widget">
    <metal:widget use-macro="context/@@launchpad_form/widget_row" />
  </tal:bugtarget>

  <tr tal:condition="view/widgets/packagename|nothing">
    <th colspan="2" style="text-align: left"><label
        tal:attributes="for view/widgets/packagename/name"
        >In what package did you find this bug?</label>
    </th>
  </tr>

  <tr tal:condition="view/widgets/packagename|nothing">
    <td style="padding-bottom: 1.5em" colspan="2"
        tal:attributes="class view/getPackageNameFieldCSSClass">
      <ul style="list-style: none"
          tal:define="select_packagename view/shouldSelectPackageName">
        <li>
          <input type="radio" name="packagename_option" value="none"
                 id="no-package"
                 tal:attributes="checked not:select_packagename"/>
          <label style="font-weight: normal" for="no-package">
            I don't know
          </label>
        </li>
        <li style="margin-top: 4px">
          <input type="radio" name="packagename_option" value="choose"
                 id="choose"
                 tal:attributes="checked select_packagename"/>
          <span tal:content="structure view/widgets/packagename" />
        </li>
      </ul>
      <div
        tal:condition="view/widget_errors/packagename|nothing"
        class="message"
        tal:content="view/widget_errors/packagename"
      >An error on package name.</div>
    </td>
  </tr>

  <tal:product tal:define="widget nocall:view/widgets/product|nothing"
               tal:condition="widget">
    <metal:widget use-macro="context/@@launchpad_form/widget_row" />
  </tal:product>

  <metal:summary tal:define="widget nocall:view/widgets/title">
    <metal:row use-macro="context/@@launchpad_form/widget_row" />
  </metal:summary>

  <metal:description tal:define="widget nocall:view/widgets/comment">
    <metal:row use-macro="context/@@launchpad_form/widget_row" />
  </metal:description>

  <metal:bug_reporting_guidelines
      use-macro="context/@@+filebug-macros/bug_reporting_guidelines" />

  <tr tal:define="security_context view/getSecurityContext">
    <td colspan="2" width="100%"
        tal:define="widget nocall: view/widgets/security_related">
      <table>
        <tbody>
          <tr>
            <td>
              <input type="checkbox" tal:replace="structure widget" />
            </td>
            <td>
              <label tal:attributes="for widget/name">
                This bug is a security vulnerability
              </label>
              <div tal:condition="view/can_decide_security_contact"
                   tal:define="security_contact security_context/security_contact|nothing">
                <tal:security-contact tal:condition="security_contact">
                  The security contact for
                  <tal:security-context content="security_context/displayname" />,
                  <a tal:replace="structure security_contact/fmt:link" />,
                  will be notified.
                </tal:security-contact>
                <tal:maintainer condition="not:security_contact"
                   define="maintainer security_context/owner">
                  The maintainer of
                  <tal:security-context content="security_context/displayname">
                    Mozilla Firefox</tal:security-context>,
                  <a tal:replace="structure maintainer/fmt:link">
                    Sample Person</a>,
                  will be notified.
                </tal:maintainer>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </td>
  </tr>

  <tr>
    <td colspan="2">
      <fieldset class="collapsible collapsed">
        <legend>Extra options</legend>
        <table>
          <tal:status
              define="widget nocall:view/widgets/status|nothing"
              condition="widget">
            <metal:row use-macro="context/@@launchpad_form/widget_row" />
          </tal:status>
          <tal:importance
              define="widget nocall:view/widgets/importance|nothing"
              condition="widget">
            <metal:row use-macro="context/@@launchpad_form/widget_row" />
          </tal:importance>
          <tal:milestone
              define="widget nocall:view/widgets/milestone|nothing"
              condition="widget">
            <metal:row use-macro="context/@@launchpad_form/widget_row" />
          </tal:milestone>
          <tal:tags tal:define="widget nocall:view/widgets/tags">
            <metal:row use-macro="context/@@launchpad_form/widget_row" />
          </tal:tags>
          <tal:assignee
              define="widget nocall:view/widgets/assignee|nothing"
              condition="widget">
            <metal:row use-macro="context/@@launchpad_form/widget_row" />
          </tal:assignee>
        </table>
        <metal:attachment-form
            use-macro="context/@@bug-attachment-macros/attachment-form" />
      </fieldset>
    </td>
  </tr>

</metal:basic_filebug_widgets>


<metal:not_uses_malone define-macro="not_uses_malone">

  <tal:not_uses_malone tal:condition="not: view/contextUsesMalone">

    <tal:has-context define="product_or_distro view/getProductOrDistroFromContext"
                     condition="product_or_distro">

      <p class="warning message">
        <span tal:replace="product_or_distro/displayname">Alsa Utils</span> does not use
        Launchpad as its bug tracker.
        <br />
        <span tal:condition="view/frontpage_form">
          You can <a href="+filebug">refine and resubmit</a> your bug report.
        </span>
      </p>

      <tal:upstream condition="view/contextIsProduct">

        <tal:defines define="bugtracker product_or_distro/getExternalBugTracker">

          <h3>Are you sure this bug is in <acronym class="explain" style="color: inherit"
                                title="the original developer of the software">upstream</acronym>
                                <span tal:replace="product_or_distro/displayname" />?</h3>

          <ul class="info">
            <li tal:condition="product_or_distro/distrosourcepackages">
              If you are using a package installed by your Linux
              distribution, <b>the bug should be reported in that
              distribution</b>, instead. Launchpad knows that <span
              tal:replace="product_or_distro/displayname" /> is present in
              the following distribution packages:
                  <ul class="source package" tal:repeat="dsp product_or_distro/distrosourcepackages">
                      <li><a tal:attributes="href dsp/fmt:url"><span tal:replace="dsp/distribution/displayname" /> <span tal:replace="dsp/sourcepackagename" /></a>
                      </li>
                  </ul>
              You can report bugs by visiting the package's page.
            </li>

            <br />
            <li tal:condition="not: product_or_distro/distrosourcepackages">If
              the bug you are reporting is in a package installed by a <a
              href="/distros">distribution registered in Launchpad</a>, you should file the bug
              against that specific distribution.

              <tal:XXX condition="nothing">
                # XXX: Graham Binns 2007-07-12 bug=125574:
                # The formatting of this next paragraph seems a little
                # odd when seen in the context of a product that does not
                # use Malone and does not specify another bug tracker.
                # For an example of this, see
                # http://bugs.launchpad.dev/thunderbird/+filebug.
              </tal:XXX>
              <p class="helpwanted message">Launchpad doesn't know of
              any distribution packages that include upstream <span
              tal:replace="product_or_distro/displayname" />. You can
              help by <a tal:attributes="href
              string:${product_or_distro/development_focus/fmt:url}/+ubuntupkg">linking
              them for us.</a></p>
            </li>

            <tal:has-bugtracker condition="bugtracker">
              <br />
              <li id="bugtarget-upstream-bugtracker-info">
                Bugs in
                <abbr title="the original developer of the software"
                      class="explain">upstream</abbr>
                <span tal:replace="product_or_distro/displayname">
                  Alsa Utils
                </span>
                <tal:action
                    define="via_email
                            bugtracker/bugtrackertype/enumvalue:EMAILADDRESS">
                  <tal:via-email condition="via_email">
                    should be sent to
                    <a tal:replace="structure bugtracker/fmt:external-link" />
                  </tal:via-email>
                  <tal:not-via-email condition="not:via_email">
                    should be reported in its official bug tracker,
                    <a tal:replace="structure bugtracker/fmt:external-title-link" />
                  </tal:not-via-email>
                </tal:action>
              </li>
            </tal:has-bugtracker>

          </ul>

          <tal:XXX condition="nothing">
            # XXX: kiko 2007-03-14:
            # We shouldn't be using feedback@launchpad.net, but we have no
            # way of allowing people to go around changing product bugtracker
            # details, so for now it will have to do.
          </tal:XXX>
          <p tal:condition="not: bugtracker" class="helpwanted message">
              Launchpad doesn't know what bug tracker <span
              tal:replace="product_or_distro/displayname">Alsa Utils</span>
              uses. Do you know? <a href="mailto: feedback@launchpad.net">Tell us about it.</a>
          </p>
        </tal:defines>

      </tal:upstream>


      <tal:distro condition="not: view/contextIsProduct">

        To file a bug for this distribution, visit its official bug
        tracker.

      </tal:distro>
    </tal:has-context>

    <tal:project condition="view/contextIsProject">

      <p class="informational message"
        condition="not: context/required:launchpad.Edit"
      >
        There are no projects registered for
        <span tal:replace="context/displayname">project displayname</span>
        that use Launchpad to track bugs.
      </p>

      <tal:admin-warning condition="context/required:launchpad.Edit">
        <p tal:condition="not: context/products" class="warning message">
          There are no projects registered for
          <span tal:replace="context/displayname">project displayname</span>.
          <br />
          You need to <a href="+newproduct">register another project that is
          part of <tal:project replace="context/displayname" /></a> or
          associate an existing project with it.
        </p>
      </tal:admin-warning>

      <tal:has-products condition="context/products">

        <tal:plural condition="python:context.products.count() > 1">
          <p id="product-list-summary">
            There are <tal:count replace="context/products/count" /> projects
            registered as part of <tal:project replace="context/displayname" />
            but none of them use Launchpad as their bug tracker.
          </p>
          <p>
            However, it may be possible for you to file a bug against a
            specific project in a source package with which it is registered
            or in an external bug tracker.
          </p>
          <p>
            The projects that are part of
            <tal:project replace="context/displayname" />
            are listed below, along with
            the source packages with which they are registered and their
            external bug trackers.  If you can't find an appropriate place
            to file your bug, please try contacting the administrator of
            <tal:project replace="context/displayname" />.
          </p>
        </tal:plural>
        <tal:singular condition="python:context.products.count() == 1">
          <p id="product-list-summary">
            There is 1 project registered as part of
            <tal:project replace="context/displayname">Project</tal:project>
            but it does not use Launchpad as its bug tracker.
          </p>
          <p>
            The details of the project are shown below, along with any source
            packages with which it is registered and its external bug tracker,
            if it uses one. If you can't find an appropriate place to file
            your bug, please contact the administrator of
            <tal:project replace="context/displayname">Project</tal:project>.
          </p>
        </tal:singular>

        <ul class="product-bug-options" tal:repeat="product context/products">
          <li condition="product/official_malone">
            <tal:link replace="structure product/fmt:link" />

            <ul>
              <tal:external-tracker
                  define="bugtracker product/getExternalBugTracker">

                <li tal:condition="bugtracker">
                  External bug tracker:
                  <a tal:attributes="href bugtracker/baseurl"
                      tal:content="bugtracker/title">
                    Bug Tracker
                  </a>.
                </li>

                <li tal:condition="not: bugtracker">
                   <tal:product replace="product/displayname">
                     Project
                   </tal:product>
                   does not use an external bug tracker or has not registered
                   it with launchpad.
                </li>
              </tal:external-tracker>

              <tal:packages define="packages product/distrosourcepackages">

                <li tal:condition="packages">
                  <ul tal:repeat="package packages">
                    <li class="source package">
                      Source package:
                      <a tal:attributes="href package/fmt:url">
                        <tal:displayname
                            replace="package/distribution/displayname" />
                        <tal:packagename replace="package/sourcepackagename" />
                      </a>
                      (<a
                         tal:attributes="href string:${package/fmt:url}/+filebug"
                       >File a bug here</a>)
                    </li>
                  </ul>
                </li>

                <li tal:condition="not: packages">
                  <tal:product replace="product/displayname">
                    Project
                  </tal:product>
                  is not registered with any source packages. You can help by
                  <a tal:attributes="href string:${product/development_focus/fmt:url}/+ubuntupkg">linking them for us.</a>
                </li>

              </tal:packages>
            </ul>
          </li>
        </ul>

      </tal:has-products>

    </tal:project>
  </tal:not_uses_malone>

</metal:not_uses_malone>


<metal:bug_reporting_guidelines define-macro="bug_reporting_guidelines">
  <tr tal:define="guidelines view/bug_reporting_guidelines"
      tal:condition="guidelines">
    <td colspan="2" id="bug-reporting-guidelines">
      <tal:guidelines repeat="guideline guidelines">
        <h3><span tal:replace="guideline/source" /> guidelines:</h3>
        <div tal:content="structure guideline/content/fmt:text-to-html" />
      </tal:guidelines>
    </td>
  </tr>
</metal:bug_reporting_guidelines>

<metal:similar-bugs define-macro="display-similar-bugs">
  <ul id="similar-bugs" style="list-style: none; margin-left: 0; margin-bottom: 0">
    <li tal:repeat="bug view/similar_bugs" class="similar-bug">
      <table tal:define="bugtask python:view.getRelevantBugTask(bug)">
        <tbody>
          <tr>
            <td>
              <input type="radio" name="field.bug_already_reported_as"
                     class="duplicate-bug-button"
                     tal:attributes="
                         id string:bug-already-reported-as-${bug/id};
                         value string:${bug/id};
                         checked python:
                             path('repeat/bug/start') and not (
                             path('view/this_is_my_bug_action/submitted') or
                             path('view/submit_bug_action/submitted'))" />
            </td>
            <td>
              <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                     tal:condition="bugtask"
                     tal:content="structure bugtask/image:icon" />
              <img alt="" src="/@@/bug" tal:condition="not:bugtask" />
            </td>
            <td>
              <div>
                <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                       style="font-weight: normal">
                  #<tal:bug-id replace="bug/id">4</tal:bug-id>
                  <a tal:attributes="href bug/fmt:url"
                     tal:content="bug/title"
                     >Bug title here</a>
                </label>
              </div>

              <div class="lesser" style="margin-bottom: 0.2em">
                <span class="lesser">
                  <tal:bugtask-status tal:condition="bugtask">
                    <span tal:attributes="class string:status${bugtask/status/name}"
                      ><tal:status content="bugtask/status/title" /></span>
                  </tal:bugtask-status>

                  <tal:no-bugtask condition="not: bugtask">
                    <tal:closed condition="bug/is_complete">Closed</tal:closed>
                    <tal:open condition="not:bug/is_complete">Open</tal:open>
                  </tal:no-bugtask>

                  (<tal:comments replace="bug/comment_count" />
                  <tal:one_comment condition="python: bug.comment_count == 1"
                    replace="string: comment"
                    /><tal:plural_comments
                      condition="python: bug.comment_count != 1"
                      replace="string: comments" />)

                  last updated
                  <tal:last-updated
                      content="bug/date_last_updated/fmt:approximatedate">
                    2007-07-03
                  </tal:last-updated>
                </span>
              </div>

              <div class="duplicate-details" tal:attributes="
                  id string:details-for-bug-${bug/id};
                  style python: not path('repeat/bug/start') and not (
                        path('view/this_is_my_bug_action/submitted') or
                        path('view/submit_bug_action/submitted'))
                        and 'display: none'"
                >

                <div class="lesser" style="margin-bottom: 0.5em;"
                    tal:define="description bug/description/fmt:shorten/500/fmt:obfuscate-email/fmt:text-to-html"
                    tal:content="structure description" />

                <div class="lesser" tal:condition="bugtask">
                  <span style="padding-left: 1.5em">
                    <input type="submit"
                        id="field.actions.this_is_my_bug"
                        name="field.actions.this_is_my_bug"
                        value="This is my bug" />
                  </span>
                </div>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </li>
  </ul>

  <p tal:define="error_message view/widget_errors/bug_already_reported_as|nothing"
     tal:condition="error_message" tal:content="error_message" class="error message" />

</metal:similar-bugs>

<metal:similar-bugs-and-filebug-form
    define-macro="show-similar-bugs-and-filebug-form">


  <tal:similar-bugs condition="view/contextUsesMalone">
    <metal:similar-bugs
        use-macro="context/@@+filebug-macros/display-similar-bugs" />

    <ul style="list-style: none; margin-left: 0">
      <li style="margin-top: 1em">
        <tal:comment replace="nothing">
          We hide this next paragraph if the context doesn't use
          malone because in that situation we're showing the form
          after an error message and in that context the message
          makes no sense.
        </tal:comment>
        <table tal:condition="view/contextUsesMalone">
          <tbody>
            <tr>
              <td>
                <input id="bug-not-already-reported" type="radio"
                       name="field.bug_already_reported_as" value=""
                       tal:attributes="checked view/submit_bug_action/submitted|nothing" />
              </td>
              <td>
                <label for="bug-not-already-reported">
                  No, I need to report a new bug
                </label>
              </td>
            </tr>
          </tbody>
        </table>
      </li>
    </ul>

  </tal:similar-bugs>

  <tal:submit-new-bug>
    <div id="bug_reporting_form">
      <a name="form-start" />
      <table class="form">
        <metal:basic_filebug_widgets
            metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
      </table>
      <div class="actions">
        <input tal:replace="structure view/submit_bug_action/render" />
      </div>
    </div>
  </tal:submit-new-bug>

  <script type="text/javascript" tal:condition="view/similar_bugs">
    /*
     * Arrange the bug form for either the state where the user is selecting
     * an existing bug report, or for where they're filing a new bug.
     */
    function arrangeBugForm(event) {
      var no_radiobtn = $('bug-not-already-reported');
      var bugtarget_package_btn = $('field.bugtarget.option.package');

      if (no_radiobtn.checked) {
        showElement('bug_reporting_form');
        // Try to get the whole bug form into view.
        $('field.actions.submit_bug').focus();
        window.location.href = '#form-start';

        if (bugtarget_package_btn != null) {
          if (bugtarget_package_btn.checked) {
            $('field.bugtarget.package').focus();
          } else {
            $('field.comment').focus();
          }
        } else {
          var package_name = $('field.packagename')
          if (package_name != null) {
            package_name.focus();
          } else {
            $('field.comment').focus();
          }
        }
      } else {
        hideElement('bug_reporting_form');
      }

      // Disable "Subscribe to This Bug Report" to avoid accidental use.
      $('field.actions.this_is_my_bug').disabled = no_radiobtn.checked;
    }

    /*
     * On-load, make sure that the 'No' stuff is displayed correctly.
     * We must always work from the data in the form, not just from
     * events. Some browsers (e.g. Firefox) refill the form when a page
     * is refreshed and you don't get onchange/onkeypress events.
     */
    connect(window, 'onload', arrangeBugForm);

    /*
     * Arrange the form if any of the radio buttons are clicked.
     */
    forEach(
      getElementsByTagAndClassName('input', null, 'similar-bugs'),
      function(element) {
        connect(element, 'onclick', arrangeBugForm);
      });
    connect('bug-not-already-reported', 'onclick', arrangeBugForm);
  </script>
</metal:similar-bugs-and-filebug-form>

</tal:root>
