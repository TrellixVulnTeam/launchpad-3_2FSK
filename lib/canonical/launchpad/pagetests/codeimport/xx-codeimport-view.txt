Currently, the pages relating to code imports are only visible to
members of the vcs-imports team and Launchpad admins.  We log in as
David Allouche, a member of vcs-imports (and not an admin):

    >>> browser.addHeader('Authorization',
    ...                   'Basic david.allouche@canonical.com:test')

For now, there is no link to the page that lists all code imports, so
we browse there directly:

    >>> browser.open('http://code.launchpad.dev/+code-imports')

Admins can also browse to this page, although anonymous and ordinary
users cannot:

    >>> admin_browser.open('http://code.launchpad.dev/+code-imports')
    >>> admin_browser.url
    'http://code.launchpad.dev/+code-imports'
    >>> anon_browser.open('http://code.launchpad.dev/+code-imports')
    Traceback (most recent call last):
      ...
    Unauthorized: ...
    >>> user_browser.open('http://code.launchpad.dev/+code-imports')
    Traceback (most recent call last):
      ...
    Unauthorized: ...


There are two CodeImports in the sample data and they both show up in
the page:

    >>> table = find_tag_by_id(browser.contents, 'code-import-listing')
    >>> rows = table.tbody('tr')
    >>> ids = [extract_text(tr.td) for tr in rows]
    >>> ids
    [u'1', u'2']

If we click on the code import's name, we go to the page for that
import:

    >>> browser.getLink('1').click()
    >>> browser.url
    'http://code.launchpad.dev/+code-imports/1'

It displays some information about the code import, for example the
review status and the URL of the Subversion branch the import is from:

    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'review-status'))
    u'Reviewed'
    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'subversion-url'))
    u'http://svn.example.org/svnroot/gnome-terminal/trunk'

There is also a link to the associated branch:

    >>> browser.getLink('GNOME Terminal Import Branch').url
    'http://code.launchpad.dev/~vcs-imports/gnome-terminal/import'

There's a similar page for the other import, which uses CVS:

    >>> browser.getLink('Code Imports').click()
    >>> browser.getLink('2').click()
    >>> browser.url
    'http://code.launchpad.dev/+code-imports/2'
    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'review-status'))
    u'Pending Review'
    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'cvs-root'))
    u':pserver:anonymous@anoncvs.example.org:/cvs/gnome'
    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'cvs-module'))
    u'evolution'

The code import listing is filterable, though only on review status so
far.  There are no invalid imports in the sample data, so if we filter
just on them we'll see the "no imports found" message.

    >>> browser.getLink('Code Imports').click()
    >>> control = browser.getControl(name="field.status")
    >>> control.displayValue = ["Invalid"]
    >>> browser.getControl(name="submit").click()
    >>> extract_text(
    ...     find_tag_by_id(browser.contents, 'no-imports'))
    u'No matching code imports found!'

If we create a lot of imports, the listing view will be batched.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.interfaces import (
    ...     IBranchSet, ICodeImportSet, ILaunchpadCelebrities,
    ...     IPersonSet, IProductSet)
    >>> from canonical.lp.dbschema import RevisionControlSystems

    >>> login('david.allouche@canonical.com')

    >>> code_import_set = getUtility(ICodeImportSet)
    >>> svn = RevisionControlSystems.SVN
    >>> svn_url = 'svn://svn.example.com/trunk-%s'
    >>> nopriv = getUtility(IPersonSet).getByName('no-priv')
    >>> vcs_imports = getUtility(ILaunchpadCelebrities).vcs_imports
    >>> def import_branch_for_new_product(name):
    ...     product = getUtility(IProductSet).createProduct(
    ...         nopriv, name, name, name, name, name)
    ...     return getUtility(IBranchSet).new(
    ...         'trunk', vcs_imports, product, None, 'Import branch')
    >>> for i in range(100):
    ...     new_branch = import_branch_for_new_product('import-%s'%i)
    ...     svn_import = code_import_set.new(
    ...         registrant=nopriv, branch=new_branch,
    ...         rcs_type=svn, svn_branch_url=svn_url%i)

    >>> logout()

    >>> browser.open('http://code.launchpad.dev/+code-imports')
    >>> browser.getLink('Next').click()
    >>> browser.url
    'http://code.launchpad.dev/+code-imports/+index?start=50'
