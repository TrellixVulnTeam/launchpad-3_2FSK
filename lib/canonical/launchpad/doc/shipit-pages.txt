ShipIt Pages
============

    >>> from canonical.launchpad.database import ShippingRequest
    >>> jordis_request = ShippingRequest.get(16)

Let's define a helper function to make it easier to construct a view.

    >>> from zope.component import getView
    >>> from zope.publisher.browser import TestRequest
    >>> from canonical.launchpad.layers import ShipItUbuntuLayer, setFirstLayer
    >>> def create_view(context, name, form=None):
    ...     request = TestRequest(form=form)
    ...     request.notifications = []
    ...     setFirstLayer(request, ShipItUbuntuLayer)
    ...     view = getView(context, name, request)
    ...     return view


/shipit/myrequest
-----------------

This is the only page that normal users have access to. Here they can make new
requests, change/cancel existing ones and see the previous one that were
shipped already.

When making a new request, users have to chose the number of CDs from a set of
predefined options. These options are stored on the StandardShipItRequest
table, and if we don't have a single option in the database, it doesn't make
sense to allow people to use shipit to make new requests, so we'll say that
shipit is closed, in case we don't find any StandardShipItRequest. This can
also be overused to close shipit through the web UI, by simply removing all
StandardShipItRequests.

    >>> from canonical.launchpad.ftests import login
    >>> login('test@canonical.com')
    >>> from canonical.launchpad.systemhomes import ShipItApplication
    >>> shipit = ShipItApplication()
    >>> myrequest_view = create_view(shipit, 'myrequest')
    >>> html = myrequest_view.renderStandardrequestForm()
    >>> 'Request CDs' in html
    True
    >>> 'ShipIt is currently closed' in html
    False

    >>> myrequest_view.is_open = False
    >>> html = myrequest_view.renderStandardrequestForm()
    >>> 'How many CDs would you like?' in html
    False
    >>> 'ShipIt is currently closed' in html
    True


/shipit/requests/$request.id
-----------------

This is the page where shipit admins go to approve, deny or change an existing
request.

In this page we display a table of Flavours X Architectures, containing the
widgets for the quantities of requested CDs of a given flavour and arch. These
widgets must always be ordered according to the order we use in the table
headers, or we'll start shipping wrong CDs to people. This order is specified
by the ordered_flavours and ordered_architectures attributes of the view
class.

    >>> review_request_view = create_view(jordis_request, '+edit')
    >>> [flavour.title for flavour in review_request_view.ordered_flavours]
    ['Ubuntu', 'Kubuntu', 'Edubuntu']

    >>> [arch.title for arch in review_request_view.ordered_architectures]
    ['PC', '64-bit PC']

And this is the order we use when generating the widgets matrix.

    >>> matrix = review_request_view.widgetsMatrixWithFlavours()
    >>> for row in matrix:
    ...     newrow = []
    ...     for cell in row:
    ...         if isinstance(cell, basestring) or cell is None:
    ...             newrow.append(cell)
    ...         else:
    ...             newrow.append(cell.label)
    ...     print newrow
    ['Ubuntu', u'PC', u'64-bit PC']
    ['Kubuntu', u'PC', u'64-bit PC']
    ['Edubuntu', u'PC', None]

Similarly to the quantity widgets, we use a table to display the quantities
requested by the user. But in this case, the shipit admins are not supposed to
change these values, so we don't need widgets.

    >>> for row in review_request_view.quantities_matrix:
    ...     print row
    ['Kubuntu', 5, 0]
    ['Edubuntu', 5, 0]


If the request we're looking at is already approved, we use the approved
quantities as initial values for the widgets. Otherwise we use the requested
quantities as initial values, so that the shipit admin approving the request
don't have to type all the requested quantities in the approved quantities
widgets.

    >>> review_request_view.context.isApproved()
    True
    >>> review_request_view.initial_values
    {'highpriority': True, 'kubuntu_quantityamd64approved': 0,
     'ubuntu_quantityx86approved': 0, 'kubuntu_quantityx86approved': 5,
     'edubuntu_quantityx86approved': 5, 'ubuntu_quantityamd64approved': 0}

    >>> pending_approval_request = ShippingRequest.get(12)
    >>> review_request_view = create_view(pending_approval_request, '+edit')
    >>> review_request_view.context.isApproved()
    False

    >>> for row in review_request_view.quantities_matrix:
    ...     print row
    ['Ubuntu', 10, 0]

    >>> review_request_view.initial_values
    {'highpriority': False, 'kubuntu_quantityamd64approved': 0,
     'ubuntu_quantityx86approved': 10, 'kubuntu_quantityx86approved': 0,
     'edubuntu_quantityx86approved': 0, 'ubuntu_quantityamd64approved': 0}

