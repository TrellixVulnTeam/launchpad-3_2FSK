<html
  xmlns="http://www.w3.org/1999/xhtml"
  xml:lang="en"
  lang="en"
  metal:use-macro="context/@@main_template/master"
  i18n:domain="launchpad">

<body>

<metal:heading fill-slot="pageheading">
  <h1 tal:condition="not: view/similar_bugs">Report a new bug</h1>
  <h1 tal:condition="view/similar_bugs">Has your bug already been reported?</h1>
</metal:heading>

<div metal:fill-slot="main">

  <metal:not_uses_malone
      use-macro="context/@@+filebug-macros/not_uses_malone" />

  <tal:uses_malone tal:condition="view/contextUsesMalone">

  <div metal:use-macro="context/@@launchpad_form/form">

    <div metal:fill-slot="extra_info">
      <p class="informational message"
         tal:condition="not: view/similar_bugs">
        No similar bugs were found.
      </p>
    </div>

    <metal:widgets metal:fill-slot="widgets">

      <div id="bug_reporting_form" tal:condition="not: view/similar_bugs">
        <table class="form">
          <metal:basic_filebug_widgets
              metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
        </table>
        <div class="actions">
          <input tal:replace="structure view/actions/field.actions.submit_bug/render" />
        </div>
      </div>

      <table class="form" tal:condition="view/similar_bugs">
        <tbody>

          <tal:similar-bugs condition="view/contextUsesMalone">
            <tr>
              <td>
                <input type="radio" id="bug-already-reported-yes"
                       name="field.bug_already_reported" value="on"
                       tal:attributes="checked python: not path('view/submit_bug_action/submitted')
                                                       and 'checked' or None" />
              </td>
              <td style="width: 100%">
                <label for="bug-already-reported-yes">
                  Yes, it's one of these:
                </label>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <div id="similar_bugs_form">
                  <ul id="similar-bugs" style="list-style: none; margin-left: 0">
                    <li tal:repeat="bug view/similar_bugs"
                        tal:attributes="title bug/description/fmt:shorten/500"
                        title="bug description goes here">
                      <table tal:define="bugtask python:view.getRelevantBugTask(bug)">
                        <tbody>
                          <tr>
                            <td>
                              <input type="radio" name="field.bug_already_reported_as"
                                     tal:attributes="id string:bug-already-reported-as-${bug/id};
                                                     value string:${bug/id};
                                                     checked repeat/bug/start|nothing" />
                            </td>
                            <td>
                              <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                                     tal:condition="bugtask"
                                     tal:content="structure bugtask/image:icon" />
                              <img alt="" src="/@@/bug" tal:condition="not:bugtask" />
                            </td>
                            <td>
                              <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                                     style="font-weight: normal">
                                <div>
                                  #<tal:bug-id replace="bug/id">4</tal:bug-id>
                                  <a tal:attributes="href bug/fmt:url"
                                     tal:content="bug/title">Bug title here</a>
                                </div>
                                <div class="lesser" tal:condition="bugtask">
                                  <tal:status replace="bugtask/status/title" />,
                                  last updated
                                  <tal:last-updated content="bug/date_last_updated/fmt:approximatedate">
                                    2007-07-03
                                  </tal:last-updated>
                                </div>
                                <div class="lesser" tal:condition="not:bugtask">
                                  <tal:closed condition="bug/is_complete">
                                    Closed <tal:when replace="bug/date_closed/fmt:approximatedate" />
                                  </tal:closed>
                                  <tal:open condition="not:bug/is_complete">
                                    Open, last updated <tal:when replace="bug/date_last_updated/fmt:approximatedate" />
                                  </tal:open>
                                </div>
                              </label>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </li>
                  </ul>

                  <div class="actions">
                    <input tal:replace="structure view/actions/field.actions.this_is_my_bug/render" />
                  </div>
                </div>
              </td>
            </tr>
          </tal:similar-bugs>

          <tal:submit-new-bug>
             <tal:comment replace="nothing">
               We hide this next row if the context doesn't use malone because
               in that situation we're showing the form after an error message
               and in that context the radio button makes no sense.
             </tal:comment>
             <tr tal:condition="view/contextUsesMalone">
              <td>
                <input type="radio" id="bug-already-reported-no"
                       name="field.bug_already_reported" value="off"
                       tal:attributes="checked python: path('view/submit_bug_action/submitted')
                                                       and 'checked' or None" />
              </td>
              <td>
                <label for="bug-already-reported-no">
                  No, I'd like to report a new bug:
                </label>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <div id="bug_reporting_form">
                  <table class="form">
                    <metal:basic_filebug_widgets
                        metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
                  </table>
                  <div class="actions">
                    <input tal:replace="structure view/actions/field.actions.submit_bug/render" />
                  </div>
                </div>
              </td>
            </tr>
          </tal:submit-new-bug>

        </tbody>
      </table>

      <script type="text/javascript" tal:condition="view/similar_bugs">
        var similar_bugs_form_elements = concat(
          getElementsByTagAndClassName('input', null, 'similar_bugs_form'));
        var submit_bug_form_elements = concat(
          getElementsByTagAndClassName('input', null, 'bug_reporting_form'),
          getElementsByTagAndClassName('textarea', null, 'bug_reporting_form'));

        /*
         * On-load, make sure that the 'No' stuff is displayed correctly.
         * We must always work from the data in the form, not just from
         * events. Some browsers (e.g. Firefox) refill the form when a page
         * is refreshed and you don't get onchange/onkeypress events.
         */
        connect(window, 'onload', $('bug-already-reported-no'),
          function(e) {
            var func = this.checked ? showElement : hideElement;
            func('bug_reporting_form');
          });

        /*
         * Show the bug form when the 'No' radio is selected.
         */
        connect('bug-already-reported-no', 'onchange',
          function(e) {
            if (this.checked) {
              showElement('bug_reporting_form');
            }
          });
        // Safari doesn't trigger onchange for radio buttons it seems.
        connect('bug-already-reported-no', 'onclick', function(e) {
            signal(this, 'onchange');
          });

        /*
         * If a similar bug is selected, also select the 'Yes' radio button.
         */
        forEach(similar_bugs_form_elements, function(element) {
            var target = $('bug-already-reported-yes');
            var handler = function(e) {
                target.checked = true;
              };
            if (element.type == 'submit') {
              connect(element, 'onmousedown', handler);
            }
            else {
              connect(element, 'onchange', handler);
              connect(element, 'onclick', handler); // For Safari
            }
          });

        /*
         * If one of the form elements in the 'No' section is changed (or,
         * for immediate feedback, there is a key-press), then select the
         * 'Yes' radio button and signal the 'No' onchange handler.
         */
        forEach(submit_bug_form_elements, function(element) {
            var target = $('bug-already-reported-no');
            var handler = function(e) {
                target.checked = true;
                signal(target, 'onchange');
              };
            if (element.type == 'submit') {
              connect(element, 'onmousedown', handler);
            }
            else {
              connect(element, 'onchange', handler);
              connect(element, 'onkeypress', handler);
            }
          });
      </script>

    </metal:widgets>

    <div class="actions" metal:fill-slot="buttons">
      <tal:comment replace="nothing">
        This suppresses the normal action buttons.
      </tal:comment>
    </div>

  </div>

  </tal:uses_malone>

</div>

</body>
</html>
