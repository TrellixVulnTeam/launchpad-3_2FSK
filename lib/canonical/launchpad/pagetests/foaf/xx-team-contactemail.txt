= Team contact address =

Team admins are allowed to set the contact method used by Launchpad to
send notifications to that team.  The possible contact methods are:

    - None:  There's no way to contact the team as a whole, so any
             notification is sent to every member of the team.

    - External address:  All notifications are sent to the given email
                         address (stored as the team's preferredemail).

    - Hosted mailing list:  Notifications are sent to this team's mailing
                            list hosted on Launchpad.

    >>> browser = setupBrowser(auth='Basic test@canonical.com:test')
    >>> browser.open('http://launchpad.dev/~landscape-developers')
    >>> browser.getLink('Change contact address').click()
    >>> browser.url
    'http://launchpad.dev/~landscape-developers/+contactaddress'

As we can see, the landscape-developers team has no contact address.

    >>> browser.getControl(name='field.contact_method').displayValue
    ['\xa0None; Launchpad will contact team members directly']

Changing it to an external address will require the user to go through
the email address confirmation process.

    >>> browser.getControl('External').selected = True
    >>> browser.getControl(name='field.contact_address').value = 'foo@baz.com'
    >>> browser.getControl('Change').click()

    >>> browser.url
    'http://launchpad.dev/~landscape-developers'
    >>> for msg in get_feedback_messages(browser):
    ...     print msg
    A confirmation message has been sent to...

    >>> from canonical.launchpad.mail import stub
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> assert not stub.test_emails

    # Extract the link (from the email we just sent) the user will have to
    # use to finish the registration process.
    >>> from canonical.launchpad.ftests.logintoken import (
    ...     get_token_url_from_email)
    >>> token_url = get_token_url_from_email(raw_msg)
    >>> token_url
    'http://launchpad.dev/token/...'
    >>> to_addrs
    ['foo@baz.com']

Follow the token link, to confirm the new email address.

    >>> browser.open(token_url)
    >>> browser.url
    'http://launchpad.dev/token/.../+validateteamemail'
    >>> browser.getControl('Continue').click()

    >>> browser.url
    'http://launchpad.dev/~landscape-developers'
    >>> for msg in get_feedback_messages(browser):
    ...     print msg
    Email address successfully confirmed.

    >>> browser.getLink('Change contact address').click()
    >>> browser.url
    'http://launchpad.dev/~landscape-developers/+contactaddress'
    >>> browser.getControl(name='field.contact_method').displayValue
    ['\xa0External contact email']
    >>> browser.getControl(name='field.contact_address').value
    'foo@baz.com'

We can change that to a hosted mailing list, but the change won't have
effect until it's approved by a Launchpad admin.

    >>> browser.getControl('Launchpad hosted').selected = True
    >>> browser.getControl('Change').click()

    >>> browser.url
    'http://launchpad.dev/~landscape-developers'
    >>> for msg in get_feedback_messages(browser):
    ...     print msg
    Mailing list requested and now queued for approval.

    >>> from canonical.launchpad.database import MailingList, Person
    >>> mailing_list = MailingList.selectOneBy(
    ...     team=Person.byName('landscape-developers'))
    >>> mailing_list.status
    <...MailingListStatus.REGISTERED...>

    >>> from canonical.launchpad.interfaces import MailingListStatus
    >>> from canonical.launchpad.ftests import login, logout
    >>> login('foo.bar@canonical.com')
    >>> mailing_list.review(
    ...     Person.byName('name16'), MailingListStatus.APPROVED)
    >>> mailing_list.syncUpdate()
    >>> logout()

    >>> browser.getLink('Change contact address').click()
    >>> for msg in get_feedback_messages(browser):
    ...     print msg
    This team's mailing list has been approved and is being constructed...

When the mailing list is actually constructed, it's used as the team's
contact address.

    >>> mailing_list.startConstructing()
    >>> mailing_list.transitionToStatus(MailingListStatus.ACTIVE)
    >>> mailing_list.syncUpdate()
    >>> browser.reload()
    >>> [msg for msg in get_feedback_messages(browser)]
    []

    >>> browser.getControl(name='field.contact_method').displayValue
    [...Launchpad hosted team mailing list...]


XXX: We don't really want all this functionality to be visible to users
when this code lands on mainline, so there's a config variable which
control its visibility.  That variable is named expose_hosted_mailing_lists
and if it's set to False the option to use a hosted mailing list is not
visible.  This test will go away as soon as we decide to deploy that
functionality on production. -- Guilherme Salgado 2007-09-20

    >>> from canonical.config import config
    >>> config.mailman.expose_hosted_mailing_lists
    True

    >>> radio = browser.getControl(name='field.contact_method')
    >>> radio.displayOptions
    ['\xa0None; Launchpad will contact team members directly',
     '\xa0Launchpad hosted team mailing list
      (i.e. ubuntumembers@teams.launchpad.net)',
     '\xa0External contact email']

    >>> config.mailman.expose_hosted_mailing_lists = False
    >>> browser.reload()
    >>> radio = browser.getControl(name='field.contact_method')
    >>> radio.displayOptions
    ['\xa0None; Launchpad will contact team members directly',
     '\xa0External contact email']

