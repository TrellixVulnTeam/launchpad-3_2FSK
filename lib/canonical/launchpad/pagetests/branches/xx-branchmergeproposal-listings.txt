= Listings of branch merge proposals =

From both the main code page for a person or team, or a product, it is
possible to go to a listing of merge proposals that are either needing a
review, or have been approved for landing.


== Create a new product and merge proposals for it ==

Log-in an administrator to avoid permission problems.

    >>> login('foo.bar@canonical.com')
    >>> fooix = factory.makeProduct(name='fooix')

Make a trunk branch and set as the development focus branch.

    >>> trunk = factory.makeProductBranch(product=fooix)
    >>> fooix.development_focus.branch = trunk

Make a single proposal for albert that is needing review by robert.

    >>> albert = factory.makePerson(
    ...     name='albert', email="albert@example.com", password="test")
    >>> robert = factory.makePerson(name='robert')
    >>> branch = factory.makeProductBranch(
    ...     owner=albert, product=fooix, name='review')
    >>> proposal = branch.addLandingTarget(albert, trunk)
    >>> proposal.requestReview()
    >>> _unused_vote = proposal.nominateReviewer(robert, albert,
    ...                                          review_type='ui')

Make two proposals for bob, one needing review, and one approved.

    >>> bob = factory.makePerson(name='bob')
    >>> branch = factory.makeProductBranch(
    ...     owner=bob, product=fooix, name='review')
    >>> proposal = branch.addLandingTarget(bob, trunk)
    >>> proposal.requestReview()
    >>> # Ensure the date_created is later to ensure stable ordering.
    >>> from datetime import timedelta
    >>> from zope.security.proxy import removeSecurityProxy
    >>> removeSecurityProxy(proposal).date_created += timedelta(1)

    >>> branch = factory.makeProductBranch(
    ...     owner=bob, product=fooix, name='approved')
    >>> proposal = branch.addLandingTarget(bob, trunk)
    >>> proposal.approveBranch(trunk.owner, 'some-revision')
    >>> removeSecurityProxy(proposal).date_created += timedelta(2)
    >>> logout()

    >>> import transaction
    >>> transaction.commit()


== Listings from the main product code page ==

Below the branch counts in the main content, there is a paragraph that lists
the number of active reviews and approved merges.

    >>> browser.open('http://code.launchpad.dev/fooix')
    >>> print_tag_with_id(browser.contents, 'merge-counts')
    2 pending proposals, 1 unmerged proposal

The 'active reviews' and 'approved merge' text are links to the listing pages
for these.

    >>> browser.getLink('pending proposals').click()
    >>> print browser.title
    Pending proposals

The proposals are listed in a table that shows the source and target branches,
who requested the merge, the date the review was requested, and the vote
summary.

    >>> print_tag_with_id(browser.contents, "proposals")
    Branch Merge Proposal   Requested By          Activity
    lp://dev/~bob/fooix/review  &rArr; lp://dev/fooix
            Bob           ...                     None
    lp://dev/~albert/fooix/review &rArr; lp://dev/fooix
            Albert        ...                     None

We go back to the proposals listing, and check the approved merges has
the date the merge was approved.

    >>> browser.open('http://code.launchpad.dev/fooix')
    >>> browser.getLink('unmerged proposal').click()
    >>> print browser.title
    Approved merges for Fooix

    >>> print_tag_with_id(browser.contents, 'proposal-listing')
    Branch Merge Proposal     Requested By     Date Reviewed
    lp://dev/~bob/fooix/approved &rArr; lp://dev/fooix
            Bob ...


== Listings from the main person code page ==

The summary before the branch listings also shows the number of active reviews
and approved merges.

    >>> browser.open('http://code.launchpad.dev/~albert')
    >>> print_tag_with_id(browser.contents, 'page-summary')
    1 owned branch, 1 registered branch, 1 subscribed branch
    1 active proposal, 0 approved merges, 0 requested reviews

    >>> browser.getLink('approved merges').click()
    >>> print_tag_with_id(browser.contents, 'no-proposals')
    Albert has no approved merges.


== Listings for person's requested reviews ==

A person can also list all of their currently requested reviews, and the status
of their reviews

    >>> browser.open('http://code.launchpad.dev/~robert/+requestedreviews')
    >>> print_tag_with_id(browser.contents, 'page-summary')
    0 owned branches, 0 registered branches, 0 subscribed branches
    0 active proposals, 0 approved merges, 1 requested review

    >>> print_tag_with_id(browser.contents, 'proposal-listing')
    Branch Merge Proposal             Requested By    Review
    lp://dev/~albert/fooix/review ... Albert ...      Pending ui

The requested reviews for a team will only ever show pending reviews, as a
team cannot approve a review, only a person can.

    >>> login('foo.bar@canonical.com')
    >>> team = factory.makeTeam(
    ...     owner=albert, name="a-team", displayname="A-Team")
    >>> logout()

    >>> browser = setupBrowser(auth='Basic albert@example.com:test')
    >>> browser.open('http://code.launchpad.dev/~albert/fooix/review')
    >>> browser.getLink('Ready for review').click()
    >>> browser.getLink('Request another review').click()
    >>> browser.getControl('Reviewer').value = 'a-team'
    >>> browser.getControl('Review type').value = 'tag'
    >>> browser.getControl('Request Review').click()

    >>> browser.open('http://code.launchpad.dev/~a-team')
    >>> browser.getLink('requested review').click()
    >>> print_tag_with_id(browser.contents, 'proposal-listing')
    Branch Merge Proposal             Requested By    Review
    lp://dev/~albert/fooix/review ... Albert ...      Pending
