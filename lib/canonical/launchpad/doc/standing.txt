= Personal standing =

People have a property called 'personal standing', which affects their
ability to post to mailing lists that 72they are not members of.  It's a
form of automatic moderation.  Most people have unknown standing, which
is the default.

    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> login('foo.bar@canonical.com')
    >>> lifeless = getUtility(IPersonSet).getByName('lifeless')
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...

A person also has a reason for why their standing is what it is.  The
default value of None means that no reason for the personal_standing
value is available.

    >>> print lifeless.personal_standing_reason
    None

A Launchpad administrator may change a person's standing, and may give a
reason for the change.

    >>> from canonical.launchpad.ftests import syncUpdate
    >>> from canonical.testing import LaunchpadZopelessLayer
    >>> LaunchpadZopelessLayer.switchDbUser('launchpad')

    >>> from canonical.launchpad.interfaces import PersonalStanding
    >>> lifeless.personal_standing = PersonalStanding.GOOD
    >>> lifeless.personal_standing_reason = 'Such a cool guy!'
    >>> syncUpdate(lifeless)

    >>> lifeless.personal_standing
    <DBItem PersonalStanding.GOOD...
    >>> print lifeless.personal_standing_reason
    Such a cool guy!

Non-administrators may not change a person's standing.

    >>> login('test@canonical.com')
    >>> lifeless.personal_standing = PersonalStanding.POOR
    Traceback (most recent call last):
    ...
    Unauthorized: ...
    >>> lifeless.personal_standing_reason = 'Such a cool guy!'
    Traceback (most recent call last):
    ...
    Unauthorized: ...

    >>> login('foo.bar@canonical.com')
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.GOOD...
    >>> print lifeless.personal_standing_reason
    Such a cool guy!
    >>> login(ANONYMOUS)


== Automatic updates ==

Standing can also be calculated by a cron script from the history of
reviewed messages that have been approved by a person.  If a person
posts a message to a mailing list they are not a member of, their
message gets held for moderator approval.

    >>> login('foo.bar@canonical.com')
    >>> from canonical.launchpad.ftests import mailinglists_helper
    >>> team_one, list_one = mailinglists_helper.new_team('test-one', True)
    >>> lifeless.personal_standing = PersonalStanding.UNKNOWN
    >>> lifeless.personal_standing_reason = ''

    # A helper for posting messages to a list.
    >>> from canonical.launchpad.interfaces import (
    ...     IMailingListSet, IMessageSet)
    >>> from email.Utils import formatdate
    >>> def post_message(team_name, message_id):
    ...     message = getUtility(IMessageSet).fromEmail("""\
    ... From: robertc@robertcollins.net
    ... To: %s@lists.launchpad.dev
    ... Subject: Something to think about
    ... Message-ID: %s
    ... Date: %s
    ...
    ... Point of order!
    ... """ % (team_name, message_id, formatdate()))
    ...     mailing_list = getUtility(IMailingListSet).get(team_name)
    ...     held_message = mailing_list.holdMessage(message)
    ...     return held_message

    >>> from canonical.launchpad.scripts.standing import (
    ...     UpdatePersonalStanding)
    >>> from canonical.config import config
    >>> class TestableScript(UpdatePersonalStanding):
    ...     """A testable version of `UpdatePersonalStanding`."""
    ...     def main(self):
    ...         """Set up and restore the script's environment."""
    ...         # Simulate Mailman acting changed state.
    ...         mailinglists_helper.mailman.act()
    ...         # Commit the in-progress transaction, since switching
    ...         # database users does an abort.
    ...         LaunchpadZopelessLayer.txn.commit()
    ...         LaunchpadZopelessLayer.switchDbUser(
    ...             config.standingupdater.dbuser)
    ...         self.txn = LaunchpadZopelessLayer.txn
    ...         results = super(TestableScript, self).main()
    ...         LaunchpadZopelessLayer.switchDbUser('launchpad')
    ...         return results
    >>> script = TestableScript('update-standing', test_args=[])

After one approval, Robert's standing does not change.

    >>> foobar = getUtility(IPersonSet).getByName('name16')
    >>> message = post_message('test-one', '<aardvark>')
    >>> message.approve(foobar)
    >>> script.main()
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

Even after three approvals, if the message was posted to the same list,
Robert's personal standing does not change.

    >>> message = post_message('test-one', '<badger>')
    >>> message.approve(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

    >>> message = post_message('test-one', '<caribou>')
    >>> message.approve(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

Robert needs to get some approvals from a few more mailing lists before
his personal standing can be updated.

    >>> team_two, list_two = mailinglists_helper.new_team('test-two', True)
    >>> team_three, list_three = mailinglists_helper.new_team(
    ...     'test-three', True)

    >>> message = post_message('test-two', '<dingo>')
    >>> message.approve(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

Rejected and discarded messages don't count.

    >>> message = post_message('test-three', '<elephant>')
    >>> message.reject(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

    >>> message = post_message('test-three', '<falcon>')
    >>> message.discard(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.UNKNOWN...>

Robert's next message goes to a third mailing list, and this gets
approved.  As a result, his personal standing gets updated.

    >>> message = post_message('test-three', '<giraffe>')
    >>> message.approve(foobar)
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.GOOD...>

However, Robert's standing will only be updated if it was previously
Unknown.  A standing of Poor, Good or Excellent will not be changed by
the cron script.  The most common case of this is when a person's
standing has been set to Poor by a Launchpad administrator.  In that
case, no amount of approved messages will kick them back to Good
standing.

    >>> lifeless.personal_standing = PersonalStanding.POOR
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.POOR...>

    >>> lifeless.personal_standing = PersonalStanding.GOOD
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.GOOD...>

    >>> lifeless.personal_standing = PersonalStanding.EXCELLENT
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.EXCELLENT...>

Should Robert's standing get kicked back to Unknown, then his approved
messages will count toward his good standing again.

    >>> lifeless.personal_standing = PersonalStanding.UNKNOWN
    >>> syncUpdate(lifeless)
    >>> script.main()
    >>> syncUpdate(lifeless)
    >>> lifeless.personal_standing
    <DBItem PersonalStanding.GOOD...>

    >>> login(ANONYMOUS)


== Cron script ==

XXX Run (some of) this is a cron script.
