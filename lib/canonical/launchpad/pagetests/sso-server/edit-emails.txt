= Managing Email Addresses =

Single sign on users can manage the email addresses associated with
their account through the web.  First lets create a user:

    >>> browser = setupBrowser()
    >>> browser.open('http://openid.launchpad.dev')
    >>> browser.getControl(name='field.email').value = 'new-user@example.com'
    >>> browser.getControl('No, I want to create an account now').click()
    >>> browser.getControl('Continue').click()
    >>> soup = find_main_content(browser.contents)
    >>> print soup.find('h1').renderContents()
    Registration mail sent

    >>> from canonical.launchpad.mail import stub
    >>> from canonical.launchpad.ftests.logintoken import (
    ...     get_token_url_from_email)
    >>> from_addr, to_addr, msg = stub.test_emails.pop()
    >>> token_url = get_token_url_from_email(msg)
    >>> browser.open(token_url)
    >>> print browser.url
    http://openid.launchpad.dev/token/.../+newaccount

    >>> browser.getControl('Name').value = 'New User'
    >>> browser.getControl('Create password').value = 'test'
    >>> browser.getControl(name='field.password_dupe').value = 'test'
    >>> browser.getControl('Continue').click()

The user will now be on the front page, which includes a list of the
email addresses associated with their account:

    >>> print browser.url
    http://openid.launchpad.dev
    >>> print extract_text(find_tag_by_id(browser.contents, 'maincontent'))
    Logged in as New User (edit)
    Emails:
    new-user@example.com


== Adding a new email address ==

The user can manage the email addresses associated with their account
with the edit emails form:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> print extract_text(find_tag_by_id(browser.contents, 'maincontent'))
    Change your e-mail settings
    Your e-mail addresses
      Your preferred contact address for all Launchpad e-mail is:
        new-user@example.com
      These addresses are confirmed as being yours:
        new-user@example.com
    Add a new address:

The user can add a new email address with this form:

    >>> browser.getControl('Add a new address').value = (
    ...     'second-email@example.com')
    >>> browser.getControl('Add', index=1).click()
    >>> print browser.url
    http://openid.launchpad.dev/+edit-emails
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    A confirmation message has been sent to...

The new email address is now listed on the form, but not confirmed as
belonging to the user:

    >>> print extract_text(find_tag_by_id(browser.contents, 'maincontent'))
    Change your e-mail settings
    Your e-mail addresses
      Your preferred contact address for all Launchpad e-mail is:
        new-user@example.com
      These addresses are confirmed as being yours:
        new-user@example.com
      These addresses may also be yours:
        second-email@example.com
    Add a new address:

To validate the new address, the user will need to respond to the
email confirmation:

    >>> from_addr, to_addr, msg = stub.test_emails.pop()
    >>> token_url = get_token_url_from_email(msg)
    >>> browser.open(token_url)
    >>> print browser.url
    http://openid.launchpad.dev/token/.../+validateemail

    >>> browser.getControl('Continue').click()
    >>> print browser.url
    http://openid.launchpad.dev/
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    Email address successfully confirmed.

We can now see that the user owns the new address:

    >>> print extract_text(find_tag_by_id(browser.contents, 'maincontent'))
    Logged in as New User (edit)
    Emails:
    new-user@example.com
    second-email@example.com


== Changing the Contact Email Address ==

The user can also change their contact email address using the edit
emails form:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> print_radio_button_field(browser.contents, "VALIDATED_SELECTED")
    (*) new-user@example.com
    ( ) second-email@example.com
    >>> browser.getControl('second-email@example.com').selected = True
    >>> browser.getControl('Set as Contact Address').click()

    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    Your contact address has been changed to: second-email@example.com
    >>> print_radio_button_field(browser.contents, "VALIDATED_SELECTED")
    (*) second-email@example.com
    ( ) new-user@example.com


== Removing an Email Address ==

The user can also remove email addresses other than their contact address.

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('second-email@example.com').selected = True
    >>> browser.getControl('Remove', index=0).click()
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    There is 1 error.
    You can't remove second-email@example.com because it's your
    contact email address.

Removing other addresses works though:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('new-user@example.com').selected = True
    >>> browser.getControl('Remove', index=0).click()
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    The email address 'new-user@example.com' has been removed.


== Attempting to Add Existing Addresses ==

A user can't add an email address that has already been claimed.
There are a number of different states the other address could be in:

=== Attempting to Add Own Address ===

An error will be produced if a user attempts to add an address they
already own:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('Add a new address').value = (
    ...     'second-email@example.com')
    >>> browser.getControl('Add', index=1).click()
    >>> print browser.url
    http://openid.launchpad.dev/+edit-emails
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    There is 1 error.
    The email address 'second-email@example.com' is already registered
    as your email address. This can be either because you already
    added this email address before or because our system detected it
    as being yours. If it was detected by our system, it's probably
    shown on this page and is waiting to be confirmed as yours.


=== Attempting to Add an Address Owned By Another Account ===

If a user tries to add an address belonging to another account, it
will fail:

    >>> import transaction
    >>> from canonical.launchpad.ftests import login, logout, ANONYMOUS
    >>> from canonical.launchpad.testing.factory import LaunchpadObjectFactory
    >>> login(ANONYMOUS)
    >>> factory = LaunchpadObjectFactory()
    >>> account = factory.makeAccount(
    ...     'Some Other User', 'some-other-user@example.com')
    >>> logout()
    >>> transaction.commit()

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('Add a new address').value = (
    ...     'some-other-user@example.com')
    >>> browser.getControl('Add', index=1).click()
    >>> print browser.url
    http://openid.launchpad.dev/+edit-emails
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    There is 1 error.
    The email address 'some-other-user@example.com' is registered to
    another user.


=== Attempting to Add an Address Owned By A Launchpad User ===

If a user tries to add an address belonging to another user that is
using Launchpad, they'll be directed to the Launchpad merge person
page:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('Add a new address').value = (
    ...     'test@canonical.com')
    >>> browser.getControl('Add', index=1).click()
    >>> print browser.url
    http://openid.launchpad.dev/+edit-emails
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    There is 1 error.
    The email address 'test@canonical.com' is already registered to
    Sample Person. If you think that is a duplicated account, you can
    merge it into your account.
    >>> print browser.getLink('merge it').url
    http://launchpad.dev/people/+requestmerge?field.dupeaccount=name12


=== Attempting to Add an Address Owned By A Launchpad Team ===

If a user tries to add an address belonging to a Launchpad team,
they'll get a similar error:

    >>> browser.open('http://openid.launchpad.dev/+edit-emails')
    >>> browser.getControl('Add a new address').value = (
    ...     'support@ubuntu.com')
    >>> browser.getControl('Add', index=1).click()
    >>> print browser.url
    http://openid.launchpad.dev/+edit-emails
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    There is 1 error.
    The email address 'support@ubuntu.com' is already registered to
    Ubuntu Team. If you think that is a duplicated account, you can
    merge it into your account.
    >>> print browser.getLink('merge it').url
    http://launchpad.dev/people/+requestmerge?field.dupeaccount=ubuntu-team
