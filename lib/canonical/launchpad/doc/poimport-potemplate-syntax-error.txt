PO Import test with a .pot file that has a syntax error
-------------------------------------------------------

When we import a .pot file with a syntax error, we should notify
the user about that error so they have a chance to fix it.

In this test, we are going to check that we detect and notify the error.

Here are some imports we need to get this test running.

  >>> from canonical.database.sqlbase import flush_database_updates
  >>> from canonical.launchpad.interfaces import IPersonSet
  >>> from canonical.launchpad.interfaces import IPOTemplateNameSet
  >>> from canonical.launchpad.interfaces import ITranslationImportQueue
  >>> from canonical.launchpad.database import POTemplateSubset
  >>> import datetime
  >>> import pytz
  >>> UTC = pytz.timezone('UTC')
  >>> translation_import_queue = getUtility(ITranslationImportQueue)

We need this for the Librarian to work properly.

  >>> import transaction

And also, the DBSchema to change the imports status

  >>> from canonical.lp.dbschema import RosettaImportStatus

Then, let's get a handle to our mailer. This is the thing we'll examine to show
what email has been sent, to whom, and what the body of the message contains:

  >>> import email
  >>> from canonical.launchpad.mail import stub

Login as an admin to be able to do changes to the import queue.

  >>> login('carlos@canonical.com')

Here's the person who'll be doing the import.

  >>> person_set = getUtility(IPersonSet)
  >>> person = person_set.getByName('sabdfl')

Now, is time to create the new potemplate

  >>> from canonical.launchpad.database import ProductRelease
  >>> release = ProductRelease.get(3)
  >>> release.productseries.product.name
  u'firefox'
  >>> series = release.productseries
  >>> ptn = getUtility(IPOTemplateNameSet).new('firefox', 'Whatever')
  >>> subset = POTemplateSubset(productseries=series)
  >>> potemplate = subset.new(
  ...     potemplatename=ptn,
  ...     path='po/firefox.pot',
  ...     owner=person)

Let's import a .pot file that misses its header. That's a POSyntaxError

  >>> potemplate_contents = r'''
  ... msgid "foo"
  ... msgstr ""
  ... '''
  >>> published = True
  >>> entry = translation_import_queue.addOrUpdateEntry(
  ...     potemplate.path, potemplate_contents, published, person,
  ...     productseries=series, potemplate=potemplate)
  >>> transaction.commit()
  >>> entry.status = RosettaImportStatus.APPROVED
  >>> flush_database_updates()
  >>> potemplate.importFromQueue()

The status is now FAILED:

  >>> entry.status == RosettaImportStatus.FAILED
  True

And we sent an email with the notification of the error.

We need to commit the transaction to get the email.

  >>> transaction.commit()

There is one email and it's for the error we produced.

  >>> len(stub.test_emails)
  1

  >>> from_addr, to_addrs, raw_message = stub.test_emails.pop()
  >>> msg = email.message_from_string(raw_message)
  >>> msg["Subject"]
  'Import problem - firefox in Mozilla Firefox trunk'
  >>> print msg.get_payload(decode=True)
  Hello Mark Shuttleworth,
  <BLANKLINE>
  On ..., you uploaded a file with
  firefox in Mozilla Firefox trunk in Rosetta.
  <BLANKLINE>
  We didn't import it because we found errors in the file format.
  <BLANKLINE>
  You can check this file with the 'msgfmt' command. Please fix any
  error raised by that tool and upload the file again. If you check
  the file and you don't find any error in it, please, contact us to
  help you with this problem.
  <BLANKLINE>
  For your convenience, you can get the file you uploaded at:
  http://localhost:58000/.../firefox.pot
  <BLANKLINE>
  Thank you,
  <BLANKLINE>
  The Launchpad team
  <BLANKLINE>
