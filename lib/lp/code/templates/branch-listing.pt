<div
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
>
  <form method="get" name="filter" id="filter_form"
        style="padding-bottom: 0.5em"
        tal:attributes="action context/view/form_action|context/request/URL">
    <label for="field.lifecycle">
      Branches with status:
    </label>
    <tal:lifecycle-selector replace="structure context/view/widgets/lifecycle"/>
    <tal:sort-by replace="structure context/view/widgets/sort_by"
                 condition="context/view/widgets/sort_by|nothing"/>
    <noscript>
      <input type="submit" value="Filter"/>
    </noscript>
  </form>

<script type="text/javascript">
function submit_filter() {
    getElement('filter_form').submit();
}

function hookUpFilterSubmission () {
    connect('field.lifecycle', 'onchange', submit_filter);
    if (getElement('field.sort_by')) {
        connect('field.sort_by', 'onchange', submit_filter);
    }
}
function show_commit(id) {
    var div = document.getElementById('branch-log-' + id);
    if (div) {
        div.style.display = "block";
    }
}
function hide_commit(id) {
    var div = document.getElementById('branch-log-' + id);
    if (div) {
        div.style.display = "none";
    }
}
registerLaunchpadFunction(hookUpFilterSubmission);

YUI().use('io-base', 'node', 'json-parse', function(Y) {

function doUpdate(transaction_id, response, args) {
    json_values = Y.JSON.parse(response.responseText);
    // Make sure that the branch isn't empty, and that there
    // have been commits in the last 90 days
    if(json_values.commits && json_values.count > 0) {
        document.getElementById(args.container).innerHTML = '';
        sparkline(args.container, json_values);
    }
}


function renderSpark() {
    spark_div = 'dev_focus_spark';

    if(Y.get('#' + spark_div) !== null) {
        json_url = branch_sparks[0][1];
        var container = spark_div;
        var uri = json_url;
        var xhr_config = {
            on: {
                success: doUpdate,
            },
            arguments: {
                'container': container
            }
        };

      Y.io(uri, xhr_config);
    }
}


function sparkline(branch_id, o) {
    var spark_div = document.getElementById(branch_id);
    var number_commits = parseInt(o.commits.length);
    var w = 160;
    var min = 9999;
    var max = -1;
    var h = 12;
    var co = document.createElement("canvas");

    co.style.height = h;
    co.style.width = w;
    co.width = w;
    co.height = h;

    spark_div.appendChild(co);

    // Figure out the max and min number of commits
    for (var i = 0; i < number_commits; i++) {
        o.commits[i] = o.commits[i] - 0;
        if ( o.commits[i] < min ) min = o.commits[i];
        if ( o.commits[i] > max ) max = o.commits[i];
    }

    if (co.getContext) {
        var c = co.getContext("2d");
        c.strokeStyle = "black";
        c.lineWidth = 1.0;
        c.beginPath();

      for (var i = 0; i < number_commits; i++) {
          x_pos = (w / number_commits) * i;
          // We subtract 1 pixel here to compensate for the base line
          y_pos = (h-1) - (((o.commits[i] - min) / (max - min)) * (h-1));

          if (i == 0) {
              c.moveTo(x_pos, y_pos);
          }
          c.lineTo(x_pos, y_pos);

          // When was the last commit?
          if(o.commits[i] > 0) {
              last_commit = i+1;
          }

      }
      c.stroke();

      // Draw the base line
      c.beginPath();
      c.strokeStyle = "gray";
      c.moveTo(0,h);
      c.lineTo(w,h);
      c.stroke();

      // Marks the point with the most commits
      c.fillStyle = 'red';
      c.beginPath();
      c.arc((w / number_commits) * o.max_commits,
            h+2 - (((o.commits[o.max_commits] - min) / (max - min)) * h),
            2, 0, (Math.PI*2), true);
      c.fill();

      // Shows the number of max commits
      new_text = document.createTextNode(o.commits[o.max_commits] + ' max commits');
      new_div = document.createElement('div');
      new_div.setAttribute('id', 'txt_max_' + branch_id);
      new_div.appendChild(new_text);
      document.getElementById(branch_id).appendChild(new_div);
      new_div.style.fontSize = '8px';
      new_div.style.color = 'red';
      new_div.style.position = 'relative';
      new_div.style.top = '-22px';
      new_div.style.left = (((w / number_commits) * o.max_commits)-14) + 'px';


      // Marks the point of last commit
      c.fillStyle = 'blue';
      c.beginPath();
      c.arc((w / number_commits) * last_commit, h-2,
            2, 0, (Math.PI*2), true);
      c.fill();

      // Shows the date of the last commit and time frame
      new_text = document.createTextNode('90 days - Last commit ' + o.last_commit);
      new_div = document.createElement('div');
      new_div.setAttribute('id', 'txt_' + branch_id);
      new_div.appendChild(new_text);
      document.getElementById(branch_id).appendChild(new_div);
      new_div.style.fontSize = '8px';
      new_div.style.color = 'blue';
      new_div.style.position = 'relative';
      new_div.style.left = '2px';
      new_div.style.top = '-10px';

    }
}

Y.on("domready", renderSpark);

});



</script>

  <tal:needs-batch condition="context/multiple_pages">
    <div id="branch-batch-links">
      <tal:navigation replace="structure context/@@+navigation-links-upper" />
    </div>
  </tal:needs-batch>

  <table tal:attributes="class context/table_class" id="branchtable">
    <thead>
      <tr>
        <th colspan="2">Name</th>
        <th>Status</th>
        <th tal:condition="context/show_column/date_created|nothing">
          Registered
        </th>
        <th tal:condition="context/show_column/product|nothing">
          Project
        </th>
        <th>Last Modified</th>
        <th>Last Commit</th>
      </tr>
    </thead>
    <tbody>
        <tal:allow-setting-dev-focus condition="context/view/show_set_development_focus">
        <tal:missing-dev-focus define="product context/view/context;
                                       dev_focus context/view/has_development_focus_branch"
             condition="not: dev_focus">
      <tal:ignore condition="nothing">
        Only show the warning and link if the user can actually set the development focus
      </tal:ignore>
      <tr tal:condition="product/required:launchpad.Edit"
          tal:define="edit_link product/development_focus/fmt:url/+linkbranchtoseries">
        <td colspan="5" class="branch-no-dev-focus">A development focus branch hasn't 
            been specified, <a tal:attributes="href edit_link">set it now</a>.</td>
      </tr>
      </tal:missing-dev-focus>
      </tal:allow-setting-dev-focus>
      <tr tal:repeat="branch context/branches">
        <td>
          <img src="/@@/branch" /> <a tal:attributes="href branch/fmt:url;
                             title branch/displayname"
             tal:content="branch/bzr_identity">
               Name
          </a>
          <tal:associated-series repeat="series branch/active_series"
                                 condition="context/view/show_series_links">
            <tal:first-series condition="repeat/series/start">
            <br/><strong style="margin-left: 2.5em;">Series:</strong>
            </tal:first-series>
            <tal:comment condition="nothing">
              The lack of whitespace in the following tal expression
              is there to make sure the comma immediately follows the series
              link rather than having a space after it.
            </tal:comment>
            <tal:series-link>
              <a tal:attributes="href series/fmt:url" tal:content="series/name">
                trunk
              </a></tal:series-link><tal:comma condition="not: repeat/series/end">,</tal:comma>
          </tal:associated-series>
        </td>
        <td align="right" style="padding-right: 5px">
          <tal:dev_focus condition="branch/is_development_focus">
            <img src="/@@/favourite-yes" title="focus of development"/>
          </tal:dev_focus>
          <tal:badges replace="structure branch/badges:small"/>
        </td>
        <td>
          <span tal:condition="not:context/multiple_pages"
                tal:content="branch/lifecycle_status/sortkey"
                class="sortkey">23</span>
          <span tal:content="branch/lifecycle_status/title"
                tal:attributes="
                  class string:branchstatus${branch/lifecycle_status/name}">
                  Status</span>
        </td>
        <td tal:condition="context/show_column/date_created|nothing">
          <span class="sortkey"
                tal:content="branch/date_created/fmt:datetime">
            2005-02-12 13:45 EST
          </span>
          <span tal:attributes="title branch/date_created/fmt:datetime"
                tal:content="branch/since_created/fmt:approximateduration/use-digits">
            sometime
            </span> ago
        </td>
        <td tal:condition="context/show_column/product|nothing">
          <a tal:condition="branch/product"
             tal:attributes="href branch/product/fmt:url"
             tal:content="branch/product/name">
               Project
          </a>
        </td>

        <td>
          <span class="sortkey"
                tal:content="branch/date_last_modified/fmt:datetime">
            2005-02-12 13:45 EST
          </span>
          <div tal:condition="branch/is_development_focus" id="dev_focus_spark" style="top:10px; position:relative; height:18px;">
            <div tal:attributes="id string:b-${repeat/branch/number}">
            <span tal:attributes="title branch/date_last_modified/fmt:datetime"
                  tal:content="branch/since_updated/fmt:approximateduration/use-digits">
                sometime
            </span> ago
            </div>
          </div>
        </td>

        <tal:no_commit condition="not: branch/last_commit">
          <td>
            <em>
              <metal:no-revision-message
                use-macro="branch/@@+macros/no-revision-message" />
            </em>
          </td>
        </tal:no_commit>

        <tal:has_commit condition="branch/last_commit">
          <td tal:attributes="onmouseover string:show_commit(${branch/id});
                              onmouseout string:hide_commit(${branch/id});">
            <div class="lastCommit">
              <a tal:attributes="href branch/revision_codebrowse_link"
                 tal:content="branch/revision_count">1234</a>.
              <tal:revision-log replace="branch/revision_log/fmt:shorten/40"/>
            </div>
            <div class="popupTitle"
                 tal:attributes="id string:branch-log-${branch/id};
                                 onmouseover string:hide_commit(${branch/id});">
              <p><strong>Author:</strong>
              <tal:known-person condition="branch/revision_author/person">
                <tal:person-link
                    replace="structure branch/revision_author/person/fmt:link"/>
              </tal:known-person>
              <tal:unknown-person
                  condition="not: branch/revision_author/person">
                <tal:person-text
                    tal:replace="branch/revision_author/name_without_email">
                  John Doe
                </tal:person-text>
                <tal:person-only-email
                    condition="not: branch/revision_author/name_without_email">
                  <tal:not-anonymous condition="context/view/user">
                    <tal:person-text
                        tal:replace="branch/revision_author/email">
                      doe.john@example.com
                    </tal:person-text>
                  </tal:not-anonymous>
                  <tal:anonymous condition="not:context/view/user">
                    &lt;email address hidden&gt;
                  </tal:anonymous>
                </tal:person-only-email>
              </tal:unknown-person>
              <br/>
              <strong>Revision Date:</strong>
              <tal:revision-date replace="branch/revision_date/fmt:datetime"/></p>
              <tal:commit-msg replace="structure branch/revision_log/fmt:text-to-html"/>
            </div>
          </td>

        </tal:has_commit>
      </tr>
      <tr tal:condition="not:context/batch/total">
        <td tal:attributes="colspan context/column_count">
          <div id="no-branch-message"
               tal:content="structure context/view/no_branch_message" />
        </td>
      </tr>
    </tbody>
  </table>

  <tal:navigation replace="structure context/@@+navigation-links-lower" />

</div>

<tal:script
    replace="structure string:&lt;script type='text/javascript'&gt;" />
<tal:var tal:replace="string:var branch_sparks =" /><tal:array replace="context/branch_sparks"/><tal:comma replace="string:;;" />
<tal:script replace="structure string:&lt;/script&gt;" />
