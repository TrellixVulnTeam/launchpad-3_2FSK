Bug commenting and attaching files is done on the same form.

When a comment is submitted, the attachment is optional. Accessing the
comment form requires launchpad.Edit permission on the bugtask. In this
case, it means being logged in.

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    Traceback (most recent call last):
      ..
    Unauthorized: ...launchpad.Edit...

So let's login and add a comment.

    >>> import re
    >>> from BeautifulSoup import BeautifulSoup

    >>> def get_feedback_messages(browser):
    ...     soup = BeautifulSoup(browser.contents)
    ...     feedback_messages = []
    ...     for div_tag in soup('div', re.compile('message')):
    ...         feedback_messages.append(div_tag.string)
    ...
    ...     return feedback_messages

    >>> browser.addHeader("Authorization", "Basic test@canonical.com:test")

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Comment").value = "a test comment"
    >>> browser.getControl("Save Changes").click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1

    >>> get_feedback_messages(browser)
    ['Thank you for your comment.']

When an attachment is submitted, the comment is optional.

    >>> from StringIO import StringIO

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Include attachment").selected = True
    >>> browser.getControl("File").add_file(
    ...     StringIO("a test file"), "text/plain", "foo.txt")
    >>> browser.getControl("Save Changes").click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1

    >>> get_feedback_messages(browser)
    ['Attachment foo.txt added to bug.']

A comment and attachment can be submitted in one request.

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Comment").value = "this is a comment"
    >>> browser.getControl("Include attachment").selected = True
    >>> browser.getControl("File").add_file(
    ...     StringIO("some file"), "text/plain", "bar.txt")
    >>> browser.getControl("Save Changes").click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1

    >>> get_feedback_messages(browser)
    ['Thank you for your comment.', 'Attachment bar.txt added to bug.']

You cannot upload an empty attachment.

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Include attachment").selected = True
    >>> browser.getControl("File").add_file(
    ...     StringIO(""), "text/plain", "foo.txt")
    >>> browser.getControl("Save Changes").click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1/+addcomment

    >>> get_feedback_messages(browser)
    ['Cannot upload empty file.']

You cannot add a comment without a subject.

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Subject").value = ""
    >>> browser.getControl("Save Changes").click()

(The error message is duplicated because it's shown once at the top of
the page and once under the field. Ideally, it should not be
duplicated.)

    >>> get_feedback_messages(browser)
    ['Required input is missing.', 'Required input is missing.']

The size of uploaded files is limited with the max_bug_attachment_size
option in launchpad.conf. In our example, the size is limited to 1024.

    >>> from canonical.config import config

    >>> print config.launchpad.max_bug_attachment_size
    1024

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1/+addcomment-form")
    >>> browser.getControl("Include attachment").selected = True
    >>> browser.getControl("File").add_file(
    ...     StringIO("x"*1025), "text/plain", "foo.txt")
    >>> browser.getControl("Save Changes").click()

    >>> get_feedback_messages(browser)
    ['Cannot upload files larger than 1024 bytes']

The comment/attach file form is available from a link on the bug page.

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1")
    >>> browser.getLink("Comment/Attach File").click()
    >>> browser.getControl("Include attachment").selected = True
    >>> browser.getControl("File").add_file(
    ...     StringIO("a test file"), "text/plain", "foo.txt")
    >>> browser.getControl("Save Changes").click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1

    >>> get_feedback_messages(browser)
    ['Attachment foo.txt added to bug.']

And directly on the bug page (after the comments.)

    >>> browser.open(
    ...     "http://localhost/products/firefox/+bug/1")
    >>> browser.getControl("Subject") is not None
    True
    >>> browser.getControl("Comment", index=3).value = "a test comment"
    >>> browser.getControl("Include attachment") is not None
    True
    >>> browser.getControl("File") is not None
    True
    >>> browser.getControl("patch") is not None
    True
    >>> browser.getControl("Description") is not None
    True
    >>> browser.getControl("Save Changes", index=3).click()

    >>> print browser.url
    http://localhost/products/firefox/+bug/1

    >>> get_feedback_messages(browser)
    ['Thank you for your comment.']