NameVirtualHost 127.0.0.88:80

RewriteLock /var/tmp/rewrite-lock

<VirtualHost 127.0.0.88:80>
  ServerName xmlrpc-private.launchpad.dev
  ServerName xmlrpc.launchpad.dev
  <Proxy *>
    Order deny,allow
    Allow from 127.0.0.0/255.0.0.0
  </Proxy>
  ProxyPreserveHost on

  ProxyPass / http://localhost:8087/ retry=1
</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName codebrowse.launchpad.dev
  RedirectMatch permanent /(.*) http://bazaar.launchpad.dev/$1
</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName bazaar.launchpad.dev
  LogLevel debug

  ProxyRequests off
  <Proxy *>
    Order deny,allow
    Allow from localhost 127.0.0.0/255.0.0.0
  </Proxy>
  ProxyTimeout 20

  # The ACLs here are... complex:

  # (1) People hitting the frontpage (i.e. /) are redirected to the Launchpad frontpage
  # (2) Anything mapped in the launchpad-lookup.txt file is public, so we proxy it
  # (3) Anything of the form /+branches/nnnnnnnn/ is only allowed from the branch scanner and proxied
  # (4) Anything of the form /nn/nn/nn/nn/ is only allowed from ourselves (i.e. via a proxy from the above 2 rules)
  # (5) The /robots.txt file is served normally.
  # (6) Everything else is proxied to the local loggerhead instance.

  RewriteEngine On
  RewriteMap branch-list prg:/home/mwh/prog.py

  # (1) / -> Launchpad frontpage
  RewriteRule ^/$ http://launchpad.dev [L]

  # (3) Proxied access to the directory structure (4 levels of 2 digit hex directories)
  RewriteRule ^/[[:xdigit:]]{2}/[[:xdigit:]]{2}/[[:xdigit:]]{2}/[[:xdigit:]]{2}/.*$ - [L]

  # (3) The /robots.txt file is served normally.
  RewriteRule ^/robots.txt$ - [L]

  # (4) The branch name -> id based access is done in an external program (which also
  # takes care of the redirects to loggerhead).
  RewriteRule ^(/~.*)$ ${branch-list:$1} [L,P]

  DocumentRoot /var/tmp/bazaar.launchpad.dev/mirrors
  <Directory /var/tmp/bazaar.launchpad.dev/mirrors/>
    Options SymLinksIfOwnerMatch
    AllowOverride None
    Options Indexes
  </Directory>

  <Location />
	  ProxyPassReverse http://localhost:8080/
  </Location>
</VirtualHost>

<VirtualHost 127.0.0.88:443>
  ServerName launchpad.dev
  ServerAlias *.launchpad.dev
  ServerAlias shipit.edubuntu.dev
  ServerAlias shipit.kubuntu.dev
  ServerAlias shipit.ubuntu.dev
  <Proxy *>
    Order deny,allow
    Allow from 127.0.0.0/255.0.0.0
  </Proxy>
  SSLEngine On
  SSLCertificateFile /etc/apache2/ssl/launchpad.crt
  SSLCertificateKeyFile /etc/apache2/ssl/launchpad.key

  ProxyPreserveHost on
  ProxyPass / http://localhost:8086/ retry=1

  <Location />
    # Insert filter
    SetOutputFilter DEFLATE

    # Don't compress images
    SetEnvIfNoCase Request_URI \
    \.(?:gif|jpe?g|png)$ no-gzip dont-vary

    # Don't gzip anything that starts /@@/ and doesn't end .js (ie images)
    SetEnvIfNoCase Request_URI ^/@@/ no-gzip dont-vary
    SetEnvIfNoCase Request_URI ^/@@/.*\.js$ !no-gzip !dont-vary
  </Location>

</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName launchpad.dev
  ServerAlias *.launchpad.dev
  ServerAlias shipit.edubuntu.dev
  ServerAlias shipit.kubuntu.dev
  ServerAlias shipit.ubuntu.dev
  RewriteEngine On
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
