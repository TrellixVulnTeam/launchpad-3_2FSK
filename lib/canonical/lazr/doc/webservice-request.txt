= Adapting a browser request into a web service request =

Most of the time, web service requests come through the web service
layer. But there are times when a request that came through the
website neeeds to be treated as a web service request. It's easy to
adapt an IBrowserRequest into an IIWebServiceClientRequest request.

This adapters uses the request factory from the IWebServiceConfiguration
utility.

    >>> from canonical.lazr.interfaces.rest import (
    ...     IWebServiceConfiguration, IWebServiceClientRequest)
    >>> from canonical.lazr.rest.publisher import (
    ...     browser_request_to_web_service_request)
    >>> from canonical.lazr.testing.webservice import (
    ...     WebServiceTestPublication, WebServiceTestRequest)
    >>> from zope.interface import implements
    >>> from zope.component import getSiteManager
    >>> from zope.publisher.browser import TestRequest

    >>> class SimpleWebServiceConfiguration:
    ...     implements(IWebServiceConfiguration)
    ...     path_override = 'api'
    ...     service_version_uri_prefix = 'beta'
    ...
    ...     def createRequest(self, body_stream, environ):
    ...         request = WebServiceTestRequest(body_stream, environ)
    ...         request.setPublication(WebServiceTestPublication(None))
    ...         return request

    >>> sm = getSiteManager()
    >>> sm.registerUtility(SimpleWebServiceConfiguration())
    >>> sm.registerAdapter(browser_request_to_web_service_request)

    >>> website_request = TestRequest(SERVER_URL="http://cookbooks.dev/")
    >>> request = IWebServiceClientRequest(website_request)
    >>> request
    <...WebServiceTestRequest...>
    >>> request.getApplicationURL()
    'http://cookbooks.dev/api/beta'


= The JSON Cache=

Objects can be stored in a cache so that they can be included in
Javascript code inside the template. This is provided by the
IJSONRequestCache. There is a default adapter available that works with
any IApplicationRequest.

An object can be stored in the cache's 'objects' dict or its 'links' dict.

    >>> from canonical.lazr.interfaces.rest import IJSONRequestCache
    >>> from canonical.lazr.rest.jsoncache import JSONRequestCache
    >>> sm.registerAdapter(JSONRequestCache)
    >>> cache = IJSONRequestCache(website_request)

The 'objects' dict is for objects that should have their full JSON
representations put into the template.

    >>> cache.objects['object1'] = 'foo'
    >>> cache.objects['object2'] = 'bar'
    >>> for key in cache.objects:
    ...     print "%s: %s" % (key, cache.objects[key])
    object1: foo
    object2: bar

The 'links' dict is for objects that should have their self_links put
into the template, not their whole representations.

    >>> cache.links['objectA'] = 'foo'
    >>> cache.links['objectB'] = 'bar'
    >>> for key in cache.links:
    ...     print "%s: %s" % (key, cache.links[key])
    objectA: foo
    objectB: bar

There is a TALES formatter available that can be used to obtain a
reference to this cache from TALES:

    >>> from canonical.lazr.rest.tales import WebServiceRequestAPI
    >>> from canonical.lazr.testing.tales import test_tales
    >>> from zope.interface import Interface
    >>> from zope.traversing.adapters import DefaultTraversable

    >>> sm.registerAdapter(DefaultTraversable, [Interface])
    >>> sm.registerAdapter(WebServiceRequestAPI, name="webservicerequest")

    >>> cache = test_tales(
    ...     "request/webservicerequest:cache", request=website_request)
    >>> for key in cache.links:
    ...     print "%s: %s" % (key, cache.links[key])
    objectA: foo
    objectB: bar

