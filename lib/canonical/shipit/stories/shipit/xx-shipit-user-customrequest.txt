Let's test the /specialrequest page, where users place custom requests and/or
change existing ones.

  >>> browser.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
  >>> browser.open('http://shipit.ubuntu.dev/specialrequest')
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

First of all, we'll make sure a request is accepted only if all required 
fields are filled.

  >>> browser.getControl('Submit Request').click()
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> print_errors(browser.contents)
  You can't make a request with 0 CDs
  ...
  Required input is missing...

To make a custom request, the reason field is required.

  >>> browser.getControl(name='field.recipientdisplayname').value = 'Foo'
  >>> browser.getControl(name='field.ubuntu_quantityx86').value = '1'
  >>> browser.getControl(name='field.organization').value = 'Baz'
  >>> browser.getControl(name='field.addressline1').value = 'Street'
  >>> browser.getControl(name='field.city').value = 'City'
  >>> browser.getControl(name='field.province').value = 'Province'
  >>> browser.getControl(name='field.postcode').value = '4352542'
  >>> browser.getControl(name='field.country').value = ['226']
  >>> browser.getControl(name='field.phone').value = '43242442'
  >>> browser.getControl('Submit Request').click()
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> browser.getControl(name='field.reason').value
  ''
  >>> print_errors(browser.contents)
  (Required)
  Required input is missing.

The quantities specified by the user must be positive integers.

  >>> browser.getControl(name='field.reason').value = 'foo'
  >>> browser.getControl(name='field.ubuntu_quantityx86').value = '-1'
  >>> browser.getControl('Submit Request').click()

  >>> print_errors(browser.contents)
  You can't make a request with 0 CDs
  Quantities must be greater than or equal 0.

  >>> from canonical.shipit.interfaces.shipit import ShipItConstants
  >>> browser.getControl(name='field.ubuntu_quantityx86').value = str(
  ...     ShipItConstants.max_size_for_auto_approval)
  >>> browser.getControl('Submit Request').click()
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> for message in get_feedback_messages(browser.contents):
  ...     print message
  Request accepted. Please note that special requests can take up to
  sixteen weeks to deliver...

All custom requests with less than $max_size_for_auto_approval CDs are
automatically approved.

  >>> max_cds = ShipItConstants.max_size_for_auto_approval

  >>> from canonical.shipit.interfaces.shipit import IShipitAccount
  >>> from canonical.launchpad.database import Person
  >>> from canonical.launchpad.ftests import login, logout, ANONYMOUS
  >>> login(ANONYMOUS)
  >>> shipit_account = IShipitAccount(Person.byName('name16').account)
  >>> current_request = shipit_account.currentShipItRequest()
  >>> current_request.isApproved()
  True
  >>> current_request.getTotalApprovedCDs() == max_cds
  True
  >>> logout()

But custom requests with more than $max_size_for_auto_approval CDs have to
be approved before they can be shipped.

  >>> quantity = str(max_cds + 1)
  >>> browser.getControl(name='field.ubuntu_quantityx86').value = quantity
  >>> browser.getControl('Change Request').click()

  >>> login(ANONYMOUS)
  >>> shipit_account.currentShipItRequest().isAwaitingApproval()
  True
  >>> shipit_account.currentShipItRequest().getTotalApprovedCDs()
  0
  >>> shipit_account.currentShipItRequest().reason
  u'foo'
  >>> logout()


If later the user asks for standard quantities of CDs of a different flavour,
the request will still be pending approval, because it contains more than
$max_size_for_auto_approval CDs in total.

  >>> browser.open('http://shipit.kubuntu.dev/myrequest')
  >>> browser.url
  'http://shipit.kubuntu.dev/myrequest'

  >>> browser.getControl(name='ordertype').value = ['10']
  >>> browser.getControl(name='field.recipientdisplayname').value = 'Foo'
  >>> browser.getControl(name='field.organization').value = 'Baz'
  >>> browser.getControl(name='field.addressline1').value = 'Street'
  >>> browser.getControl(name='field.city').value = 'City'
  >>> browser.getControl(name='field.province').value = 'Province'
  >>> browser.getControl(name='field.postcode').value = '43242342'
  >>> browser.getControl(name='field.country').value = ['226']
  >>> browser.getControl(name='field.phone').value = '43242442'

  # This is an existent request, so all address fields are already filled.
  >> browser.getControl(name='field.recipientdisplayname').value
  'Foo'
  >> browser.getControl(name='field.organization').value
  'Baz'

  >>> browser.getControl('Request More CDs').click()

  >>> login(ANONYMOUS)
  >>> shipit_account.currentShipItRequest().isAwaitingApproval()
  True
  >>> shipit_account.currentShipItRequest().getTotalApprovedCDs()
  0
  >>> logout()

And the reason will still be there, because Marilize will have to check it
before approving.

  >>> login(ANONYMOUS)
  >>> shipit_account.currentShipItRequest().reason
  u'foo'
  >>> logout()

Now, let's pretend this request was approved and shipped, so that we can see
how shipit would behave if this guy (name16) comes back asking for more CDs
of this same distroseries.

  >>> login(ANONYMOUS)
  >>> shipit_request = shipit_account.currentShipItRequest()
  >>> shipit_request.approve()
  >>> for requestedcds in shipit_request.getAllRequestedCDs():
  ...     requestedcds.quantityapproved = requestedcds.quantity
  >>> from canonical.database.sqlbase import flush_database_updates
  >>> flush_database_updates()
  >>> from canonical.shipit.model.shipit import ShippingRequestSet
  >>> run = ShippingRequestSet()._create_shipping_run([shipit_request.id])
  >>> [request.recipient.displayname for request in run.requests]
  [u'Foo Bar']
  >>> logout()

His shipped request contained only Ubuntu and Kubuntu CDs, so a request for
Server CDs that is under the $max_size_for_auto_approval CDs limit will
be auto approved.

  >>> browser.open('http://shipit.ubuntu.dev/specialrequest-server')
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest-server'

  # As name16 already has a request, the address fields will be pre-filled for
  # him.
  >>> browser.getControl(name='field.recipientdisplayname').value
  'Foo'
  >>> browser.getControl(name='field.organization').value
  'Baz'

  >>> browser.getControl(name='field.ubuntu_quantityamd64').value = '10'
  >>> browser.getControl(name='field.reason').value = 'foo'
  >>> browser.getControl('Submit Request').click()

  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest-server'

  >>> for message in get_feedback_messages(browser.contents):
  ...     print message
  Request accepted. Please note that special requests can take up to
  sixteen weeks to deliver...

  >>> login(ANONYMOUS)
  >>> shipit_account.currentShipItRequest().isApproved()
  True
  >>> logout()

If later on he adds some Ubuntu (or Kubuntu) CDs to his request it'll then be
marked as pending approval.

  >>> browser.open('http://shipit.ubuntu.dev/specialrequest')
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> browser.getControl(name='field.ubuntu_quantityx86').value = '10'
  >>> browser.getControl(name='field.reason').value = 'foo'
  >>> browser.getControl('Request More CDs').click()

  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> for message in get_feedback_messages(browser.contents):
  ...     print message
  Request changed successfully...

Although his new request contains only 21 CDs, it will be pending approval
because he already has a shipped request containing Ubuntu CDs.

  >>> login(ANONYMOUS)
  >>> shipit_account.currentShipItRequest().isAwaitingApproval()
  True
  >>> logout()


The architectures of the CDs we ship depend on the flavour (Ubuntu, Kubuntu
and Server).

For Ubuntu, we ship only X86 CDs.

  >>> browser.open('http://shipit.ubuntu.dev/specialrequest')
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest'

  >>> browser.getControl(name='field.ubuntu_quantityx86')
  <Control name='field.ubuntu_quantityx86' type='text'>
  >>> browser.getControl(name='field.ubuntu_quantityamd64')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityamd64'
  >>> browser.getControl(name='field.ubuntu_quantityppc')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityppc'


For Kubuntu we also ship only X86.

  >>> browser.open('http://shipit.kubuntu.dev/specialrequest')
  >>> browser.url
  'http://shipit.kubuntu.dev/specialrequest'

  >>> browser.getControl(name='field.ubuntu_quantityx86')
  <Control name='field.ubuntu_quantityx86' type='text'>
  >>> browser.getControl(name='field.ubuntu_quantityamd64')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityamd64'
  >>> browser.getControl(name='field.ubuntu_quantityppc')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityppc'


And for Server, we ship only AMD64.

  >>> browser.open('http://shipit.ubuntu.dev/specialrequest-server')
  >>> browser.url
  'http://shipit.ubuntu.dev/specialrequest-server'

  >>> browser.getControl(name='field.ubuntu_quantityamd64')
  <Control name='field.ubuntu_quantityamd64' type='text'>
  >>> browser.getControl(name='field.ubuntu_quantityx86')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityx86'
  >>> browser.getControl(name='field.ubuntu_quantityppc')
  Traceback (most recent call last):
  ...
  LookupError: name 'field.ubuntu_quantityppc'
