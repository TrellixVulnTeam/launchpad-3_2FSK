#!/usr/bin/python

from bzrlib import branch, errors
import commands
from launchpadlib.launchpad import Launchpad
import os
import sys

launchpad = Launchpad.login_with('rocketfuel-mp-status', 'edge')
trunk = commands.getoutput(
    '. ~/.rocketfuel-env.sh && echo $LP_TRUNK_NAME')
projpath = commands.getoutput(
    '. ~/.rocketfuel-env.sh && echo $LP_PROJECT_PATH')
os.chdir(projpath)
branches = os.listdir('.')
if len(sys.argv) > 1:
    branches = sys.argv[1:]
lp_branches = launchpad.branches

for lb in branches:
    if lb == trunk:
        continue
    try:
        _branch  = branch.Branch.open(lb)
    except errors.NotBranchError:
        continue
    print ' * %s' % lb
    rem_branch_url = _branch.get_public_branch()
    try:
        rem_branch = branch.Branch.open(rem_branch_url)
    except errors.NotBranchError:
        print '   - Remote branch does not exist'
        continue
    if _branch.revno() != rem_branch.revno():
        print '   - Remote branch is missing revisions'
    else:
        print '   - Remote branch is up to date'
    remote = lp_branches.getByUrl(url = rem_branch_url)
    mps = remote.landing_targets
    for mp in mps:
        print '   - MP: %s' % mp.queue_status

