POMsgSet View
=============

On this section, we are going to test the view class for an IPOFile.

    >>> from zope.component import getView
    >>> from canonical.launchpad.database import POMsgSet
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest

All the tests will be submitted as comming from the Foo Bar person.

    >>> login('foo.bar@canonical.com')

We are going to see what happens if we get an entry for a language
without the plural form information.

    >>> pomsgset = POMsgSet.get(1)
    >>> pofile_tlh = pomsgset.pofile.potemplate.getDummyPOFile('tlh')
    >>> pomsgset_tlh = pofile_tlh.getPOMsgSet(u'evolution addressbook')
    >>> request = LaunchpadTestRequest()
    >>> pomsgset_view = getView(pomsgset_tlh, "+translate", request)
    >>> pomsgset_view.initialize()

Here we can see that it's lacking that information.

    >>> pomsgset_view.context.pofile.language.pluralforms is None
    True

And the view class detects it correctly.

    >>> pomsgset_view.has_plural_form_information
    False

Now, we will use a objects that we have in our database, instead of dummy ones.

    >>> pomsgset_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_view.initialize()

We have the plural form information for this language.

    >>> pomsgset_view.context.pofile.language.pluralforms is not None
    True

And thus, the view class should know that it doesn't lacks the plural forms
information.

    >>> pomsgset_view.has_plural_form_information
    True

The request didn't get any argument, and because that, we should get the
default values for the alternative language.

    >>> pomsgset_view.second_lang_code is None
    True

We are at the beginning because this pomsgset is for the first item.

    >>> pomsgset_view.context.potmsgset.sequence == 1
    True

And the view detects it.

    >>> pomsgset_view.is_at_beginning
    True

And there are more than one message to translate.

    >>> len(pomsgset_view.context.pofile.potemplate) > 1
    True

We cannot be at the end.

    >>> pomsgset_view.is_at_end
    False

How many lines does the message have.

    >>> pomsgset_view.max_lines_count
    1

And as it has only one line, it's not a multi line message set.

    >>> pomsgset_view.is_multi_line
    False

It does not have a plural msgid.

    >>> pomsgset_view.msgid_plural is None
    True

And thus, it only has one translation.

    >>> pomsgset_view.translation_range
    [0]

Which is the one we wanted.

    >>> pomsgset_view.getTranslation(0)
    u'libreta de direcciones de Evolution'

Now, we are going to test the tab index generator to be sure the TAB key
will work as expected when navigating over the translation form.

First time we call it, first position.

    >>> pomsgset_view.generateNextTabIndex()
    1

Next time we call it, it's increased.

    >>> pomsgset_view.generateNextTabIndex()
    2

It's time to check the submission of translations and the IPOFile statistics
update.

But first, let's see current values.

    >>> pomsgset_view.context.pofile.updateStatistics()
    (7, 0, 0)
    >>> pomsgset_view.context.pofile.currentCount()
    7
    >>> pomsgset_view.context.pofile.updatesCount()
    0
    >>> pomsgset_view.context.pofile.rosettaCount()
    0

Now we do the submit

    >>> request = LaunchpadTestRequest(form={
    ...     'alt': None,
    ...     'msgset_1': None,
    ...     'msgset_1_es_translation_0': 'Foo',
    ...     'submit_translations': 'Save &amp; Continue'})
    >>> request.method = 'POST'
    >>> pomsgset_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_view.initialize()

And check again.

    >>> pomsgset_view.context.pofile.currentCount()
    7
    >>> pomsgset_view.context.pofile.updatesCount()
    1
    >>> pomsgset_view.context.pofile.rosettaCount()
    0

And that's all, folks!
