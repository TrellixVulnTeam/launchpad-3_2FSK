+portlet-packages
-----------------

When the product is not linked to a source package in Ubuntu the
+portlet-packages will show suggestions on potential matches and ask
the user to make the connection.

    >>> import sys
    >>> import pdb
    >>> def stop():
    ...     # Temporarily restore the real stdout.
    ...     old_stdout = sys.stdout
    ...     sys.stdout = sys.__stdout__
    ...     try:
    ...         pdb.set_trace()
    ...     finally:
    ...         sys.stdout = old_stdout

Create a helper to update the distribution source package cache, which
does not happen automatically.

    >>> from canonical.launchpad.testing.pages import find_tag_by_id
    >>> from canonical.launchpad.testing.pages import extract_text
    >>> from canonical.launchpad.interfaces.launchpad import (
    ...     ILaunchpadCelebrities)
    >>> from lp.registry.interfaces.product import IProductSet
    >>> from lp.registry.interfaces.sourcepackagename import (
    ...     ISourcePackageNameSet)

    >>> import transaction
    >>> from canonical.launchpad.scripts import QuietFakeLogger
    >>> logger = QuietFakeLogger()
    >>> from canonical.testing.layers import reconnect_stores
    >>> from canonical.config import config
    >>> def updateCache():
    ...     # Switch to the statistician user who is the only user with
    ...     # write permission to the source package cache tables.
    ...     transaction.commit()
    ...     reconnect_stores(config.statistician.dbuser)
    ...     ubuntu = getUtility(ILaunchpadCelebrities).ubuntu
    ...     updated = ubuntu.updateCompleteSourcePackageCache(
    ...         archive=ubuntu.main_archive, log=logger, ztm=transaction)
    ...     transaction.commit()
    ...     reconnect_stores('launchpad')
    ...     # Get ubuntu, our product, and the sourcepackage name again
    ...     # since the transaction changed.
    ...     ubuntu = getUtility(ILaunchpadCelebrities).ubuntu
    ...     product = getUtility(IProductSet)['bingo']
    ...     spn = getUtility(ISourcePackageNameSet)['bingo']
    ...     login(ANONYMOUS)
    ...     return (ubuntu, product, spn)


Let's create a test project.

    >>> product = factory.makeProduct(name="bingo")
    >>> login_person(product.owner)
    >>> view = create_initialized_view(
    ...     product, name="+portlet-packages",
    ...     principal=product.owner)
    >>> print view.suggestions
    []

No distribution source packages match so the user is shown an
appropriate message asking to suggest a match.

    >>> content = find_tag_by_id(view.render(), 'portlet-packages')
    >>> print extract_text(content)
    All packages
    Packages in Ubuntu
    Launchpad doesn't know which Ubuntu packages this project
    provides. Links from distribution packages to upstream projects
    let distribution and upstream maintainers share bugs, patches, and
    translations efficiently.
    There are no source packages that are a good match. Can you suggest one?
    Link to Ubuntu package


A distribution source package in a distribution other than ubuntu will
not be suggested.

    >>> spn = factory.makeSourcePackageName(name="bingo")
    >>> distro_package = factory.makeDistributionSourcePackage(
    ...     sourcepackagename=spn)
    >>> spph = factory.makeSourcePackagePublishingHistory(
    ...     sourcepackagename=spn)
    >>> (ubuntu, product, spn) = updateCache()
    >>> view = create_initialized_view(
    ...     product, name="+portlet-packages",
    ...     principal=product.owner)
    >>> print view.suggestions
    []

An Ubuntu distribution package that is not in the current series
will be suggested.

    >>> distro_package = factory.makeDistributionSourcePackage(
    ...     sourcepackagename=spn, distribution=ubuntu)
    >>> warty = ubuntu.getSeries('warty')
    >>> warty == ubuntu.currentseries
    False
    >>> spph = factory.makeSourcePackagePublishingHistory(
    ...     sourcepackagename=spn, distroseries=warty)
    >>> (ubuntu, product, spn) = updateCache()
    >>> view = create_initialized_view(
    ...     product, name="+portlet-packages",
    ...     principal=product.owner)
    >>> for dsp in view.suggestions:
    ...     print dsp.name
    bingo

And the user is presented with a form to select the distribution
source package.

    >>> content = find_tag_by_id(view.render(), 'portlet-packages')
    >>> print extract_text(content)
    All packages
    Packages in Ubuntu
    Launchpad doesn't know which Ubuntu packages this project
    provides. Links from distribution packages to upstream projects
    let distribution and upstream maintainers share bugs, patches, and
    translations efficiently.
    Registered upstream project:
    bingo...

A distribution series with a matching name in the Ubuntu current
series will be suggested.

    >>> distro_package = factory.makeDistributionSourcePackage(
    ...     sourcepackagename=spn, distribution=ubuntu)
    >>> spph = factory.makeSourcePackagePublishingHistory(
    ...     sourcepackagename=spn, distroseries=ubuntu.currentseries)
    >>> (ubuntu, product, spn) = updateCache()
    >>> view = create_initialized_view(
    ...     product, name="+portlet-packages",
    ...     principal=product.owner)
    >>> for dsp in view.suggestions:
    ...     print dsp.name
    bingo

If multiple source packages match they will all be displayed.

    >>> spn = factory.makeSourcePackageName(name="ba-bingo")
    >>> distro_package = factory.makeDistributionSourcePackage(
    ...     sourcepackagename=spn, distribution=ubuntu)
    >>> spph = factory.makeSourcePackagePublishingHistory(
    ...     sourcepackagename=spn, distroseries=ubuntu.currentseries)
    >>> (ubuntu, product, spn) = updateCache()
    >>> view = create_initialized_view(
    ...     product, name="+portlet-packages",
    ...     principal=product.owner)
    >>> for dsp in view.suggestions:
    ...     print dsp.name
    bingo
    ba-bingo

    >>> content = find_tag_by_id(view.render(), 'portlet-packages')
    >>> print extract_text(content)
    All packages
    Packages in Ubuntu
    Launchpad doesn't know which Ubuntu packages this project
    provides. Links from distribution packages to upstream projects
    let distribution and upstream maintainers share bugs, patches, and
    translations efficiently.
    Registered upstream project:
    bingo
    ba-bingo...
