#!/bin/sh

set -e

rm -rf build
mkdir -p build/js/yui

# Populate YUI.
tar zxf download-cache/dist/yui-${versions:yui}.tar.gz -C build/js/yui

# And YUI 2, for now.
cp -a lib/canonical/launchpad/icing/yui_2.7.0b/build build/js/yui2

# Copy in our modules.
mkdir build/js/lp
for jsdir in lib/lp/*/javascript ; do
    app=$(echo $jsdir | sed -e 's,lib/lp/\(.*\)/javascript,\1,')
    cp -a $jsdir build/js/lp/$app
done
# ... and delete tests.
find build/js -name 'tests' -type d | xargs rm -rf

# We have to move some modules around.
mv build/js/lp/contrib/lp.mustache.js build/js/lp
cp lib/lp/services/worlddata/javascript/languages.js build/js/lp
cp lib/lp/app/longpoll/javascript/longpoll.js build/js/lp

# Build the LP module definition file.
utilities/js-deps -n LP_MODULES -s build/js/lp -o build/js/lp/meta.js >/dev/null

# Minify our JS.
#for jsfile in $(find build/js/lp -name '*.js') ; do
#    outfile=$(echo $jsfile | sed -e 's/.js$/-min.js/')
#	bin/py -m lp.scripts.utilities.js.jsmin < $jsfile > $outfile
#done

# Check if any JS modules are missing.
error=0
for mod in $(grep '  LP' build/js/lp/meta.js | tr -s ' ' | cut -d\  -f2) ; do
    if ! grep -q "modules\[$mod\]" build/js/lp/meta.js ; then
        echo "ERROR: $mod is not mentioned in the meta file"
        error=1
    fi
done

exit $error
