Here we are going to check the basic behaviour of the translation form when we
render just one message with all available information for it.

First, we need to define a function to see that the message we are
interested on doesn't have any translation.

  >>> def getMessageValues(content, has_errors=False):
  ...     """Return english string and translation for the first message."""
  ...
  ...     from BeautifulSoup import BeautifulSoup
  ...     translation_form_soup = BeautifulSoup(content)
  ...     translation_tbody = translation_form_soup.findAll('tbody')[1]
  ...     translation_tbody_content = translation_tbody.renderContents()
  ...     translation_table_soup = BeautifulSoup(translation_tbody_content)
  ...     tr_list = translation_table_soup.findAll('tr')
  ...     tr_english_msgid = tr_list[0]
  ...     td_ignore, td_id, td_ignore, td_msgid = (
  ...         tr_english_msgid('td'))
  ...
  ...     if 'msgset_143' in td_id.renderContents():
  ...         tr_translation_index = 3
  ...     elif has_errors:
  ...         # There is a 'tr' tag to show an error.
  ...         tr_translation_index = 2
  ...     else:
  ...         tr_translation_index = 1
  ...
  ...     tr_translation = tr_list[tr_translation_index]
  ...     td_ignore, td_translation = tr_translation('td')
  ...
  ...     return (td_id.renderContents(), td_msgid.renderContents(),
  ...             td_translation.renderContents())


First, we need to be sure that anonymous users are able to browse translations
but they don't have a chance to change anything.

  >>> browser.open(
  ...     'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/5')
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/5/+translate'

The set of things that should be hidden in this case are:

 - No msgset_134_es_translation_0_new_checkbox or
   msgset_134_es_translation_0_new tags. Those are used to introduce
   new translations/suggestions so it makes no sense to allow that in a read
   only mode.
 - No copy buttons, for this message: msgset_134_singular_copy,
   msgset_134_es_translation_0_copy, msgset_134_es_suggestion_689_0_copy,
   msgset_134_es_suggestion_4_0_copy and msgset_134_es_suggestion_690_0_copy.
 - The 'Needs review' flag should not be editable, ie. disabled.
 - The 'submit_translations' submit button.

  >>> 'msgset_134_es_translation_0_new_checkbox' in browser.contents
  False
  >>> 'msgset_134_es_translation_0_new' in browser.contents
  False
  >>> 'msgset_134_singular_copy' in browser.contents
  False
  >>> 'msgset_134_es_translation_0_copy' in browser.contents
  False
  >>> 'msgset_134_es_suggestion_689_0_copy' in browser.contents
  False
  >>> 'msgset_134_es_suggestion_4_0_copy' in browser.contents
  False
  >>> 'msgset_134_es_suggestion_690_0_copy' in browser.contents
  False
  >>> 'name="submit_translations"' in browser.contents
  False
  >>> for tag in find_tags_by_class(browser.contents, 'fuzzy-checkbox'):
  ...     print tag
  <label class="fuzzy-checkbox">
    <input type="checkbox" value="fuzzy" disabled="disabled" name="msgset_134_es_needsreview" />
    Someone should review this translation
  </label>


To be completely sure that previous test is working because the form is
behaving as it should, instead of working because we don't use those tags
anymore, we check now that we can see them when we are logged in.

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open(
  ...     'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/5')
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/5/+translate'

And now, we can see that the tags exist:

  >>> 'msgset_134_es_translation_0_new_checkbox' in browser.contents
  True
  >>> 'msgset_134_es_translation_0_new' in browser.contents
  True
  >>> 'msgset_134_singular_copy' in browser.contents
  True
  >>> 'msgset_134_es_translation_0_copy' in browser.contents
  True
  >>> 'msgset_134_es_suggestion_689_0_copy' in browser.contents
  True
  >>> 'msgset_134_es_suggestion_4_0_copy' in browser.contents
  True
  >>> 'msgset_134_es_suggestion_690_0_copy' in browser.contents
  True
  >>> 'name="submit_translations"' in browser.contents
  True
  >>> for tag in find_tags_by_class(browser.contents, 'fuzzy-checkbox'):
  ...     print tag
  <label class="fuzzy-checkbox">
    <input type="checkbox" value="fuzzy" name="msgset_134_es_needsreview" />
    Someone should review this translation
  </label>


Now, we are going to test common parts of the navigation.

The main page for a pomsgset object should redirect us to the translation form.

  >>> browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1')
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate'

When we are on the first message, we should be 100% sure that the 'First' and
'Previous' links are hidden and 'Next' and 'Last' are the right ones.

  >>> browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/1/+translate')
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate'

  >>> browser.getLink('First')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Prev')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> next = browser.getLink('Next')
  >>> print next.url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/2/+translate
  >>> print browser.getLink('Last').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=0

when we choose the next entry, all links should appear.

  >>> next.click()
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/2/+translate'

  >>> print browser.getLink('First').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Next').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/3/+translate
  >>> last = browser.getLink('Last')
  >>> print last.url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=1

And the last one.

  >>> last.click()
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate'

  >>> print browser.getLink('First').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> prev = browser.getLink('Previous')
  >>> print prev.url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/21/+translate

  >>> browser.getLink('Next')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

  >>> browser.getLink('Last')
  Traceback (most recent call last):
  ...
  LinkNotFoundError

And the link to the IPOFile view should be there too:

  >>> print browser.getLink('Return to multiple messages view').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=21

Let's test the ones at the end of the form.

  >>> prev.click()
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/21/+translate'

  >>> print browser.getLink('First').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/1/+translate
  >>> print browser.getLink('Previous').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/20/+translate
  >>> print browser.getLink('Next').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate
  >>> print browser.getLink('Last').url
  http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/22/+translate

Now, we are going to check a message submission.

  >>> browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate'

Check that the message #13 is without translation.

First what we represent in the form when there is no translation:

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents)
  >>> print msgid_number
  13.
  <input type="hidden" name="msgset_142" />
  >>> print msgid
  Migrating `<code>%s</code>':
  >>> print translation
  (no translation yet)

And also, we don't get anyone as the Last translator because there is no
translation at all ;-)

  >>> 'Translated by:' in browser.contents
  False

Let's submit an invalid value for this message #13.

  >>> browser.getControl(name='msgset_142_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_142_es_translation_0_new').value = 'foo %i'
  >>> browser.getControl(name='submit_translations').click()
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate'
  >>> for tag in find_tags_by_class(browser.contents, 'error'):
  ...     print tag
  <div class="error message">There is an error in the translation you provided. Please correct it before continuing.</div>
  <tr class="error translation">
    <th colspan="3">
      <strong>Error in Translation:</strong>
    </th>
    <td>
    </td><td>
      <div>
        format specifications in 'msgid' and 'msgstr' for argument 1 are not the same
      </div>
    </td>
  </tr>

The message is still without translation:

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents, has_errors=True)
  >>> print msgid_number
  13.
  <input type="hidden" name="msgset_142" />
  >>> print msgid
  Migrating `<code>%s</code>':
  >>> print translation
  (no translation yet)

And now a good submit.

  >>> browser.getControl(name='msgset_142_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_142_es_translation_0_new').value = 'foo %s'
  >>> browser.getControl(name='submit_translations').click()

We moved to the next message, that means this submission worked.

  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'

Now, it has the submitted value.

  >>> browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/13/+translate')
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/13/+translate'

Check that the message #13 has the new value we submitted.

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents)
  >>> print msgid_number
  13.
  <input type="hidden" name="msgset_142" />
  >>> print msgid
  Migrating `<code>%s</code>':
  >>> print translation
  <div lang="es" dir="ltr">foo <code>%s</code></div>

And now, we get someone as the Translator and also, we have a reviewer (in
this case, it's the same):

  >>> print browser.contents
  <!DOCTYPE...
  Translated by:
  ...Carlos...
  on
  ...
  Reviewed by:
  ...Carlos...
  on
  ...

Now, we will check suggestions in this form.

  >>> browser.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'

Check that suggestions come in from other contexts:

  >>> "<label>Suggested elsewhere:</label>" in browser.contents
  True
  >>> suggested = "This is a suggestion added by a non-editor for a multiline entry, and it happens to have a "
  >>> suggested in browser.contents
  True

Check that no other suggestions are presented (since no others are
relevant for this message):

  >>> "<label>Suggestion" not in browser.contents
  True
  >>> "<label>Used elsewhere:</label>" not in browser.contents
  True

Check for the translator note:

  >>> "This is an example of commenttext for a multiline msgset" in browser.contents
  True

  ...Suggested elsewhere:...
  ...No Privileges Person...
  ...name="msgset_143_es_needsreview"...
  ...Translator note:...

Also check that the alternative language selection is working:

  >>> browser.getControl(name='field.alternative_language').value = ['ja']
  >>> browser.getControl(name='select_alternate_language').click()
  >>> browser.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate?field.alternative_language=ja&field.alternative_language-empty-marker=1&select_alternate_language=Change'

If we specify more than one alternative language in the URL, we get an
UnexpectedFormData exception:

  >>> browser.open(
  ...  'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...  '+pots/evolution-2.2/es/14/+translate?field.alternative_language=ja&field.alternative_language=aj')
  Traceback (most recent call last):
    ...
  UnexpectedFormData: You specified...

(And this happens when we try and do this for the main translation page
as well!)

  >>> browser.open(
  ...  'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...  '+pots/evolution-2.2/es/+translate?field.alternative_language=ja&field.alternative_language=aj')
  Traceback (most recent call last):
    ...
  UnexpectedFormData: You specified...

Let's see what happens when we do a submission with a lock_timestamp older
than the review date for current translation.

First, we get a browser instance that will be the last one submitting the
changes.

  >>> from zope.testbrowser.testing import Browser
  >>> slow_submission = Browser()
  >>> slow_submission.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> slow_submission.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> slow_submission.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'
  >>> import transaction
  >>> transaction.commit()

Now, we get another instance that will be submitted before 'slow_submission'.

  >>> fast_submission = Browser()
  >>> fast_submission.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> fast_submission.open(
  ...     'http://launchpad.dev/ubuntu/hoary/+source/evolution/'
  ...     '+pots/evolution-2.2/es/14/+translate')
  >>> fast_submission.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'

Let's change the translation.

  >>> fast_submission.getControl(
  ...     name='msgset_143_es_translation_0_new_checkbox').value = True
  >>> fast_submission.getControl(
  ...     name='msgset_143_es_translation_0_new').value = u'blah'

And submit it.

  >>> fast_submission.getControl(name='submit_translations').click()
  >>> fast_submission.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/15/+translate'

Now, we check that the translation we are going to add is not yet in the
form, so we can check later that it's added as a suggestion:

  >>> 'foo!!' in fast_submission.contents
  False

Now, we update the translation in slow_submission.

  >>> slow_submission.getControl(
  ...     name='msgset_143_es_translation_0_new_checkbox').value = True
  >>> slow_submission.getControl(
  ...     name='msgset_143_es_translation_0_new').value = u'foo!!'

We submit it

  >>> slow_submission.getControl(name='submit_translations').click()
  >>> slow_submission.url
  'http://launchpad.dev/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/14/+translate'
  >>> for tag in find_tags_by_class(slow_submission.contents, 'error'):
  ...     print tag
  <div class="error message">There is an error in the translation you provided. Please correct it before continuing.</div>
  <tr class="error translation">
    <th colspan="3">
      <strong>Error in Translation:</strong>
    </th>
    <td>
    </td><td>
      <div>
        Somebody else changed this translation since you started. To avoid
        accidentally reverting work done by others, we added your translations
        as suggestions, so please review current values.
      </div>
    </td>
  </tr>

Also, we should still have previous translation:

  >>> (msgid_number, msgid, translation) = getMessageValues(
  ...     slow_submission.contents, has_errors=True)
  >>> print msgid_number
  14.
  <input type="hidden" name="msgset_143" />
  >>> print msgid
  The location and hierarchy of the Evolution contact...
  >>> translation
  '\n<div lang="es" dir="ltr">blah</div>\n'

But also, the new one should appear in the form.

  >>> 'foo!!' in slow_submission.contents
  True
