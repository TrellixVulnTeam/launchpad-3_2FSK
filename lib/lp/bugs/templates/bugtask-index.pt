<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  metal:use-macro="view/macro:page/main_side"
>
  <body>
    <metal:block fill-slot="head_epilogue">
      <script type='text/javascript' tal:content="string:var yui_base='${yui}';" />
      <script type='text/javascript' id='available-official-tags-js'
              tal:content="view/available_official_tags_js" />
      <tal:devmode condition="devmode">
       <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/bugs/subscriber.js">
       </script>
        <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/bugs/bugtask-index.js">
        </script>
        <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/bugs/bug_tags_entry.js">
        </script>
        <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/lp/comment.js">
        </script>
        <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/lp/errors.js">
        </script>
        <script type="text/javascript"
                tal:define="lp_js string:${icingroot}/build"
                tal:attributes="src string:${lp_js}/code/popupdiff.js">
        </script>
      </tal:devmode>
      <script type="text/javascript">
        LPS.use('base', 'node', 'oop', 'event', 'bugs.bugtask_index',
                  'code.branchmergeproposal.popupdiff', function(Y) {
            Y.bugs.setup_bugtask_index();
            Y.on('load', function(e) {
              Y.code.branchmergeproposal.popupdiff.connect_diff_links();
            }, window);
        });
      </script>
      <style type="text/css">
        /* A page-specific fix for inline text are editing to line up box. */
        #edit-description .yui-ieditor-input { top: 0; }
        /* Align the 'add comment' link to the right of the comment box. */
        #add-comment-form textarea { width: 100%; }
        #add-comment-form { max-width: 60em; padding-bottom: 4em; }
        #add-comment-form .actions {float: right;}
        .bug-branch-summary dd { font-size: 85% }
        a#privacy-link:link:hover, a#privacy-link:visited:hover {text-decoration:none;}
      </style>
    </metal:block>

    <metal:side fill-slot="side" tal:define="context_menu context/menu:context">
      <div tal:replace="structure context/bug/@@+portlet-privacy" />
      <div tal:replace="structure context/bug/@@+portlet-actions" />
      <div tal:replace="structure context/bug/@@+portlet-duplicates" />
      <div tal:replace="structure context/bug/@@+portlet-subscribers" />
      <div tal:replace="structure context/bug/@@+portlet-questions" />
      <div tal:replace="structure context/bug/@@+portlet-specs" />
      <div tal:replace="structure context/bug/@@+portlet-attachments" />
      <div tal:replace="structure context/bug/@@+portlet-watch" />
    </metal:side>

    <tal:registering metal:fill-slot="registering">
    <div tal:replace="cache:public,1 hour">
      Bug #<tal:block content="context/bug/id"/> reported by
      <tal:reporter replace="structure context/bug/owner/fmt:link" />
      <span
        tal:attributes="title context/bug/datecreated/fmt:datetime"
        tal:content="context/bug/datecreated/fmt:displaydate" />
      <tal:heat replace="structure view/bug_heat_html" />
    </div>
    </tal:registering>

    <metal:heading fill-slot="heading" tal:define="context_menu context/menu:context">
      <h1 tal:replace="structure view/bug_title_edit_widget">
        Bug title
      </h1>
    </metal:heading>

    <div metal:fill-slot="main" tal:define="context_menu context/menu:context">
      <div id="tags-autocomplete">
       <div id="tags-autocomplete-content"></div>
      </div>
      <tal:block condition="view/reportBugInContext" />

      <p class="informational message"
         tal:condition="view/notices"
         tal:repeat="notice view/notices"
         tal:content="notice">
        Reported this bug as also occurring in upstream firefox
      </p>

      <p
         id="can-expire"
         tal:condition="context/bug/can_expire"
         >
        <tal:expiration_message replace="view/expiration_message" />
        (<a href="https://help.launchpad.net/BugExpiry">find out why</a>)
      </p>

      <p id="bug-is-question" class="informational message"
         tal:condition="context/bug/getQuestionCreatedFromBug"
         tal:define="question context/bug/getQuestionCreatedFromBug">
        This bug report was converted into a question:
        question #<tal:question-id replace="question/id" />:
        <a href=""
           tal:attributes="href question/fmt:url"
           tal:content="question/title">%s</a>.
        <tal:XXX condition="nothing">
          # XXX mpt 20080716 bug=249094: This should be an alert only when
          # you have just now converted the report into a question.
        </tal:XXX>
      </p>

      <div tal:replace="structure context/bug/@@+bugtasks-and-nominations-table" />

      <div id="maincontentsub">
        <div><!-- id="nonportlets"> -->
        <div class="top-portlet">

      <div class="report">
        <tal:description
            define="global description context/bug/description/fmt:obfuscate-email/fmt:text-to-html" />

        <div id="edit-description" class="lazr-multiline-edit"
          tal:content="structure view/bug_description_html"
          />

        <div style="margin:-20px 0 20px 5px" class="clearfix">
          <span tal:condition="view/wasDescriptionModified" class="discreet"
          >See <a href="comments/0">original description</a></span>
        </div>

          <div id="bug-tags"
               tal:attributes="class python: ('tags-container ' +
                                              (context.bug.tags and
                                               'tags-show' or 'tags-hide'))">
            Tags:
            <span id="tag-list">
              <a tal:repeat="tag view/official_tags"
                 tal:content="tag"
                 class="official-tag"
                 tal:attributes="href string:${context/target/fmt:url}/+bugs?field.tag=${tag}">tag</a>
              <a tal:repeat="tag view/unofficial_tags"
                 tal:content="tag"
                 class="unofficial-tag"
                 tal:attributes="href string:${context/target/fmt:url}/+bugs?field.tag=${tag}">tag</a>
            </span>
            <form id="tags-form" style="display: inline">
                <input type="text" id="tag-input" style="display: none; width: 15em;" />
                <img src="/@@/spinner" id="tags-edit-spinner" style="display: none" />
                <a href="+edit" title="Edit tags" id="edit-tags-trigger" class="sprite edit"></a>
              <script type="text/javascript">
                  LPS.use('event', 'node', 'bugs.bug_tags_entry', function(Y) {
                      // XXX intellectronica 2009-04-16 bug #362309:
                      // The load event fires very late on bug pages that take a
                      // long time to render, but we prefer to use it since the
                      // domready event isn't reliable in YUI3 yet. To make sure
                      // that user doesn't click the trigger and navigates to the
                      // non-JS form, we first disable the link. This is awful and
                      // must be fixed as soon as YUI3 is fixed.
                      if (LP.client.links['me'] !== undefined) {
                          Y.one('#edit-tags-trigger').on('click', function(e) {
                              e.halt();
                          });
                      }
                      Y.on('load',
                           function(e) {
                               Y.bugs.setup_tag_entry(available_official_tags);
                           },
                           window);
                  });
              </script>

              <button class="lazr-pos lazr-btn yui-ieditor-submit_button"
                      id="edit-tags-ok" style="display: none"
                      type="button">Ok</button>
              <button class="lazr-neg lazr-btn yui-ieditor-cancel_button"
                      id="edit-tags-cancel" style="display: none"
                      type="button">Cancel</button>
           </form>
          </div>
          <div id="add-bug-tags"
               tal:attributes="class python: ('tags-container ' +
                                              (not(context.bug.tags) and
                                              'tags-show' or 'tags-hide'))">
            <a href="+edit" title="Add tags" id="add-tags-trigger" class="sprite add">
              Add tags
            </a>
          </div>

        <div class="clearfix"></div>
      </div>

      <div id="branches-and-cves">
        <div id="bug-branches-container"
            style="float: left">
          <tal:branches
              define="linked_branches view/linked_branches"
              condition="linked_branches">

            <div id="bug-branches">
              <h2>Related branches</h2>

              <tal:bug-branches repeat="linked_branch linked_branches">
                <tal:bug-branch replace="structure linked_branch/@@+bug-branch" />
              </tal:bug-branches>
            </div>
          </tal:branches>
        </div><!-- bug-branch-container -->

        <div tal:condition="context/bug/cves" class="cves">
          <h2>CVE References</h2>
          <ul>
            <li class="sprite cve" tal:repeat="cve context/bug/cves">
              <a tal:attributes="href cve/fmt:url;
                                 title cve/description/fmt:shorten/40"
                 tal:content="cve/sequence"
                 >2002-1342</a>
            </li>
          </ul>
        </div>

        <div class="clearfix"></div>
      </div> <!-- branches and CVEs -->

      <tal:comments>
        <tal:comment repeat="comment_or_activity view/activity_and_comments">
          <tal:is-comment
              define="comment comment_or_activity/comment|nothing"
              condition="comment">
            <tal:comment-box condition="python: comment.can_be_shown and
                                       (view.user_is_admin or
                                       comment.visible)"
                             replace="structure comment/@@+box">
            </tal:comment-box>
          </tal:is-comment>

          <tal:is-activity
              define="activity_list comment_or_activity/activity|nothing;
                      activity_date comment_or_activity/date|nothing;
                      activity_person comment_or_activity/person|nothing"
              condition="activity_list">
              <metal:comment-box
                  metal:use-macro="context/@@bugcomment-macros/activity-box" />
          </tal:is-activity>
        </tal:comment>
        <div style="float: right;">
          <tal:activity_log
              define="context_menu context/menu:context"
              content="structure context_menu/activitylog/render" />
        </div>
        <div class="clearfix"></div>

        <tal:comment-list-complete
            tal:condition="not:view/visible_comments_truncated_for_display">
          <tal:logged-in condition="view/user">
            <div tal:define="comment_form nocall:context/@@+addcomment-form;
                 dummy comment_form/initialize"
                 id="add-comment-form">
              <div
                  tal:condition="context/bug/duplicateof"
                  class="warning message"
                  id="warning-comment-on-duplicate">
                  Remember, this bug report is a duplicate of
                    <a href="#" tal:attributes="href
                      context/bug/duplicateof/fmt:url">bug #<span
                      tal:replace="context/bug/duplicateof/id">42</span></a>.
                  Comment here only if you think the duplicate status is wrong.
              </div>
              <h2>Add comment</h2>
              <form action="+addcomment"
                    method="post"
                    enctype="multipart/form-data"
                    accept-charset="UTF-8">
                <tal:comment-input
                  replace="structure comment_form/widgets/comment" />
                <div class="actions"
                  tal:content="structure
                  comment_form/actions/field.actions.save/render" />
              </form>
              <tal:comment condition="nothing">
                <!-- If javascript is enabled, hide the Save Changes button.
                It will be replaced later by an "Add comment" link,
                which does commenting inline. The reason for hiding the
                button is that it's kind of ugly having it transformed
                into a link. Better to hide it and have it appear after
                a while. At some point we should be able to hook up
                inline commenting earlier than in the on-load handler,
                which would make this hack not needed. -->
              </tal:comment>
              <script type="text/javascript">
                var button = document.getElementById('field.actions.save');
                button.style.display = 'none';
              </script>
              <script type="text/javascript">
                LPS.use('lp.comment', function(Y) {
                    var comment = new Y.lp.Comment();
                    comment.render();
                });
              </script>
            </div>
            <tal:attachment-link
                define="add_attachment_link context_menu/addcomment"
                replace="structure add_attachment_link/render" />
          </tal:logged-in>

          <tal:not-logged-in condition="not: view/user">
            <div align="center" id="add-comment-login-first">
              To post a comment you must <a
              href="+login?comments=all">log in</a>.
            </div>
          </tal:not-logged-in>
        </tal:comment-list-complete>
        <tal:comment-list-truncated
            tal:condition="view/visible_comments_truncated_for_display">
          <div class="informational message">
            Displaying first <span
            tal:replace="view/visible_comments_for_display/count:len" />
            comments.
            <tal:what-next
                define="view_all_href
                        string:${context/fmt:url}?comments=all">
              <a href="#" tal:attributes="href view_all_href">
                View all <span
                tal:replace="view/visible_comments/count:len" />
                comments</a> or <a href="#" tal:attributes="href
                view_all_href">add a comment</a>.
            </tal:what-next>
          </div>
        </tal:comment-list-truncated>
      </tal:comments>

      <div class="related">
        <h2>What next?</h2>
        <ul>
          <li>
            <a
                tal:attributes="href string:${context/target/fmt:url}/+filebug"
                >Report another bug</a>
            about <tal:context replace="context/target/displayname" />
          </li>
          <li>
            <a
                tal:attributes="href string:${context/target/fmt:url}/+bugs"
                >List open bugs</a>
            for <tal:context replace="context/target/displayname" />
          </li>
        </ul>
      </div>

      </div><!-- class="top-portlet" -->
        </div><!-- id="nonportlets"-->
      </div><!--- id="maincontentsub"-->
      <div>
        <div id="duplicate-form-container"></div>
        <div id="privacy-form-container"></div>
      </div>
    </div>
  </body>
</html>
