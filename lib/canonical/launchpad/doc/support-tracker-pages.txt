Support Tracker Pages
=====================

Several views are used to handle the various operations on a ticket.

    >>> from zope.component import getView
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet, IProductSet)
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> ticket_three = ubuntu.getTicket(3)
    >>> firefox = getUtility(IProductSet).getByName('firefox')
    >>> firefox_ticket = firefox.getTicket(2)

TicketSubscriptionView
----------------------

This view is used to subscribe and unsubscribe from a ticket.
Subscription is done when the user click on the 'Subscribe' button.

    >>> login('test@canonical.com')
    >>> request = LaunchpadTestRequest(form={'subscribe': 'Subscribe'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+subscribe', request)
    >>> view.initialize()
    >>> ticket_three.isSubscribed(getUtility(ILaunchBag).user)
    True

A notification message is displayed and the view redirect to the ticket
view page.

    >>> for notice in request.notifications:
    ...     print notice.message
    You have subscribed to this request.
    >>> request.response.getHeader('Location')
    '.../+ticket/3'

Unsubscription works in a similar manner.

    >>> request = LaunchpadTestRequest(form={'subscribe': 'Unsubscribe'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+subscribe', request)
    >>> view.initialize()
    >>> ticket_three.isSubscribed(getUtility(ILaunchBag).user)
    False
    >>> for notice in request.notifications:
    ...     print notice.message
    You have unsubscribed from this request.
    >>> request.response.getHeader('Location')
    '.../+ticket/3'

These two actions didn't generate any notification mails:

    >>> from canonical.launchpad.mail import stub
    >>> import transaction
    >>> transaction.commit()
    >>> len(stub.test_emails)
    0

TicketWorkflowView
------------------

However, if we reopen a request, it will cause a notification to be
sent:

    >>> login('foo.bar@canonical.com')
    >>> request = LaunchpadTestRequest(form={'reopen': ''})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+reopen', request)
    >>> view.initialize()
    >>> for notice in request.notifications:
    ...     print notice.message
    You have reopened this request.

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> import email
    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Status: Invalid => Open
    <BLANKLINE>

    >>> stub.test_emails = []

Lastly, let's take a look at +addmessage. It's used to add a comment to
the ticket, as well as changing it's state to Answered, which only the
submitter can do.

It needs to be open, for us to changed it to Answered:

    >>> ticket_three.reopen(getUtility(ILaunchBag).user)
    <TicketReopening...>

And now we can change the status to Answered:

    >>> request = LaunchpadTestRequest(form={
    ...     'UPDATE_SUBMIT': '',
    ...     'field.subject': 'Re: Better Title',
    ...     'field.content': 'Thanks!',
    ...     'field.resolved': 'on'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+addmessage', request)
    >>> view.update()
    ''
    >>> ticket_three.status.title
    'Answered'

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Status: Open => Answered
    <BLANKLINE>
    Comment:
    Thanks!

    >>> stub.test_emails = []

TicketMakeBugView
-----------------

The TicketMakeBugView is used to handle the creation of a bug from a
ticket. In addition to creating a bug, this operation will also link
the bug to the ticket.

If the user cancels a bug creation request, the user is redirected back
the ticket page.

    >>> request = LaunchpadTestRequest(form={'cancel': 'cancel'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> makebug.process_form()
    ''
    >>> list(ticket_three.bugs)
    []

If the user creates a bug, a "Linked to bug" notification is sent and
the user is subscribed to the bug.

    >>> request = LaunchpadTestRequest(
    ...     form={'create': 'create',
    ...           'field.title': 'Bug title',
    ...           'field.description': 'Bug description.'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> makebug.process_form()
    >>> sorted(bug.id for bug in ticket_three.bugs)
    [11L]
    >>> print ticket_three.bugs[0].title
    Bug title
    >>> print ticket_three.bugs[0].description
    Bug description.
    >>> print makebug.user.name
    name16
    >>> ticket_three.bugs[0].isSubscribed(makebug.user)
    True
    >>> [n.message for n in request.notifications]
    [u'Thank you! Bug #11 created.']

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Linked to bug: #11
    ...

    >>> stub.test_emails = []

If the ticket already has bugs linked to it, no new bug can be created.

    >>> request = LaunchpadTestRequest(form={'create': 'create'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> for n in request.notifications:
    ...     print n.message
    You cannot create a bug report...

BugLinkView and BugsUnlinkView
------------------------------

Linking bug (+linkbug) to the ticket is managed through the BugLinkView
Unlinking bugs from the ticket is managed through the BugsUnlinkView.
See 'buglinktarget-pages.txt' for their documentation. The notifications
sent along linking and unlinking bugs can be found in
'support-tracker-notifications.txt'.

TicketRejectView
----------------

    (XXX flacoste 2006/09/21 The firefox_ticket doesn't have any
    subscribers, let's subscribe the owner.)
    >>> firefox_ticket.subscribe(firefox_ticket.owner)
    <TicketSubscription...>

That view is used by administrator and support contacts to reject a
support request.

    >>> login('foo.bar@canonical.com')
    >>> request = LaunchpadTestRequest(
    ...     form={'field.actions.reject': 'Reject',
    ...           'field.message': 'Rejecting for the fun of it.'})
    >>> request.method = 'POST'
    >>> view = getView(firefox_ticket, '+reject', request)
    >>> view.initialize()
    >>> for notice in request.notifications:
    ...     print notice.message
    You have rejected this request.
    >>> print firefox_ticket.status.title
    Invalid

This action also triggers a notification to be sent.

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #2...
    ...
        Status: Open => Invalid
    <BLANKLINE>
    Comment:
    Rejecting for the fun of it.

    >>> stub.test_emails = []

TicketChangeStatusView
----------------------

TicketChangeStatusView is used by administrator to change the status
outside of the comment workflow.

    >>> request = LaunchpadTestRequest(
    ...     form={'field.actions.change-status': 'Change Status',
    ...           'field.status': 'Expired',
    ...           'field.message': 'Previous rejection was an error.'})
    >>> request.method = 'POST'
    >>> view = getView(firefox_ticket, '+change-status', request)
    >>> view.initialize()
    >>> for notice in request.notifications:
    ...     print notice.message
    Request status updated.
    >>> print firefox_ticket.status.title
    Expired

This action also triggers a notification to be sent.

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #2...
    ...
        Status: Invalid => Expired
    <BLANKLINE>
    Comment:
    Previous rejection was an error.

    >>> stub.test_emails = []

TicketEditView
--------------

TicketEditView available through '+edit' is used to edit most ticket
fields. It can be used to edit the ticket title and description and also
its metadata like priority, assignee, source package and whiteboard.

    >>> login('test@canonical.com')
    >>> ticket_three.sourcepackagename = None
    >>> request = LaunchpadTestRequest(form={
    ...     'field.actions.change': 'Continue',
    ...     'field.title': 'Better Title',
    ...     'field.description': 'A better description.',
    ...     'field.sourcepackagename': 'mozilla-firefox',
    ...     'field.assignee': 'name16',
    ...     'field.whiteboard': 'Some note',
    ...     'field.priority': 'Wishlist'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+edit', request)
    >>> view.initialize()
    >>> ticket_three.title
    u'Better Title'
    >>> ticket_three.description
    u'A better description.'
    >>> print ticket_three.sourcepackagename.name
    mozilla-firefox

Since only a user with launchpad.Admin privilege can change the
priority, assignee and status whiteboard, the values won't have been
changed:

    >>> print ticket_three.priority.title
    Normal
    >>> ticket_three.assignee is None
    True
    >>> ticket_three.whiteboard is None
    True

This View send the event appropriate to send out a notification:

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
    Summary changed to:
    Better Title
    <BLANKLINE>
    Description changed to:
    A better description.
    <BLANKLINE>

    >>> stub.test_emails = []

If the user has the required permission, the assignee, whiteboard and
priority fields will be updated:

    >>> login('foo.bar@canonical.com')
    >>> request = LaunchpadTestRequest(form={
    ...     'field.actions.change': 'Continue',
    ...     'field.title': 'Better Title',
    ...     'field.description': 'A better description.',
    ...     'field.sourcepackagename': 'mozilla-firefox',
    ...     'field.assignee': 'name16',
    ...     'field.whiteboard': 'Some note',
    ...     'field.priority': 'Wishlist'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+edit', request)
    >>> view.initialize()
    >>> print ticket_three.priority.title
    Wishlist
    >>> print ticket_three.assignee.displayname
    Foo Bar
    >>> print ticket_three.whiteboard
    Some note

In a similar manner, the sourcepackagename field can only be updated on
a distribution ticket:

    >>> request = LaunchpadTestRequest(form={
    ...     'field.actions.change': 'Continue',
    ...     'field.title': 'Better Title',
    ...     'field.description': 'A better description.',
    ...     'field.sourcepackagename': 'mozilla-firefox',
    ...     'field.assignee': '',
    ...     'field.whiteboard': '',
    ...     'field.priority': 'Normal'})
    >>> request.method = 'POST'
    >>> view = getView(firefox_ticket, '+edit', request)
    >>> view.initialize()
    >>> firefox_ticket.sourcepackagename is None
    True

    (Clear out the pending notifications.)
    >>> transaction.commit()
    >>> stub.test_emails = []

