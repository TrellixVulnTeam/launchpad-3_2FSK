Distribution Search page
========================

In the 'Bugs' facet of a distribution we can find a list of
bugs reported in that distribution and simple and advanced search forms.

    >>> from canonical.launchpad.interfaces import (
    ...     IOpenLaunchBag, IDistributionSet)
    >>> launchbag = getUtility(IOpenLaunchBag)
    >>> debian = getUtility(IDistributionSet).getByName('debian')

A helper function to make it easier to construct a view.  The function
also adds the context object to the launchbag, which approximates what
happens during traversal.

    >>> from zope.component import getView
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> def create_view(context, name, form=None):
    ...     launchbag.clear()
    ...     launchbag.add(context)
    ...     view = getView(context, name, LaunchpadTestRequest(form=form))
    ...     view.initialize()
    ...     return view

The simple search form returns only open bugtasks.

    >>> form_values = {
    ...     'search': 'Search',
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> distro_search_listingview = create_view(
    ...     debian, "+bugs", form_values)

    >>> open_bugtasks = list(distro_search_listingview.search().batch)
    >>> [(bugtask.bug.id, bugtask.status.name, bugtask.importance.name)
    ...  for bugtask in open_bugtasks]
    [(3, 'UNCONFIRMED', 'MEDIUM'),
     (1, 'CONFIRMED', 'MINOR'),
     (2, 'CONFIRMED', 'MINOR')]

And the advanced form allows us to query for specific bug statuses.

    >>> form_values = {
    ...     'search': 'Search bugs in Debian',
    ...     'advanced': 1,
    ...     'field.status': 'Fix Released',
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(debian, '+bugs', form_values)
    >>> fix_released_bugtasks = list(distro_advanced_search_listingview.search().batch)
    >>> [(bugtask.bug.id, bugtask.status.name)
    ...     for bugtask in fix_released_bugtasks]
    [(8, 'FIXRELEASED')]

A triager may find it useful to query for bugs with no package:

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')

    >>> form_values = {
    ...     'search': 'Search bugs in Ubuntu',
    ...     'advanced': 1,
    ...     'field.has_no_package': 'on',
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     ubuntu, '+bugs', form_values)

    >>> bugtasks_needing_packages = list(
    ...     distro_advanced_search_listingview.search().batch)
    >>> [bugtask.bug.id for bugtask in bugtasks_needing_packages]
    [2]

If the search query contains new line characters they'll be replaced by
spaces.

    >>> form_values = {
    ...     'search': 'Search',
    ...     'field.searchtext': 'blackhole\n\rtrash\n\rfolder',
    ...     'field.orderby': '-importance'}

    >>> distro_search_listingview = create_view(
    ...     ubuntu, '+bugs', form_values)

    >>> bugtasks_search_with_new_lines = list(
    ...     distro_search_listingview.search().batch)
    >>> [bugtask.bug.id for bugtask in bugtasks_search_with_new_lines]
    [2]

We can filter our search results by reporter

    >>> form_values = {
    ...     'search': 'Search bugs in Ubuntu',
    ...     'advanced': 1,
    ...     'field.owner': 'name12',
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     debian, '+bugs', form_values)

    >>> bugtasks_filtered_by_reporter = list(
    ...     distro_advanced_search_listingview.search().batch)
    >>> [(bugtask.bug.id, bugtask.bug.owner.name)
    ...     for bugtask in bugtasks_filtered_by_reporter]
    [(1, u'name12'), (2, u'name12')]

But if we query for an invalid person, the view displays a nice error message

    >>> form_values = {
    ...     'search': 'Search bugs in Ubuntu',
    ...     'advanced': 1,
    ...     'field.owner': 'invalid-reporter',
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     debian, '+bugs', form_values)

    >>> distro_advanced_search_listingview.owner_error
    u"There's no person with the name or email address 'invalid-reporter'"

The same if we try with an invalid assignee

    >>> form_values = {
    ...     'search': 'Search bugs in Ubuntu',
    ...     'advanced': 1,
    ...     'field.assignee': 'invalid-assignee',
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     debian, '+bugs', form_values)

    >>> distro_advanced_search_listingview.assignee_error
    u"There's no person with the name or email address 'invalid-assignee'"

Searching by component is possible, as long as the context has defined a
.currentrelease.

    >>> form_values = {
    ...     'search': 'Search bugs in Ubuntu',
    ...     'advanced': 1,
    ...     'field.component': 1,
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     ubuntu, '+bugs', form_values)

    >>> distro_advanced_search_listingview.shouldShowComponentWidget()
    True

    >>> found_bugs = list(distro_advanced_search_listingview.search().batch)

    >>> sorted([bug.id for bug in found_bugs])
    [25]

If the context does *not* have a currentrelease, component searching is
ambiguous, because a package may be published in a different component
in each release. In this case, the component search widget is hidden.

    >>> gentoo = getUtility(IDistributionSet).getByName('gentoo')

    >>> form_values = {
    ...     'search': 'Search bugs in Gentoo',
    ...     'advanced': 1,
    ...     'field.component': 1,
    ...     'field.orderby': '-importance'}

    >>> distro_advanced_search_listingview = create_view(
    ...     gentoo, '+bugs', form_values)

    >>> distro_advanced_search_listingview.shouldShowComponentWidget()
    False

Distribution Release search page
================================

    >>> woody = debian.getRelease('woody')

The simple search form returns only open bugtasks.

    >>> form_values = {
    ...     'search': 'Search',
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> distrorelease_search_listingview = create_view(
    ...     woody, "+bugs", form_values)

    >>> open_bugtasks = list(distrorelease_search_listingview.search().batch)
    >>> [(bugtask.bug.id, bugtask.status.name, bugtask.importance.name)
    ...  for bugtask in open_bugtasks]
    [(2, 'UNCONFIRMED', 'MEDIUM'),
     (3, 'UNCONFIRMED', 'MEDIUM')]

And now we'll change the status of one of the bugtasks, but first we need to
be logged in.

    >>> from canonical.launchpad.ftests import login
    >>> from canonical.database.sqlbase import flush_database_updates

    >>> login("test@canonical.com")

    >>> from canonical.lp.dbschema import BugTaskStatus
    >>> from canonical.launchpad.interfaces import IBugTaskSet
    >>> open_bugtask = getUtility(IBugTaskSet).get(18)
    >>> open_bugtask.status.name
    'UNCONFIRMED'
    >>> open_bugtask.bug.id
    3
    >>> open_bugtask.transitionToStatus(BugTaskStatus.REJECTED)
    >>> flush_database_updates()

And the advanced form allows us to query for specific bug statuses.

    >>> form_values = {
    ...     'search': 'Search bugs in Woody',
    ...     'advanced': 1,
    ...     'field.status': 'Rejected',
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> distrorelease_advanced_search_view = create_view(woody, '+bugs', form_values)
    >>> rejected_bugtasks = list(distrorelease_advanced_search_view.search().batch)
    >>> [(bugtask.bug.id, bugtask.status.name)
    ...     for bugtask in rejected_bugtasks]
    [(3, 'REJECTED')]


Project Search Page
===================

    >>> from canonical.launchpad.interfaces import IProjectSet
    >>> mozilla = getUtility(IProjectSet).getByName('mozilla')

The simple search form returns only open bugtasks.

    >>> form_values = {
    ...     'search': 'Search',
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> mozilla_search_listingview = create_view(
    ...     mozilla, "+bugs", form_values)

    >>> open_bugtasks = list(mozilla_search_listingview.search().batch)
    >>> for bugtask in open_bugtasks:
    ...     print bugtask.bug.id, bugtask.product.name, bugtask.status.name
    5 firefox UNCONFIRMED
    4 firefox UNCONFIRMED
    1 firefox UNCONFIRMED

And now we'll change the status of one of the bugtasks (we are still
logged in from earlier):

    >>> open_bugtasks[0].transitionToStatus(BugTaskStatus.REJECTED)
    >>> flush_database_updates()

And the advanced form allows us to query for specific bug statuses.

    >>> form_values = {
    ...     'search': 'Search bugs in the Mozilla Project',
    ...     'advanced': 1,
    ...     'field.status': 'Rejected', 
    ...     'field.searchtext': '',
    ...     'field.orderby': '-importance'}

    >>> mozilla_search_listingview = create_view(mozilla, '+bugs', form_values)
    >>> rejected_bugtasks = list(mozilla_search_listingview.search().batch)
    >>> for bugtask in rejected_bugtasks:
    ...     print bugtask.bug.id, bugtask.product.name, bugtask.status.name
    5 firefox REJECTED

Check what milestones are displayed on the advanced search form:

    >>> form_values = {
    ...     'advanced': 1}

    >>> advanced_search_view = create_view(
    ...     mozilla, '+bugs', form_values)
    >>> for value in advanced_search_view.getMilestoneWidgetValues():
    ...     print value['title']
    Mozilla Firefox: 1.0

