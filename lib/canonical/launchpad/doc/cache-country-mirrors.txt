= Caching country mirrors =

The <distro>/+countrymirrors-archive page serves the list of official mirrors
for the country where the request was originated.  This functionality is
provided so that apt can pick the mirror which is geographically closer to
the box where it's running, but since there are way too many Ubuntu users
and most of them will update their systems when security updates are
available apt would surely DDoS Launchpad if it tried to fetch the list
of mirrors directly from Launchpad, so from time to time we'll generate
static versions of these lists and serve them through apache.

The static versions are generated by the cache-country-mirrors.py, which takes
a single argument -- the directory in which the files are saved.

    >>> from subprocess import Popen, PIPE
    >>> import tempfile
    >>> directory = tempfile.mkdtemp()
    >>> process = Popen(
    ...     'scripts/cache-country-mirrors.py -q %s' % directory,
    ...     shell=True, stdin=PIPE, stdout=PIPE, stderr=PIPE)
    >>> (out, err) = process.communicate()
    >>> out, err
    ('', '')
    >>> process.returncode
    0

Let's have a look at one of the files generated by our script to see if it
looks good.

    >>> import os
    >>> sorted(open(os.path.join(directory, 'FR.txt')).read().split('\n'))
     ['http://archive.ubuntu.com/ubuntu/',
     'http://localhost:11375/archive-mirror/',
     'http://localhost:11375/valid-mirror/']

Cleanup!

    >>> import shutil
    >>> shutil.rmtree(directory)

