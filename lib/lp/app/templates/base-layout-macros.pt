<macros
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  i18n:domain="launchpad"
  tal:omit-tag=""
>

<metal:notifications define-macro="notifications"
  tal:define="notifications notifications|request/notifications">
  <tal:comment replace="nothing">
    This macro expects the following variables:
    :notifications: An object implementing INotificationList.
  </tal:comment>

  <div class="error message"
    tal:repeat="notification notifications/error"
    tal:content="structure notification/message"
  >An error notification message</div>
  <div class="warning message"
    tal:repeat="notification notifications/warning"
    tal:content="structure notification/message"
  >A warning notification message</div>
  <div class="informational message"
    tal:repeat="notification notifications/notice"
    tal:content="structure notification/message"
  >A notice notification message</div>
  <div class="informational message"
    tal:repeat="notification notifications/info"
    tal:content="structure notification/message"
  >An info notification message</div>
  <div class="debug message"
    tal:repeat="notification notifications/debug"
    tal:content="structure notification/message"
  >A debug notification message, only displayed for developers.</div>
</metal:notifications>


<metal:load-javascript define-macro="load-javascript"
  tal:define="
      revno modules/canonical.launchpad.versioninfo/revno | string:unknown;
      icingroot string:/+icing/rev${revno};
      devmode modules/canonical.config/config/devmode;
      yui string:${icingroot}/yui;
      lazr_js string:${icingroot}/lazr/build;
      lp_js string:${icingroot}/build"
  >
  <tal:comment replace="nothing">
    This macro just loads javascript files. It doesn't
    do any initialization.

    We load all of the script files from the same host that served the HTML in
    order to optimize IE caching over SSL. This is inefficient when you cross
    subdomains (from bugs to code for example) but luckily most users stay
    within one or two domains.

    XXX mars 2010-04-08
    We can revisit this IE-only optimization if we remove SSL.  Any changes that
    affect IE should be tested using webpagetest.org. (See the dev.launchpad.net
    wiki for details.)

    XXX mars 2010-01-21
    We have to load MochiKit outside of the main javascript rollup so that the
    rollup's size does not exceed 512Kb.  That magic number triggers a bug
    somewhere in the automated test system that will prevent Windmill from
    executing.
  </tal:comment>
  <script type="text/javascript"
          tal:attributes="src string:${icingroot}/MochiKit.js"></script>

  <tal:devmode condition="devmode">

    <tal:comment replace="nothing">
      Instead of loading the yui.js seed we will load three of it's five
      sub-components.

      We leave out get.js and loader.js, effectively disabling
      dynamic loading of modules.

      XXX mars 2009-11-03
      To see what modules are missing you have to change yui-base.js to
      yui-base-debug.js and move the <script/> node outside of this block.

      This will hopefully be fixed in YUI itself.
      See http://yuilibrary.com/projects/yui3/ticket/2528368
    </tal:comment>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/yui/yui-base.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/yui/yui-log.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/yui/yui-later.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${yui}/oop/oop.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/event/event.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/event/event-key.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/event-custom/event-custom.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/event-simulate/event-simulate.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/dom/dom.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/node/node.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/node-focusmanager/node-focusmanager.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/node/node-event-simulate.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/dump/dump.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/io/io.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/json/json.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/attribute/attribute.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/base/base.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/substitute/substitute.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/anim/anim.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/classnamemanager/classnamemanager.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/plugin/plugin.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/pluginhost/pluginhost.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget-position-ext.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/cookie/cookie.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget-position.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget-position-ext.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget-stack.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/widget/widget-stdmod.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/overlay/overlay.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${yui}/node-menunav/node-menunav.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/lazr/lazr.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/anim/anim.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/inlineedit/editor.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/autocomplete/autocomplete.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/overlay/overlay.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/activator/activator.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/picker/picker.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/formoverlay/formoverlay.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/choiceedit/choiceedit.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lazr_js}/effects/effects.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/lp.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/lp-mochi.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/lp-links.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/dragscroll.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/picker.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/bugtracker_overlay.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/registry/milestoneoverlay.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/registry/milestonetable.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/registry/timeline.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/sorttable/sorttable.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/inlinehelp/inlinehelp.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/client/client.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branch.bugspeclinks.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branch.status.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branchmergeproposal.diff.js">
      </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branch.subscription.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branchmergeproposal.status.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/branchmergeproposal.reviewcomment.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/code/productseries-setbranch.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/comment.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/app/errors.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/registry/team.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/translations/importqueue.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/translations/importqueueentry.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/translations/languages.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/translations/pofile.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/soyuz/archivesubscribers_index.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/soyuz/base.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/soyuz/lp_dynamic_dom_updater.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/soyuz/update_archive_build_statuses.js"></script>

    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/filebug_dupefinder.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/bug_tags_entry.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/official_bug_tags.js">
    </script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/subscriber.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${lp_js}/bugs/bugtask_index.js">
    </script>

  </tal:devmode>
  <tal:production condition="not:devmode">
    <script type="text/javascript"
            tal:attributes="src string:${icingroot}/build/launchpad.js"></script>
  </tal:production>

  <script type="text/javascript"
      tal:content="string:var cookie_scope = '${request/lp:cookie_scope}';"></script>
  <script type="text/javascript">
    // Define a global YUI sandbox that should be used by everyone.
    var LPS = YUI();
  </script>
</metal:load-javascript>


<metal:page-javascript define-macro="page-javascript"
  tal:define="
      revno modules/canonical.launchpad.versioninfo/revno | string:unknown;
      icingroot_contrib string:/+icing-contrib/rev${revno};
      devmode modules/canonical.config/config/devmode;
      map_query string:&amp;file=api&amp;v=2&amp;key=${modules/canonical.config/config/google/maps_api_key};">
  <tal:comment replace="nothing">
    Load and initialize the common script used by all pages.
  </tal:comment>

  <tal:needs_json tal:condition="request/needs_json">
    <script type="text/javascript"
            tal:attributes="src string:${icingroot_contrib}/json2.js"></script>
    <script type="text/javascript"
            tal:attributes="src string:${icingroot_contrib}/JSONScriptRequest.js"></script>
  </tal:needs_json>

  <metal:load-lavascript use-macro="context/@@+base-layout-macros/load-javascript" />

  <script id="base-layout-load-scripts" type="text/javascript">
    LPS.use('node', 'lp', function(Y) {
        Y.on('load', function(e) {
            sortables_init();
            initInlineHelp();
            Y.lp.activate_collapsibles();
            activateFoldables();
            activateConstrainBugExpiration();
        }, window);

        // Hook up the function that dismisses the help window if we click
        // anywhere outside of it.
        Y.on('click', handleClickOnPage, window);
    });

    LPS.use('lp.app.links',
      function(Y) {
        Y.on('load', function(e) {
            Y.lp.app.links.check_branch_links();
        }, window);
    });
  </script>
</metal:page-javascript>


<metal:launchpad-stylesheet-3-0 define-macro="launchpad-stylesheet-3-0"
  tal:define="
    revno modules/canonical.launchpad.versioninfo/revno | string:unknown;
    icingroot string:/+icing/rev${revno}">
  <tal:comment replace="nothing">
    This macro loads a single css file containing all our stylesheets.
    If you need to include a new css file here, add it to
    buildout-templates/bin/combine-css.in instead.

    We load the CSS from the same host that served the HTML in order to optimize
    IE caching over SSL. This is inefficient when you cross subdomains (from
    bugs to code for example) but luckily most users stay within one or two
    domains.

    XXX mars 2010-04-08
    We can revisit this IE-only optimization if we remove SSL.  Any changes that
    affect IE should be tested using webpagetest.org. (See the dev.launchpad.net
    wiki for details.)
  </tal:comment>
  <link
        type="text/css"
        rel="stylesheet"
        media="screen, print"
        tal:attributes="href string:${icingroot}/combo.css" />
</metal:launchpad-stylesheet-3-0>


<metal:lp-client-cache define-macro="lp-client-cache">
  <tal:cache condition="view/user|nothing"
              define="cache request/webservicerequest:cache;
                      links cache/links;
                      objects cache/objects;">
    <script tal:repeat="key links"
      tal:content="string:LP.client.links['${key}'] =
                   '${links/?key/fmt:api_url}';">
    </script>
    <script tal:repeat="key objects"
      tal:content="string:LP.client.cache['${key}'] =
                   ${objects/?key/webservice:json};">
    </script>
  </tal:cache>

  <script tal:condition="context/webservice:is_entry"
    tal:content="string:LP.client.cache['context'] =
                 ${context/webservice:json};">
  </script>
</metal:lp-client-cache>


<metal:application-buttons define-macro="application-buttons">
  <!-- Application Menu -->
  <ul class="facetmenu"
      tal:define="facetmenu view/menu:facet">
    <tal:facet repeat="link facetmenu">
      <li
        tal:condition="python: link.enabled and link.selected"
        tal:attributes="title link/summary; class string:${link/name} active"
        ><span
          tal:condition="not:link/linked"
          tal:content="structure link/escapedtext"
          /><a
          tal:condition="link/linked"
          tal:attributes="href link/url"
          tal:content="structure link/escapedtext" /></li>
      <li
        tal:condition="python: link.enabled and not link.selected"
        tal:attributes="title link/summary; class link/name"
        ><a
          tal:condition="link/enabled"
          tal:attributes="href link/url"
          tal:content="structure link/escapedtext"
          /></li>
      <li
        tal:condition="not:link/enabled"
        tal:attributes="class string:${link/name} disabled-tab"
        ><span
           tal:content="link/escapedtext" /></li>
    </tal:facet>
  </ul>
</metal:application-buttons>


<metal:footer define-macro="footer">
  <div id="footer" class="footer">
    <div class="lp-arcana" tal:condition="not:view/is_root_page|nothing">
        <div class="lp-branding">
          <a tal:attributes="href string:${rooturl}"><img src="/@@/launchpad-logo-and-name-hierarchy.png" alt="Launchpad"/></a>
          &nbsp;&bull;&nbsp;
          <a tal:attributes="href string:${rooturl}+tour">Take the tour</a>
          &nbsp;&bull;&nbsp;
          <a href="https://help.launchpad.net/">Read the guide</a>
          &nbsp;
          <form id="globalsearch" method="get" accept-charset="UTF-8"
            tal:condition="view/macro:pagehas/globalsearch"
            tal:attributes="action string:${rooturl}+search">
            <input type="search" id="search-text" name="field.text" />
            <input type="submit" value="" class="icon-only sprite search-icon" />
          </form>
        </div>
        <metal:site-message
          use-macro="context/@@+base-layout-macros/site-message"/>
    </div>

    <div class="colophon">
      &copy; 2004-2010
      <a href="http://canonical.com/">Canonical&nbsp;Ltd.</a>
      &nbsp;&bull;&nbsp;
      <a tal:attributes="href string:${rooturl}legal">Terms of use</a>
      &nbsp;&bull;&nbsp;
      <a tal:condition="not: view/user|nothing"
        href="/feedback">Contact Launchpad Support</a>
      <a tal:condition="view/user|nothing"
        href="/support">Contact Launchpad Support</a>
      &nbsp;&bull;&nbsp;
      <a href="http://identi.ca/launchpadstatus"
        >System status</a>
      <span id="lp-version" tal:condition="not:is_lpnet">
      &nbsp;&bull;&nbsp;
        r<tal:revno replace="revno" />
        <tal:devmode condition="devmode">devmode</tal:devmode>
        <tal:demo condition="is_demo">demo site</tal:demo>
        <tal:edge condition="is_edge">
          beta site (<a href="https://code.edge.launchpad.net/~launchpad-pqm/launchpad/stable/"
             >get the code</a>)
        </tal:edge>
      </span>
    </div>
  </div>
</metal:footer>

<metal:site-message define-macro="site-message">
  <div class="sitemessage" tal:condition="site_message">
    <tal:site_message tal:content="structure site_message">
      This site is running pre-release code.
    </tal:site_message>
    <tal:edge_only condition="is_edge">
      <a href="#" class="js-action" onclick="setBetaRedirect(false)"
         tal:condition="not:request/isRedirectInhibited">
        Disable edge redirect.
      </a>
      <a href="#" class="js-action" onclick="setBetaRedirect(true)"
         tal:condition="request/isRedirectInhibited">
        Enable edge redirect.
      </a>
    </tal:edge_only>
  </div>
</metal:site-message>

<metal:plural-msg define-macro="plural-message">
  <tal:comment condition="nothing">
    Expected variables to be defined in a containing tag or global:
    count - value to check to determine plural form
    singluar - string to use when count == 1
    plural - string to use when count > 1.  If no plural is given it defaults
    to the singular value + 's'.
  </tal:comment>
  <tal:singular
    condition="python: count == 1"
    replace="singular" /><tal:plural
     define="l_default string:s;
             l_plural plural | string:$singular$l_default;"
    condition="python: count != 1"
    replace="l_plural" /></metal:plural-msg>
</macros>
