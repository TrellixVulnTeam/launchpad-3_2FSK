POFile
------

Get evolution template for Ubuntu Hoary

>>> from zope.component import getUtility
>>> from canonical.launchpad.interfaces import (IPOTemplateSet,
... ISourcePackageNameSet, IDistributionSet)
>>> sourcepackagenameset = getUtility(ISourcePackageNameSet)
>>> sourcepackagename = sourcepackagenameset['evolution']
>>> distributionset = getUtility(IDistributionSet)
>>> distribution = distributionset['ubuntu']
>>> release = distribution['hoary']
>>> potemplateset = getUtility(IPOTemplateSet)
>>> potemplatesubset = potemplateset.getSubset(
...     distrorelease=release, sourcepackagename=sourcepackagename)
>>> potemplate = potemplatesubset['evolution-2.2']

Get Xhosa translation

>>> pofile = potemplate.queryPOFileByLang('xh')

Get the set of POTMsgSets that are untranslated.

>>> potmsgsets = list(pofile.getPOTMsgSetUntranslated())
>>> len(potmsgsets)
22

Get Spanish translation

>>> pofile = potemplate.queryPOFileByLang('es')

Get the set of POTMsgSets that are untranslated.

>>> potmsgsets = list(pofile.getPOTMsgSetUntranslated())
>>> len(potmsgsets)
15

Test that the header is updated.

>>> from canonical.launchpad.components.poparser import POHeader

This is the comment.

>>> comment = ' This is the top comment.'

This is the new header.

>>> msgstr = '''Project-Id-Version: es
... POT-Creation-Date: 2004-08-18 11:10+0200
... PO-Revision-Date: 2005-08-18 13:22+0000
... Last-Translator: Carlos Perelló Marín <carlos@canonical.com>
... Language-Team: Spanish <traductores@es.gnome.org>
... MIME-Version: 1.0
... Content-Type: text/plain; charset=UTF-8
... Content-Transfer-Encoding: 8bit
... Report-Msgid-Bugs-To: serrador@hispalinux.es
... X-Generator: Rosetta (http://launchpad.ubuntu.com/rosetta/)
... Plural-Forms: nplurals=2; plural=n != 1;'''

Now, get a POHeader object with that information.

>>> new_header = POHeader(commentText=comment, msgstr=msgstr)
>>> new_header.finish()

We check that the plural forms expression is correctly parsed:

>>> new_header.getPluralFormExpression() == 'n != 1'
True

To be sure the new header is being applied, here we have the old values:

>>> print pofile.topcomment.encode('utf-8')
traducción de es.po al Spanish
translation of es.po to Spanish
...

>>> print pofile.header.encode('utf-8')
Project-Id-Version: es
POT-Creation-Date: 2004-08-17 11:10+0200
PO-Revision-Date: 2005-04-07 13:22+0000
...
Plural-Forms: nplurals=2; plural=(n != 1);

>>> pofile.fuzzyheader
True

>>> pofile.pluralforms
2

Now, is time to change the old header with the new one.

>>> pofile.updateHeader(new_header)

And the new values:

>>> pofile.topcomment
u' This is the top comment.'

>>> print pofile.header.encode('utf-8')
Project-Id-Version: es
POT-Creation-Date: 2004-08-18 11:10+0200
PO-Revision-Date: 2005-08-18 13:22+0000
...
Plural-Forms: nplurals=2; plural=n != 1;

>>> pofile.fuzzyheader
False

>>> pofile.pluralforms
2

Now I'm going to test creating a header with invalid plural-forms and
trying to parse the number and type of plural forms it has.

>>> msgstr = '''Project-Id-Version: es
... POT-Creation-Date: 2004-08-18 11:10+0200
... PO-Revision-Date: 2005-08-18 13:22+0000
... Last-Translator: Carlos Perelló Marín <carlos@canonical.com>
... Language-Team: Spanish <traductores@es.gnome.org>
... MIME-Version: 1.0
... Content-Type: text/plain; charset=UTF-8
... Content-Transfer-Encoding: 8bit
... Report-Msgid-Bugs-To: serrador@hispalinux.es
... X-Generator: Rosetta (http://launchpad.ubuntu.com/rosetta/)
... Plural-Forms: n != 1'''
>>> new_header = POHeader(msgstr=msgstr)
>>> new_header.finish()
WARNING:root:The plural form header has an unknown error. Using the default value...
>>> new_header.getPluralFormExpression() == None
True

