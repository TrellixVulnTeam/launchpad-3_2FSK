<div
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
>
  <form method="get" name="filter" id="filter_form"
        style="padding-bottom: 0.5em"
        tal:attributes="action context/view/form_action|context/request/URL">
    <label for="field.lifecycle">
      Branches with status:
    </label>
    <tal:lifecycle-selector replace="structure context/view/widgets/lifecycle"/>
    <tal:sort-by replace="structure context/view/widgets/sort_by"
                 condition="context/view/widgets/sort_by|nothing"/>
    <noscript>
      <input type="submit" value="Filter"/>
    </noscript>
  </form>

<script type="text/javascript">
function submit_filter() {
  getElement('filter_form').submit();
}

function hookUpFilterSubmission () {
  connect('field.lifecycle', 'onchange', submit_filter);
  if (getElement('field.sort_by')) {
    connect('field.sort_by', 'onchange', submit_filter);
  }
}
function show_commit(id) {
  var div = document.getElementById('branch-log-' + id);
  if (div) {
    div.style.display = "block";
  }
}
function hide_commit(id) {
  var div = document.getElementById('branch-log-' + id);
  if (div) {
    div.style.display = "none";
  }
}
registerLaunchpadFunction(hookUpFilterSubmission);

/* Sparklines!
addEvent( window, "load", function() {
  for(i in branch_sparks) {
    branch_id = branch_sparks[i][0];
    json_url = branch_sparks[i][1];
    document.getElementById(branch_id).innerHTML = json_url;
  }
});
*/

YUI().use('io-base', 'lazr.anim', 'node', 'json-parse', function(Y) {

  function doUpdate(transaction_id, response, args) {
    json_values = Y.JSON.parse(response.responseText);
    if(json_values.commits && json_values.count > 0) {
      document.getElementById(args.container).innerHTML = '';
      sparkline(args.container, json_values);
    }
    else
    {
      //alert(json_values);
    }
  }


  function updateSparks() {
    for(i in branch_sparks) {
      branch_id = branch_sparks[i][0];
      json_url = branch_sparks[i][1];
      var container = branch_id;
      var uri = json_url;
      var xhr_config = {
          on: {
              success: doUpdate,
          },
          arguments: {
              'container': container
          }
      };

      Y.io(uri, xhr_config);
    }
  }


  function sparkline(branch_id, o) {
    var nw = "auto";
    var nh = "auto";
    var spark_div = document.getElementById(branch_id);
    var number_commits = parseInt(o.commits.length);
    if (window.getComputedStyle) {
      nw = window.getComputedStyle(spark_div, null).width;
      nh = window.getComputedStyle(spark_div, null).height;
    }

    if ( nw != "auto" ) nw = nw.substr( 0, nw.length - 2 );
    if ( nh != "auto" ) nh = nh.substr( 0, nh.length - 2 );

    var f = 4;
    var w = ( nw == "auto" || nw == 0 ? o.commits.length * f : nw - 0 );
    var h = ( nh == "auto" || nh == 0 ? "1em" : nh );

    var co = document.createElement("canvas");

    if ( co.getContext ) spark_div.style.display = 'inline';
    else return false;

    co.style.height = h;
    co.style.width = w;
    co.width = w;
    spark_div.appendChild(co);

    var h = co.offsetHeight;
    co.height = h;

    var min = 9999;
    var max = -1;

    for (var i = 0; i < number_commits; i++) {
      o.commits[i] = o.commits[i] - 0;
      if ( o.commits[i] < min ) min = o.commits[i];
      if ( o.commits[i] > max ) max = o.commits[i];
    }

    if (co.getContext) {
      var c = co.getContext("2d");
      c.strokeStyle = "black";
      c.lineWidth = 1.0;
      c.beginPath();

      Y.log(number_commits);
      for (var i = 0; i < number_commits; i++) {
        if (i == 0) {
          Y.log('Result: ' + (w / number_commits) * i)
          Y.log('Result2: ' + (h - (((parseInt(o.commits[i]) - min)) * h)));
          Y.log('commits[1] = ' + o.commits[i]);
          Y.log('h = ' + h);
          Y.log('min = ' + min);
          Y.log('min = ' + max);
          c.moveTo( (w / number_commits) * i, h - (((o.commits[i] - min) / (max - min)) * h) );

        }
        c.lineTo( (w / number_commits) * i, h - (((o.commits[i] - min) / (max - min)) * h) );
      }

      c.stroke();

  /*
      // vertical line
      c.strokeStyle = "blue";
      c.beginPath();
      c.moveTo(w, h);
      c.lineTo(w, 0)
      c.stroke();

      // horizontal line
      c.beginPath();
      c.moveTo(0, h);
      c.lineTo(w, h)
      c.stroke();
  */
      spark_div.style.display = 'inline';
    }
  }

  Y.on("domready", updateSparks);
});



</script>

  <tal:needs-batch condition="context/multiple_pages">
    <div id="branch-batch-links">
      <tal:navigation replace="structure context/@@+navigation-links-upper" />
    </div>
  </tal:needs-batch>

  <table tal:attributes="class context/table_class" id="branchtable">
    <thead>
      <tr>
        <th colspan="2">Name</th>
        <th>Status</th>
        <th tal:condition="context/show_column/date_created|nothing">
          Registered
        </th>
        <th tal:condition="context/show_column/product|nothing">
          Project
        </th>
        <th>Last Modified</th>
        <th>Last Commit</th>
      </tr>
    </thead>
    <tbody>
        <tal:allow-setting-dev-focus condition="context/view/show_set_development_focus">
        <tal:missing-dev-focus define="product context/view/context;
                                       dev_focus context/view/has_development_focus_branch"
             condition="not: dev_focus">
      <tal:ignore condition="nothing">
        Only show the warning and link if the user can actually set the development focus
      </tal:ignore>
      <tr tal:condition="product/required:launchpad.Edit"
          tal:define="edit_link product/development_focus/fmt:url/+linkbranchtoseries">
        <td colspan="5" class="branch-no-dev-focus">A development focus branch hasn't 
            been specified, <a tal:attributes="href edit_link">set it now</a>.</td>
      </tr>
      </tal:missing-dev-focus>
      </tal:allow-setting-dev-focus>
      <tr tal:repeat="branch context/branches">
        <td>
          <img src="/@@/branch" /> <a tal:attributes="href branch/fmt:url;
                             title branch/displayname"
             tal:content="branch/bzr_identity">
               Name
          </a>
          <tal:associated-series repeat="series branch/active_series"
                                 condition="context/view/show_series_links">
            <tal:first-series condition="repeat/series/start">
            <br/><strong style="margin-left: 2.5em;">Series:</strong>
            </tal:first-series>
            <tal:comment condition="nothing">
              The lack of whitespace in the following tal expression
              is there to make sure the comma immediately follows the series
              link rather than having a space after it.
            </tal:comment>
            <tal:series-link>
              <a tal:attributes="href series/fmt:url" tal:content="series/name">
                trunk
              </a></tal:series-link><tal:comma condition="not: repeat/series/end">,</tal:comma>
          </tal:associated-series>
        </td>
        <td align="right" style="padding-right: 5px">
          <tal:dev_focus condition="branch/is_development_focus">
            <img src="/@@/favourite-yes" title="focus of development"/>
          </tal:dev_focus>
          <tal:badges replace="structure branch/badges:small"/>
        </td>
        <td>
          <span tal:condition="not:context/multiple_pages"
                tal:content="branch/lifecycle_status/sortkey"
                class="sortkey">23</span>
          <span tal:content="branch/lifecycle_status/title"
                tal:attributes="
                  class string:branchstatus${branch/lifecycle_status/name}">
                  Status</span>
        </td>
        <td tal:condition="context/show_column/date_created|nothing">
          <span class="sortkey"
                tal:content="branch/date_created/fmt:datetime">
            2005-02-12 13:45 EST
          </span>
          <span tal:attributes="title branch/date_created/fmt:datetime"
                tal:content="branch/since_created/fmt:approximateduration/use-digits">
            sometime
            </span> ago
        </td>
        <td tal:condition="context/show_column/product|nothing">
          <a tal:condition="branch/product"
             tal:attributes="href branch/product/fmt:url"
             tal:content="branch/product/name">
               Project
          </a>
        </td>

        <td>
          <span class="sortkey"
                tal:content="branch/date_last_modified/fmt:datetime">
            2005-02-12 13:45 EST
          </span>
          <div tal:attributes="id string:b-${repeat/branch/number}">
          <span tal:attributes="title branch/date_last_modified/fmt:datetime"
                tal:content="branch/since_updated/fmt:approximateduration/use-digits">
            sometime
            </span> ago
          </div>
        </td>

        <tal:no_commit condition="not: branch/last_commit">
          <td>
            <em>
              <metal:no-revision-message
                use-macro="branch/@@+macros/no-revision-message" />
            </em>
          </td>
        </tal:no_commit>

        <tal:has_commit condition="branch/last_commit">
          <td tal:attributes="onmouseover string:show_commit(${branch/id});
                              onmouseout string:hide_commit(${branch/id});">
            <div class="lastCommit">
              <a tal:attributes="href branch/revision_codebrowse_link"
                 tal:content="branch/revision_count">1234</a>.
              <tal:revision-log replace="branch/revision_log/fmt:shorten/40"/>
            </div>
            <div class="popupTitle"
                 tal:attributes="id string:branch-log-${branch/id};
                                 onmouseover string:hide_commit(${branch/id});">
              <p><strong>Author:</strong>
              <tal:known-person condition="branch/revision_author/person">
                <tal:person-link
                    replace="structure branch/revision_author/person/fmt:link"/>
              </tal:known-person>
              <tal:unknown-person
                  condition="not: branch/revision_author/person">
                <tal:person-text
                    tal:replace="branch/revision_author/name_without_email">
                  John Doe
                </tal:person-text>
                <tal:person-only-email
                    condition="not: branch/revision_author/name_without_email">
                  <tal:not-anonymous condition="context/view/user">
                    <tal:person-text
                        tal:replace="branch/revision_author/email">
                      doe.john@example.com
                    </tal:person-text>
                  </tal:not-anonymous>
                  <tal:anonymous condition="not:context/view/user">
                    &lt;email address hidden&gt;
                  </tal:anonymous>
                </tal:person-only-email>
              </tal:unknown-person>
              <br/>
              <strong>Revision Date:</strong>
              <tal:revision-date replace="branch/revision_date/fmt:datetime"/></p>
              <tal:commit-msg replace="structure branch/revision_log/fmt:text-to-html"/>
            </div>
          </td>

        </tal:has_commit>
      </tr>
      <tr tal:condition="not:context/batch/total">
        <td tal:attributes="colspan context/column_count">
          <div id="no-branch-message"
               tal:content="structure context/view/no_branch_message" />
        </td>
      </tr>
    </tbody>
  </table>

  <tal:navigation replace="structure context/@@+navigation-links-lower" />

</div>

<tal:script
    replace="structure string:&lt;script type='text/javascript'&gt;" />
var branch_sparks = <tal:array replace="context/branch_sparks"/>;
<tal:script replace="structure string:&lt;/script&gt;" />
