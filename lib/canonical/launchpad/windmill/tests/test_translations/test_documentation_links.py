# Copyright 2009 Canonical Ltd.  All rights reserved.

"""Test for translation documentation links behaviour."""

__metaclass__ = type
__all__ = []

# Generated by the windmill services transformer
from windmill.authoring import WindmillTestClient

from canonical.launchpad.windmill.testing import lpuser

class DocumentationLinksTest:
    """Test that the documentation links on translation pages work properly."""

    def __init__(self, name=None, url='http://translations.launchpad.net:8085',
                 suite='translations', user=lpuser.TRANSLATIONS_ADMIN):
        """Create a new DocumentationLinksTest.

        :param name: Name of the test.
        :param url: Start at, default http://translation.launchpad.net:8085.
        :param suite: The suite in which this test is part of.
        :param user: The user who should be logged in.
        """
        self.url = url
        if name is None:
            self.__name__ = 'test_%s_documentation_links' % suite
        else:
            self.__name__ = name
        self.suite = suite
        self.user = user

    def __call__(self):
        """Tests that documentation links are shown/hidden properly.

        The test:
        * sets translation instructions link for a translation group;
        * opens a Spanish translation page;
        * tries hiding the notification box;
        * makes sure it's hidden when you stay on the same translation;
        * makes sure it's shown again when you go to a different translation.
        """
        client = WindmillTestClient(self.suite)

        # Go to Evolution translations page logged in as translations admin.
        self.user.ensure_login(client)
        client.open(url=self.url)
        client.waits.forPageLoad(timeout=u'20000')
        client.waits.forElement(link=u'Evolution', timeout=u'8000')
        client.click(link=u'Evolution')
        client.waits.forPageLoad(timeout=u'20000')

        # Set a 'Just a testing team' documentation link.
        client.waits.forElement(link=u'Just a testing team', timeout=u'8000')
        client.click(link=u'Just a testing team')
        client.waits.forPageLoad(timeout=u'20000')
        client.waits.forElement(link=u'Edit translation group details',
                                timeout=u'8000')
        client.click(link=u'Edit translation group details')
        client.waits.forPageLoad(timeout=u'20000')
        client.waits.forElement(timeout=u'8000',
                                id=u'field.translation_guide_url')
        client.click(id=u'field.translation_guide_url')
        client.type(text=u'https://help.launchpad.net/Translations/'
                         u'LaunchpadTranslators',
                    id=u'field.translation_guide_url')
        client.click(id=u'field.actions.change')
        client.waits.forPageLoad(timeout=u'20000')

        # Go to Evolution Spanish translation.
        client.waits.forElement(link=u'Evolution', timeout=u'8000')
        client.click(link=u'Evolution')
        client.waits.forPageLoad(timeout=u'20000')
        client.waits.forElement(link=u'Spanish', timeout=u'8000')
        client.click(link=u'Spanish')
        client.waits.forPageLoad(timeout=u'20000')

        # Make sure notification box is shown.
        client.waits.forElement(classname=u'important-notice-container',
                                timeout=u'8000')
        # Click the hide button.
        client.waits.forElement(classname=u'important-notice-cancel-button',
                                timeout=u'8000')
        client.click(classname=u'important-notice-cancel-button')
        # Hiding entire container looks ugly, so only the ballon itself
        # is hidden.
        client.waits.forElementProperty(classname=u'important-notice-balloon',
                                        option=u'style.display|none',
                                        timeout=u'8000')

        # Navigating to the next page of this translation doesn't show
        # the documentation box.
        client.click(classname=u'next')
        client.waits.forPageLoad(timeout=u'20000')
        client.asserts.assertProperty(classname=u'important-notice-container',
                                      validator=u'style.display|none')

        # Looking at Catalan translation instead shows the notice box again.
        client.waits.forElement(
            link=u'Template "evolution-2.2" in Evolution trunk',
            timeout=u'8000')
        client.click(link=u'Template "evolution-2.2" in Evolution trunk')
        client.waits.forPageLoad(timeout=u'20000')
        client.waits.forElement(link=u'Catalan', timeout=u'8000')
        client.click(link=u'Catalan')
        client.waits.forPageLoad(timeout=u'20000')
        client.asserts.assertNotProperty(
            classname=u'important-notice-container',
            validator=u'style.display|none')

test_documentation_links = DocumentationLinksTest(
    name='test_documentation_links')
