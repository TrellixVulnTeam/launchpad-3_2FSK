This file lists all the karma events that Malone produces. First let's
import some stuff and define a function to help us make the
documentation cleaner:

    >>> from canonical.launchpad.interfaces import (IPersonSet, IKarmaSet,
    ...     IKarmaActionSet, IDistributionSet, IBugSet, IMessageSet)
    >>> foo_bar = getUtility(IPersonSet).getByEmail('foo.bar@canonical.com')

    >>> karmaset = getUtility(IKarmaSet)

First let's define a variable, so that we can make sure that every
karma action got tested.

    >>> added_karma_actions = set()

Then we define a function that makes it easier to test. It makes sure
that foo_bar got the given karma action, and that he got the given
number of points as well. Also it adds the karma action to
added_karma_actions, so that we can make sure that every karma action
was covered in this document.

    >>> from zope.event import notify
    >>> from zope.interface import Interface
    >>> from canonical.launchpad.ftests.event import TestEventListener
    >>> from canonical.launchpad.event.interfaces import IKarmaAssignedEvent
    >>> def on_assigned_event(object, event):
    ...     action = event.karma.action
    ...     added_karma_actions.add(action)
    ...     print "Karma added: action=%s, points=%i" % (
    ...         action.name, action.points)
    >>> on_assigned_listener = TestEventListener(
    ...     Interface, IKarmaAssignedEvent, on_assigned_event)


Foo Bar is the one that will get all the karma:

    >>> login('foo.bar@canonical.com')


Karma Actions
-------------

Create a bug:

    >>> from canonical.launchpad.event import (SQLObjectCreatedEvent,
    ...     SQLObjectModifiedEvent)
    >>> from canonical.launchpad.interfaces import CreateBugParams
    >>> debian = getUtility(IDistributionSet).getByName('debian')
    >>> params = CreateBugParams(
    ...     comment=u"Give me some karma!", title=u"New Bug", owner=foo_bar)
    >>> bug = debian.createBug(params)
    >>> notify(SQLObjectCreatedEvent(bug))
    Karma added: action=bugcreated, points=10

Change the title of a bug:

    >>> from canonical.launchpad.webapp.snapshot import Snapshot
    >>> from canonical.launchpad.interfaces import IBug
    >>> old_bug = Snapshot(bug, providing=IBug)
    >>> bug.title = "Better Title"
    >>> notify(SQLObjectModifiedEvent(bug, old_bug, ['title']))
    Karma added: action=bugtitlechanged, points=1

Change the description of a bug:

    >>> old_bug = Snapshot(bug, providing=IBug)
    >>> bug.description = "Description of bug"
    >>> notify(SQLObjectModifiedEvent(bug, old_bug, ['description']))
    Karma added: action=bugdescriptionchanged, points=3

Add a web link to a bug:

    >>> from canonical.launchpad.interfaces import IBugExternalRefSet
    >>> link = getUtility(IBugExternalRefSet).createBugExternalRef(
    ...     bug, "http://www.com/", "Some link", foo_bar)
    >>> notify(SQLObjectCreatedEvent(link))
    Karma added: action=bugextrefadded, points=10

Add a CVE reference to a bug:

    >>> from canonical.launchpad.interfaces import ICveSet
    >>> from canonical.launchpad.database import BugCve
    >>> from canonical.lp.dbschema import CveStatus
    >>> cve = getUtility(ICveSet).new('2003-1234', description="Blah blah",
    ...     status=CveStatus.CANDIDATE)
    >>> bugcve = BugCve(cve=cve, bug=bug)
    >>> notify(SQLObjectCreatedEvent(bugcve))
    Karma added: action=bugcverefadded, points=15

Add watch for external bug to the bug:

    >>> from canonical.launchpad.interfaces import IBugTrackerSet
    >>> from canonical.launchpad.database import BugWatch
    >>> debbugs = getUtility(IBugTrackerSet)['debbugs']
    >>> bugwatch = BugWatch(
    ...     bug=bug,bugtracker=debbugs, remotebug=42, owner=foo_bar)
    >>> notify(SQLObjectCreatedEvent(bugwatch))
    Karma added: action=bugwatchadded, points=10

Mark a bug task as fixed:

    >>> from canonical.launchpad.interfaces import IDistroBugTask
    >>> from canonical.lp.dbschema import BugTaskStatus
    >>> bugtask = bug.bugtasks[0]
    >>> old_bugtask = Snapshot(bugtask, providing=IDistroBugTask)
    >>> bugtask.transitionToStatus(BugTaskStatus.FIXRELEASED)
    >>> notify(SQLObjectModifiedEvent(bugtask, old_bugtask, ['status']))
    Karma added: action=bugfixed, points=10

Reject a bug task:

    >>> old_bugtask = Snapshot(bugtask, providing=IDistroBugTask)
    >>> bugtask.transitionToStatus(BugTaskStatus.REJECTED)
    >>> notify(SQLObjectModifiedEvent(bugtask, old_bugtask, ['status']))
    Karma added: action=bugrejected, points=3

Accept a bug task:

    >>> old_bugtask = Snapshot(bugtask, providing=IDistroBugTask)
    >>> bugtask.transitionToStatus(BugTaskStatus.CONFIRMED)
    >>> notify(SQLObjectModifiedEvent(bugtask, old_bugtask, ['status']))
    Karma added: action=bugaccepted, points=5

Change a bug task's importance:

    >>> from canonical.lp.dbschema import BugTaskImportance
    >>> bugtask.importance = BugTaskImportance.HIGH
    >>> for importance in BugTaskImportance.items:
    ...     old_bugtask = Snapshot(bugtask, providing=IDistroBugTask)
    ...     bugtask.importance = importance
    ...     print importance.name
    ...     notify(SQLObjectModifiedEvent(bugtask, old_bugtask, ['importance']))
    UNTRIAGED
    Karma added: action=bugtaskimportancechanged, points=1
    WISHLIST
    Karma added: action=bugtaskimportancechanged, points=1
    LOW
    Karma added: action=bugtaskimportancechanged, points=1
    MEDIUM
    Karma added: action=bugtaskimportancechanged, points=1
    HIGH
    Karma added: action=bugtaskimportancechanged, points=1
    CRITICAL
    Karma added: action=bugtaskimportancechanged, points=1
    UNKNOWN
    Karma added: action=bugtaskimportancechanged, points=1

Create a new bug task:

    >>> from canonical.launchpad.interfaces import IBugTaskSet, IProductSet
    >>> evolution = getUtility(IProductSet)['evolution']
    >>> evolution_task = getUtility(IBugTaskSet).createTask(
    ...     bug, product=evolution, owner=foo_bar)
    >>> notify(SQLObjectCreatedEvent(evolution_task))
    Karma added: action=bugtaskcreated, points=10

Mark a bug as a duplicate:

    >>> bug_one = getUtility(IBugSet).get(1)
    >>> old_bug = Snapshot(bug, providing=IBug)
    >>> bug.duplicateof = bug_one
    >>> notify(SQLObjectModifiedEvent(bug, old_bug, ['duplicateof']))
    Karma added: action=bugmarkedasduplicate, points=5

Adding a comment generates a karma event, bug gives no points:

    >>> from canonical.launchpad.interfaces import IBugMessageSet
    >>> comment = getUtility(IBugMessageSet).createMessage(
    ...     subject="foo", bug=bug, owner=foo_bar, content="bar")
    >>> notify(SQLObjectCreatedEvent(comment))
    Karma added: action=bugcommentadded, points=0

Now, let's ensure that we've covered every one of Malone's karma actions,
except for updating the obsolete "summary" and "priority":

    >>> from canonical.launchpad.database import KarmaCategory
    >>> bugs_category = KarmaCategory.byName('bugs')
    >>> bugs_karma_actions = bugs_category.karmaactions
    >>> summary_change = getUtility(
    ...     IKarmaActionSet).getByName('bugsummarychanged')
    >>> added_karma_actions.add(summary_change)
    >>> priority_change = getUtility(
    ...     IKarmaActionSet).getByName('bugtaskprioritychanged')
    >>> added_karma_actions.add(priority_change)
    >>> added_karma_actions == set(bugs_karma_actions)
    True

Unregister the event listener to make sure we won't interfere in other tests.

    >>> on_assigned_listener.unregister()

XXX Matthew Paul Thomas 2006-03-22: On 2007-03-23, a year after bug summaries
were removed, all the karma gained from updating bug summaries will have
expired. Then the 'bugsummarychanged' row should be removed from the database,
and summary_change can be removed from this test. The same applies to the
'bugtaskprioritychanged' row on about 2007-05-15.
