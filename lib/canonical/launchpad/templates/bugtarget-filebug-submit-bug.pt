<html
  xmlns="http://www.w3.org/1999/xhtml"
  xml:lang="en"
  lang="en"
  metal:use-macro="context/@@main_template/master"
  i18n:domain="launchpad">

<body>

<metal:heading fill-slot="pageheading">
  <h1 tal:condition="not: view/similar_bugs">Report a new bug</h1>
  <h1 tal:condition="view/similar_bugs">Has your bug already been reported?</h1>
</metal:heading>

<div metal:fill-slot="main">

  <div metal:use-macro="context/@@launchpad_form/form">

    <div metal:fill-slot="extra_info">
      <p class="informational message"
         tal:condition="not: view/similar_bugs">
        No similar bugs were found.
      </p>
    </div>

    <metal:widgets metal:fill-slot="widgets">

      <div id="bug_reporting_form" tal:condition="not: view/similar_bugs">
        <table class="form">
          <metal:basic_filebug_widgets
              metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
        </table>
        <div class="actions">
          <input tal:replace="structure view/actions/field.actions.submit_bug/render" />
        </div>
      </div>

      <table width="100%" tal:condition="view/similar_bugs">
        <tbody>

          <tal:similar-bugs>
            <tr>
              <td>
                <input type="radio" id="bug-already-reported-yes" checked="checked"
                       name="field.bug_already_reported" value="on"
                       tal:condition="not:request/htmlform:field.bug_already_reported/selected/off" />
                <input type="radio" id="bug-already-reported-yes"
                       name="field.bug_already_reported" value="on"
                       tal:condition="request/htmlform:field.bug_already_reported/selected/off" />
              </td>
              <td>
                <label for="bug-already-reported-yes">
                  Yes, it's one of these:
                </label>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <table tal:replace="nothing" class="listing" id="similar-bugs" style="clear: both">
                  <thead>
                    <tr><th colspan="4">Summary</th></tr>
                  </thead>
                  <tbody>
                    <tr tal:repeat="bug view/similar_bugs"
                        tal:attributes="title bug/description/fmt:shorten/500"
                        title="bug description goes here">
                      <td>
                        <input type="radio" name="field.bug_already_reported_as"
                               tal:attributes="value string:${bug/id};
                                               id string:this-is-my-bug-${bug/id}" />
                      </td>
                      <td class="amount">
                        <label tal:content="bug/id" style="font-weight: normal"
                               tal:attributes="for string:this-is-my-bug-${bug/id}">1</label></td>
                        <td width="100%">
                          <label tal:content="bug/title" style="font-weight: normal"
                                 tal:attributes="for string:this-is-my-bug-${bug/id}">
                            Bug title
                          </label>
                        </td>
                        <td>
                          <a href="#" tal:attributes="href bug/fmt:url">
                            <nobr>View details...</nobr>
                          </a>
                        </td>
                    </tr>
                  </tbody>
                </table>

                <ul id="similar-bugs" style="list-style: none">
                  <li tal:repeat="bug view/similar_bugs"
                      tal:attributes="title bug/description/fmt:shorten/500"
                      title="bug description goes here">
                    <label style="font-weight: normal">
                      <input type="radio" name="field.bug_already_reported_as"
                             tal:attributes="value string:${bug/id};" />
                      <a tal:attributes="href bug/fmt:url" href="#"
                         tal:content="string:#${bug/id}: ${bug/title}">
                        #1: Firefox does not support SVG
                      </a>
                    </label>
                  </li>
                </ul>

                <div class="actions">
                  <input tal:replace="structure view/actions/field.actions.this_is_my_bug/render" />
                </div>
              </td>
            </tr>
          </tal:similar-bugs>

          <tal:submit-new-bug>
            <tr>
              <td>
                <input type="radio" id="bug-already-reported-no" checked="checked"
                       name="field.bug_already_reported" value="off"
                       tal:condition="request/htmlform:field.bug_already_reported/selected/off" />
                <input type="radio" id="bug-already-reported-no"
                       name="field.bug_already_reported" value="off"
                       tal:condition="not:request/htmlform:field.bug_already_reported/selected/off" />
              </td>
              <td>
                <label for="bug-already-reported-no">
                  No, I'd like to report a new bug.
                </label>
              </td>
            </tr>
            <tr>
              <td></td>
              <td>
                <div id="bug_reporting_form">
                  <table class="form">
                    <metal:basic_filebug_widgets
                        metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
                  </table>
                  <div class="actions">
                    <input tal:replace="structure view/actions/field.actions.submit_bug/render" />
                  </div>
                </div>
              </td>
            </tr>
          </tal:submit-new-bug>

        </tbody>
      </table>

      <script type="text/javascript" tal:condition="view/similar_bugs">
        var similar_bugs_form_elements = concat(
          getElementsByTagAndClassName('input', null, 'similar-bugs'));
        var submit_bug_form_elements = concat(
          getElementsByTagAndClassName('input', null, 'bug_reporting_form'),
          getElementsByTagAndClassName('textarea', null, 'bug_reporting_form'));

        /*
         * On-load, make sure that the 'No' stuff is displayed correctly.
         * We must always work from the data in the form, not just from
         * events. Some browsers (e.g. Firefox) refill the form when a page
         * is refreshed and you don't get onchange/onkeypress events.
         */
        connect(window, 'onload', $('bug-already-reported-no'),
          function(e) {
            var func = this.checked ? showElement : hideElement;
            func('bug_reporting_form');
          });

        /*
         * When the 'No' radio is selected, deselect all the 'Yes' options.
         */
        connect('bug-already-reported-no', 'onchange',
          function(e) {
            if (this.checked) {
              showElement('bug_reporting_form');
              forEach(similar_bugs_form_elements, function(element) {
                  element.checked = false;
                });
            }
          });
        // Safari doesn't trigger onchange for radio buttons it seems.
        connect('bug-already-reported-no', 'onclick', function(e) {
            signal(this, 'onchange');
          });

        /*
         * If a similar bug is selected, also select the 'Yes' radio button.
         */
        forEach(similar_bugs_form_elements, function(element) {
            var target = $('bug-already-reported-yes');
            var handler = function(e) {
                target.checked = true;
              };
            connect(element, 'onchange', handler);
            connect(element, 'onclick', handler); // For Safari
          });

        /*
         * If one of the form elements in the 'No' section is changed (or,
         * for immediate feedback, there is a key-press), then select the
         * 'Yes' radio button and signal the 'No' onchange handler.
         */
        forEach(submit_bug_form_elements, function(element) {
            var target = $('bug-already-reported-no');
            var handler = function(e) {
                target.checked = true;
                signal(target, 'onchange');
              };
            connect(element, 'onchange', handler);
            connect(element, 'onkeypress', handler);
          });
      </script>

    </metal:widgets>

    <div class="actions" metal:fill-slot="buttons">
    </div>

  </div>

</div>

</body>
</html>
