We need to login in order to add attachments.

  >>> browser.open('http://localhost/products/firefox/+bug/1')
  >>> browser.getLink('Add Attachment').click()
  Traceback (most recent call last):
  ...
  Unauthorized:...

When we're logged in we can access the page.

  >>> browser.addHeader('Authorization', 'Basic test@canonical.com:test')
  >>> browser.open('http://localhost/products/firefox/+bug/1')
  >>> browser.getLink('Add Attachment').click()

  >>> browser.url
  'http://localhost/products/firefox/+bug/1/+addattachment'

Let's add an attachment. We need to start the Librarian first.

  >>> from canonical.librarian.ftests.harness import LibrarianTestSetup
  >>> LibrarianTestSetup().setUp()

We then create a file-like object.

  >>> from cStringIO import StringIO
  >>> foo_file = StringIO('Traceback...')

and proceed to add it. We're not allowed to enter a whitespace-only title for
the attachment

  >>> browser.getControl('Attachment').add_file(
  ...   foo_file, 'text/plain', 'foo.txt')
  >>> browser.getControl('Title').value = '    '
  >>> browser.getControl('Comment').value = 'Added some information'
  >>> browser.getControl('Add').click()

  >>> 'Required input is missing' in browser.contents
  True

We try again with a proper title, note that we leave some leading and trailing
whitespace to test that we strip them:

  >>> foo_file.seek(0)
  >>> browser.getControl('Attachment').add_file(
  ...   foo_file, 'text/plain', 'foo.txt')
  >>> browser.getControl('Title').value = '   Some information   '
  >>> browser.getControl('Add').click()

After we added the attachment, we get redirected to the bug page.

  >>> browser.url
  'http://localhost/products/firefox/+bug/1'

We can check that the attachment is there

  >>> browser.getLink('Some information').url
  'http://localhost:58000/48/foo.txt'

  >>> 'Added some information' in browser.contents
  True

And that we stripped the leading and trailing whitespace correctly

  >>> '   Some information   ' in browser.contents
  False
