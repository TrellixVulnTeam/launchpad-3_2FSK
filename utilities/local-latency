#!/usr/bin/env python
import sys
import subprocess

class UserError(Exception):
    pass

def tc(command):
     subprocess.call('sudo tc ' + command, shell=True)

def start(delay=500, port=443):
    tc('qdisc add dev lo root handle 1: prio')
    tc('qdisc add dev lo parent 1:3 handle 30: netem delay %dms' % delay)
    tc('filter add dev lo protocol ip parent 1:0 prio 3 u32 match ip'
       ' dport %d 0xffff flowid 1:3' % port)
    tc('filter add dev lo protocol ip parent 1:0 prio 3 u32 match ip'
       ' sport %d 0xffff flowid 1:3' % port)


def stop():
    tc('qdisc del dev lo root')


def main(argv):
    commands = {
        'start': start,
        'stop': stop,
    }
    if len(argv) != 1:
        raise UserError('Must supply a command: %s.' %
                        ', '.join(commands.keys()))
    try:
        command = commands[argv[0]]
    except KeyError:
        raise UserError('%s invalid.  Valid commands: %s.' %
                        (argv[1], ', '.join(commands.keys())))
    command()


if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except UserError, e:
        sys.stderr.write(str(e)+'\n')
