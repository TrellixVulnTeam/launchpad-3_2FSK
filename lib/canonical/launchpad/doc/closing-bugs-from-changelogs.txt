= Closing bugs from changelogs =

When a package is uploaded to a distribution, a bug number can be
specified in the Launchpad-bugs-fixed header of the changes file.

    >>> changes_template = """
    ... Format: 1.7
    ... Launchpad-bugs-fixed: %s
    ... """

The package uploads are associated with specific releases of the
package, but the bugs they reference may be filed on the generic
distribution package.

    >>> from canonical.testing.layers import LaunchpadZopelessLayer
    >>> from canonical.launchpad.interfaces import (
    ...     CreateBugParams, IDistributionSet)
    >>> login('no-priv@canonical.com')
    >>> LaunchpadZopelessLayer.switchDbUser('launchpad')
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> pmount_ubuntu = ubuntu.getSourcePackage('pmount')
    >>> bug_params = CreateBugParams(
    ...     getUtility(ILaunchBag).user, "Test bug", "Test bug.")
    >>> pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> pmount_bug_id = pmount_bug.id

The package source uploads are represented as DistroSeriesQueue items
that are associated with DistroSeriesQueueSource items and a changes
file. The only thing in the changes file that is used to close the bug
is the Launchpad-bugs-fixed header.

    >>> from StringIO import StringIO
    >>> from canonical.launchpad.database import PackageUpload
    >>> from canonical.librarian.interfaces import ILibrarianClient
    >>> from canonical.lp.dbschema import (
    ...     PackageUploadStatus, PackagePublishingPocket)

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> ubuntu_hoary = ubuntu.getSeries('hoary')
    >>> changes = changes_template % pmount_bug_id
    >>> changes_file = getUtility(ILibrarianClient).addFile(
    ...     'pmount.changes', len(changes), StringIO(changes), 'text/plain')
    >>> queue_item = PackageUpload(
    ...     status=PackageUploadStatus.DONE,
    ...     archive=ubuntu_hoary.main_archive,
    ...     distroseries=ubuntu_hoary,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)
    >>> queue_item_id = queue_item.id

The DistroSeriesQueueSource items are linke to SourcePackageRelease
items, but for closing bugs the only thing that mattters is who uploaded
it, what package name is it, and to what distribution series it was
uploaded to.


    >>> from canonical.launchpad.database import (
    ...     PackageUploadSource, SourcePackageRelease)
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> sabdfl = getUtility(IPersonSet).getByName('sabdfl')
    >>> pmount_release_id = 20
    >>> pmount_release = SourcePackageRelease.get(pmount_release_id)
    >>> pmount_release.sourcepackagename.name
    u'pmount'
    >>> pmount_release.uploaddistroseries.name
    u'hoary'
    >>> source_queue = PackageUploadSource(
    ...     packageupload=queue_item,
    ...     sourcepackagerelease=pmount_release)

    # Need to commit the transaction so that the changes file can be
    # downloaded from the Librarian.
    >>> from canonical.database.sqlbase import commit
    >>> commit()

Right after the queue items have been processed by the publishing
scripts, close_bugs() is called with a list of queue item ids that have
been published. Passing a queue item with a Launchpad-bugs-fixed header
will close the specified bug.

    >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)
    >>> from canonical.launchpad.interfaces import IBugSet
    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'UNCONFIRMED'

    >>> from canonical.launchpad.scripts.processaccepted import close_bugs
    >>> close_bugs([queue_item_id])
    >>> pmount_task.status.name
    'FIXRELEASED'

The changelog associated with the SourcePackageRelease is automatically
added as a comment from the uploader.

    >>> commit()
    >>> LaunchpadZopelessLayer.switchDbUser('launchpad')
    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> last_comment = pmount_bug.messages[-1]
    >>> pmount_release = SourcePackageRelease.get(pmount_release_id)
    >>> print pmount_release.creator.displayname
    Mark Shuttleworth
    >>> print last_comment.owner.displayname
    Mark Shuttleworth

    >>> print pmount_release.changelog
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

    >>> print last_comment.text_contents
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

A bug notification is created for both the status change, and for the
comment addition. The both notifications will be batched together into a
single e-mail later.

    >>> from canonical.launchpad.database import BugNotification
    >>> notifications = BugNotification.select(orderBy='id')
    >>> for notification in notifications[-2:]:
    ...     print "From %s:\n%s\n" % (
    ...         notification.message.owner.displayname,
    ...         notification.message.text_contents)
    From Mark Shuttleworth:
    ** Changed in: pmount (Ubuntu)
           Status: Unconfirmed => Fix Released
    <BLANKLINE>
    From Mark Shuttleworth:
    pmount (0.1-1) hoary; urgency=low
    <BLANKLINE>
     * Fix description (Malone #1)
     * Fix debian (Debian #2000)
     * Fix warty (Warty Ubuntu #1)
    <BLANKLINE>
     -- Sample Person <test@canonical.com> Tue, 7 Feb 2006 12:10:08 +0300

It's possible to specify more than one bug in the Launchpad-bugs-fixed
header, each will be marked as Fix Released. If a nonexistent bug is
specified, it's ignored.

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> pmount_ubuntu = ubuntu.getSourcePackage('pmount')
    >>> pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> pmount_bug_id = pmount_bug.id
    >>> another_pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> another_pmount_bug_id = another_pmount_bug.id

    >>> changes = changes_template % "%d nonexistent %d" % (
    ...     pmount_bug_id, another_pmount_bug_id)
    >>> changes_file = getUtility(ILibrarianClient).addFile(
    ...     'pmount.changes', len(changes), StringIO(changes), 'text/plain')
    >>> queue_item = PackageUpload(
    ...     status=PackageUploadStatus.DONE,
    ...     distroseries=ubuntu_hoary,
    ...     archive=ubuntu_hoary.main_archive,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)
    >>> queue_item_id = queue_item.id
    >>> source_queue = PackageUploadSource(
    ...     packageupload=queue_item,
    ...     sourcepackagerelease=pmount_release)

    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'UNCONFIRMED'
    >>> another_pmount_bug = getUtility(IBugSet).get(another_pmount_bug_id)
    >>> [another_pmount_task] = another_pmount_bug.bugtasks
    >>> another_pmount_task.status.name
    'UNCONFIRMED'

    >>> commit()
    >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)
    >>> close_bugs([queue_item_id])
    >>> commit()
    >>> LaunchpadZopelessLayer.switchDbUser('launchpad')

    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'FIXRELEASED'
    >>> another_pmount_bug = getUtility(IBugSet).get(another_pmount_bug_id)
    >>> [another_pmount_task] = another_pmount_bug.bugtasks
    >>> another_pmount_task.status.name
    'FIXRELEASED'

== process-accepted.py ==

The closing of bugs are done in process-accepted.py, right after the
queue items have been processed.

    >>> commit()
    >>> LaunchpadZopelessLayer.switchDbUser('launchpad')
    >>> queue_item = PackageUpload.get(queue_item_id)
    >>> queue_item = PackageUpload(
    ...     status=PackageUploadStatus.ACCEPTED,
    ...     distroseries=ubuntu_hoary,
    ...     archive=ubuntu_hoary.main_archive,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)
    >>> queue_item_id = queue_item.id
    >>> source_queue = PackageUploadSource(
    ...     packageupload=queue_item,
    ...     sourcepackagerelease=pmount_release)

    >>> from canonical.lp.dbschema import BugTaskStatus
    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.transitionToStatus(BugTaskStatus.CONFIRMED)
    >>> another_pmount_bug = getUtility(IBugSet).get(another_pmount_bug_id)
    >>> [another_pmount_task] = another_pmount_bug.bugtasks
    >>> another_pmount_task.transitionToStatus(BugTaskStatus.CONFIRMED)


    >>> commit()
    >>> LaunchpadZopelessLayer.switchDbUser(test_dbuser)

    >>> import os.path
    >>> import subprocess
    >>> import sys
    >>> from canonical.config import config
    >>> script = os.path.join(config.root, "scripts/process-accepted.py")
    >>> process = subprocess.Popen(
    ...     [sys.executable, script, "ubuntu"])
    ...     stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    >>> stdout, stderr = process.communicate()
    >>> process.returncode
    0

    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'FIXRELEASED'
    >>> another_pmount_bug = getUtility(IBugSet).get(another_pmount_bug_id)
    >>> [another_pmount_task] = another_pmount_bug.bugtasks
    >>> another_pmount_task.status.name
    'FIXRELEASED'
