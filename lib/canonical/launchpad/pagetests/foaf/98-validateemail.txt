= Validating an email address =

The user 'salgado' has an unvalidated email address that was probably
added by gina. Now he wants to validate it.

    # Workaround for https://launchpad.net/launchpad/+bug/39016
    >>> from canonical.launchpad.mail import stub
    >>> stub.test_emails[:] = []

    >>> browser = setupBrowser(auth='Basic salgado@ubuntu.com:zeca')
    >>> browser.open('http://launchpad.dev/~salgado/+editemails')
    >>> print browser.title
    Guilherme Salgado's e-mail addresses

    >>> browser.getControl(name="UNVALIDATED_SELECTED").getControl(
    ...     value='salgado@ubuntu.com').selected = True
    >>> browser.getControl('Confirm').click()
    >>> for msg in get_feedback_messages(browser.contents):
    ...     print msg
    A new email was sent to 'salgado@ubuntu.com'...

Retrieve the email and make sure it was sent to the right address.

    >>> import email
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> msg = email.message_from_string(raw_msg)
    >>> print msg.get('to')
    salgado@ubuntu.com

Visit the token URL mentioned in the email, and get redirected to
+validateemail.

    >>> from canonical.launchpad.ftests.logintoken import (
    ...     get_token_url_from_email)
    >>> token_url = get_token_url_from_email(raw_msg)
    >>> browser.open(token_url)

    >>> print browser.url
    http://launchpad.dev/token/.../+validateemail
    >>> print browser.title
    Confirm e-mail address

    >>> print find_main_content(browser.contents)
    <div...Confirm e-mail address...salgado@ubuntu.com...

    >>> browser.getControl('Continue').click()
    >>> print browser.title
    Guilherme Salgado in Launchpad

Check that the email address now shows up as validated.

    >>> browser.getLink('Update e-mail addresses').click()
    >>> browser.getControl(name="VALIDATED_SELECTED").getControl(
    ...     value='salgado@ubuntu.com')
    <ItemControl...optionValue='salgado@ubuntu.com'>

    >>> browser.getControl(name="UNVALIDATED_SELECTED").getControl(
    ...     value='salgado@ubuntu.com')
    Traceback (most recent call last):
    ...
    LookupError...
