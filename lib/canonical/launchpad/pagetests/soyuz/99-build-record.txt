
Presenting Build Record details:

  >>> from zope.testbrowser.testing import Browser
  >>> from mechanize import LinkNotFoundError
  >>> from urllib2 import HTTPError

  >>> anon_browser.open("http://localhost/+builds/+build/17")
  >>> anon_browser.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...pmount...
  ...0.1-1...
  ...ubuntu...
  ...breezy-autotest...
  ...i386...
  ...Failed to build...
  ...2005-10-01 00:00:00 UTC...
  ...2005-10-02 00:00:01 UTC...'

With anonymous access, Reset Build link should not be there

  >>> try:
  ...     anon_browser.getLink("Reset Build")
  ... except LinkNotFoundError:
  ...     print "LinkNotFoundError"
  LinkNotFoundError

...and if we go directly to the page, no dice

  >>> anon_browser.handleErrors = True
  >>> anon_browser.open("http://localhost/+builds/+build/17/+reset")
  >>> anon_browser.url
  'http://localhost/+builds/+build/17/+reset/+login'

Let's log in and the link should appear:

  >>> admin_browser.open("http://localhost/+builds/+build/17")
  >>> admin_browser.getLink("Reset Build").click()
  >>> admin_browser.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Reset Build...'

We'll also set up a second browser pointing at this page, for later.

  >>> admin_browser_2 = Browser()
  >>> admin_browser_2.addHeader("Authorization", "Basic foo.bar@canonical.com:test")
  >>> admin_browser_2.open("http://localhost/+builds/+build/17")
  >>> admin_browser_2.getLink("Reset Build").click()

Performing "Reset Build" with the first browser

  >>> admin_browser.getControl("Reset Build").click()
  >>> admin_browser.contents
  '...Build Record reset...'

Now it's reset, the reset button and the link to the reset page
are gone.

  >>> admin_browser.handleErrors = True
  >>> try:
  ...     admin_browser.getControl("Reset Build")
  ... except LookupError:
  ...     print "LookupError"
  LookupError

  >>> try:
  ...     admin_browser.getLink("Reset Build")
  ... except LinkNotFoundError:
  ...     print "LinkNotFoundError"
  LinkNotFoundError

The second browser has old content, so still has a reset build button.
Clicking this should give a warning.

  >>> admin_browser_2.getControl("Reset Build").click()
  >>> admin_browser_2.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Build can not be reset...'

Build rescoring feature (fixed bug #44227, we create build records
when reseting a build, so there is not life-cycle for a pending build
w/o build record anymore.)

  >>> admin_browser.getLink("Rescore Build").click()
  >>> admin_browser.getControl(name="SCORE").value = '100'
  >>> admin_browser.getControl("Update").click()
  >>> admin_browser.contents
  '...Rescore i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Build Record rescored to 100...'

it also checks input data sanity (bug # 44240):

  >>> admin_browser.getControl(name="SCORE").value = 'foo'
  >>> admin_browser.getControl("Update").click()
  >>> admin_browser.contents
  '...Rescore i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...priority must be an integer not "foo"...'


Also handles attempts to rescore a build in the wrong state:

  >>> print http(r"""
  ... POST /+builds/+build/13/+rescore HTTP/1.1
  ... Authorization: Basic Y2FybG9zQGNhbm9uaWNhbC5jb206dGVzdA==
  ... Content-Length: 9
  ...
  ... RESCORE=6""")
  HTTP/1.1 200 Ok
  Content-Length: ...
  ...i386 build of netapplet 0.99.6-1 in ubuntu warty...
  ...Build can not be rescored...

Build record inserted by gina that has an unknown build record.

  >>> admin_browser.open("http://localhost/+builds/+build/10")
  >>> admin_browser.contents
  '...i386 build of cnews cr.g7-37 in ubuntu warty...
  ...<td>Successfully built</td>...
  ...<td>2006-01-27 02:00:00 SAST</td>...
  ...Build machine:...
  ...unknown...'


Check if buildd-celebrity is working as expected, try to access protected
pages as cprov (launchpad-buildd-admins member). Not using the better login
method here, as don't know the password.

  >>> browser = Browser()
  >>> browser.addHeader(
  ...     "Authorization",
  ...     "Basic Y2Vsc28ucHJvdmlkZWxvQGNhbm9uaWNhbC5jb206Y3Byb3Y=")

  >>> browser.open("http://localhost/+builds/+build/12")
  >>> browser.getLink("Reset Build").click()
  >>> browser.getControl("Reset Build").click()
  >>> browser.contents
  '...Build Record reset...'

Allow Re-score:

  >>> browser.getLink("Rescore Build").click()
  >>> browser.getControl(name="SCORE").value = '100'
  >>> browser.getControl("Update").click()
  >>> browser.contents
  '...Build Record rescored to 100...'

Allow new builder:

  >>> browser.open("http://localhost/+builds/+new")

Denied admistration of a builder:

  >>> try:
  ...     browser.open("http://localhost/+builds/bob/+admin")
  ... except HTTPError, info:
  ...     info
  <HTTPError...

Adding new builder still denied for non-members (Edgar, no membership):

(Disabled, as fixed by a change cprov has but hasn't landed)
The commented line below will be the correct results section for the
test case below when the other change is being merged.

  >>> browser = Browser()
  >>> browser.addHeader("Authorization", "Basic edgar@monteparadiso.hr:test")

  >>> try:
  ...     browser.open("http://localhost/+builds/+new")
  ... except HTTPError, info:
  ...     info

  <HTTPError...

