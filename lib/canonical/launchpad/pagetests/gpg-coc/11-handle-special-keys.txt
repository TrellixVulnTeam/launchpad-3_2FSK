This test verifies that we correctly handle keys which are in some way
special: either invalid, broken, revoked, expired, sign-only or already
imported.

  >>> import email
  >>> from canonical.launchpad.mail import stub
  >>> from canonical.zeca.ftests.harness import ZecaTestSetup

  >>> z = ZecaTestSetup()
  >>> z.setUp()

  >>> sign_only   = "447D BF38 C4F9 C4ED 7522  46B7 7D88 9137 17B0 5A8F"
  >>> preimported = "A419AE861E88BC9E04B9C26FBA2B9389DFD20543"

Try to import a key which is already imported:

  >>> browser.addHeader('Authorization', 'Basic test@canonical.com:test')
  >>> browser.open('http://launchpad.dev/~name12/+editpgpkeys')
  >>> browser.getControl(name='fingerprint').value = preimported
  >>> browser.getControl(name='import').click()
  >>> "A message has been sent" in browser.contents
  False
  >>> stub.test_emails
  []
  >>> print browser.contents
  <BLANKLINE>
  ...
  ...has already been imported...

Finally, a key which is sign-only. This one is actually supported and
has a special validation email..

  >>> browser.open('http://launchpad.dev/~name12/+editpgpkeys')
  >>> browser.getControl(name='fingerprint').value = sign_only
  >>> browser.getControl(name='import').click()
  >>> print browser.contents
  <BLANKLINE>
  ...
  ...A message has been sent...

..which is not encrypted..

  >>> "decrypt the message" in browser.contents
  False

and looks like this:

  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
  >>> msg = email.message_from_string(raw_msg)
  >>> print msg.get_payload(decode=True)
  <BLANKLINE>
  ...
  We received a request from Sample Person using email address
  test@canonical.com, trying to confirm an OpenPGP key for use in
  Launchpad.
  <BLANKLINE>
  Key details:
  <BLANKLINE>
  447DBF38C4F9C4ED752246B77D88913717B05A8F
  1024D/17B05A8F
  sign.only@canonical.com
  <BLANKLINE>
  <BLANKLINE>
  Please go here to finish adding the key to your Launchpad account:
  http://.../token/...
  ...

Finally, kill zeca:

  >>> z.tearDown()

