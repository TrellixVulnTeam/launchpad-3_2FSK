Let's test the /myrequest page, where users place new requests and/or change
existing ones.

  >>> browser.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
  >>> browser.open('http://localhost/shipit-ubuntu/myrequest')
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...Request CDs...
  ...

First of all, we'll make sure a request is accepted only if all required 
fields are filled.

  >>> browser.getControl(name='ordertype').value = ['1']
  >>> browser.getControl('Request CDs').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...Your ShipIt Request...
  ...
  ...Please fix the problems below and try again...
  ...
  ...Name...
  ...
  ...Required input is missing...
  ...
  ...Address...
  ...
  ...Required input is missing...
  ...
  ...City/Town/etc...
  ...
  ...Required input is missing...
  ...
  ...Country...
  ...
  ...Required input is missing...
  ...
  ...Phone...
  ...
  ...Required input is missing...
  ...


For some countries like the US, our shipping company requires a postcode, so
we can't accept a request from the US without a postcode.

  >>> browser.getControl(name='field.recipientdisplayname').value = 'Foo'
  >>> browser.getControl(name='field.organization').value = 'Baz'
  >>> browser.getControl(name='field.addressline1').value = 'Street'
  >>> browser.getControl(name='field.city').value = 'City'
  >>> browser.getControl(name='field.province').value = 'Province'
  >>> browser.getControl(name='field.postcode').value = ''
  >>> browser.getControl(name='field.country').value = ['226']
  >>> browser.getControl(name='field.phone').value = '43242442'
  >>> browser.getControl('Request CDs').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...Please fix the problems below and try again...
  ...Shipping to your country requires a postcode, but you didn't provide...
  ...one. Please enter one below...


Now we fill in the last remaining required field and the request is
accepted. The request is automatically approved because the user can
only choose the number of CDs from a list of predefined options.

  >>> browser.getControl(name='field.postcode').value = '42423'
  >>> browser.getControl('Request CDs').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...Request accepted. Please note that requests usually take from 4 to 6...
  ...weeks to deliver, depending on the country of shipping...

  >>> from canonical.launchpad.database import Person
  >>> from canonical.launchpad.ftests import login, logout, ANONYMOUS
  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest().isApproved()
  True
  >>> Person.byName('name16').currentShipItRequest().getTotalApprovedCDs()
  10
  >>> logout()


If now we go to one of shipit.kubuntu or shipit.edubuntu, we'll be able to
add more CDs to our existing request...

  >>> browser.open('http://localhost/shipit-kubuntu/myrequest')
  >>> browser.url
  'http://localhost/shipit-kubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...<h1>...
  ...Request more CDs...
  ...</h1>...

  >>> browser.getControl(name='ordertype').value = ['10']
  >>> browser.getControl('Request More CDs').click()
  >>> browser.url
  'http://localhost/shipit-kubuntu/myrequest'


...and it will still be approved, because it's a standard request.

  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest().isApproved()
  True
  >>> Person.byName('name16').currentShipItRequest().getTotalApprovedCDs()
  11
  >>> logout()


Now we'll create a ShippingRun to simulate that this request was shipped, so
that we can see how shipit behaves for people making further requests for a
given distrorelease.

  >>> from canonical.launchpad.database import ShippingRequestSet
  >>> login(ANONYMOUS)
  >>> shippingrun = ShippingRequestSet()._create_shipping_run(
  ...     [Person.byName('name16').currentShipItRequest().id])
  >>> [request.recipient.name for request in shippingrun.requests]
  [u'name16']
  >>> logout()

name16's shipped request contained Ubuntu and Kubuntu CDs. This means that if
he makes another request containing /only/ Edubuntu CDs it'll be auto
approved, otherwise it'll have to be manually approved.

  >>> sorted(flavour.title 
  ...        for flavour in shippingrun.requests[0].getContainedFlavours())
  ['Kubuntu', 'Ubuntu']

  >>> browser.open('http://localhost/shipit-edubuntu/myrequest')
  >>> browser.url
  'http://localhost/shipit-edubuntu/myrequest'

As name16 already has a request, the address fields will be pre-filled for
him.

  >>> browser.getControl(name='field.recipientdisplayname').value
  'Foo'
  >>> browser.getControl(name='field.organization').value
  'Baz'

  >>> browser.getControl(name='ordertype').value = ['14']
  >>> browser.getControl('Request CDs').click()
  >>> browser.url
  'http://localhost/shipit-edubuntu/myrequest'

  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest().isApproved()
  True
  >>> Person.byName('name16').currentShipItRequest().getTotalApprovedCDs()
  1
  >>> logout()

If he adds any Ubuntu or Kubuntu CDs to his request, it'll then be marked as
pending approval.

  >>> browser.open('http://localhost/shipit-ubuntu/myrequest')
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> browser.getControl(name='ordertype').value = ['1']
  >>> browser.getControl('Request More CDs').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest().isAwaitingApproval()
  True
  >>> Person.byName('name16').currentShipItRequest().getTotalApprovedCDs()
  0
  >>> logout()

Let's pretend Marilize approved his request and it was shipped, so that we
can make a third one and see what happens.

  >>> login('marilize@hbd.com')
  >>> request = Person.byName('name16').currentShipItRequest()
  >>> request.approve()
  >>> shippingrun = ShippingRequestSet()._create_shipping_run(
  ...     [Person.byName('name16').currentShipItRequest().id])
  >>> [request.recipient.name for request in shippingrun.requests]
  [u'name16']
  >>> Person.byName('name16').currentShipItRequest() is None
  True
  >>> logout()

  >>> browser.open('http://localhost/shipit-ubuntu/myrequest')
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> browser.getControl(name='ordertype').value = ['1']
  >>> browser.getControl('Request CDs').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest().isToBeDenied()
  True
  >>> logout()

It's also possible to cancel an existing request.

  >>> browser.getControl('Cancel Request').click()
  >>> browser.url
  'http://localhost/shipit-ubuntu/myrequest'

  >>> print browser.contents
  <!DOCTYPE...
  ...Request Cancelled...
  ...Shipped/Cancelled requests...
  ...
  ...11 CDs requested in...
  ...

  >>> login(ANONYMOUS)
  >>> Person.byName('name16').currentShipItRequest() is None
  True
  >>> logout()


We have Ubuntu and Kubuntu DVDs on amazon. We'll link to them from shipit.

  >>> browser.open('http://localhost/shipit-ubuntu/myrequest')
  >>> print browser.contents
  <!DOCTYPE...
  ...Ubuntu DVDs...
  ...http://rcm.amazon.com/...

  >>> browser.open('http://localhost/shipit-kubuntu/myrequest')
  >>> print browser.contents
  <!DOCTYPE...
  ...Kubuntu DVDs...
  ...http://rcm.amazon.com/...

But we don't yet have Edubuntu DVDs on amason. :-(

  >>> browser.open('http://localhost/shipit-edubuntu/myrequest')
  >>> 'Edubuntu DVDs' not in browser.contents
  True
  >>> 'amazon.com' not in browser.contents
  True
