<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  xmlns:i18n="http://xml.zope.org/namespaces/i18n"
  xml:lang="en"
  lang="en"
  dir="ltr"
  metal:use-macro="view/macro:page/onecolumn"
  i18n:domain="launchpad"
>

<body>


<metal:heading fill-slot="pageheading">
  <h1>Upload and build queue</h1>
</metal:heading>

<div metal:fill-slot="main"
     tal:define="setup view/setupQueueList;
                 message view/performQueueAction;
                 error view/error|nothing">

  <p class="informational message"
     tal:condition="message"
     tal:content="structure message">
     This call to view/performQueueAction actually parses the form and does
     the database queries based on actions posted (packages accepted or
     rejected), and shows the status of those actions here.
  </p>

  <p class="error message"
      tal:condition="error"
      tal:content="error"/>

  <div class="queue_list" tal:condition="not: error">

    <tal:batch define="batch view/batchnav/currentBatch|nothing">

    <form name="queue_items_state" action="" method="GET">

      Show:

      <select name="queue_state" size="1">

        <option tal:repeat="option view/filtered_options"
                tal:attributes="selected option/selected;
                                value option/value"
                tal:content="option/name" />

      </select>

      uploads with names like:

      <input size="20" type="text" name="queue_text"
                       tal:attributes="value view/name_filter" />

      <input type="submit" value="Update" />

    </form>

    <br />

     <tal:navigation
        replace="structure view/batchnav/@@+navigation-links-upper" />

     <form name="queue_items_action" action="" method="POST">
     <input tal:attributes="type string:hidden;
                            name string:queue_state;
                            value view/state/value"/>
     <table class="listing sortable" tal:condition="batch"
            id="distroseriesqueue">
       <thead>
         <tr class="queue-row">
           <tal:checkbox condition="view/availableActions">
             <th colspan="3"> Package </th>
           </tal:checkbox>
           <tal:nocheckbox condition="not: view/availableActions">
             <th colspan="2"> Package </th>
           </tal:nocheckbox>
           <th> Version </th>
           <th> Component </th>
           <th> Section </th>
           <th> Priority </th>
           <th> Pocket </th>
           <th> When </th>
         </tr>
       </thead>
       <tbody class="lesser">
         <tal:batch repeat="packageupload batch">
           <tal:block
                define="filelist_class string:queue-${packageupload/displayname}-${packageupload/id}">
             <tr class="queue-row">
                <!-- Every column is top-padded apart from the checkbox
                     because Firefox renders it offset anyway.  This will make
                     other browsers look odd, now. :/ -->
                <td width="14" style="padding-top: 5px">
                  <a tal:attributes="href string:./+queue;
                     onclick string:return toggleExpandableTableRows('${filelist_class}')">
                    <img tal:attributes="id string:${filelist_class}-arrow"
                         width="14" height="14"
                         src="/@@/treeCollapsed" alt="view files"/>
                  </a>
                </td>
                <td class="icon left" tal:condition="view/availableActions">
                     <input type="checkbox" name="QUEUE_ID"
                            tal:attributes="value packageupload/id"/>
                </td>
                <td style="padding-top: 5px">
                  <tal:iconlist replace="structure packageupload/@@+iconlist"/>
                </td>

                <td style="padding-top: 5px" 
                    tal:content="packageupload/displayversion">2.0.17-6
                </td>
                <tal:is_source define="is_source packageupload/contains_source">
                  <td style="padding-top: 5px">
                    <tal:component condition="is_source"
                         content="packageupload/sourcepackagerelease/component/name/lower">
                    </tal:component>
                  </td>
                  <td style="padding-top: 5px">
                    <tal:section condition="is_source"
                         content="packageupload/sourcepackagerelease/section/name/lower">
                    </tal:section>
                  </td>
                  <td style="padding-top: 5px">
                    <tal:priority condition="is_source"
                         content="packageupload/sourcepackagerelease/urgency/name/lower">
                    </tal:priority>
                  </td>
                </tal:is_source>
                <td style="padding-top: 5px"
                    tal:content="packageupload/pocket/title">Updates
                </td>
                <td style="padding-top: 5px">
                  <span class="sortkey"
                    tal:content="packageupload/datecreated/fmt:datetime" />
                  <span
                    tal:attributes="title packageupload/datecreated/fmt:datetime"
                    tal:content="packageupload/datecreated/fmt:approximatedate">
                    2006-03-15
                  </span>
                </td>
             </tr>
             <metal:filelist use-macro="template/macros/package-filelist"/>
           </tal:block>
         </tal:batch>
         <tr tal:condition="view/availableActions">
           <td colspan="4" style="text-align: right;
                                  vertical-align: bottom;
                                  padding-bottom: 5px">
             <label>Override for selected uploads:</label>
           </td>
           <td style="vertical-align: bottom">
             <label>Component:</label><br/>
             <select name="component_override" size="1">
               <option value="" selected="selected">(no change)</option>
               <option tal:repeat="option context/components"
                       tal:attributes="value option/name"
                       tal:content="option/name"/>
             </select>
           </td>
           <td style="vertical-align: bottom">
             <label>Section:</label><br/>
             <select name="section_override" size="1">
               <option value="" selected="selected">(no change)</option>
               <option tal:repeat="option view/sortedSections"
                       tal:attributes="value option/name"
                       tal:content="option/name"/>
             </select>
           </td>
           <td style="vertical-align: bottom">
             <label>Priority (binary):</label><br/>
             <select name="priority_override" size="1">
               <option value="" selected="selected">(no change)</option>
               <option tal:repeat="option view/priorities"
                       tal:attributes="value option/title/lower"
                       tal:content="option/title/lower"/>
             </select>
           </td>
           <td colspan="2" style="vertical-align: bottom">
             <input value="Reject" name="Reject" type="submit"/>
             <br/>
             <br/>
             <input value="Accept" name="Accept" type="submit"/>
           </td>
         </tr>
       </tbody>
     </table>

     </form>

     <div class="message" tal:condition="not: batch">
       The <span tal:replace="view/state/title" /> queue is empty.
     </div>

     <tal:navigation
        replace="structure view/batchnav/@@+navigation-links-lower" />

     </tal:batch>
  </div>

</div>


<metal:macros fill-slot="bogus">
<metal:macro define-macro="package-filelist">

  <tal:comment replace="nothing">
    This macro expects the following variables defined:
    :packageupload: A PackageUpload record for which we display files.
  </tal:comment>

    <tal:source repeat="source packageupload/sources">
      <tr tal:repeat="file source/sourcepackagerelease/files"
          tal:attributes="class string:${filelist_class}"
          style="display:none">
        <td/>
        <td tal:condition="view/availableActions"/>
        <td>
          <a tal:attributes="href file/libraryfile/http_url">
            <tal:filename content="file/libraryfile/filename"/>
          </a>
          (<span tal:replace="file/libraryfile/content/filesize/fmt:bytes" />)
        </td>
        <td colspan="6"/>
      </tr>
    </tal:source>

    <tal:build repeat="queuebuild packageupload/builds">
      <tal:binary repeat="binary queuebuild/build/binarypackages">
        <tr tal:repeat="file binary/files"
            tal:attributes="class string:${filelist_class}"
            style="display:none">
          <td/>
          <td tal:condition="view/availableActions"/>
          <td>
            <a tal:attributes="href file/libraryfile/http_url">
              <tal:filename content="file/libraryfile/filename"/>
            </a>
            (<tal:size replace="file/libraryfile/content/filesize/fmt:bytes" />)
            <span style="color: red" tal:condition="binary/is_new">NEW</span>
          </td>
          <td tal:content="binary/version"/>
          <td tal:content="binary/component/name/lower"/>
          <td tal:content="binary/section/name/lower"/>
          <td tal:content="binary/priority/name/lower"/>
          <td colspan="2"/>
        </tr>
      </tal:binary>
    </tal:build>

    <tal:custom define="customfiles packageupload/customfiles"
                condition="customfiles">
      <tr tal:repeat="custom customfiles"
          tal:attributes="class string:${filelist_class}"
          style="display:none">
        <td/>
        <td tal:condition="view/availableActions"></td>
        <td>
          <a tal:attributes="href custom/libraryfilealias/http_url">
            <tal:filename content="custom/libraryfilealias/filename"/>
          </a>
          (<tal:size replace="
                custom/libraryfilealias/content/filesize/fmt:bytes" />)
        </td>
        <td colspan="6"/>
      </tr>
    </tal:custom>

</metal:macro>
</metal:macros>


<div metal:fill-slot="help">
  <p>
    The packages incorporation work-flow within a distroseries is
    represented as a pipeline.
  </p>
  <p>
    The pipeline can process three types of packages: Sources, which
    contain one uploaded source package each submitted by the
    developers; Builds, which can contain, at least, one binary packages
    and optionally, one or more custom packages, it's resulted of the
    build of a published source; and Customs, a single custom package.
  </p>
  <p>
    Custom uploads are special files, usually a tarball, that are not
    targeted to be build normally (i.e, they are not sources, neither
    binaries), instead they have specific contents to be directly
    processed by one of the available custom processors in
    Launchpad. Currently, the following custom processors are offered:
    Installer, Dist-Upgrader, DDTP and Translations.
  </p>
  <p>
    All incoming packages tend to go for the stable states, DONE or
    REJECTED, the end of the pipeline, which means that the package
    was completely incorporated or excluded, respectively, in the
    distroseries in question.
  </p>
  <p>
    All incoming packages, essentially, start in NEW stage. Already
    known packages, which previous versions are already incorporated,
    are automatically moved to ACCEPTED stage, the remaining ones
    need manual approval of the archive administrators for this
    distroseries to continue.
  </p>
  <p>
    Packages with some policy restrictions, like post-release updates
    and security updates, also wait manual approval as UNAPPROVED.
  </p>
  <p>
    Once a package is in ACCEPTED stage, it waits the distroseries
    periodic publication cycle to happen, then sources will get
    published and will start building and builds and customs will be
    published in the archive appropriately, ending up in DONE.
  </p>
</div>

</body>
</html>
