<script type="text/javascript">
  function toggleFormVisibility(row, expander) {
    if (row.style.display=="none") {
      expander.setAttribute('src', '/@@/treeExpanded.gif');
      row.style.display = "table-row";
    } else {
      expander.setAttribute('src', '/@@/treeCollapsed.gif');
      row.style.display = "none";
    }
    return false;
  }
</script>

<table class="listing"
       cellpadding="0" cellspacing="0"
       style="width: 100%; margin-bottom: 1px; margin-top: 2px;
              font-size: 90%;">
  <thead>
    <tr>
      <th colspan="2">Affects</th>
      <th>Status</th>
      <th>Importance</th>
      <th>Assigned To</th>
    </tr>
  </thead>

  <tbody>
    <tal:request repeat="bugtask context/bugtasks">
      <tal:whatever define="shouldExpand python:bugtask == view.currentBugTask() and view.user">
        <tr tal:define="tasklink python: view.taskLink(bugtask)"
            tal:attributes="class python:view.getFixRequestRowCSSClassForBugTask(bugtask)">
          <td class="icon left">
            <a
              tal:condition="shouldExpand"
              tal:attributes="href tasklink"
              onclick="return toggleFormVisibility(document.getElementById('editform'), document.getElementById('editexpander')); return false"
            ><img id="editexpander" alt="" src="/@@/treeCollapsed.gif" /></a>
          </td>
          <td style="margin: 0; padding: 0">
            <a
              tal:condition="shouldExpand"
              tal:attributes="href tasklink"
              tal:content="bugtask/targetname"
              onclick="return toggleFormVisibility(document.getElementById('editform'), document.getElementById('editexpander'))"
              style="display: block; padding: 3px"
            />
            <a
              tal:condition="not:shouldExpand"
              tal:attributes="href tasklink"
              tal:content="bugtask/targetname"
              style="display: block; padding: 3px"
            />
          </td>

      <td tal:attributes="class string:status${bugtask/status/title}"
           tal:content="bugtask/status/title">
          $BugTask.status
      </td>

      <td tal:attributes="class string:importance${bugtask/importance/title}"
           tal:content="bugtask/importance/title">
          Critical
      </td>

      <td style="margin: 0; padding: 0; vertical-align: middle">
        <tal:has_watch condition="bugtask/bugwatch">
          <a style="display: block; text-decoration: none; padding: 3px"
             tal:attributes="href bugtask/bugwatch/url">
            <img tal:condition="bugtask/assignee"
                 src="/@@/user.gif" alt="" />
            <img
              alt="Linked to "
              src="/@@/arrowRight.gif"
            />
            <span tal:replace="bugtask/bugwatch/bugtracker/name">Zilla</span>
            #<span tal:replace="bugtask/bugwatch/remotebug">123</span>
          </a>
        </tal:has_watch>
        <tal:has_no_watch condition="not: bugtask/bugwatch">

          <tal:has_assignee condition="bugtask/assignee">
            <a
              style="display: block; text-decoration: none;"
              tal:attributes="href string:${bugtask/assignee/fmt:url}/+assignedbugs"
            >
              <img src="/@@/user.gif"
                   style="padding-bottom: 2px"
                   alt="" />
              <span tal:replace="bugtask/assignee/browsername">
                assignee.browsername
              </span>
            </a>
          </tal:has_assignee>
          <tal:no_assignee condition="not: bugtask/assignee">
            &mdash;
          </tal:no_assignee>
        </tal:has_no_watch>

          </td>

        </tr>

        <tr
          id="editform"
          style="display: none"
          tal:condition="shouldExpand"
          tal:define="current_task view/currentBugTask"
        >
          <td colspan="5" tal:content="structure current_task/@@+edit-form" />
        </tr>
      </tal:whatever>
    </tal:request>
  </tbody>

</table>

<div style="font-size: 80%; text-align: right; margin-bottom: 1em;"
     tal:define="current_bugtask view/currentBugTask">

  Also affects:
  <span style="white-space: nowrap">
      <img src="/@@/add.gif" alt="+" />
      <a tal:attributes="href string:${current_bugtask/fmt:url}/+upstreamtask"
         title="Mark this bug as occurring upstream">
        Upstream&hellip;
      </a>
  </span>

  <span style="white-space: nowrap">
      <img src="/@@/add.gif" alt="+" />
      <a tal:attributes="href string:${current_bugtask/fmt:url}/+distrotask"
         title="Mark this bug as occurring in a distro package">
        Distribution&hellip;
      </a>
  </span>

</div>

