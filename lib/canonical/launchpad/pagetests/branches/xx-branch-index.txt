= Branch Details =

== Recent Revisions ==

On the Code site, registered branches are reached by
/<owner>/<product>/<branch-name>.

    >>> user_browser.open('http://code.launchpad.dev/~name12/+junk/junk.dev')
    >>> revisions = find_tag_by_id(user_browser.contents, 'recent-revisions')


=== Heading ===

We display the recent revisions of a branch if it has been scanned. There's a
"Recent revisions" heading:

    >>> print revisions.h2.renderContents()
    Recent revisions


=== Revision information ===

Underneath that heading we see the ten most-recent revisions of the branch in
reverse-chronological order.

    >>> def traverse_children(tag, tag_type=None):
    ...     """Iterate over the direct children of a tag.
    ...
    ...     :param tag_type: If specified, only direct children of the type
    ...         specified are returned, e.g. tag_type='div'.
    ...     """
    ...     def matching_tag(tag):
    ...         return (tag_type is None or
    ...                 getattr(tag, 'name', None) == tag_type)
    ...     child = tag.next
    ...     if child.parent is tag:
    ...         if matching_tag(child):
    ...             yield child
    ...         while child.nextSibling is not None:
    ...             child = child.nextSibling
    ...             if matching_tag(child):
    ...                 yield child

    >>> for revision in traverse_children(revisions, 'div'):
    ...     print extract_text(revision.div).encode('ascii')
    6. By foo &lt;foo@localhost&gt; on 2005-10-31
    5. By foo &lt;foo@localhost&gt; on 2005-10-31
    4. By bar@localhost on 2005-10-31
    3. By Sample Committer &lt;test@canonical.com&gt; on 2005-10-31
    2. By Sample Committer &lt;test@canonical.com&gt; on 2005-10-31
    1. By Sample Committer &lt;test@canonical.com&gt; on 2005-10-31

Each of the revision numbers are now anchors to codebrowse (for public
branches).

    >>> print revisions.div.div.a
    <a href="http://codebrowse.launchpad.dev/~name12/+junk/junk.dev/revision/6">6</a>


=== Email addresses ===

Commit messages often (always?) have email addresses associated with them.
'Revision information' shows that the addresses are shown to logged in users.
However, emails should *not* be shown to anonymous users.

In particular, we don't want search engine and spam bots harvesting email
addresses.

    >>> anon_browser.open('http://code.launchpad.dev/~name12/+branch/+junk/junk.dev')
    >>> revisions = find_tag_by_id(anon_browser.contents, 'recent-revisions')
    >>> for revision in traverse_children(revisions, 'div'):
    ...     print extract_text(revision.div).encode('ascii')
    6. By foo &lt;email address hidden&gt; on 2005-10-31
    5. By foo &lt;email address hidden&gt; on 2005-10-31
    4. By &lt;email address hidden&gt; on 2005-10-31
    3. By Sample Committer &lt;email address hidden&gt; on 2005-10-31
    2. By Sample Committer &lt;email address hidden&gt; on 2005-10-31
    1. By Sample Committer &lt;email address hidden&gt; on 2005-10-31


=== Excursis ===

In terms of HTML, each commit is contained in a <div> with an id of "revN",
where "N" is the revision sequence number.

The revision number, author and date are all contained in a heading (h3), and
the commit message follows as a number of paragraphs.

    >>> browser.open('http://code.launchpad.dev/~name12/+branch/+junk/junk.dev')
    >>> def get_commit_message(sequence):
    ...     revision = find_tag_by_id(browser.contents, 'rev%s' % sequence)
    ...     return revision.fetch('p')


=== Commit messages ===

The commit message is displayed in paragraphs underneath the revision id and
author.

    >>> for paragraph in get_commit_message(6):
    ...     print paragraph.renderContents()
    fix bug in bar


When a commit message refers to a bug using the form "bug <bugnumber>", a link
to that bug is created.

    >>> for paragraph in get_commit_message(3):
    ...     print paragraph.renderContents()
    fix <a ...>bug 1</a>


This link can be followed to the bug's details page.

    >>> browser.getLink('bug 1').click()
    >>> print browser.title
    Bug #1 in Mozilla Firefox...


== Unscanned branches ==

Some branches won't have any revisions in the database. Sometimes, this is
simply because the branch is empty. However, much of the time, the lack of
revisions will be because of an error or delay in the scanning process.

Before we can display the revisions, a branch needs to be mirrored (or
'published') and scanned. When a branch is not yet mirrored, we'll see a
helpful message.

    >>> browser.open('http://code.launchpad.dev/~name12/firefox/main')
    >>> print extract_text(find_tag_by_id(browser.contents, 'recent-revisions'))
    Recent revisions
    This branch has not been mirrored yet.

We don't want to use the word 'mirrored' for hosted or imported branches,
because those branches are only mirrored internally. "Published" is a better
word for these.

    >>> browser.open('http://code.launchpad.dev/~name12/gnome-terminal/pushed')
    >>> print extract_text(find_tag_by_id(browser.contents, 'recent-revisions'))
    Recent revisions
    This branch has not been published yet.

If a branch has been mirrored, but not scanned, we display a different message.
This is helpful particularly for hosted and imported branches, which are
available for download as soon as they are published.

    >>> browser.open('http://code.launchpad.dev/~name12/gnome-terminal/mirrored')
    >>> print extract_text(find_tag_by_id(browser.contents, 'recent-revisions'))
    Recent revisions
    This branch has not been scanned yet.

If a branch has been mirrored and scanned, and has no revisions, then it is
empty.

    >>> browser.open('http://code.launchpad.dev/~name12/gnome-terminal/scanned')
    >>> print extract_text(find_tag_by_id(browser.contents, 'recent-revisions'))
    Recent revisions
    This branch is empty.


== Branch Details ==

The branch page includes a table of details about the branch. The exact details
vary from branch type to branch type.

For hosted branches, the table has a link to the branch's project and the URL
for the branch's canonical location.

    >>> def get_branch_details_table():
    ...     table = find_tag_by_id(browser.contents, 'branch-details-table')
    ...     return table.tbody

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/scanned')
    >>> print extract_text(get_branch_details_table())
    Project: GNOME Terminal
    Upload URL: Only Sample Person can upload to this branch.
      If you are Sample Person please log in for upload directions.


For mirrored branches, the table has a link to the branch's project, the
location of the original branch, the mirror on Launchpad, information about
when the branch was last mirrored and when it will be mirrored again.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/klingon')
    >>> print extract_text(get_branch_details_table())
    Project: GNOME Terminal
    Location: http://trekkies.example.com/gnome-terminal/klingon
    Next mirror: As soon as possible


Branches that have never been mirrored don't have a 'Last mirrored' field.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/main')
    >>> print extract_text(get_branch_details_table())
    Project: GNOME Terminal
    Location: http://example.com/gnome-terminal/main
    Next mirror: As soon as possible

If mirror_request_time is NULL, then mirroring of the branch is disabled.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> from canonical.launchpad.interfaces import (
    ...     BranchType, IBranchSet, IPersonSet)
    >>> login('no-priv@canonical.com')
    >>> no_priv = getUtility(IPersonSet).getByName('no-priv')
    >>> branch = getUtility(IBranchSet).new(
    ...     BranchType.MIRRORED, name='mirror-disabled', creator=no_priv,
    ...     owner=no_priv, product=None, url='http://example.com/disabled',
    ...     title='Disabled branch')
    >>> branch.mirror_request_time = None
    >>> flush_database_updates()
    >>> logout()


    >>> browser.open(
    ...     'http://code.launchpad.dev/~no-priv/+junk/mirror-disabled')
    >>> print extract_text(get_branch_details_table())
    Location: http://example.com/disabled
    Next mirror: Disabled


== Structural object presentation ==

The structural object presentation of a branch is the heading that appears
in the top left hand corner of the browser, and should refer to the
context object that all the tabs apply to.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/scanned')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, "structuralobjectheading"))
    Sample Person


== Codebrowse link ==

The codebrowse link only appears for branches that have revisions.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/scanned')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, "recent-revisions"))
    Recent revisions
    This branch is empty.
    >>> browser.getLink('Browse code')
    Traceback (most recent call last):
    ...
    LinkNotFoundError

Sample Person's junk branch has some revisions, so the 'Browse code'
link is shown.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/+junk/junk.dev')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, "recent-revisions").div)
    6. By foo... fix bug in bar...
    >>> print browser.getLink('Browse code').url
    http://codebrowse.launchpad.dev/~name12/+junk/junk.dev

If the branch is private, the browse code link is not shown.
In order to see the private branch, we need to log in as a user that
is able to see the branch.

    >>> browser = setupBrowser(auth="Basic test@canonical.com:test")
    >>> browser.open(
    ...     'http://code.launchpad.dev/~landscape-developers/landscape/trunk')
    >>> browser.getLink('Browse code')
    Traceback (most recent call last):
    ...
    LinkNotFoundError


== Download URL ==

In the details table there is a link to the branch download URL.

For public branches this shows links to the codehosting using http, whereas
private branches show bzr+ssh as they are not available over anonymous
http, and anyone who can see the branch is able to access it using bzr+ssh.

The download URL is only shown for branches that actually have revisions.
So we need to fake that here.

    >>> login('foo.bar@canonical.com')
    >>> branch = getUtility(IBranchSet).getByUniqueName(
    ...     '~landscape-developers/landscape/trunk')
    >>> branch.revision_count = 42
    >>> branch = getUtility(IBranchSet).getByUniqueName(
    ...     '~name12/gnome-terminal/scanned')
    >>> branch.revision_count = 13
    >>> flush_database_updates()
    >>> logout()

    >>> browser.open(
    ...     'http://code.launchpad.dev/~landscape-developers/landscape/trunk')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, 'branch-details-table'))
    Project: The Landscape Project
    Download URL:
      bzr+ssh://&lt;name&gt;@bazaar.launchpad.dev/~landscape-developers/landscape/trunk
    Example:
      bzr branch bzr+ssh://name12@bazaar.launchpad.dev/~landscape-developers/landscape/trunk
    ...

Public branches use http.

    >>> browser.open(
    ...     'http://code.launchpad.dev/~name12/gnome-terminal/scanned')
    >>> print extract_text(find_tag_by_id(
    ...     browser.contents, 'branch-details-table'))
    Project: GNOME Terminal
    Download URL:
      http://bazaar.launchpad.dev/~name12/gnome-terminal/scanned
    Example:
      bzr branch http://bazaar.launchpad.dev/~name12/gnome-terminal/scanned
    ...
