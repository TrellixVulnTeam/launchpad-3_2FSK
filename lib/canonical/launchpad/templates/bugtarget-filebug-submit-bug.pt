<html
  xmlns="http://www.w3.org/1999/xhtml"
  xml:lang="en"
  lang="en"
  metal:use-macro="context/@@main_template/master"
  i18n:domain="launchpad">

<body>

<metal:heading fill-slot="pageheading">
  <h1 tal:condition="not: view/similar_bugs">Report a new bug</h1>
  <h1 tal:condition="view/similar_bugs">Is the bug you're reporting one of these?</h1>
</metal:heading>

<div metal:fill-slot="main">

  <metal:not_uses_malone
      use-macro="context/@@+filebug-macros/not_uses_malone" />

  <tal:uses_malone tal:condition="view/contextUsesMalone">

  <div metal:use-macro="context/@@launchpad_form/form">

    <div metal:fill-slot="extra_info">
      <p class="informational message"
         tal:condition="not: view/similar_bugs">
        No similar bugs were found.
      </p>
    </div>

    <metal:widgets metal:fill-slot="widgets">

      <div id="bug_reporting_form" tal:condition="not: view/similar_bugs">
        <table class="form">
          <metal:basic_filebug_widgets
              metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
        </table>
        <div class="actions">
          <input tal:replace="structure view/submit_bug_action/render" />
        </div>
      </div>

      <div tal:condition="view/similar_bugs">

        <tal:similar-bugs condition="view/contextUsesMalone">

          <ul id="similar-bugs" style="list-style: none; margin-left: 0">
            <li tal:repeat="bug view/similar_bugs"
                tal:attributes="title bug/description/fmt:shorten/500"
                title="bug description goes here" class="similar-bug">
              <table tal:define="bugtask python:view.getRelevantBugTask(bug)">
                <tbody>
                  <tr>
                    <td>
                      <input type="radio" name="field.bug_already_reported_as"
                             tal:attributes="id string:bug-already-reported-as-${bug/id};
                                             value string:${bug/id};
                                             checked python: path('repeat/bug/start') and not (
                                                 path('view/this_is_my_bug_action/submitted') or
                                                 path('view/submit_bug_action/submitted'))" />
                    </td>
                    <td>
                      <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                             tal:condition="bugtask"
                             tal:content="structure bugtask/image:icon" />
                      <img alt="" src="/@@/bug" tal:condition="not:bugtask" />
                    </td>
                    <td>
                      <div>
                        <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                               style="font-weight: normal">
                          #<tal:bug-id replace="bug/id">4</tal:bug-id>
                          <a tal:attributes="href bug/fmt:url"
                             tal:content="bug/title">Bug title here</a>
                        </label>
                      </div>
                      <div class="lesser" tal:condition="bugtask">
                        <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                               style="font-weight: normal">
                          <tal:status replace="bugtask/status/title" />,
                          last updated
                          <tal:last-updated content="bug/date_last_updated/fmt:approximatedate">
                            2007-07-03
                          </tal:last-updated>
                        </label>
                      </div>
                      <div class="lesser" tal:condition="not:bugtask">
                        <label tal:attributes="for string:bug-already-reported-as-${bug/id}"
                               style="font-weight: normal">
                          <tal:closed condition="bug/is_complete">Closed,</tal:closed>
                          <tal:open condition="not:bug/is_complete">Open,</tal:open>
                          last updated <tal:when replace="bug/date_last_updated/fmt:approximatedate" />
                        </label>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>

          <p tal:define="error_message view/widget_errors/bug_already_reported_as|nothing"
             tal:condition="error_message" tal:content="error_message" class="error message" />

          <div class="actions" style="margin-top: 0.5em; margin-bottom: 1em">
            <input tal:replace="structure view/this_is_my_bug_action/render" />
          </div>

          <ul style="list-style: none; margin-left: 0">
            <li style="margin-top: 1em">
              <tal:comment replace="nothing">
                We hide this next paragraph if the context doesn't use
                malone because in that situation we're showing the form
                after an error message and in that context the message
                makes no sense.
              </tal:comment>
              <table tal:condition="view/contextUsesMalone">
                <tbody>
                  <tr>
                    <td>
                      <input id="bug-not-already-reported" type="radio"
                             name="field.bug_already_reported_as" value=""
                             tal:attributes="checked view/submit_bug_action/submitted|nothing" />
                    </td>
                    <td>
                      <label for="bug-not-already-reported">
                        No, I'd like to report a new bug
                      </label>
                    </td>
                  </tr>
                </tbody>
              </table>
            </li>
          </ul>

        </tal:similar-bugs>

        <tal:submit-new-bug>
          <div id="bug_reporting_form">
            <table class="form">
              <metal:basic_filebug_widgets
                  metal:use-macro="context/@@+filebug-macros/basic_filebug_widgets" />
            </table>
            <div class="actions">
              <input tal:replace="structure view/submit_bug_action/render" />
            </div>
          </div>
        </tal:submit-new-bug>

      </div>

      <script type="text/javascript" tal:condition="view/similar_bugs">
        /*
         * Arrange the bug form for either the state where the user is selecting
         * an existing bug report, or for where they're filing a new bug.
         */
        function arrangeBugForm(bug_already_reported) {
          var no_radiobtn = $('bug-not-already-reported');

          if (bug_already_reported == undefined) {
            bug_already_reported = !no_radiobtn.checked;
          } else {
            no_radiobtn.checked = !bug_already_reported;
          }

          if (bug_already_reported) {
            hideElement('bug_reporting_form');
          } else {
            showElement('bug_reporting_form');
            /* Try and get the whole bug form into view. */
            $('field.actions.submit_bug').focus();
            $('field.comment').focus();
          }

          $('field.actions.this_is_my_bug').disabled = !bug_already_reported;
        }

        /*
         * arrangeBugForm wrapped for use as an event handler.
         */
        function arrangeBugFormHandler(event) {
          return arrangeBugForm();
        }

        /*
         * On-load, make sure that the 'No' stuff is displayed correctly.
         * We must always work from the data in the form, not just from
         * events. Some browsers (e.g. Firefox) refill the form when a page
         * is refreshed and you don't get onchange/onkeypress events.
         */
        connect(window, 'onload', arrangeBugFormHandler);

        /*
         * Arrange the form if any of the radio buttons are clicked.
         */
        forEach(
          getElementsByTagAndClassName('input', null, 'similar-bugs'),
          function(element) {
            connect(element, 'onclick', arrangeBugFormHandler);
          });
        connect('bug-not-already-reported', 'onclick', arrangeBugFormHandler);
      </script>

    </metal:widgets>

    <div class="actions" metal:fill-slot="buttons">
      <tal:comment replace="nothing">
        This suppresses the normal action buttons.
      </tal:comment>
    </div>

  </div>

  </tal:uses_malone>

</div>

</body>
</html>
