================
Product Branches
================

    >>> from lp.code.tests.branch_helper import (
    ...     reset_all_branch_last_modified)
    >>> reset_all_branch_last_modified()


Product branch summaries
========================

Branch listings for products now have a summary shown at the top of
the page before the listing table itself.

What is shown depends on the how many branches are in the project,
who they are owned by, whether or not the branch officially uses
Launchpad code, whether or not there is a development focus branch,
whether or not there are any download files specified for the product.


No branches
===========

If there are no branches a message offering options is shown.

The default page for the code rootsite on a product is the code
overview page.

    >>> browser.open('http://code.launchpad.dev/applets')
    >>> print browser.title
    Code : Gnome Applets

If there are not any branches, a helpful message is shown.

    >>> def get_summary(browser):
    ...     return find_tag_by_id(browser.contents, 'application-summary')
    >>> summary = get_summary(browser)
    >>> print extract_text(summary)
    There are no branches for Gnome Applets in Launchpad.
    If there are Bazaar branches of Gnome Applets in a publicly
      accessible location, Launchpad can act as a mirror of the branch
      by registering a Mirrored branch. Read more.
    Launchpad can also act as a primary location for Bazaar branches of
      Gnome Applets. Read more.
    Launchpad can import code from CVS or Subversion into Bazaar branches.
      Read more.

The 'Read more' links go to the help wiki.

    >>> for anchor in summary.fetch('a'):
    ...     print anchor['href']
    https://help.launchpad.net/Code/MirroredBranches
    https://help.launchpad.net/Code/UploadingABranch
    https://help.launchpad.net/VcsImports


Link to the product downloads
=============================

It is possible that a new person coming to the code tab would be interested
in downloads that may have been added for the product.

    >>> browser.open('http://code.launchpad.dev/netapplet')
    >>> print extract_text(get_summary(browser))
    There are no branches for NetApplet in Launchpad.
    ...
    There are download files available for NetApplet.


Development focus branches
==========================

If a development focus branch is set and browseable, the user is shown
a link to browse the code and a simple command line to get the branch.
If the branch is not browseable (in this case, it has no revisions but
it could be private or remote), only the command to get the branch is
shown.

    >>> browser.open('http://code.launchpad.dev/evolution')
    >>> summary = get_summary(browser)
    >>> print extract_text(get_summary(browser))
    3 active branches ...
    0 active reviews or unmerged proposals
    You can get a copy of the development focus branch using the
    command:
       bzr branch lp://dev/evolution

    >>> links = summary.findAll('a')

Both active reviews and approved merges are links allowing the user to
go to listing views.


Initial branch listing
======================

The initial branch listing has the following branches in order:
 * The current development focus branch
 * Other series branches (as long as not Merged or Abandoned)
 * Other non-series branches ordered by most recently modified

If a branch is associated with more than one series, it is only shown
once, but both series are shown in the listing.

    >>> admin_browser.open('http://launchpad.dev/firefox/trunk/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~name12/firefox/main'
    >>> admin_browser.getControl('Update').click()
    >>> admin_browser.open('http://launchpad.dev/firefox/1.0/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~name12/firefox/main'
    >>> admin_browser.getControl('Update').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    lp://dev/firefox
      Series: trunk, 1.0                     Development ...
    lp://dev/~mark/firefox/release--0.9.1  Development ...

Firstly lets associate release--0.9.1 with the 1.0 series.

    >>> admin_browser.open('http://launchpad.dev/firefox/1.0/+linkbranch')
    >>> admin_browser.getControl('Branch').value = '~mark/firefox/release--0.9.1'
    >>> admin_browser.getControl('Update').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    lp://dev/firefox
      Series: trunk                 Development ...
    lp://dev/firefox/1.0
      Series: 1.0                   Development ...

If series branches are marked as Abandoned they will not show up on the
default listings.

    >>> admin_browser.open(
    ...     'http://code.launchpad.dev/~name12/firefox/main/+edit')
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()
    >>> admin_browser.open(
    ...     'http://code.launchpad.dev/~mark/firefox/release--0.9.1/+edit')
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()

    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> table = find_tag_by_id(browser.contents, 'branchtable')
    >>> for row in table.tbody.fetch('tr')[0:2]:
    ...     print extract_text(row)
    lp://dev/~mark/firefox/release-0.8     Development ...


Floating buttons
================

There are two buttons that show on the right hand side of the screen
for project branch listings.  'Register a branch' and 'Import your project'.

    >>> from zope.component import getUtility
    >>> from lp.registry.interfaces.product import IProductSet
    >>> login('admin@canonical.com')
    >>> product = getUtility(IProductSet).getByName('firefox')
    >>> old_branch = product.development_focus.branch
    >>> product.development_focus.branch = None
    >>> logout()
    >>> def print_links(browser):
    ...     links = find_tag_by_id(browser.contents, 'floating-links')
    ...     for link in links.findAll('a'):
    ...         print extract_text(link)
    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> print_links(browser)
    Register a branch
    Import your project

If the product specifies that it officially uses Launchpad code, then
the 'Import your project' button is not shown.

    >>> login('admin@canonical.com')
    >>> product.development_focus.branch = old_branch
    >>> logout()
    >>> browser.open('http://code.launchpad.dev/firefox')
    >>> print_links(browser)
    Register a branch


Nice wording of summary numbers
===============================

The text that is shown giving a summary of the number of branches
shows correct singular and plural forms.

    >>> def print_summary(product):
    ...     browser.open('http://code.launchpad.dev/%s' % product)
    ...     print extract_text(get_summary(browser))

    >>> print_summary('gnome-terminal')
    8 active branches owned by 1 person and 2 teams, 0 commits in the last month
    ...
    >>> from lp.testing import ANONYMOUS, login, logout
    >>> login(ANONYMOUS)
    >>> fooix = factory.makeProduct('fooix')
    >>> ignored = factory.makeProductBranch(fooix)
    >>> ignored = factory.makeProductBranch(fooix)
    >>> logout()
    >>> print_summary('fooix')
    2 active branches owned by 2 people, 0 commits in the last month
    ...
    >>> print_summary('evolution')
    3 active branches owned by 1 person and 1 team, 0 commits in the last month
    ...
    >>> print_summary('iso-codes')
    1 active branch owned by 1 person, 0 commits in the last month
    ...


Product has Branches, but none initially visible
================================================

It is a bit of an edge case, but if there are branches for a product but all
of them are either merged or abandoned and there is no development focus
branch, then they will not appear on the initial branch listing.

    >>> admin_browser.open('http://code.launchpad.dev/~carlos/iso-codes/0.35')
    >>> admin_browser.getLink('Change branch details').click()
    >>> admin_browser.getControl('Abandoned').click()
    >>> admin_browser.getControl('Change Branch').click()

    >>> browser.open('http://code.launchpad.dev/iso-codes')
    >>> print extract_text(get_summary(browser))
    0 active branches, 0 commits in the last month
    0 active reviews or unmerged proposals

    >>> message = find_tag_by_id(browser.contents, 'no-branch-message')
    >>> print extract_text(message)
    There are branches registered for iso-codes but none of them match the
    current filter criteria for this page. Try filtering on "Any Status".


Getting to the branch listing for a product
===========================================

If there are branches, but they do not fit with the appropriate filter
we are given a different message.

    >>> browser.open(
    ...     'http://code.launchpad.dev/firefox/+branches'
    ...     '?field.lifecycle=Mature')
    >>> message = find_tag_by_id(browser.contents, 'no-branch-message')
    >>> print extract_text(message)
    There are branches registered for Mozilla Firefox but none of them match
    the current filter criteria for this page. Try filtering on "Any Status".
