= Bugzilla bugtrackers with the Launchpad plugin =

These tests cover the BugzillaLPPlugin ExternalBugTracker, which handles
Bugzilla instances that have the Launchpad plugin installed.

For testing purposes, a custom XML-RPC transport can be passed to it,
so that we can avoid network traffic in tests.

    >>> from canonical.launchpad.components.externalbugtracker import (
    ...     BugzillaLPPlugin)
    >>> from canonical.launchpad.ftests.externalbugtracker import (
    ...     TestBugzillaXMLRPCTransport)
    >>> test_transport = TestBugzillaXMLRPCTransport()
    >>> bugzilla = BugzillaLPPlugin(
    ...     'http://example.com/', xmlrpc_transport=test_transport)
    >>> bugzilla.xmlrpc_transport is test_transport
    True


== Getting the current time ==

The BugzillaLPPlugin ExternalBugTracker, like all other
ExternalBugTrackers, has a getCurrentDBTime() method, which returns the
current time on the remote server.

    >>> from datetime import datetime
    >>> # It seems there's no way to create a UTC timestamp without
    >>> # monkey-patching the TZ environment variable. Rather than do
    >>> # that, we create our own timestamp and work with that.
    >>> datetime.utcfromtimestamp(1210953200.0)
    datetime.datetime(2008, 5, 16, 15, 53, 20)

    >>> test_transport.utc_offset = 60**2
    >>> test_transport.timezone = 'CET'
    >>> test_transport.seconds_since_epoch = 1210956800.0
    >>> bugzilla.getCurrentDBTime()
    datetime.datetime(2008, 5, 16, 15, 53, 20, tzinfo=<UTC>)


== Initializing the remote bug database ==

The BugzillaLPPlugin implements the standard initializeRemoteBugDB()
method, taking a list of the bug ids that need to be updated. It uses
the Bugzilla Bug.get_bugs() API to retrieve bugs from the remote system.

    >>> bugzilla.xmlrpc_transport.print_method_calls = True
    >>> bugzilla.initializeRemoteBugDB([1, 2])
    CALLED Bug.get_bugs({'ids': [1, 2], 'permissive': True})

The bug data is stored as a list of dicts:

    >>> for bug in sorted(bugzilla.bugs.keys()):
    ...     print "Bug %s:" % bug
    ...     for key in sorted(bugzilla.bugs[bug].keys()):
    ...         print "    %s: %s" % (key, bugzilla.bugs[bug][key])
    ...     print "\n"
    Bug 1:
        alias: 
        assigned_to: test@canonical.com
        component: GPPSystems
        creation_time: 20080610T16:19:53
        id: 1
        internals:...
        is_open: True
        last_change_time: 20080610T16:19:53
        priority: P1
        product: HeartOfGold
        resolution: FIXED
        severity: normal
        status: RESOLVED
        summary: That bloody robot still exists.
    <BLANKLINE>
    Bug 2:
        alias: bug-two
        assigned_to: marvin@heartofgold.ship
        component: Crew
        creation_time: 20080611T09:23:12
        id: 2
        internals:...
        is_open: True
        last_change_time: 20080611T09:24:29
        priority: P1
        product: HeartOfGold
        resolution: 
        severity: high
        status: NEW
        summary: Collect unknown persons in docking bay 2.
    <BLANKLINE>
    <BLANKLINE>


== Getting remote statuses ==

BugzillaLPPlugin.getRemoteStatus() will return the remote status of a
given bug as a string. If the bug has a resolution, that will be
returned too.

    >>> print bugzilla.getRemoteStatus(1)
    RESOLVED FIXED

    >>> print bugzilla.getRemoteStatus(2)
    NEW

If a bug can't be found a BugNotFound error will be raised.

    >>> bugzilla.getRemoteStatus('no-such-bug')
    Traceback (most recent call last):
      ...
    BugNotFound: no-such-bug
