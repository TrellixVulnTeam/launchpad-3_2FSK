= Directions to upload to branches =

The branch ~name12/gnome-terminal/pushed is an upload branch. Its index page
shows contextual directions on how to upload to it.

  >>> branch_page = (
  ...     'http://code.launchpad.dev/~name12/+branch/gnome-terminal/pushed')

We will need multiple browsers, logged in with different users. Set them up
now.

  >>> from zope.testbrowser.testing import Browser
  >>> name12_browser = Browser()
  >>> name12_browser.addHeader(
  ...     'Authorization', 'Basic test@canonical.com:test')
  >>> ddaa_browser = Browser()
  >>> ddaa_browser.addHeader(
  ...     'Authorization', 'Basic david.allouche@canonical.com:test')

We will also need a ssh key. Save it now.

  >>> some_sshkey = (
  ...     'ssh-dss AAAAB3NzaC1kc3MAAAEBAPfhCA15ZaT08brwVXwpJjcZT6QFIipzF1sGy57'
  ...     'HY7QPi/W+uljr1VcCHzWdlSmda7YpTCTx0NFYYQIccQRGX6zYL8v1w9FSRCAnxxUJmq'
  ...     'EhsUDFYFdVTa9uLCrs3MSbmh7wwFPdRrGrO6X5x7T4dMZQwykSZrOVdpLcCHRgrMZsl'
  ...     'LomIAjERn6OAQNiGFz7B2tEi/3Soqd52bGJwOtGymRiAXkPSLbH7KfzSCe34ytdh6BD'
  ...     '+4SrgSoa+TL3VDV70QAdlOFXD42ZHl3Sc0Tde4LbZeYq2Uf84DOATLZBbOYpRSqTLkM'
  ...     '9XngpnvCRVb6dxEQfgODDw783tEuPpySLj2EAAAAVANpUVgivDjt9gFibN/AXfYy1me'
  ...     'eBAAABAB6FtnMywmWZg2lr2I3nDfE5U5QbGUQB/ZEP98ZkSkhOcF29VlnGOxyb2/VZb'
  ...     'VTLa/btlPF82L4An/c8VKtKZnel7LnAlMoArdgzQNXGVQQVtnaWwM26ydgDzkSSIes3'
  ...     'elNZgsfnPRBvaF0ol9Tqju0rNGKjnr3ZOX/NX+42bxpjRnxYj1h56yP2jKKeGfjorI6'
  ...     'JK1YfqBAiTxzaDMzSpknnrbztaKJoh7IFqMMOp9ANSFh7H106pEaCv3ebCTJZprtWqN'
  ...     'Kjb2zum7OQPRz3upA0qx22ocTokjv4itXJ6yj/BvGu9qdOIQFXuB2rsFtLZtS8ATueO'
  ...     'ly0GzyeiZBx/AEAAAEBAO8jRYjL7tAYnVlO1p6UzPOicAuGCFWfNbBEDRAXoSgLNdj4'
  ...     '51jStw+eUc9ZVz7tG/XRVZsiavtFHb2cbrcfX1YOd69xi0m+IY6mo3yKt3irQRokDtt'
  ...     '376sHoUdHgj2ozySZJgG8IJndtoS+VQQy6NdClA3fNFb96bF865eNaRYoHJO9ZI84lk'
  ...     'WQL++MLzIuyFfCs1hSlapyyuHC8kFmF7AQdrVZvbohSbnWs+w53nIW8nAA7z21wAukv'
  ...     'E1Pl6AQyG0e7U1sYS8Pc8dtmzJvdtVZWBl02/gqQJ7f06mFvnsN45rR1Uyxnrwl6rbF'
  ...     'wqabZDlyD5Ac6Icbvz9SG1gBOiI= andrew@trogdor')

== Branch owned by a person ==

Initially, the user is not logged in, the branch page points to the owner of
the branch, and suggest logging in for directions.

  >>> anon_browser.open(branch_page)
  >>> content = anon_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print instructions.renderContents()
  Only
  <a href="http://code.launchpad.dev/~name12">Sample Person</a>
  can upload to this branch. If this is you,
  <a href="+login">log in</a> for directions.
 
If the user is logged in, and is not the owner of the branch, we can be
definitive that it is not possible to upload to this branch.

  >>> ddaa_browser.open(branch_page)
  >>> content = ddaa_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print instructions.renderContents()
  You cannot upload to this branch. Only
  <a href="http://code.launchpad.dev/~name12">Sample Person</a>
  can upload to this branch.

The user is the owner of the branch and logs in. The page gives the full upload
URL for the branch.

  >>> name12_browser.open(branch_page)
  >>> content = name12_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print extract_text(instructions)
  You can upload to this branch at:
  sftp://name12@bazaar.launchpad.net/~name12/gnome-terminal/pushed

== SSH key directions ==

If the user has the permission to upload to a branch, but does not have a SSH
key registered, point to the SSH keys form.

First, unregister the existing SSH key for Sample Person.

  >>> name12_browser.open('http://launchpad.dev/')
  >>> name12_browser.getLink('Sample Person').click()
  >>> name12_browser.getLink('Update SSH keys').click()
  >>> name12_browser.getControl('Remove').click()

The branch page now displays directions and a link to register a SSH key.

  >>> name12_browser.open(branch_page)
  >>> content = name12_browser.contents
  >>> instructions = find_tag_by_id(content, 'ssh-key-directions')
  >>> print instructions.renderContents()
  To authenticate with the Launchpad branch upload service, you need to
  <a href="http://code.launchpad.dev/~name12/+editsshkeys">
  register a SSH key </a>.

Click the link and register a key.

  >>> name12_browser.getLink('register a SSH key').click()
  >>> name12_browser.getControl(name='sshkey').value = some_sshkey
  >>> name12_browser.getControl('Import Public Key').click()

The branch page should no longer display the SSH key directions.

  >>> name12_browser.open(branch_page)
  >>> content = name12_browser.contents
  >>> print find_tag_by_id(content, 'ssh-key-directions')
  None

If the user is not logged in, or does have the permission to upload to the
branch, the SSH key directions are not displayed. So they do not become part of
the perceptual "noise" of the page, and the user pays attention when they
appear.

  >>> anon_browser.open(branch_page)
  >>> content = anon_browser.contents
  >>> print find_tag_by_id(content, 'ssh-key-directions')
  None

  >>> ddaa_browser.open(branch_page)
  >>> content = ddaa_browser.contents
  >>> print find_tag_by_id(content, 'ssh-key-directions')
  None

== Branch owned by a team ==

When the branch is owned by a team, the directions need to be a bit different.
In particular, they should be adapted to refer to team "members", and should
help the user in joining the team. We will use the landscape-developers team,
which is owned by Sample Person.

Reassign the branch to the team.

  >>> name12_browser.open(branch_page)
  >>> name12_browser.getLink('Change registrant').click()
  >>> name12_browser.getControl(name='field.owner').value = (
  ...     'landscape-developers')
  >>> name12_browser.getControl('Change Registrant').click()

This changes the URL of the branch. Save the new URL.

  >>> branch_page = name12_browser.url

The upload directions for unauthenticated users are adapted to the fact the
owner is a team.

  >>> anon_browser.open(branch_page)
  >>> content = anon_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print instructions.renderContents()
  Members of <a
  href="http://code.launchpad.dev/~landscape-developers">Landscape
  Developers</a> can upload to this branch. <a href="+login">Log in</a> for
  directions.

If the user is authenticated and is not a member of the team, we can display a
link to easily join.

  >>> ddaa_browser.open(branch_page)
  >>> content = ddaa_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print instructions.renderContents()
  You cannot upload to this branch. Members of <a
  href="http://code.launchpad.dev/~landscape-developers">Landscape
  Developers</a> can upload to this branch.
  <a href="http://code.launchpad.dev/~landscape-developers/+join">Join the
  team</a>.

Check that the "Join the team" link is not broken.

  >>> ddaa_browser.getLink("Join the team").click()

Finally, if the user is a member of the team, we display the same "you can
upload" message as before. Of course the upload URL looks different, in
particular the login should be the user name, while the branch URL reflects the
owning team's name.

  >>> name12_browser.open(branch_page)
  >>> content = name12_browser.contents
  >>> instructions = find_tag_by_id(content, 'upload-directions')
  >>> print extract_text(instructions)
  You can upload to this branch at:
  sftp://name12@bazaar.launchpad.net/~landscape-developers/gnome-terminal/pushed

