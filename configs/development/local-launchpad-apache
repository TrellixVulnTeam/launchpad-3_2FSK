NameVirtualHost 127.0.0.88:80

RewriteLock /var/tmp/rewrite-lock

<VirtualHost 127.0.0.88:80>
  ServerName xmlrpc-private.launchpad.dev
  ServerName xmlrpc.launchpad.dev
  <Proxy *>
    Order deny,allow
    Allow from 127.0.0.0/255.0.0.0
  </Proxy>
  ProxyPreserveHost on

  ProxyPass / http://localhost:8087/ retry=1
</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName codebrowse.launchpad.dev
  RedirectMatch permanent /(.*) http://bazaar.launchpad.dev/$1
</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName bazaar.launchpad.dev
  LogLevel debug

  ProxyRequests off
  <Proxy *>
    Order deny,allow
    Allow from localhost 127.0.0.0/255.0.0.0
  </Proxy>
  ProxyTimeout 20

  RewriteEngine On
  RewriteMap branch-rewrite prg:%BRANCH_REWRITE%

  # Requests to the root are redirected to the Launchpad homepage.
  RewriteRule ^/$ http://launchpad.dev [L]

  # Requests by branch id are served from the file system (in
  # production, this rule is protected by a RewriteCond that only
  # allows requests from localhost and a few other hosts that need to
  # be able to access all branches).
  RewriteRule ^/[[:xdigit:]]{2}/[[:xdigit:]]{2}/[[:xdigit:]]{2}/[[:xdigit:]]{2}/.*$ - [L]

  # Serve the robots.txt file normally.
  RewriteRule ^/robots.txt$ - [L]

  # Everything else is translated by the branch-rewrite.py script.
  RewriteRule ^(/~.*)$ ${branch-rewrite:$1} [L,P]

  DocumentRoot /var/tmp/bazaar.launchpad.dev/mirrors
  <Directory /var/tmp/bazaar.launchpad.dev/mirrors/>
    Options SymLinksIfOwnerMatch
    AllowOverride None
    Options Indexes
  </Directory>

  <Location />
	  ProxyPassReverse http://localhost:8080/
  </Location>
</VirtualHost>

<VirtualHost 127.0.0.88:443>
  ServerName launchpad.dev
  ServerAlias *.launchpad.dev
  ServerAlias shipit.edubuntu.dev
  ServerAlias shipit.kubuntu.dev
  ServerAlias shipit.ubuntu.dev
  <Proxy *>
    Order deny,allow
    Allow from 127.0.0.0/255.0.0.0
  </Proxy>
  SSLEngine On
  SSLCertificateFile /etc/apache2/ssl/launchpad.crt
  SSLCertificateKeyFile /etc/apache2/ssl/launchpad.key

  ProxyPreserveHost on
  ProxyPass / http://localhost:8086/ retry=1

  <Location />
    # Insert filter
    SetOutputFilter DEFLATE

    # Don't compress images
    SetEnvIfNoCase Request_URI \
    \.(?:gif|jpe?g|png)$ no-gzip dont-vary

    # Don't gzip anything that starts /@@/ and doesn't end .js (ie images)
    SetEnvIfNoCase Request_URI ^/@@/ no-gzip dont-vary
    SetEnvIfNoCase Request_URI ^/@@/.*\.js$ !no-gzip !dont-vary
  </Location>

</VirtualHost>

<VirtualHost 127.0.0.88:80>
  ServerName launchpad.dev
  ServerAlias *.launchpad.dev
  ServerAlias shipit.edubuntu.dev
  ServerAlias shipit.kubuntu.dev
  ServerAlias shipit.ubuntu.dev
  RewriteEngine On
  RewriteRule (.*) https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>
