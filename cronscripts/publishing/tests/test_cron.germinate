#!/bin/sh

set -e

TEST_ARCHIVEROOT=$(readlink -f "./mock-data/ubuntu-archive/ubuntu")
TEST_LAUNCHPADROOT=$(readlink -f "./mock-data/mock-lp-root")

export TEST_ARCHIVEROOT TEST_LAUNCHPADROOT

# do not run the real germiante as it takes a long time and
# there is no test for it currently
echo "using fake germinate"
PATH=$(readlink -f "./mock-data/mock-bin"):$PATH
echo $PATH
export PATH

DISTS="hardy lucid maverick"

# clean
rm -f $TEST_ARCHIVEROOT/../ubuntu-misc/* || true
rm -f $TEST_ARCHIVEROOT/../ubuntu-germinate/* || true
rm -rf $TEST_ARCHIVEROOT/ubuntu/dists/ || true

# create mock data
for dist in $DISTS; do
    echo "abrowser Task mock" > $TEST_ARCHIVEROOT/../ubuntu-misc/more-extra.override.$dist.main
done

# setup environment for germinate
for component in main restricted universe multiverse; do
    mkdir -p $TEST_ARCHIVEROOT/dists/natty/$component/source
    gzip -c /dev/null > $TEST_ARCHIVEROOT/dists/natty/$component/source/Sources.gz
    for arch in i386 amd64 armel powerpc; do 
        # normal archive
        mkdir -p $TEST_ARCHIVEROOT/dists/natty/$component/binary-$arch/
        gzip -c /dev/null > $TEST_ARCHIVEROOT/dists/natty/$component/binary-$arch/Packages.gz
        # debian-installer
        mkdir -p $TEST_ARCHIVEROOT/dists/natty/$component/debian-installer/binary-$arch/
        gzip -c /dev/null > $TEST_ARCHIVEROOT/dists/natty/$component/debian-installer/binary-$arch/Packages.gz
    done

done

# run in fake environment
../cron.germinate

# check results
for dist in $DISTS; do
    f="$TEST_ARCHIVEROOT/../ubuntu-misc/more-extra.override.$dist.main.supported"
    if [ ! -e "$f" ]; then
        echo "FAIL: could not find $f"
        exit 1
    fi
done

# check if the existing data was left intact
for dist in $DISTS; do
    f="$TEST_ARCHIVEROOT/../ubuntu-misc/more-extra.override.$dist.main"
    if ! grep -q "abrowser Task mock" $f; then
        echo "FAIL: could not find Task header for $f"
        exit 1
    fi
done

# ensure we really get the updated override info
if ! grep -q "linux-image-2.6.32-25-server/i386 Supported 5y" $TEST_ARCHIVEROOT/../ubuntu-misc/more-extra.override.lucid.main; then
    echo "FAIL: expected override not found"
fi

