<tal:root
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  omit-tag="">

  <metal:form-picker define-macro="form-picker">
    <tal:input replace="structure view/inputField" />

    <tal:search_results condition="not: view/hasValidInput"
      define="suggestion_id string:${view/name}-suggestions">
      <select tal:condition="view/matches"
        tal:attributes="id string:${suggestion_id}">
        <option value="">Did you mean...</option>
        <option
            tal:repeat="match view/matches"
            tal:attributes="value match/token;
                selected python:path('match/token') == path('view/formToken');"
            tal:content="string:${match/title} (${match/token})"
            />
      </select>
      <script type="text/javascript" tal:content="string:
          LPS.use('node', 'lp.app.picker', function(Y) {
              var text_input = Y.DOM.byId('${view/name}');
              var select_menu = Y.DOM.byId('${suggestion_id}');
              Y.lp.app.picker.connect_select_menu(
                  select_menu, text_input);
          });">
      </script>
    </tal:search_results>

    <tal:chooseLink replace="structure view/chooseLink" />
    <script tal:content="structure string:
    LPS.use('node', 'lp.app.picker', 'plugin', function(Y) {
        if (Y.UA.ie) {
            return;
        }
        namespace = Y.namespace('lp.macros');
        // The vocabulary picker, created when used for the first time.
        function make_picker(config) {
            var vocab_name = config.vocabulary_name;
            var picker = Y.lp.app.picker.create(vocab_name, config);
            if (config.extra_no_results_message !== null) {
                picker.before('resultsChange', function (e) {
                    var new_results = e.details[0].newVal;
                    if (new_results.length === 0) {
                        picker.set('footer_slot',
                                   Y.Node.create(config.extra_no_results_message));
                    }
                    else {
                        picker.set('footer_slot', null);
                    }
                });
            }
            picker.plug(Y.lazr.TextFieldPickerPlugin,
                        {input_element: '[id=\x22' + config.input_id + '\x22]'});
            return picker;
        }
        namespace.make_picker = make_picker;
    });
    "/>

    <script tal:content="structure string:
    LPS.use('node', 'lp.app.picker', 'plugin', function(Y) {
        if (Y.UA.ie) {
            return;
        }
        var picker = null;
        var config = {
            vocabulary_name: '${view/vocabulary_name}',
            header: ${view/header_text},
            step_title: ${view/step_title_text},
            extra_no_results_message: ${view/extra_no_results_message},
            picker_type: '${view/picker_type}',
            input_id: '${view/input_id}'
        };
        Y.on('domready', function(e) {
            // Sort out the Choose... link.
            var show_widget_node = Y.one('#${view/show_widget_id}');

            show_widget_node.set('innerHTML', 'Choose&hellip;');
            show_widget_node.addClass('js-action');
            show_widget_node.get('parentNode').removeClass('unseen');
            show_widget_node.on('click', function (e) {
                if (picker === null) {
                    picker = Y.lp.macros.make_picker(config);
                }
                picker.show();
                e.preventDefault();
            });
        });
    });
    "/>
  </metal:form-picker>
</tal:root>
