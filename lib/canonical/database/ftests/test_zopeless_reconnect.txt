
This test demonstrates the behaviour of initZopeless with implicitBegin=False,
especially the auto-reconnect on ztm.begin() (but not at any other time).

Setup the database.

    >>> from canonical.launchpad.ftests.harness import LaunchpadTestSetup
    >>> LaunchpadTestSetup().setUp()

Make a TCP proxy to postgres. Note we have to match the version of
twisted we use with our version of Python.

    >>> import os, sys
    >>> import canonical.lp
    >>> from canonical.database.ftests import (
    ...     getDBHost, wait_until_proxy_is_ready, wait_until_proxy_is_stopped)
    >>> dbhost = getDBHost()
    >>> ver = sys.version[:3]
    >>> cmd = ('mktap%s portforward --port 5555 --dest_port 5432 '
    ...        '--host %s' % (ver, dbhost))
    >>> os.system(cmd)
    0
    >>> os.system('twistd%s -of portforward.tap' % ver)
    0

Wait for the proxy to start.

    >>> wait_until_proxy_is_ready()

Init Zopeless via the proxy, with implicit begin disabled.

    >>> from canonical.lp import initZopeless
    >>> ztm = initZopeless(dbhost='localhost port=5555',
    ...                    implicitBegin=False)

Without explicitly beginning, _connection is None, so queries will fail:

    >>> from canonical.launchpad.database import Person
    >>> print Person._connection
    None
    >>> Person.get(1)
    Traceback (most recent call last):
    ...
    AttributeError: 'NoneType' object has no attribute 'cache'

Begin, and issue a query:

    >>> ztm.begin()
    >>> print Person.get(1).name
    sabdfl

Errors in queries still propagate as normal:

    >>> print Person.select("garbage invalid sql")[0]
    Traceback (most recent call last):
    ...
    ProgrammingError: ERROR:  syntax error at or near "invalid" at ...
    ...

Start a new transaction, to show that everything will recover smoothly.

    >>> ztm.abort()
    >>> print Person._connection
    None
    >>> ztm.begin()
    >>> print Person.get(1).name
    sabdfl

Break the connection by stopping the proxy.

    >>> os.system('kill `cat twistd.pid`')
    0

Wait for the proxy to stop.

    >>> wait_until_proxy_is_stopped()

Executing a query now blocks until the database connection can be
reestablished.

    >>> import threading
    >>> before_txn = threading.Event()
    >>> after_select = threading.Event()
    >>> thread_result = []
    >>> def foo():
    ...     before_txn.set()
    ...     ztm.begin()
    ...     name = Person.get(1).name
    ...     thread_result.append(name)
    ...     after_select.set()

Create the thread and ensure that it has started:

    >>> thread = threading.Thread(target=foo)
    >>> thread.start()
    >>> before_txn.wait()

Execution does not progress, since the database connection can not be
established:

    >>> after_select.wait(1)
    >>> after_select.isSet()
    False
    >>> thread.isAlive()
    True

# TODO: test that the disconnection is logged -- spiv

Restart the proxy:

    >>> os.system('twistd%s -of portforward.tap' % ver)
    0
    >>> wait_until_proxy_is_ready()

Now, our blocked thread should've finished successfully.

    >>> after_select.wait()
    >>> after_select.isSet()
    True
    >>> thread_result
    [u'sabdfl']
    >>> thread.isAlive()
    False

The interrupted transaction in this thread still fails.

    >>> Person.get(2)
    Traceback (most recent call last):
    ...
    ProgrammingError: server closed the connection unexpectedly
    ...

Uninstall the zopeless transaction manager.

    >>> ztm.uninstall()

If we init Zopeless via the proxy, with implicitBegin disabled and using a
username that doesn't exist, it'll fail to connect and raise an exception (as
if implicitBegin was enabled):

    >>> ztm = initZopeless(dbuser='nonexistent', dbhost='localhost port=5555',
    ...                    implicitBegin=False)
    >>> ztm.begin()
    Traceback (most recent call last):
    ...
    OperationalError: ...
    >>> ztm.uninstall()

Clean up the proxy.

    >>> os.system('kill `cat twistd.pid`')
    0
    >>> wait_until_proxy_is_stopped()
    >>> os.remove('twistd.log')
    >>> os.remove('portforward.tap')

Tear down the database

    >>> LaunchpadTestSetup().tearDown()

