XXX: CarlosPerelloMarin 20060609: To validate textarea data content, we are
using BeautifulSoup because the testing infrastructure is adding
extra new line characters with text areas when you get the value with
getControl(...).value. For more information, please, read bug #47511.

  >>> from BeautifulSoup import BeautifulSoup

First, we need to define a function to see that the message we are
interested on doesn't have any translation.

  >>> def getMessageValues(content, message):
  ...     """Return english string and translation for the first message."""
  ...
  ...     translation_form_soup = BeautifulSoup(content)
  ...     translation_tbody = translation_form_soup.findAll('tbody')[1]
  ...     tr_list = translation_tbody.findAll('tr')
  ...     tr_english_msgid = tr_list[0]
  ...     td_ignore, td_id, td_ignore, td_msgid = (
  ...         tr_english_msgid('td'))
  ...
  ...     if message == 20:
  ...         translation_index = 4
  ...     elif message == 23:
  ...         translation_index = 2
  ...     else:
  ...         translation_index = 3
  ...
  ...     tr_translation = tr_list[translation_index]
  ...     td_ignore, td_translation = tr_translation('td')
  ...
  ...     return (td_id.renderContents(), td_msgid.renderContents(),
  ...             td_translation.renderContents())


  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open(
  ...     'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=19&batch=1')
  >>> browser.url
  'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=19&batch=1'

We can see that the message we are interested on is not translated.

  >>> (msgid_number, msgid, translation) = getMessageValues(
  ...     browser.contents, 20)
  >>> print msgid_number
  20.
  <input type="hidden" name="msgset_149" />
  >>> print msgid
  Please select a key size in bits.  The cipher you have chosen...
  >>> print translation
  (no translation yet)

Now, we submit some text with new lines before and after the text, the
answer should have exactly those strings.

  >>> browser.getControl(name='msgset_149_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_149_es_translation_0_new').value = '\r\nfoo\r\n\r\n'
  >>> browser.getControl(name='submit_translations').click()
  >>> browser.url
  'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=19&batch=1'
  >>> soup = BeautifulSoup(browser.contents)
  >>> soup.find(attrs={"name" : "msgset_149_es_translation_0_new"})
  <textarea ... name="msgset_149_es_translation_0_new" ...>

  foo

  </textarea>

And finally, a line that does not start with a new line so we are sure we
don't get extra whitespaces. The NORMALIZE_WHITESPACE must be there, if you
change the test, to be 100% sure that the textarea content is the right one.

  >>> browser.getControl(name='msgset_149_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_149_es_translation_0_new').value = 'foo'
  >>> browser.getControl(name='submit_translations').click()
  >>> browser.url
  'http://localhost/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/es/+translate?start=19&batch=1'
  >>> soup = BeautifulSoup(browser.contents)
  >>> soup.find(attrs={"name" : "msgset_149_es_translation_0_new"}) #doctest: -NORMALIZE_WHITESPACE
  <textarea ... name="msgset_149_es_translation_0_new" ...>
  foo</textarea>

Now, Check that even though the user forgot the trailing new line char, Rosetta
adds it automatically

  >>> browser.open('http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=21&batch=1')
  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=21&batch=1'
  >>> browser.getControl(name='msgset_165_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_165_es_translation_0_new').value = '%s: la opcion \xc2\xab%s\xc2\xbb es ambigua'
  >>> browser.getControl(name='submit_translations').click()

We were redirected to the next form, the translation was accepted.

  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=0&batch=1'

Get previous page to check that the save translation is the right one.

  >>> browser.getLink('Last').click()
  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=21&batch=1'

And, as we can see, we get the trailing new line char

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents, 23)
  >>> print msgid_number
  23.
  <input type="hidden" name="msgset_165" />
  >>> print msgid
  <code>%s</code>: option `<code>%s</code>' is ambiguous...
  >>> print translation
  <div lang="es" dir="ltr"><code>%s</code>: la opcion «<code>%s</code>» es ambigua<img alt="" src="/@@/translation-newline" /><br />
  </div>

Now, we do the right submit, with one trailing new line...

  >>> browser.getControl(name='msgset_165_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_165_es_translation_0_new').value = '%s: la opcion \xc2\xab%s\xc2\xbb es ambigua\r\n'
  >>> browser.getControl(name='submit_translations').click()

We were redirected to the next form, the translation was accepted.

  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=0&batch=1'

Get previous page to check that the save translation is the right one.

  >>> browser.getLink('Last').click()
  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=21&batch=1'

And, as we can see, we get the same output, just one trailing new line char

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents, 23)
  >>> print msgid_number
  23.
  <input type="hidden" name="msgset_165" />
  >>> print msgid
  <code>%s</code>: option `<code>%s</code>' is ambiguous...
  >>> print translation
  <div lang="es" dir="ltr"><code>%s</code>: la opcion «<code>%s</code>» es ambigua<img alt="" src="/@@/translation-newline" /><br />
  </div>

Last check, the user sends two new line chars instead of just one...

  >>> browser.getControl(name='msgset_165_es_translation_0_new_checkbox').value = True
  >>> browser.getControl(name='msgset_165_es_translation_0_new').value = '%s: la opcion \xc2\xab%s\xc2\xbb es ambigua\r\n\r\n'
  >>> browser.getControl(name='submit_translations').click()

We were redirected to the next form, the translation was accepted.

  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=0&batch=1'

Get previous page to check that the save translation is the right one.

  >>> browser.getLink('Last').click()
  >>> browser.url
  'http://localhost/evolution/trunk/+pots/evolution-2.2/es/+translate?start=21&batch=1'

And Rosetta comes to the rescue and stores just one!.

  >>> (msgid_number, msgid, translation) = getMessageValues(browser.contents, 23)
  >>> print msgid_number
  23.
  <input type="hidden" name="msgset_165" />
  >>> print msgid
  <code>%s</code>: option `<code>%s</code>' is ambiguous...
  >>> translation
  '\n<div lang="es" dir="ltr"><code>%s</code>: la opcion \xc2\xab<code>%s</code>\xc2\xbb es ambigua<img alt="" src="/@@/translation-newline" /><br />\n</div>\n'
