<tal:bugtask
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  define="expandable view/canSeeTaskDetails;
          indent_task view/shouldIndentTask;
          is_conjoined_slave view/is_conjoined_slave;
          tasklink view/taskLink;
          row_id string:tasksummary${context/id};
          form_row_id string:task${context/id}">
  <tr tal:attributes="class view/getTaskRowCSSClass; id row_id">
    <td class="icon left right">
      <metal:expander
          metal:define-macro="expander"
          tal:define="expander_link_text expander_link_text|nothing">
        <a tal:condition="expandable"
           tal:attributes="
            href tasklink;
            onclick string:return toggleFormVisibility('${form_row_id}')">
          <img src="/@@/bug-status-expand" alt="[edit]" />
          <tal:link_text tal:replace="expander_link_text" />
        </a>
        <tal:no_expander tal:condition="not: expandable"
                         tal:replace="expander_link_text" />
      </metal:expander>
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em"
        tal:condition="indent_task"
        tal:define="series_targetname view/getSeriesTargetName">
      <img src="/@@/milestone" alt="Targeted to" />
      <tal:not-conjoined-task condition="not: is_conjoined_slave">
        <a
          tal:attributes="href context/target/fmt:url"
          tal:content="series_targetname"
        />
      </tal:not-conjoined-task>
    </td>
    <td tal:condition="not:indent_task">
      <img
        tal:condition="view/bugtask_icon"
        alt=""
        tal:attributes="src view/bugtask_icon"
      />
      <a tal:attributes="
            href context/target/fmt:url;
            title view/target_link_title"
        tal:content="context/bugtargetdisplayname"
      />
    </td>

    <tal:conjoined-task condition="is_conjoined_slave">
    <td colspan="5" style="vertical-align: middle">
      <span class="discreet lesser" style="font-size: 100%">
        Status tracked in
        <tal:master tal:replace="view/getConjoinedMasterName">
          Hoary
        </tal:master>
      </span>
    </td>
    </tal:conjoined-task>

    <tal:not-conjoined-task condition="not:is_conjoined_slave">
    <td tal:attributes="class string:status${context/status/name}"
        tal:define="expander_link_text context/status/title">
      <metal:expander metal:use-macro="template/macros/expander" />
    </td>

    <td tal:attributes="class string:importance${context/importance/name}"
        tal:define="expander_link_text context/importance/title">
      <metal:expander metal:use-macro="template/macros/expander" />
    </td>

    <td class="icon left right">
      <metal:expander metal:use-macro="template/macros/expander" />
    </td>

    <td style="margin: 0; padding: 0; vertical-align: middle">
      <tal:has_watch condition="context/bugwatch">
        <div style="text-decoration: none; padding: 0.25em">
          <img tal:condition="not:context/bugwatch/last_error_type"
               alt="Linked to " src="/@@/bug-remote" />
          <img tal:condition="context/bugwatch/last_error_type"
            alt="Error updating bug watch" src="/@@/warning" />
          <a tal:replace="structure context/bugwatch/fmt:external-link">
            Zilla #123
          </a>
        </div>
      </tal:has_watch>
      <tal:has_no_watch condition="not: context/bugwatch"
        define="assignee_el_id string:assignee-link-${context/id}">

        <tal:comment condition="nothing">
          The empty <a> tag is filled in by the in-place assignee editor.
        </tal:comment>
        <a
          style="padding: 0.25em; text-decoration: none;"
          tal:attributes="
            id assignee_el_id;
            href string:${context/assignee/fmt:url}/+assignedbugs"
        >
          <tal:has_assignee condition="context/assignee">
            <img tal:replace="structure context/assignee/image:icon"
                  src="/@@/person" />
            <span tal:replace="context/assignee/browsername">
              assignee.browsername
            </span>
          </tal:has_assignee>
        </a>
          <script tal:content="structure string:
          YUI().use('lp.picker', function(Y) {
            var show_widget_node = Y.Node.create('<img/>');
            show_widget_node.set('src', '/@@/edit');
            var assignee_link = Y.get('#${assignee_el_id}');
            assignee_link.ancestor().appendChild(show_widget_node);
            var save = function (result) {
                var client = new LP.client.Launchpad();
                var person_uri = LP.client.get_absolute_uri(
                    '/~' + result['value'], true);
                var update_ui_after_save = function (e) {
                    LP.log_object(e, 'update_ui_after_save');
                    LP.log_object(result, 'result in update func');
                    assignee_link.set('innerHTML', '');
                    var icon = Y.Node.create('<img/>');
                    icon.set('src', result['image']);
                    assignee_link.appendChild(icon);
                    assignee_link.appendChild(
                        Y.Node.create(' ' + result['title']));
                    assignee_link.set('href',
                        '/~' + result['value'] + '/+assignedbugs');
                };

                // LP.client won't insert 'api/beta' into an absolute url.
                var bugtask_uri = '${view/bugtask_canonical_url}';
                var index = bugtask_uri.indexOf('//');
                index = bugtask_uri.indexOf('/', index+2);
                bugtask_uri = bugtask_uri.substring(index);

                client.named_post(
                    bugtask_uri,
                    'transitionToAssignee',
                    {
                      parameters: {assignee: person_uri},
                      on: {
                      success: update_ui_after_save,
                      failure: function (e) {
                          alert('Error');
                          Y.log(e);
                     }}}
                );
            };
            var config = {header: 'Select assignee'};
            Y.lp.picker.add('ValidAssignee', show_widget_node, save, config);
          });
          "/>
      </tal:has_no_watch>
    </td>

    <tal:milestoned condition="context/milestone">
      <td class="icon left right">
        <metal:expander metal:use-macro="template/macros/expander" />
      <a tal:attributes="href context/milestone/fmt:url"
         tal:content="context/milestone/name">1.0</a>
      </td>
      </tal:milestoned>
      <td tal:condition="not:context/milestone"></td>
    </tal:not-conjoined-task>
  </tr>
  <tal:form condition="view/displayEditForm">
    <tr
      tal:attributes="id form_row_id"
      tal:condition="expandable"
      style="display: none"
    >
     <td colspan="7" tal:content="structure view/edit_view" />
    </tr>
  </tal:form>
</tal:bugtask>
