= Reset Password =

David Allouche forgot his password and he's going to use the forgotten
password form to reset it.

He locates the forgotten password link on the login page to visit
the page.

    >>> browser.open('http://launchpad.dev/+login')
    >>> browser.getLink('Forgotten your password?').click()

    >>> browser.url
    'http://launchpad.dev/+forgottenpassword'

    >>> browser.title
    'Need a new Launchpad password?'

He types the email address registered in Launchpad and submit the form.

    >>> browser.getControl(name='email').value = (
    ...     'david.allouche@canonical.com')
    >>> browser.getControl('Request Reset').click()
    >>> print extract_text(find_main_content(browser.contents))
    Log in / Register
    ...We have sent you an email with instructions to reset your password...

David receives an email from Launchpad.

    # Get the to-addresses and link form the email.
    >>> from lp.services.mail import stub
    >>> from canonical.launchpad.ftests.logintoken import (
    ...     get_token_url_from_email)
    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> link = get_token_url_from_email(raw_msg)

The email was sent to him.

    >>> to_addrs
    ['david.allouche@canonical.com']

David uses the link in the email to visit the reset password page.

    >>> link
    'http://launchpad.dev/token/...'
    >>> browser.open(link)
    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

The token can only be used to reset the password.  Manually typing
another login token view name will redirect to the correct one:

    >>> wrong_link = link + "/+validateemail"
    >>> browser.open(wrong_link)
    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

He may now enter his password.  Unfortunately, he picks a password with
invalid characters:

    >>> browser.getControl(
    ...     name='field.email').value = 'david.allouche@canonical.com'
    >>> browser.getControl(name='field.password').value = 'é'
    >>> browser.getControl(name='field.password_dupe').value = 'é'
    >>> browser.getControl('Continue').click()

    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    There is 1 error.
    The password provided contains non-ASCII characters.

This time, David corrects the password and continues:

    >>> browser.getControl(name='field.password').value = 'test2'
    >>> browser.getControl(name='field.password_dupe').value = 'test2'
    >>> browser.getControl('Continue').click()

    >>> browser.url
    'http://launchpad.dev'

    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    Your password has been reset successfully.

    >>> print extract_text(find_tag_by_id(browser.contents, 'logincontrol'))
    David Allouche...

Now that the token is consumed, he's not able to use it again.

    >>> browser.open(link)

    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    You reached this page probably because you followed a link received by
    email. That link was sent to confirm you have access to the email
    address it was sent to, but this confirmation was already concluded, so
    you don't need to do anything else.

It is now possible for David to log in with his new password.  He
logs out and then logs in again:

    >>> browser.open('http://launchpad.dev/+logout')
    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    You have been logged out

    >>> browser.getLink('Log in / Register').click()

    >>> browser.getControl(
    ...     'E-mail address:', index=0).value = 'david.allouche@canonical.com'
    >>> browser.getControl('Password').value = 'test2'
    >>> browser.getControl('Log In').click()

    >>> browser.url
    'http://launchpad.dev'

    >>> print extract_text(find_tag_by_id(browser.contents, 'logincontrol'))
    David Allouche...


== Using email addresses other than the preferred one ==

Any of a person's validated email addresses can be used to reset his
password.

David has a second email address (david@canonical.com), which he will
use to reset his password now.

    >>> browser = setupBrowser()
    >>> browser.open('http://launchpad.dev/+login')
    >>> browser.getLink('Forgotten your password?').click()
    >>> browser.getControl(name='email').value = 'david@canonical.com'
    >>> browser.getControl('Request Reset').click()
    >>> print "\n".join(get_feedback_messages(browser.contents))

He follows the link sent to his email just like he did before.

    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> link = get_token_url_from_email(raw_msg)
    >>> browser.open(link)
    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

And then resets his password.

    >>> browser.getControl(name='field.email').value = 'david@canonical.com'
    >>> browser.getControl(name='field.password').value = 'test3'
    >>> browser.getControl(name='field.password_dupe').value = 'test3'
    >>> browser.getControl('Continue').click()
    >>> browser.url
    'http://launchpad.dev'
    >>> print "\n".join(get_feedback_messages(browser.contents))
    Your password has been reset successfully.


== Teams do not have passwords ==

Teams do not have passwords, they cannot be reset.

    >>> browser.open('http://launchpad.dev/+forgottenpassword')
    >>> browser.getControl(name='email').value = 'support@ubuntu.com'
    >>> browser.getControl('Request Reset').click()

    >>> for tag in find_tags_by_class(browser.contents, 'error'):
    ...     print tag
    <div class="error">The email address <strong>support@ubuntu.com</strong>
    belongs to a team, and teams cannot log in to Launchpad.</div>


== Reactivating an account ==

Users can reactivate their account using the reset password feature.

    # Create a new person and deactivate it. This is just so that we can show
    # that it can be reactivated.
    >>> login(ANONYMOUS)
    >>> person = factory.makePerson(name='person', password='foo')
    >>> email = person.preferredemail.email
    >>> login_person(person)
    >>> person.deactivateAccount('Testing')
    >>> logout()
    >>> transaction.commit()
    >>> deactivated_person = person
    >>> deactivated_person.account.status
    <DBItem AccountStatus.DEACTIVATED...

Former User realises his life is incomplete without Launchpad. He
tries to login, but his password does not work anymore.

    >>> browser = setupBrowser()
    >>> browser.open('http://launchpad.dev/')
    >>> browser.getLink('Log in / Register').click()
    >>> browser.getControl('E-mail address:', index=0).value = email
    >>> browser.getControl('Password').value = 'foo'
    >>> browser.getControl('Log In').click()
    >>> browser.title
    'Log in or register with Launchpad'

    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    The email address belongs to a deactivated account. Use the
    "Forgotten your password" link to reactivate it.

He requests a new password.

    >>> browser.getLink('Forgotten your password?').click()
    >>> browser.title
    'Need a new Launchpad password?'

    >>> browser.getControl(name='email').value = (
    ...     'former-user@canonical.com')
    >>> browser.getControl('Request Reset').click()

    >>> print extract_text(find_main_content(browser.contents).p)
    We have sent you an email with instructions to reset your password.

He retrieves the URL form the email and opens it in his browser.

    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> link = get_token_url_from_email(raw_msg)
    >>> to_addrs
    ['former-user@canonical.com']
    >>> link
    'http://launchpad.dev/token/...'

    >>> browser.open(link)
    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

Former User types his password twice to verify it and submits
it with the Continue button. He is happy to see his name is restored
in the URL.

    >>> browser.getControl(
    ...     name='field.email').value = 'former-user@canonical.com'
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl(name='field.password_dupe').value = 'test'
    >>> browser.getControl('Continue').click()

    >>> browser.url
    'http://launchpad.dev'

    >>> for tag in get_feedback_messages(browser.contents):
    ...     print extract_text(tag)
    Welcome back to Launchpad.
    Your password has been reset successfully.

    >>> print find_tag_by_id(browser.contents, 'not-lp-user-or-team')
    None


== Suspended accounts cannot reset their password ==

Users with suspended accounts cannot use reset password to gain access
to their accounts.

    # Open up the black box and shine a light on the test's inner workings.
    # Create a user with a SUSPENDED account.
    >>> from canonical.launchpad.interfaces.account import AccountStatus

    # Only admins can suspend an account.
    >>> login('foo.bar@canonical.com')
    >>> bad_user = factory.makePerson(
    ...     email='bad-user@canonical.com',
    ...     name='bad-user',
    ...     password='invalid')
    >>> from canonical.launchpad.interfaces import IMasterObject
    >>> IMasterObject(bad_user.account).status = AccountStatus.SUSPENDED
    >>> logout()

    >>> import transaction
    >>> transaction.commit()

Bad User has a suspended account. He discovers that his account is disabled
when he visits his profile page.

    >>> browser = setupBrowser()
    >>> browser.open('http://launchpad.dev/~bad-user')
    >>> browser.title
    'Bad-user does not use Launchpad'

He believes he can reactivate his account by resetting his password. He
requests an email that will have the link that will let him provide a
new password.

    >>> browser.getLink('Log in / Register').click()
    >>> browser.title
    'Log in or register with Launchpad'

    >>> browser.getLink('Forgotten your password?').click()
    >>> browser.title
    'Need a new Launchpad password?'
    >>> browser.getControl(name='email').value = (
    ...     'bad-user@canonical.com')
    >>> browser.getControl('Request Reset').click()

    >>> print extract_text(find_main_content(browser.contents).p)
    We have sent you an email with instructions to reset your password.

Bad User retrieves the URL from the email and opens it in his browser.

    >>> len(stub.test_emails)
    1
    >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()
    >>> link = get_token_url_from_email(raw_msg)
    >>> to_addrs
    ['bad-user@canonical.com']
    >>> link
    'http://launchpad.dev/token/...'

    >>> browser.open(link)
    >>> browser.url
    'http://launchpad.dev/token/.../+resetpassword'

Bad User types his password twice to verify it and submits it with the
Continue button. He is disappointed to see that his account is still
suspended, and that he is instructed to contact admin.

    >>> browser.getControl(
    ...     name='field.email').value = 'bad-user@canonical.com'
    >>> browser.getControl(name='field.password').value = 'test'
    >>> browser.getControl(name='field.password_dupe').value = 'test'
    >>> browser.getControl('Continue').click()

    >>> for tag in find_tags_by_class(
    ...     browser.contents, 'warning'):
    ...     print tag
    <div ...>Your password cannot be reset because your account is suspended.
    Contact a <a href="mailto:feedback@launchpad.net?subject=SU...">Launchpad
    admin</a> about this issue.</div>
