= Hardware Database Device Tables =

These tables represent devices and complete systems in the database. They
allow to look up devices by their bus IDs and by their human readable
vendor and product name. They also link a device to drivers.


== HWVendorName ==

HWVendorName is a simple list of vendor names. A new entry is created by
IHWVendorNameSet.create.

    >>> from canonical.launchpad.interfaces import IHWVendorNameSet
    >>> vendor_name_set = getUtility(IHWVendorNameSet)
    >>> intel_name = vendor_name_set.create(name='Intel')
    >>> print intel_name.name
    Intel

Each name in the table must be unique. The attempt to create a second
row with the same name raises a IntegrityError error.

    >>> from canonical.testing import LaunchpadZopelessLayer
    >>> LaunchpadZopelessLayer.txn.commit()
    >>> vendor_name_set.create('Intel')
    Traceback (most recent call last):
    ...
    IntegrityError: ERROR:  duplicate key violates unique
    constraint "hwvendorname_name_key"
    ...
    >>> LaunchpadZopelessLayer.txn.abort()

== HWVendorID ==

HWVendorID associates a bus, as enumerated by HWBus, with a bus-specific
vendor ID and a vendor name. We store the IDs as a string, because not all
all busses use numeric IDs. Numbers are represented as strings with
hexadecimal digits, prepended by '0x'.

    >>> from canonical.launchpad.interfaces import HWBus, IHWVendorIDSet
    >>> vendor_id_set = getUtility(IHWVendorIDSet)
    >>> intel_pci_id = vendor_id_set.create(bus=HWBus.PCI,
    ...                                 vendor_id='0x8086',
    ...                                 vendor_name=intel_name)
    >>> print intel_pci_id.bus.title, intel_pci_id.vendor_id_for_bus
    PCI 0x8086
    >>> print intel_pci_id.vendor_name.name
    Intel

The tuple (bus, vendor id, vendor name) must be unique.

    >>> LaunchpadZopelessLayer.txn.commit()
    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='0x8086',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    IntegrityError: ERROR:  duplicate key violates unique
    constraint "hwvendorid__bus_vendor_id__vendor_name__key"
    ...
    >>> LaunchpadZopelessLayer.txn.abort()

We store the (bus specific) vendor ID as a string, but several busses
have stricter constraints for their vendor ID. The PCI and USB busses use
16 bit integers, the IEEE1394 bus uses 24 bit integers, the SCSI bus
uses ASCII strings with exactly 8 characters. The constructor of
HWVendorID ensures that the vendor IDs match the bus-specific format.

USB and PCI IDs are represented as strings with a four-digit hexadecimal
number, prefixed by '0x'; the digits a..f must be lower cases characters.
Other ID values raise a ValueError.

The characters a..f are accepted as digits.

    >>> another_pci_vendor_id = vendor_id_set.create(bus=HWBus.PCI,
    ...                                          vendor_id='0x10ae',
    ...                                          vendor_name=intel_name)
    >>> print another_pci_vendor_id.bus.title
    PCI
    >>> print another_pci_vendor_id.vendor_id_for_bus
    0x10ae
    >>> print another_pci_vendor_id.vendor_name.name
    Intel

    >>> another_usb_vendor_id = vendor_id_set.create(bus=HWBus.USB,
    ...                                          vendor_id='0x10ae',
    ...                                          vendor_name=intel_name)
    >>> print another_usb_vendor_id.bus.title
    USB
    >>> print another_usb_vendor_id.vendor_id_for_bus
    0x10ae
    >>> print another_usb_vendor_id.vendor_name.name
    Intel

A..F is rejected.

    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='0x10AE',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x10AE' is not a valid vendor ID for PCI

    >>> vendor_id_set.create(bus=HWBus.USB,
    ...                      vendor_id='0x10AE',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x10AE' is not a valid vendor ID for USB

The ID must have the prefix "0x".

    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='8086',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '8086' is not a valid vendor ID for PCI

    >>> vendor_id_set.create(bus=HWBus.USB,
    ...                      vendor_id='8086',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '8086' is not a valid vendor ID for USB

The number must have four digits.

    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='0x123',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x123' is not a valid vendor ID for PCI

    >>> vendor_id_set.create(bus=HWBus.USB,
    ...                      vendor_id='0x123',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x123' is not a valid vendor ID for USB

    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='0x12345',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x12345' is not a valid vendor ID for PCI

    >>> vendor_id_set.create(bus=HWBus.USB,
    ...                      vendor_id='0x12345',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x12345' is not a valid vendor ID for USB

Only hex digits are allowed.

    >>> vendor_id_set.create(bus=HWBus.PCI,
    ...                      vendor_id='0xblah',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0xblah' is not a valid vendor ID for PCI

    >>> vendor_id_set.create(bus=HWBus.USB,
    ...                      vendor_id='0xblah',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0xblah' is not a valid vendor ID for USB

IEEE1394 IDs are represented as strings with a six-digit hexadecimal
number, prefixed by '0x'; the digits a..f must be lower cases characters.
Other ID values raise a value error.

    >>> vendor_id_1394 = vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                                       vendor_id='0x0010e0',
    ...                                       vendor_name=intel_name)
    >>> print vendor_id_1394.bus.title
    IEEE1394
    >>> print vendor_id_1394.vendor_id_for_bus
    0x0010e0
    >>> print vendor_id_1394.vendor_name.name
    Intel

A..F is rejected.

    >>> vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                      vendor_id='0x0010E0',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x0010E0' is not a valid vendor ID for IEEE1394

The ID must have the prefix "0x".

    >>> vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                      vendor_id='0010E0',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0010E0' is not a valid vendor ID for IEEE1394

The number must have six digits.

    >>> vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                      vendor_id='0x12345',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x12345' is not a valid vendor ID for IEEE1394

    >>> vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                      vendor_id='0x1234567',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0x1234567' is not a valid vendor ID for IEEE1394

Only hex digits are allowed.

    >>> vendor_id_set.create(bus=HWBus.IEEE1394,
    ...                      vendor_id='0xfoobar',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '0xfoobar' is not a valid vendor ID for IEEE1394

SCSI vendor IDs are ASCII strings with exactly eight characters.

    >>> intel_scsi_id = vendor_id_set.create(bus=HWBus.SCSI,
    ...                                      vendor_id='INTEL   ',
    ...                                      vendor_name=intel_name)
    >>> print intel_scsi_id.bus.title
    SCSI
    >>> intel_scsi_id.vendor_id_for_bus
    u'INTEL   '
    >>> print intel_scsi_id.vendor_name.name
    Intel

Strings with less than eight characters are not allowed as SCSI vendor IDs...

    >>> vendor_id_set.create(bus=HWBus.SCSI,
    ...                      vendor_id='1234567',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '1234567' is not a valid vendor ID for SCSI

...as well as strings with more than eight characters.

    >>> vendor_id_set.create(bus=HWBus.SCSI,
    ...                      vendor_id='123456789',
    ...                      vendor_name=intel_name)
    Traceback (most recent call last):
    ...
    ValueError: '123456789' is not a valid vendor ID for SCSI


== HWDevice ==

A HWDevice instance stores core data about a hardware device: The bus
it can connect to, the vendor ID, the product ID, the human readable
product name, variant (see below), and the number of submissions with
a device.

Aside from "real" devices like keyboards, mice, hard disks, PCI cards,
i.e., "thingies" one can connect to and remove from a computer, we also
store data about "systems" (computers) and "components" in the HWDevice
table. A component is a part that is "permanently built" into a system,
like a hard disk controller that is soldered onto the main board.

A new device record is created by IHWDeviceSet.create.

    >>> from canonical.launchpad.interfaces import IHWDeviceSet
    >>> device_set = getUtility(IHWDeviceSet)
    >>> product_name='82801GBM/GHM (ICH7 Family) USB2 EHCI Controller'
    >>> usb_controller = device_set.create(bus=HWBus.PCI,
    ...                                    vendor_id='0x8086',
    ...                                    product_id='0x27cc',
    ...                                    product_name=product_name)

Bus and vendor ID are not directly stored as HWDevice attributes; we can
access them, as well as the vendor name, via the attribute bus_vendor,
which references HWVendorID.

    >>> print usb_controller.bus_vendor.bus.title
    PCI
    >>> print usb_controller.bus_vendor.vendor_id_for_bus
    0x8086
    >>> print usb_controller.bus_vendor.vendor_name.name
    Intel

Other attributes stored in HWDevice are the product ID, the product name,
the product variant and submissions. submissions is a counter of the
number of submissions with this device.

    >>> print usb_controller.bus_product_id
    0x27cc
    >>> print usb_controller.name
    82801GBM/GHM (ICH7 Family) USB2 EHCI Controller
    >>> print usb_controller.variant
    None
    >>> print usb_controller.submissions
    0

Like vendor IDs, product IDs of some busses have certain constraints.
USB and PCI product IDs are 16 bit integers; SCSI IDs are strings
with 16 characters. (Note that the IEEE1394 does _not_ define a product
ID.)

USB and PCI IDs are represented as strings with a four-digit hexadecimal
number, prefixed by '0x'; the digits a..f must be lower cases characters.
Other ID values raise a ValueError.

    >>> another_pci_product = device_set.create(bus=HWBus.PCI,
    ...                                         vendor_id='0x8086',
    ...                                         product_id='0xabcd',
    ...                                         product_name='A PCI card')
    >>> print another_pci_product.bus_product_id
    0xabcd

    >>> another_usb_product = device_set.create(bus=HWBus.USB,
    ...                                         vendor_id='0x8086',
    ...                                         product_id='0xabcd',
    ...                                         product_name='A USB device')
    >>> print another_usb_product.bus_product_id
    0xabcd

A..F is rejected.

    >>> device_set.create(bus=HWBus.PCI,
    ...                   vendor_id='0x8086',
    ...                   product_id='0xABCD',
    ...                   product_name='A PCI card')
    Traceback (most recent call last):
    ...
    ValueError: '0xABCD' is not a valid product ID for PCI

    >>> device_set.create(bus=HWBus.USB,
    ...                   vendor_id='0x8086',
    ...                   product_id='0xABCD',
    ...                   product_name='A USB device')
    Traceback (most recent call last):
    ...
    ValueError: '0xABCD' is not a valid product ID for USB

The ID must have the prefix "0x".

    >>> device_set.create(bus=HWBus.PCI,
    ...                   vendor_id='0x8086',
    ...                   product_id='1234',
    ...                   product_name='A PCI card')
    Traceback (most recent call last):
    ...
    ValueError: '1234' is not a valid product ID for PCI

    >>> device_set.create(bus=HWBus.USB,
    ...                   vendor_id='0x8086',
    ...                   product_id='1234',
    ...                   product_name='A USB device')
    Traceback (most recent call last):
    ...
    ValueError: '1234' is not a valid product ID for USB

The number must have four digits.

    >>> device_set.create(bus=HWBus.PCI,
    ...                   vendor_id='0x8086',
    ...                   product_id='0x123',
    ...                   product_name='A PCI card')
    Traceback (most recent call last):
    ...
    ValueError: '0x123' is not a valid product ID for PCI

    >>> device_set.create(bus=HWBus.USB,
    ...                   vendor_id='0x8086',
    ...                   product_id='0x123',
    ...                   product_name='A USB device')
    Traceback (most recent call last):
    ...
    ValueError: '0x123' is not a valid product ID for USB

    >>> device_set.create(bus=HWBus.PCI,
    ...                   vendor_id='0x8086',
    ...                   product_id='0x12345',
    ...                   product_name='A PCI card')
    Traceback (most recent call last):
    ...
    ValueError: '0x12345' is not a valid product ID for PCI

    >>> device_set.create(bus=HWBus.USB,
    ...                   vendor_id='0x8086',
    ...                   product_id='0x12345',
    ...                   product_name='A USB device')
    Traceback (most recent call last):
    ...
    ValueError: '0x12345' is not a valid product ID for USB

Only hex digits are allowed.

    >>> device_set.create(bus=HWBus.PCI,
    ...                   vendor_id='0x8086',
    ...                   product_id='0xblah',
    ...                   product_name='A PCI card')
    Traceback (most recent call last):
    ...
    ValueError: '0xblah' is not a valid product ID for PCI

    >>> device_set.create(bus=HWBus.USB,
    ...                   vendor_id='0x8086',
    ...                   product_id='0xblah',
    ...                   product_name='A USB device')
    Traceback (most recent call last):
    ...
    ValueError: '0xblah' is not a valid product ID for USB

SCSI product IDs are ASCII strings with 16 characters.

    >>> scsi_device = device_set.create(bus=HWBus.SCSI,
    ...                                 vendor_id='INTEL   ',
    ...                                 product_id='12345678901234  ',
    ...                                 product_name='A SCSI device')
    >>> scsi_device.bus_product_id
    u'12345678901234  '

Strings with less than 16 characters are not allowed as SCSI product IDs...

    >>> device_set.create(bus=HWBus.SCSI,
    ...                   vendor_id='INTEL   ',
    ...                   product_id='123456789012345',
    ...                   product_name='A SCSI device')
    Traceback (most recent call last):
    ...
    ValueError: '123456789012345' is not a valid product ID for SCSI

...as well as strings with more than 16 characters.

    >>> device_set.create(bus=HWBus.SCSI,
    ...                   vendor_id='INTEL   ',
    ...                   product_id='12345678901234567',
    ...                   product_name='A SCSI device')
    Traceback (most recent call last):
    ...
    ValueError: '12345678901234567' is not a valid product ID for SCSI


=== Unknown Vendor IDs ===

If IHWDevice.create is called with a vendor ID that for which there
is no IHWVendorID record, the latter is automatically created. Since
we do not pass the vendor name to IHWDevice.create, this method
cannot set the real vendor name for the new IHWVendorID record.
Instead, the vendor name is set to "Unknown".

Reason: IHWDevice will be populated with data collected by the
HWDB client, which gets most of the device data from HAL, and HAL
quite often does not know the vendor name. Hence we will populate
and update IHWVendorID from sources like

http://www.linux-usb.org/usb.ids
http://www.pcidatabase.com/reports.php?type=csv
http://standards.ieee.org/regauth/oui/oui.txt

    >>> new_vendor_device = device_set.create(bus=HWBus.PCI,
    ...                                       vendor_id='0x4321',
    ...                                       product_id='0x8765',
    ...                                       product_name='mind sensor')
    >>> print new_vendor_device.bus_vendor.vendor_name.name
    Unknown

=== Device Variants ===

While most devices can be uniquely identified by their vendor and product
IDs, there are some cases, where different devices have identical IDs:

(a) The IDs are assigned to a USB chipset that is used in different
    devices.
(b) A vendor may inadvertently "recycle" a product ID
(c) A chip manufacturer who does not have its own vendor ID may "forge"
    the vendor ID.

A real world example of the first case is the scanner chipset from
Plustek with the USB ID 0x07b3/0x0017. This chipset is used in devices
that differ for example in the maximum scan window size.

We do not necessarily know in advance that there are different devices
with identical IDs, so we may have a HWDevice record without the variant
attribute set.

    >>> plustek_name = vendor_name_set.create('Plustek')
    >>> plustek_usb_id = vendor_id_set.create(bus=HWBus.USB,
    ...                                       vendor_id='0x07b3',
    ...                                       vendor_name=plustek_name)
    >>> some_plustek_scanner = device_set.create(bus=HWBus.USB,
    ...                                          vendor_id='0x07b3',
    ...                                          product_id='0x0017',
    ...                                          product_name='some scanner')
    >>> print some_plustek_scanner.bus_vendor.vendor_id_for_bus
    0x07b3
    >>> print some_plustek_scanner.bus_vendor.vendor_name.name
    Plustek
    >>> print some_plustek_scanner.name
    some scanner
    >>> print some_plustek_scanner.variant
    None

Once we know that (bus, vendor ID, product ID) does not uniquely
identify a device, we can disambiguate these devices by creating
IHWDevice records, where the attribute variant is, for example, set
to the product name.

    >>> optic_pro_ut12 = device_set.create(bus=HWBus.USB,
    ...                                    vendor_id='0x07b3',
    ...                                    product_id='0x0017',
    ...                                    variant='OpticPro UT12',
    ...                                    product_name='OpticPro UT12')
    >>> optic_pro_ut16 = device_set.create(bus=HWBus.USB,
    ...                                    vendor_id='0x07b3',
    ...                                    product_id='0x0017',
    ...                                    variant='OpticPro UT16',
    ...                                    product_name='OpticPro UT16')

For systems, we use HWBus.SYSTEM as the "bus name"; the HAL property
system.vendor is stored as the vendor ID and vendor name, and the HAL
property system.product is stored as the product ID and the product
name.

    >>> hal_vendor_name = 'Tonka'
    >>> hal_product_name = 'Tuffbook 2600'
    >>> tonka_name = vendor_name_set.create(name=hal_vendor_name)
    >>> tonka_system_id = vendor_id_set.create(bus=HWBus.SYSTEM,
    ...                                        vendor_id=hal_vendor_name,
    ...                                        vendor_name=tonka_name)
    >>> tuffbook_2600 = device_set.create(bus=HWBus.SYSTEM,
    ...                                   vendor_id=hal_vendor_name,
    ...                                   product_id=hal_product_name,
    ...                                   product_name=hal_product_name)
    >>> print tuffbook_2600.bus_vendor.bus.title
    System
    >>> print tuffbook_2600.bus_vendor.vendor_id_for_bus
    Tonka
    >>> print tuffbook_2600.bus_vendor.vendor_name.name
    Tonka
    >>> print tuffbook_2600.bus_product_id
    Tuffbook 2600
    >>> print tuffbook_2600.name
    Tuffbook 2600

The tuple (bus_vendor, bus_product_id, variant) must be unique.
The attempt to create two rows with the same data raises a
IntegrityError error.

    >>> LaunchpadZopelessLayer.txn.commit()
    >>> another_scanner = device_set.create(bus=HWBus.USB,
    ...                                     vendor_id='0x07b3',
    ...                                     product_id='0x0017',
    ...                                     product_name='some scanner')
    Traceback (most recent call last):
    ...
    IntegrityError: ERROR:  duplicate key violates unique
    constraint "hwdevice__bus_vendor_id__bus_product_id__key"
    ...
    >>> LaunchpadZopelessLayer.txn.abort()

    >>> another_scanner = device_set.create(bus=HWBus.USB,
    ...                                     vendor_id='0x07b3',
    ...                                     product_id='0x0017',
    ...                                     variant='OpticPro UT16',
    ...                                     product_name='OpticPro UT16')
    Traceback (most recent call last):
    ...
    IntegrityError: ERROR:  duplicate key violates unique
    constraint "hwdevice__bus_vendor_id__bus_product_id__variant__key"
    ...
    >>> LaunchpadZopelessLayer.txn.abort()


== HWDeviceNameVariant ==

Many OEM products are sold by more than one vendor under different
product names; some manufacturers sell the same device under
different names in different parts of the world. The support status
of such devices does not depend on the "publicly visible" vendor and
product name, so we consider these devices to be identical. Users will
nevertheless want to look up devices by the vendor and product name
they see in a store. HWDeviceNameVariant allows us to assign alternative
vendor and product names to a device.

    >>> from canonical.launchpad.interfaces import IHWDeviceNameVariantSet
    >>> device_name_variant_set = getUtility(IHWDeviceNameVariantSet)
    >>> variant = device_name_variant_set.create(device=optic_pro_ut16,
    ...                                          vendor_name='Medion',
    ...                                          product_name='MD 1234')
    >>> print variant.device.bus_vendor.vendor_name.name
    Plustek
    >>> print variant.vendor_name.name
    Medion
    >>> print variant.product_name
    MD 1234

We count the number of submissions which told us an alternative device
name.

    >>> print variant.submissions
    0

The tuple (device, vendor_name, product_name) must be unique.
The attempt to create two rows with the same data raises an
IntegrityError error.

    >>> LaunchpadZopelessLayer.txn.commit()
    >>> same_variant = device_name_variant_set.create(device=optic_pro_ut16,
    ...                                               vendor_name='Medion',
    ...                                               product_name='MD 1234')
    Traceback (most recent call last):
    ...
    IntegrityError: ERROR:  duplicate key violates unique
    constraint "hwdevicenamevariant__vendor_name__product_name__device__key"
    ...
    >>> LaunchpadZopelessLayer.txn.abort()
