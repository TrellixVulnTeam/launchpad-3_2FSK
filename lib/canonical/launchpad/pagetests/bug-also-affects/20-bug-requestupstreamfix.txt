= Forwarding bugs upstream =

There are two pages that deal with adding an upstream task:
+choose-affected-product and +add-affected-product. The former deals
with choosing which product that is affected by the bug, and the latter
display some information about the chosen product and adds the actual
bugtask.

If we add go to the page from an Ubuntu evolution task, we get
redirected to +add-affected-product directly.

    >>> user_browser.open(
    ...  'http://launchpad.dev/ubuntu/+source/evolution/+bug/6')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://launchpad.dev/ubuntu/+source/evolution/+bug/6/+add-affected-product?field.product=evolution'

If this wasn't what we intended, we can go back to choose another
product.

    >>> user_browser.getLink('Choose another project').click()
    >>> user_browser.url
    'http://launchpad.dev/ubuntu/+source/evolution/+bug/6/+choose-affected-product?field.product=evolution'

    >>> user_browser.getControl('Product').value
    'evolution'

    >>> user_browser.getControl('Product').value = 'thunderbird'
    >>> user_browser.getControl('Continue').click()

Since Thunderbird doesn't use  Malone, there's a widget for entering a bug URL.

    >>> user_browser.getControl('URL').value
    ''

If we leave it empty, a notification will be shown when trying to add
the task, asking us to confirm that we want to add the task without a
bug watch.

    >>> user_browser.getControl('Indicate bug in Mozilla Thunderbird').click()
    >>> user_browser.url
    'http://launchpad.dev/ubuntu/+source/evolution/+bug/6/+add-affected-product'

    >>> for notification in find_tags_by_class(user_browser.contents, 'message'):
    ...     print notification.renderContents()
    Mozilla Thunderbird doesn't use Malone as its bug tracker...

Let's confirm adding the task.

    >>> user_browser.getControl('Yes').click()
    >>> user_browser.url
    'http://launchpad.dev/thunderbird/+bug/6'

Let's add the evolution task as well.

    >>> user_browser.open(
    ...  'http://launchpad.dev/ubuntu/+source/evolution/+bug/6')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://launchpad.dev/ubuntu/+source/evolution/+bug/6/+add-affected-product?field.product=evolution'

    >>> user_browser.getControl('Indicate bug in Evolution').click()

    >>> user_browser.url
    'http://launchpad.dev/evolution/+bug/6'

== Error messages ==

If we try to add an upstream task without specifying a product:

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3')
    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'

    >>> user_browser.getControl('Product').value
    ''
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'

We get a nice error message.

  >>> 'Required input is missing' in user_browser.contents
  True

If we enter a product name that doesn't exist, we inform the user
about this and ask him to search for the product.

    >>> user_browser.getControl('Product').value = 'no-such-product'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'
    >>> for message_tag in find_tags_by_class(user_browser.contents, 'message'):
    ...     print message_tag.renderContents()
    There is 1 error.
    There is no product in Launchpad named "no-such-product". You may
    want to <a ...>search for it</a>, or <a ...>register it</a> if you
    can't find it.

    >>> search_link = user_browser.getLink('search for it')
    >>> search_link.url
    "javascript:popup_window('@@popup-window?vocabulary=Product&field=field.product&search='+escape(document.getElementById('field.product').value),'field.product','300','420')"

Since the link is a javascript popup, we can't follow the link directly,
so let's extract the real URL and open it manually.

    >>> import re
    >>> search_url = re.search(
    ...     "popup_window\('([^']*)'", search_link.url).group(1)
    >>> user_browser.open(
    ...  'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/'
    ...   + search_url)
    >>> user_browser.title
    'Select a Product'

If we go back again, we see that we also give the user the possibility
to register the product if he doesn't find it.

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/'
    ...     '+choose-affected-product')
    >>> user_browser.getControl('Product').value = 'no-such-product'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'

    >>> user_browser.getLink('register it').click()
    >>> user_browser.title
    'Register a project in Launchpad'

Since we don't restrict the input, the user can write anything, so we
need to make sure that everything is quoted before displaying the input.

    >>> user_browser.open(
    ...     'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3'
    ...     '/+choose-affected-product')

    >>> user_browser.getControl('Product').value = 'N\xc3\xb6 Such Product&<>'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://launchpad.dev/debian/+source/mozilla-firefox/+bug/3/+choose-affected-product'
    >>> [message_tag.renderContents()
    ...  for message_tag in find_tags_by_class(user_browser.contents, 'message')]
    ['There is 1 error.',
     'There is no product in Launchpad named
      "N\xc3\xb6 Such Product&amp;&lt;&gt;". You may want to
      <a ...>search for it</a>, or <a ...>register it</a> if you can\'t
      find it.']


== Linking to bug watches ==

Now we add an upstream task, while adding this new bugtask we can also
specify a bug watch. If we inadvertently left some leading or trailing white
space in the bug URL it will be stripped.

  >>> user_browser.open(
  ...     'http://launchpad.dev/debian/+source/mozilla-firefox/'
  ...     '+bug/3/+choose-affected-product')
  >>> user_browser.getControl('Product').value = 'alsa-utils'
  >>> user_browser.getControl('Continue').click()

  >>> user_browser.getControl('URL').value = (
  ...     '   https://bugzilla.mozilla.org/show_bug.cgi?id=1234   ')
  >>> user_browser.getControl('Indicate bug in alsa-utils').click()

Redirected to the newly created bugtask page

  >>> user_browser.url
  'http://launchpad.dev/alsa-utils/+bug/3'

  >>> print user_browser.contents
  <...
  ...alsa-utils (upstream)...

And we can check that the remote bug number was stripped.

  >>> user_browser.getLink('mozilla.org #1234')
  <Link text='Linked to [IMG] mozilla.org #1234'
    url='https://bugzilla.mozilla.org/show_bug.cgi?id=1234'>

And now we try to add the same upstream again.

    >>> user_browser.getLink(url='+choose-affected-product').click()
    >>> user_browser.url
    'http://launchpad.dev/alsa-utils/+bug/3/+choose-affected-product'

    >>> user_browser.getControl('Product').value = 'alsa-utils'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.url
    'http://launchpad.dev/alsa-utils/+bug/3/+choose-affected-product'

We get a nice error message.

    >>> print user_browser.contents
    <...A fix for this bug has already been requested for alsa-utils...

We can add another upstream to the bug.

    >>> user_browser.getControl('Product').value = 'evolution'
    >>> user_browser.getControl('Continue').click()
    >>> user_browser.getControl('Indicate bug in Evolution').click()
    >>> user_browser.url
    'http://launchpad.dev/evolution/+bug/3'

But if we try to change it to the target of an existing upstream bugtask,
our validator springs into action.

    >>> user_browser.getLink(url='evolution/+bug/3/+editstatus').click()
    >>> user_browser.url
    'http://launchpad.dev/evolution/+bug/3/+editstatus'
    >>> user_browser.getControl('Product').value = 'alsa-utils'
    >>> user_browser.getControl('Save Changes').click()
    >>> user_browser.url
    'http://launchpad.dev/evolution/+bug/3/+editstatus'
    >>> print user_browser.contents
    <...
    ...Please fix it and try again...
    ...
    ...A fix for this bug has already been requested for alsa-utils...
    ...
