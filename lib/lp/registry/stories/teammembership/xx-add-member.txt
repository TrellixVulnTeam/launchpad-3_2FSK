Adding members to a team
========================

Any administrator of a team can add new members to that team.

    >>> browser = setupBrowser(auth='Basic test@canonical.com:test')
    >>> browser.open('http://launchpad.dev/~landscape-developers')
    >>> browser.getLink('Add member').click()
    >>> browser.url
    'http://launchpad.dev/~landscape-developers/+addmember'
    >>> browser.getControl('New member').value = 'cprov'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    Celso Providelo (cprov) has been added as a member of this team.

Let's make sure that 'cprov' is now an Approved member of 'landscape-developers'

    >>> from lp.registry.model.person import Person
    >>> from lp.registry.model.teammembership import TeamMembership
    >>> cprov = Person.byName('cprov')
    >>> landscape_team = Person.byName('landscape-developers')
    >>> cprov_landscape_membership = TeamMembership.selectOneBy(
    ...     personID=cprov.id, teamID=landscape_team.id)
    >>> cprov_landscape_membership.status.title
    'Approved'
    >>> cprov.inTeam(landscape_team)
    True

If the new member is already an approved member of that team, we'll say that.

    >>> browser.url
    'http://launchpad.dev/%7Elandscape-developers/+addmember'
    >>> browser.getControl('New member').value = 'cprov'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents, 'message'):
    ...     print tag.renderContents()
    There is 1 error.
    Celso Providelo (cprov) is already a member of Landscape Developers.

On the other hand, if the member is among the inactive/proposed members of
the team, we'll simply change the membership's status and say that it was
successfully added.

    >>> from canonical.launchpad.interfaces import TeamMembershipStatus
    >>> from canonical.launchpad.ftests import ANONYMOUS, login, logout
    >>> login(ANONYMOUS) # login() because we need a zope interaction.
    >>> ignored = cprov_landscape_membership.setStatus(
    ...     TeamMembershipStatus.DEACTIVATED, landscape_team.teamowner)
    >>> logout()
    >>> cprov_landscape_membership.syncUpdate()

    >>> browser.url
    'http://launchpad.dev/%7Elandscape-developers/+addmember'
    >>> browser.getControl('New member').value = 'cprov'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    Celso Providelo (cprov) has been added as a member of this team.


Adding teams
------------

Teams are not added as members like we do with people. Instead, teams are
invited and one of their admins have to accept the invitation for them to
become a member.

    >>> browser.open('http://launchpad.dev/~landscape-developers/+addmember')
    >>> browser.getControl('New member').value = 'launchpad'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    Launchpad Developers (launchpad) has been invited to join this team.

As we can see, the launchpad team will not be one of the team's active
members.

    >>> launchpad = Person.byName('launchpad')
    >>> launchpad in landscape_team.activemembers
    False
    >>> membership = TeamMembership.selectOneBy(
    ...     person=launchpad, team=landscape_team)
    >>> membership.status.title
    'Invited'

And nor will the admins of Landscape Developers be able to do any changes
with the TeamMembership representing the invitation sent to the Launchpad
team, not even if they manually craft the URL.

    >>> browser.open(
    ...     'http://launchpad.dev/~landscape-developers/+member/launchpad')

    >>> print extract_text(find_tag_by_id(browser.contents, 'not-responded'))
    Launchpad Developers (launchpad) has been invited to join this team, but
    hasn't responded to the invitation yet.

    >>> landscape_admin_browser = browser


Accepting/Declining invitations
-------------------------------

Any admin of the team which receives an invitation can either accept or deny
it. Although they get a link to the invitation's page, there's also a page
listing all open invitation sent to a given team.

    >>> browser = setupBrowser(auth='Basic foo.bar@canonical.com:test')
    >>> browser.open('http://launchpad.dev/~launchpad')
    >>> browser.getLink('Show received invitations').click()
    >>> browser.url
    'http://launchpad.dev/~launchpad/+invitations'

As said above, only admins of the invited team can accept/decline the
invitation. Not even an admin of the landscape team (which as so has the
rights to edit the membership in question) can do it.

    >>> landscape_admin_browser.open(
    ...     'http://launchpad.dev/~launchpad/+invitation/landscape-developers')
    Traceback (most recent call last):
    ...
    Unauthorized: ...

First, let's accept the invitation sent on behalf of Landscape Developers to
the Launchpad Developers.

    >>> print extract_text(find_tag_by_id(browser.contents, 'invitations'))
    Sent by         On behalf of
    Andrew Bennetts Landscape Developers

    >>> browser.getLink(
    ...     url='/~launchpad/+invitation/landscape-developers').click()
    >>> browser.url
    'http://launchpad.dev/~launchpad/+invitation/landscape-developers'

    >>> browser.getControl(name='field.acknowledger_comment').value = (
    ...     'This is just a test')
    >>> browser.getControl('Accept').click()

    >>> browser.url
    'http://launchpad.dev/~launchpad'
    >>> print extract_text(
    ...     find_tags_by_class(browser.contents, 'informational')[0])
    This team is now a member of Landscape Developers.

Now we'll decline the invitation sent on behalf of Ubuntu Team to
Warty Security Team:

    >>> browser.open('http://launchpad.dev/~name20/+invitation/ubuntu-team')
    >>> browser.getControl('Decline').click()
    >>> browser.url
    'http://launchpad.dev/~name20'
    >>> print extract_text(
    ...     find_tags_by_class(browser.contents, 'informational')[0])
    Declined the invitation to join Ubuntu Team


Corner cases
------------

Given that team can have more than one admin, it's possible that at the time
one admin is browsing the invitation page, another admin might be doing the
same. When an admin accepts or declines an invitation, the other admin can't
take action on that invitation anymore.

First invite name20 to be a member of ubuntu-team.

    >>> browser = setupBrowser(
    ...     auth='Basic colin.watson@ubuntulinux.com:test')
    >>> browser.open('http://launchpad.dev/~ubuntu-team/+addmember')
    >>> browser.getControl('New member:').value = 'name20'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    Warty Security Team (name20) has been invited to join this team.

Open the invitations page with one admin browser.

    >>> browser = setupBrowser(auth='Basic mark@example.com:test')
    >>> browser.open('http://launchpad.dev/~name20/+invitation/ubuntu-team')

Open the same page with another admin browser.

    >>> second_browser = setupBrowser(auth='Basic mark@example.com:test')
    >>> second_browser.open(
    ...     'http://launchpad.dev/~name20/+invitation/ubuntu-team')

Accept the invitation in the first browser.

    >>> browser.getControl('Accept').click()
    >>> browser.url
    'http://launchpad.dev/~name20'

    >>> for tag in find_tags_by_class(browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    This team is now a member of Ubuntu Team.

Accepting the invitation in the second browser, redirects to the team page
and a message is displayed.

    >>> second_browser.getControl('Accept').click()
    >>> second_browser.url
    'http://launchpad.dev/~name20'

    >>> for tag in find_tags_by_class(second_browser.contents,
    ...                               'informational message'):
    ...     print tag.renderContents()
    This invitation has already been processed.


Evil workarounds
----------------

One thing to keep in mind is that we can't invite a team without active
members.
XXX: This restriction was added as a workaround for
https://launchpad.net/bugs/94164, but I don't think it's the correct fix for
the bug sice we could skip the notification sent to the team in this case.
-- Guilherme Salgado, 2007-05-09

    # Ideally we should do this using the web UI, but doing it this way is a
    # lot simpler.
    >>> carlos = Person.byName('carlos')
    >>> ubuntu_translators = Person.byName('ubuntu-translators')
    >>> login(ANONYMOUS) # login() because we need a zope interaction.
    >>> carlos_translators_membership = TeamMembership.selectOneBy(
    ...     personID=carlos.id, teamID=ubuntu_translators.id)
    >>> ignored = carlos_translators_membership.setStatus(
    ...     TeamMembershipStatus.DEACTIVATED, ubuntu_translators.teamowner)
    >>> logout()
    >>> carlos_translators_membership.syncUpdate()

    >>> browser = setupBrowser(auth='Basic test@canonical.com:test')
    >>> browser.open('http://launchpad.dev/~landscape-developers/+addmember')
    >>> browser.getControl('New member').value = 'ubuntu-translators'
    >>> browser.getControl('Add Member').click()

    >>> for tag in find_tags_by_class(browser.contents, 'message'):
    ...     print tag.renderContents()
    There is 1 error.
    You can't add a team that doesn't have any active members.


Avoiding cycles in teams
------------------------

If two teams invite each other to join, the first one can accept the
invitation but then attempting to accept the second invitation fails
with a cyclical team membership error, which is reported to the team
admin.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> person_set = getUtility(IPersonSet)
    >>> login(ANONYMOUS)
    >>> stevea = person_set.getByName('stevea')
    >>> team_a = factory.makeTeam(name="team-a", displayname="A Team", owner=stevea)

    >>> jdub = person_set.getByName('jdub')
    >>> team_b = factory.makeTeam(name="team-b", displayname="B Team", owner=jdub)
    >>> logout()

    >>> stevea_browser = setupBrowser(
    ...     auth='Basic steve.alexander@ubuntulinux.com:test')
    >>> jdub_browser = setupBrowser(
    ...     auth='Basic jeff.waugh@ubuntulinux.com:jdub')

Each team invites the other to become a member.

    >>> stevea_browser.open('http://launchpad.dev/~team-a/+addmember')
    >>> stevea_browser.getControl('New member').value = 'team-b'
    >>> stevea_browser.getControl('Add Member').click()
    >>> for message in get_feedback_messages(stevea_browser.contents):
    ...     print message
    B Team (team-b) has been invited to join this team.

    >>> jdub_browser.open('http://launchpad.dev/~team-b/+addmember')
    >>> jdub_browser.getControl('New member').value = 'team-a'
    >>> jdub_browser.getControl('Add Member').click()
    >>> for message in get_feedback_messages(jdub_browser.contents):
    ...     print message
    A Team (team-a) has been invited to join this team.

    >>> stevea_browser.open('http://launchpad.dev/~team-a/+invitation/team-b')
    >>> stevea_browser.getControl('Accept').click()
    >>> for message in get_feedback_messages(stevea_browser.contents):
    ...     print message
    This team is now a member of B Team.

    >>> jdub_browser.open('http://launchpad.dev/~team-b/+invitation/team-a')
    >>> jdub_browser.getControl('Accept').click()
    >>> for message in get_feedback_messages(jdub_browser.contents):
    ...     print message
    This team may not be added to A Team because it is a member of B Team.
