= Bug Links =

Questions can be linked to bugs. A user should do that when the problem
exposed in the question is related to a bug report.

== Adding Links ==

Question #2 in firefox is about a user which has trouble displaying the
SVG demo on the W3C site. There is an existing Launchpad bug report (#1)
which describes that problem. A user that wants to document that
relationship goes to the question and click the 'Link Existing Bug'.

This link is only available to registered user:

    >>> anon_browser.open(
    ...     'http://launchpad.dev/firefox/+question/2')
    >>> anon_browser.getLink(url='+linkbug').click()
    Traceback (most recent call last):
      ...
    Unauthorized: ...

    >>> user_browser.open(
    ...     'http://launchpad.dev/firefox/+question/2')
    >>> user_browser.getLink('Link existing bug').click()

To link the bug, the user enters the bug ID and clicks the 'Add'
button.

    >>> user_browser.getControl('Bug ID').value = '111'
    >>> user_browser.getControl('Link').click()

When the user makes a mistake and uses an invalid bug number, an error
message is displayed:

    >>> soup = find_main_content(user_browser.contents)
    >>> soup.first('div', 'message')
    <div class="message">Not a valid bug number or nickname.</div>

The user is offered a link to search for bug in case he doesn't know the
bug number.

    >>> user_browser.getLink('Bug listing').click()
    >>> user_browser.url
    '.../firefox/+bugs'

    >>> user_browser.goBack(1)

The user now enters the correct bug number and after clicking the
'Link' button, the bug will now be listed under the 'Related bugs'
portlet:

    >>> user_browser.getControl('Bug ID').value = '1'
    >>> user_browser.getControl('Link').click()
    >>> soup = find_portlet(user_browser.contents, 'Related bugs')
    >>> soup.first('li', 'bug-row')
    <li class="bug-row">
      <a class="sprite bug" href=".../bugs/1">Bug #1: Firefox does not support SVG</a>
    </li>

A notification is also displayed.

    >>> for message in get_feedback_messages(user_browser.contents):
    ...     print message
    Added link to bug #1: ...Firefox does not support SVG...


== Removing Links ==

To remove bug links, the user uses the 'Remove Bug Link' action.

    >>> user_browser.getLink('Remove bug link').click()
    >>> user_browser.title
    'Remove bug links from question #2'

The list of linked bugs is displayed. The user selects the link to
remove and clicks the 'Remove' button.

    >>> user_browser.getControl('#1: Firefox').selected = True
    >>> user_browser.getControl('Remove').click()

The user is redirected to the question page and a confirmation
message is displayed:

    >>> user_browser.url
    '.../firefox/+question/2'
    >>> soup = find_main_content(user_browser.contents)
    >>> soup.first('div', 'informational message')
    <div class="informational message">Removed link to bug #...</div>
    >>> soup.first('div', {'id': 'portlet-related-bugs'}) is None
    True

== Link to Private Bugs ==

    # Let's mark bug #6 as private and only accessible by an
    # administrator.
    # XXX flacoste 2006-08-22 bug=57307:
    # This should use a private bug in our sample data.
    >>> from zope.component import getUtility
    >>> from canonical.launchpad.ftests import login, logout
    >>> from canonical.launchpad.interfaces import IBugSet, ILaunchBag
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> login('foo.bar@canonical.com')
    >>> private_bug = getUtility(IBugSet).get(6)
    >>> private_bug.setPrivate(True, getUtility(ILaunchBag).user)
    True
    >>> flush_database_updates()
    >>> logout()

A regular user shouldn't be able to link to a private bug he doesn't
have access to:

    # We use the no-priv user here because sample person is subscribed
    # and thus has access to the private bug.
    >>> browser.addHeader('Authorization', 'Basic no-priv@canonical.com:test')
    >>> browser.open('http://launchpad.dev/firefox/+question/2')
    >>> browser.getLink('Link existing bug').click()
    >>> browser.getControl('Bug ID').value = '6'
    >>> browser.getControl('Link').click()
    >>> for tag in find_tags_by_class(browser.contents, 'message'):
    ...     print tag.renderContents()
    There is 1 error.
    You are not allowed to link to private bug #6.

An administrator (or another user having access to the bug) should be
able to link to that bug.

    >>> admin_browser.open(
    ...     'http://launchpad.dev/firefox/+question/2')
    >>> admin_browser.getLink('Link existing bug').click()
    >>> admin_browser.getControl('Bug ID').value = '6'
    >>> admin_browser.getControl('Link').click()
    >>> soup = find_portlet(admin_browser.contents, 'Related bugs')
    >>> soup.first('li', 'bug-row')
    <li class="bug-row">
      <a class="sprite bug" href=".../bugs/6">Bug #6: Firefox crashes when Save As dialog
        for a nonexistent window is closed</a>
    </li>

An anonymous visitor (or a user that doesn't have access to the bug)
will only see that a private bug is linked.

    >>> anon_browser.open(
    ...     'http://launchpad.dev/firefox/+question/2')
    >>> soup = find_portlet(anon_browser.contents, 'Related bugs')
    >>> soup.first('li', 'bug-row')
    <li class="bug-row">
      <a class="sprite bug" href=".../bugs/6">Bug #6: private bug</a>
    </li>

Only the administrator will be able to unlink the bug.

    >>> browser.open('http://launchpad.dev/firefox/+question/2')
    >>> browser.getLink('Remove bug link').click()
    >>> soup = find_main_content(browser.contents)
    >>> for message in get_feedback_messages(browser.contents):
    ...     print message
    There are no links that you are allowed to remove.

    >>> admin_browser.getLink('Remove bug link').click()
    >>> admin_browser.getControl('#6: Firefox').selected = True
    >>> admin_browser.getControl('Remove').click()

