# Copyright 2009-2010 Canonical Ltd.  This software is licensed under the
# GNU Affero General Public License version 3 (see the file LICENSE).

# pylint: disable-msg=E0211,E0213

from zope.interface import Interface, Attribute
from zope.schema import Bool, Choice, Int, List, Object, Text
from lazr.enum import EnumeratedType, Item

from canonical.launchpad import _
from lp.translations.interfaces.pomsgid import IPOMsgID

__metaclass__ = type

__all__ = [
    'IPOTMsgSet',
    'BrokenTextError',
    'POTMsgSetInIncompatibleTemplatesError',
    'TranslationCreditsType',
    ]


class TranslationCreditsType(EnumeratedType):
    """Identify a POTMsgSet as translation credits."""

    NOT_CREDITS = Item("""
        Not a translation credits message

        This is a standard msgid and not translation credits.
        """)

    GNOME = Item("""
        Gnome credits message

        How they do them in Gnome.
        """)

    KDE_EMAILS = Item("""
        KDE emails credits message

        How they do them in KDE for translator emails.
        """)

    KDE_NAMES = Item("""
        KDE names credits message

        How they do them in KDE for translator names.
        """)


class BrokenTextError(ValueError):
    """Exception raised when we detect values on a text that aren't valid."""

class POTMsgSetInIncompatibleTemplatesError(Exception):
    """Raised when a POTMsgSet appears in multiple incompatible templates.

    Two PO templates are incompatible if one uses English strings for msgids,
    and another doesn't (i.e. it uses English translation instead).
    """


class IPOTMsgSet(Interface):
    """A collection of message IDs."""

    id = Int(
        title=_("The identifier of this POTMsgSet."),
        readonly=True, required=True)

    context = Text(
        title=u"String used to disambiguate messages with identical msgids.")

    msgid_singular = Object(
        title=_("The singular msgid for this message."),
        description=_("""
            A message ID along with the context uniquely identifies the
            template message.
            """), readonly=True, required=True, schema=IPOMsgID)

    msgid_plural = Object(
        title=u"The plural msgid for this message.",
        description=(u"Provides a plural msgid for the message. "
                     u"If it's not a plural form message, this value"
                     u"should be None."),
        required=True,
        readonly=True,
        schema=IPOMsgID)

    sequence = Attribute("The ordering of this set within its file.")

    potemplate = Attribute("The template this set is associated with.")

    commenttext = Attribute("The manual comments this set has.")

    filereferences = Attribute("The files where this set appears.")

    sourcecomment = Attribute("The source code comments this set has.")

    flagscomment = Attribute("The flags this set has.")

    flags = Attribute("List of flags that apply to this message.")

    singular_text = Text(
        title=_("The singular text for this message."), readonly=True)

    plural_text = Text(
        title=_("The plural text for this message or None."), readonly=True)

    uses_english_msgids = Bool(
        title=_("Uses English strings as msgids"), readonly=True,
        description=_("""
            Some formats, such as Mozilla's XPI, use symbolic msgids where
            gettext uses the original English strings to identify messages.
            """))

    credits_message_ids = List(
        title=_("List of possible msgids for translation credits"),
        readonly=True,
        description=_("""
            This class attribute is intended to be used to construct database
            queries that search for credits messages.
            """))

    def getCurrentDummyTranslationMessage(potemplate, language):
        """Return a DummyTranslationMessage for this message language.

        :param potemplate: PO template you want a translation message for.
        :param language: language we want a dummy translations for.

        If a TranslationMessage for this language already exists,
        an exception is raised.
        """

    def getCurrentTranslationMessage(potemplate, language, variant=None):
        """Returns a TranslationMessage marked as being currently used.

        Diverged messages are preferred.
        """

    def getImportedTranslationMessage(potemplate, language, variant=None):
        """Returns a TranslationMessage as imported from the package.

        Diverged messages are preferred.
        """

    def getSharedTranslationMessage(language, variant=None):
        """Returns a shared TranslationMessage."""

    def getLocalTranslationMessages(potemplate, language,
                                    include_dismissed=False,
                                    include_unreviewed=True):
        """Return all local unused translation messages for the POTMsgSet.

        Unused are those which are not current or imported, and local are
        those which are directly attached to this POTMsgSet.

        :param language: language we want translations for.
        :param include_dismissed: Also return those translation messages
          that have a creation date older than the review date of the current
          message (== have been dismissed).
        :param include_unreviewed: Also return those translation messages
          that have a creation date newer than the review date of the current
          message (== that are unreviewed). This is the default.
        """

    def getExternallyUsedTranslationMessages(language):
        """Find externally used translations for the same message.

        This is used to find suggestions for translating this
        `POTMsgSet` that are actually used (i.e. current or imported) in
        other templates.

        The suggestions are read-only; they come from the slave store.

        :param language: language we want translations for.
        """

    def getExternallySuggestedTranslationMessages(language):
        """Find externally suggested translations for the same message.

        This is used to find suggestions for translating this
        `POTMsgSet` that were entered in another context, but for the
        same English text, and are not in actual use.

        The suggestions are read-only; they come from the slave store.

        :param language: language we want translations for.
        """

    def hasTranslationChangedInLaunchpad(potemplate, language):
        """Whether an imported translation differs from the current one.

        :param potemplate: potemplate we are asking about.
        :param language: language for which translations we are asking about.

        There has to be an imported translation: if there isn't, this is
        not a 'changed' translation, just a 'new' translation in Launchpad.
        """

    def isTranslationNewerThan(pofile, timestamp):
        """Whether a current translation is newer than the `timestamp`.

        :param pofile: translation file for which translations we are asking
            about.
        :param timestamp: a timestamp we are comparing to.

        Returns True if there is a current and newer translation, and False
        otherwise.
        """

    def updateTranslation(pofile, submitter, new_translations,
                          is_current_upstream, lock_timestamp,
                          force_shared=False, force_diverged=False,
                          force_suggestion=False, ignore_errors=False,
                          force_edition_rights=False, allow_credits=False):
        """Update or create a translation message using `new_translations`.

        This method is Launchpad Translations's sliderule: it does
        everything, nobody fully understands it all, and we intend to
        replace it with a range of less flexible tools.

        :param pofile: a `POFile` to add `new_translations` to.
        :param submitter: author of the translations.
        :param new_translations: a dictionary of plural forms, with the
            integer plural form number as the key and the translation as the
            value.
        :param is_current_upstream: indicates whether this update is
            imported from a packaged po file.
        :param lock_timestamp: The timestamp when we checked the values we
            want to update.
        :param force_suggestion: Whether to force translation to be
            a suggestion, even if submitted by an editor.
        :param ignore_errors: A flag that controls whether the translations
            should be stored even when an error is detected.
        :param force_edition_rights: A flag that 'forces' handling this
            submission as coming from an editor, even if `submitter` is not.
        :param allow_credits: Override the protection of translation credits
            message.

        If there is an error with the translations and ignore_errors is not
        True or it's not a fuzzy submit, raises GettextValidationError.

        :return: a modified or newly created translation message; or None if
            no message is to be updated.  This can happen when updating a
            translation credits message without the is_current_upstream
            parameter set.
        """

    def submitSuggestion(pofile, submitter, new_translations):
        """Submit a suggested translation for this message.

        If an identical message is already present, it will be returned
        (and it is not changed).  Otherwise, a new one is created and
        returned.  Suggestions for translation credits messages are
        ignored, and None is returned in that case.
        """

    def dismissAllSuggestions(pofile, reviewer, lock_timestamp):
        """Dismiss all suggestions for the given pofile.

        :param pofile: a `POFile` to dismiss suggestions from.
        :param reviewer: the person that is doing the dismissal.
        :param lock_timestamp: the timestamp when we checked the values we
            want to update.

        If a translation conflict is detected, TranslationConflict is raised.
        """

    def setCurrentTranslation(pofile, submitter, translations, origin,
                              translation_side, share_with_other_side=False):
        """Set the message's translation in Ubuntu, or upstream, or both.

        :param pofile: `POFile` you're setting translations in.  Other
            `POFiles` that share translations with this one may also be
            affected.
        :param submitter: `Person` who is setting these translations.
        :param translations: a dict mapping plural-form numbers to the
            translated string for that form.
        :param origin: A `RosettaTranslationOrigin`.
        :param translation_side: The `TranslationSide` that this
            translation is for (Ubuntu or upstream).
        :param share_with_other_side: When sharing this translation,
            share it with the other `TranslationSide` as well.
        """

    def resetCurrentTranslation(pofile, lock_timestamp):
        """Reset the currently used translation.

        This will set the "is_current_ubuntu" attribute to False and if the
        message is diverged, will try to converge it.
        :param pofile: a `POFile` to dismiss suggestions from.
        :param lock_timestamp: the timestamp when we checked the values we
            want to update.

        If a translation conflict is detected, TranslationConflict is raised.
        """

    def clearCurrentTranslation(pofile, share_with_other_side=False):
        """Set the current message in `pofile` to be untranslated.

        If the current message is shared, this will also clear it in
        other translations that share the same message.

        :param pofile: The translation file that should have its current
            translation for this `POTMsgSet` cleared.  If the message is
            shared, this may not be the only translation file that will
            be affected.
        :param share_with_other_side: If the current message is also
            current on the other side (i.e. the Ubuntu side if working
            upstream, or vice versa) then should it be cleared there as
            well?
        """

    def applySanityFixes(unicode_text):
        """Return 'unicode_text' or None after doing some sanitization.

        The text is checked against the msgid using the following filters:

          self.convertDotToSpace
          self.normalizeWhitespaces
          self.normalizeNewLines

        If the resulting string after these operations is an empty string,
        it returns None.

        :param unicode_text: A unicode text that needs to be checked.
        """

    def convertDotToSpace(unicode_text):
        """Return 'unicode_text' with the u'\u2022' char exchanged with a
        normal space.

        If the self.singular_text contains that character, 'unicode_text' is
        returned without changes as it's a valid char instead of our way to
        represent a normal space to the user.
        """

    def normalizeWhitespaces(unicode_text):
        """Return 'unicode_text' with the same trailing and leading
        whitespaces that self.singular_text has.

        If 'unicode_text' has only whitespaces but self.singular_text has
        other characters, the empty string (u'') is returned to note it as an
        untranslated string.
        """

    def normalizeNewLines(unicode_text):
        """Return 'unicode_text' with new lines chars in sync with the msgid.
        """


    hide_translations_from_anonymous = Attribute(
        """Whether the translations for this message should be hidden.

        Messages that are likely to contain email addresses
        are shown only to logged-in users, and not to anonymous users.
        """)

    is_translation_credit = Attribute(
        """Whether this is a message set for crediting translators.""")

    translation_credits_type = Choice(
        title=u"The type of translation credit of this message.",
        required=True,
        vocabulary = TranslationCreditsType)

    def makeHTMLID(suffix=None):
        """Unique name for this `POTMsgSet` for use in HTML element ids.

        The name is an underscore-separated sequence of:
         * the string 'msgset'
         * unpadded, numerical `id`
         * optional caller-supplied suffix.

        :param suffix: an optional suffix to be appended.  Must be suitable
            for use in HTML element ids.
        """

    def updatePluralForm(plural_form_text):
        """Update plural form text for this message.

        :param plural_form_text: Unicode string representing the plural form
            we want to store or None to unset current plural form.
        """

    def getSequence(potemplate):
        """Return the sequence number for this potmsgset in potemplate.

        :param potemplate: `IPOTemplate` where the sequence number applies.
        """

    def setSequence(potemplate, sequence):
        """Set the sequence number for this potmsgset in potemplate.

        :param potemplate: `IPOTemplate` where the sequence number applies.
        :param sequence: The sequence number of this `IPOTMsgSet` in the given
            `IPOTemplate`.
        """

    def setTranslationCreditsToTranslated(pofile):
        """Set the current translation for this translation credits message.

        Sets a fixed dummy string as the current translation, if this is a
        translation credits message, so that these get counted as
        'translated', too.
        Credits messages that already have a translation, imported messages
        and normal messages are left untouched.
        :param pofile: the POFile to set this translation in.
        """

    def getAllTranslationMessages():
        """Retrieve all `TranslationMessage`s for this `POTMsgSet`."""

    def getAllTranslationTemplateItems():
        """Retrieve all `TranslationTemplateItem`s for this `POTMsgSet`."""
