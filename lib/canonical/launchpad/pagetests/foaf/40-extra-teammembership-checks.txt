Start out by verifying the members page is sane.

  >>> browser.open('http://localhost/people/ubuntu-team/+members')
  >>> 'Ubuntu Team' in browser.contents
  True
  >>> 'Mark Shuttleworth' in browser.contents
  True

Let's take a look at Colin's subscription page. Colin is an
administrator and his subscription never expires.

  >>> browser.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
  >>> browser.reload()
  >>> url = 'http://localhost/people/ubuntu-team/+member/kamion'
  >>> browser.getLink(url=url).click()

  >>> "Colin Watson's membership status in Ubuntu Team" in browser.contents
  True
  >>> "Active member" in browser.contents
  True
  >>> browser.getControl(name='admin').value
  ['yes']

  >>> browser.getControl(name='expires').value
  ['never'] 

Post an incomplete date and remove his administrator status.

  >>> browser.getControl(name='admin').value = ['no']
  >>> browser.getControl(name='expires').value = ['date']
  >>> browser.getControl(name='day').value = ['16']
  >>> browser.getControl(name='month').value = ['0']
  >>> browser.getControl(name='year').value = ['0']
  >>> browser.getControl('Change').click()

We get a nice error message

  >>> 'incomplete date provided.' in browser.contents
  True

Give up on change, nothing should have changed with Colin:

  >>> from zope.component import getUtility
  >>> from canonical.launchpad.interfaces import (
  ...     IPersonSet, ITeamMembershipSet)
  >>> from canonical.launchpad.ftests import login, logout, ANONYMOUS
  >>> login(ANONYMOUS)
  >>> personset = getUtility(IPersonSet)
  >>> teammembershipset = getUtility(ITeamMembershipSet)
  >>> ubuntu_team = personset.getByName('ubuntu-team')
  >>> kamion = personset.getByName('kamion')
  >>> kamion_membership = teammembershipset.getByPersonAndTeam(
  ...     kamion, ubuntu_team)
  >>> kamion_membership.is_admin
  True
  >>> print kamion_membership.dateexpires
  None
  >>> logout()


Now revoke Colin's administrator status and make him expire in November
next year -- successfully.

  >>> from datetime import datetime
  >>> next_year = datetime.utcnow().year + 1

  >>> browser.getControl(name='admin').value = ['no']
  >>> browser.getControl(name='expires').value = ['date']
  >>> browser.getControl(name='day').value = ['14']
  >>> browser.getControl(name='month').value = ['11']
  >>> browser.getControl(name='year').value = [str(next_year)]
  >>> browser.getControl(name='comment').value = 'Arfie'
  >>> browser.getControl('Change').click()

We're redirected to the +members page

  >>> browser.url
  'http://localhost/people/ubuntu-team/+members'

  >>> login(ANONYMOUS)
  >>> kamion_membership = teammembershipset.getByPersonAndTeam(
  ...     kamion, ubuntu_team)
  >>> kamion_membership.is_admin
  False 
  >>> expire_date = datetime(next_year, 11, 14)
  >>> kamion_membership.dateexpires.date() == expire_date.date()
  True
  >>> logout()

Now check Jeff's subscription. Jeff's also an administrator and his
subscription never expires, but he can demote himself.

  >>> from zope.testbrowser.testing import Browser
  >>> jdub_browser = Browser()
  >>> jdub_browser.handleErrors = False
  >>> jdub_browser.addHeader(
  ...     'Authorization', 'Basic jeff.waugh@ubuntulinux.com:jdub')
  >>> jdub_browser.open('http://localhost/people/ubuntu-team/+members')

  >>> url = 'http://localhost/people/ubuntu-team/+member/jdub' 
  >>> jdub_browser.getLink(url=url).click()

  >>> "Jeff Waugh's membership status in Ubuntu Team" in jdub_browser.contents
  True
  >>> "Active member" in jdub_browser.contents
  True

  >>> jdub_browser.getControl(name='admin').value = ['no']
  >>> jdub_browser.getControl('Change').click()

  >>> jdub_browser.url
  'http://localhost/people/ubuntu-team/+members'

  >>> login(ANONYMOUS)
  >>> jdub = personset.getByName('jdub')
  >>> jdub_membership = teammembershipset.getByPersonAndTeam(
  ...     jdub, ubuntu_team)
  >>> jdub_membership.is_admin
  False
  >>> logout()

Sample person had his membership declined to the guadamen group. Test
that the page works and that foo.bar@canonical can access it.

  >>> browser.open('http://localhost/people/guadamen/+member/name12/')

  >>> 'Declined member' in browser.contents
  True

Dave Miller is a proposed member in Ubuntu Gnome Team.
If two people try to accept him as a member at the same time, the first one
should succeed and the second one receive a nice error message.

  >>> browser.open('http://localhost/people/name18/+members')
  >>> url = 'http://localhost/people/name18/+member/justdave'
  >>> browser.getLink(url=url).click()

  >>> second_browser = Browser()
  >>> second_browser.handleErrors = False

  >>> second_browser.addHeader(
  ...     'Authorization', 'Basic foo.bar@canonical.com:test')
  >>> second_browser.open(url)

Approve the membership in the first browser.

  >>> browser.getControl('Approve').click()

We're redirected to the members page.

  >>> browser.url
  'http://localhost/people/name18/+members'

  >>> login(ANONYMOUS)
  >>> dave = personset.getByName('justdave')
  >>> ubuntu_gnome_team = personset.getByName('name18')
  >>> dave_membership = teammembershipset.getByPersonAndTeam(
  ...     dave, ubuntu_gnome_team)
  >>> dave_membership.statusname
  'Approved'
  >>> logout()


But in the second browser with the stale data we get an error message:

  >>> second_browser.getControl('Approve').click()
  >>> message = (
  ...     'The membership request for Dave Miller has already been processed')
  >>> message in second_browser.contents
  True
