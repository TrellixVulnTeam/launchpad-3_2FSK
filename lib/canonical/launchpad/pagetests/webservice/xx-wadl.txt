= Launchpad's WADL caching =

Because Launchpad's main WADL file is so big, we cache it internally.
Because it only changes when the Launchpad software changes, it is
cached to a file.  Right now, the Launchpad webservice serves a
special test file (canonical/launchpad/apidoc/wadl-testrunner.xml)
when a client asks for the big WADL definition.  It was loaded on
module import using the canonical.config.config.instance_name, so a
development instance will use the file
canonical/launchpad/apidoc/wadl-development.xml.

    >>> test_wadl = webservice.get(
    ...     '/', 'application/vd.sun.wadl+xml').getBody()
    >>> print test_wadl
    <?xml version="1.0"?>
    <wadl:application xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                      xmlns="http://research.sun.com/wadl/2006/10"
                      xmlns:wadl="http://research.sun.com/wadl/2006/10"
                      xsi:schemaLocation="http://research.sun.com/wadl/2006/10/wadl.xsd">
    <BLANKLINE>
      <!--This file is for testing purposes only.  See
          canonical/launcpad/pagetests/webservice/xx-wadl.txt -->
    <BLANKLINE>
    </wadl:application>
    <BLANKLINE>

Let's look at the real contents, though.  To do this, we need to do
what utilities/create-lp-wadl.py does: clear out the cache on the
class.

    >>> from canonical.launchpad.systemhomes import WebServiceApplication
    >>> WebServiceApplication.cached_wadl = None

    >>> wadl = webservice.get(
    ...     '/', 'application/vd.sun.wadl+xml').getBody()
    >>> wadl = wadl.decode('UTF-8')

The real file is much bigger than the test file.

    >>> len(wadl) > len(test_wadl)
    True

The new output is now cached on the WebServiceApplication class.

    >>> WebServiceApplication.cached_wadl == wadl
    True

We don't need the cache anymore, so we'll reinstate the testing
version. This way, other tests will have a clean slate.

    >>> WebServiceApplication.cached_wadl = test_wadl

Like all lazr.restful applications, Launchpad's web service generates
valid WADL.

    >>> from canonical.lazr.rest.resource import WADL_SCHEMA_FILE
    >>> from canonical.lazr.xml import XMLValidator
    >>> wadl_schema = XMLValidator(WADL_SCHEMA_FILE)

    # We need to replace the nbsp entity, because the validator
    # doesn't support embedded definition.
    >>> wadl_schema.validate(
    ...     wadl.replace('&nbsp;', '&#160;').encode('UTF-8'))
    True
