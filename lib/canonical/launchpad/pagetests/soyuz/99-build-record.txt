
Presenting Build Record details:

  >>> from zope.testbrowser.testing import Browser

  >>> anon_browser.open("http://localhost/+builds/+build/17")
  >>> anon_browser.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...pmount...
  ...0.1-1...
  ...ubuntu...
  ...breezy-autotest...
  ...i386...
  ...Failed to build...
  ...2005-10-01 00:00:00 UTC...
  ...2005-10-02 00:00:01 UTC...'

With anonymous access, Retry Build link should not be there

  >>> anon_browser.getLink("Retry Build")
  Traceback (most recent call last):
  ...
  LinkNotFoundError

...and if we go directly to the page, no dice

  >>> anon_browser.open("http://localhost/+builds/+build/17/+retry")
  Traceback (most recent call last):
  ...
  Unauthorized: ...

Let's log in and the link should appear:

  >>> admin_browser.open("http://localhost/+builds/+build/17")
  >>> admin_browser.getLink("Retry Build").click()
  >>> admin_browser.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Retry Build...'

We'll also set up a second browser pointing at this page, for later.

  >>> admin_browser_2 = Browser()
  >>> admin_browser_2.addHeader("Authorization", "Basic foo.bar@canonical.com:test")
  >>> admin_browser_2.open("http://localhost/+builds/+build/17")
  >>> admin_browser_2.getLink("Retry Build").click()

Performing "Retry Build" with the first browser

  >>> admin_browser.getControl("Retry Build").click()
  >>> admin_browser.contents
  '...Build record active...'

Now it's active again, the retry button and the link to the retry page
are gone.

  >>> admin_browser.getControl("Retry Build")
  Traceback (most recent call last):
  ...
  LookupError: label 'Retry Build'

  >>> admin_browser.getLink("Retry Build")
  Traceback (most recent call last):
  ...
  LinkNotFoundError

The second browser has old content, so still has a retry build button.
Clicking this should give a warning.

  >>> admin_browser_2.getControl("Retry Build").click()
  >>> admin_browser_2.contents
  '...i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Build can not be retried...'

Build rescoring feature (fixed bug #44227, we create build records
when retrying a build, so there is not life-cycle for a pending build
w/o build record anymore.)

  >>> admin_browser.getLink("Rescore Build").click()
  >>> admin_browser.getControl(name="SCORE").value = '100'
  >>> admin_browser.getControl("Update").click()
  >>> admin_browser.contents
  '...Rescore i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...Build Record rescored to 100...'

it also checks input data sanity (bug # 44240):

  >>> admin_browser.getControl(name="SCORE").value = 'foo'
  >>> admin_browser.getControl("Update").click()
  >>> admin_browser.contents
  '...Rescore i386 build of pmount 0.1-1 in ubuntu breezy-autotest...
  ...priority must be an integer not "foo"...'


Also handles attempts to rescore a build in the wrong state:

  >>> print http(r"""
  ... POST /+builds/+build/13/+rescore HTTP/1.1
  ... Authorization: Basic Y2FybG9zQGNhbm9uaWNhbC5jb206dGVzdA==
  ... Content-Length: 9
  ...
  ... RESCORE=6""")
  HTTP/1.1 200 Ok
  Content-Length: ...
  ...i386 build of netapplet 0.99.6-1 in ubuntu warty...
  ...Build can not be rescored...

Build record inserted by gina that has an unknown build record.

  >>> admin_browser.open("http://localhost/+builds/+build/10")
  >>> admin_browser.contents
  '...i386 build of cnews cr.g7-37 in ubuntu warty RELEASE...
  ...Successfully built...
  ...2006-01-27 02:00:00 SAST...
  ...Changesfile...not available...
  ...Build started...not available...
  ...Build finished...not available...
  ...Builder...not available...
  ...Build log...not available...'

Check if buildd-celebrity is working as expected, try to access protected
pages as cprov (launchpad-buildd-admins member). Not using the better login
method here, as don't know the password.

  >>> browser = Browser()
  >>> browser.handleErrors = False
  >>> browser.addHeader('Authorization',
  ...                   'Basic celso.providelo@canonical.com:cprov')

  >>> browser.open("http://localhost/+builds/+build/12")
  >>> browser.getLink("Retry Build").click()
  >>> browser.getControl("Retry Build").click()
  >>> browser.contents
  '...Build record active...'

Allow Re-score:

  >>> browser.getLink("Rescore Build").click()
  >>> browser.getControl(name="SCORE").value = '100'
  >>> browser.getControl("Update").click()
  >>> browser.contents
  '...Build Record rescored to 100...'

Allow new builder:

  >>> browser.open("http://localhost/+builds/+new")

Allow administration of a builder:

  >>> browser.open("http://localhost/+builds/bob/+admin")


Adding new builder still denied for non-members (Edgar, no membership):

  >>> browser = Browser()
  >>> browser.handleErrors = False
  >>> browser.addHeader(
  ...     "Authorization",
  ...     "Basic ZWRnYXJAbW9udGVwYXJhZGlzby5ocjplZGdhcg==")
  >>> browser.open("http://localhost:9000/+builds/+new")
  Traceback (most recent call last):
  ...
  Unauthorized: ...


Adding a new builder is also denied for anonymous:

  >>> anon_browser.open(
  ...     "http://localhost/+builds/+new")
  Traceback (most recent call last):
  ...
  Unauthorized: ...
