Uploading templates
===================

An upstream maintainer can use Rosetta to submit their initial template uploads.

    >>> from zope.testbrowser.testing import Browser

    >>> ff_owner = Browser()
    >>> ff_owner.addHeader('Authorization', 'Basic test@canonical.com:test')
    >>> ff_owner.open(
    ...     'http://launchpad.dev/products/firefox/1.0/+translations-upload')
    >>> 'Upload either a single file' in ff_owner.contents
    True

Time to do the upload...

    >>> import canonical.launchpad
    >>> import os.path
    >>> test_file_name = os.path.join(
    ...     os.path.dirname(canonical.launchpad.__file__),
    ...     'pagetests/standalone/xx-translation-import-queue.tar.gz')
    >>> tarball = open(test_file_name, "rb")
    >>> upload = ff_owner.getControl('File')
    >>> upload
    <Control name='file' type='file'>
    >>> upload.add_file(tarball, 'application/x-gzip', test_file_name)
    >>> ff_owner.getControl('Request Upload').click()
    >>> ff_owner.url
    'http://launchpad.dev/products/firefox/1.0/+translations-upload'
    >>> 'Upload new translation resources' in ff_owner.contents
    True
    >>> 'Thank you for your upload. 1 files from the tarball will be reviewed' in ff_owner.contents
    True

We check now that the upload is available from the translation import queue page
and the status is static as we are not logged in.


  >>> browser.open('http://launchpad.dev/rosetta/imports')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'
  >>> 'po/es.po' in browser.contents
  True
  >>> 'Mozilla Firefox Series' in browser.contents
  True
  >>> '<td>Needs Review</td>' in browser.contents
  True

As an admin, the same page should give us extra rights to edit imports and
thus, the link should appear.

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open('http://launchpad.dev/rosetta/imports')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'
  >>> 'po/es.po' in browser.contents
  True
  >>> 'Mozilla Firefox Series' in browser.contents
  True

Also, we get a set of different status and the default one...

  >>> 'Deleted' in browser.contents
  True
  >>> 'selected="yes" value="NEEDS_REVIEW"' in browser.contents
  True
  >>> 'Blocked' in browser.contents
  True
  >>> 'Edit' in browser.contents
  True
  >>> 'Sample Person' in browser.contents
  True

Now, we attach a new file to an already existing translation resource.

  >>> browser.open('http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload')
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload'
  >>> upload = browser.getControl('File')
  >>> upload
  <Control name='file' type='file'>
  >>> import cStringIO
  >>> upload.add_file(cStringIO.StringIO('# foo\n'), 'text/x-gettext-translation-template', 'evolution.pot')
  >>> browser.getControl('Upload').click()
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload'
  >>> 'Thank you for your upload. The file content will be imported soon' in browser.contents
  True
  >>> 'Upload a new version of Template "evolution-2.2" in Ubuntu Hoary package "evolution"' in browser.contents
  True

Now the import queue should have two entries with the last upload as the last
entry.

  >>> browser = Browser()
  >>> browser.open('http://launchpad.dev/rosetta/imports')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'
  >>> print browser.contents
  <...
  ...po/es.po...
  ...Mozilla Firefox Series...
  ...<td>Needs Review</td>...
  ...po/evolution-2.2.pot...
  ...evolution in Ubuntu Hoary...
  ...<td>Needs Review</td>...
  ...Carlos Perelló Marín...
  ...Template "evolution-2.2" in Ubuntu Hoary package "evolution"...

Get the edit form for the first entry.

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open('http://launchpad.dev/rosetta/imports/1')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports/1'
  >>> '<label for="field.potemplatename">Template Name</label>' in browser.contents
  True
  >>> '<input type="text" name="field.potemplatename" onkeypress=""' in browser.contents
  True
  >>> '<label for="field.path">Path</label>' in browser.contents
  True
  >>> '<label for="field.language">Language</label>' in browser.contents
  True
  >>> '<label for="field.variant">Variant</label>' in browser.contents
  True
  >>> 'Origin:' in browser.contents
  True
  >>> 'Mozilla Firefox Series' in browser.contents
  True
  >>> 'Path:' in browser.contents
  True
  >>> 'po/es.po' in browser.contents
  True
  >>> 'Uploader:' in browser.contents
  True
  >>> 'Sample Person' in browser.contents
  True
  >>> 'Waiting since:' in browser.contents
  True
  >>> 'Status:' in browser.contents
  True
  >>> 'Needs Review' in browser.contents
  True
  >>> 'Status changed on:' in browser.contents
  True

Is time to associate this import to the right IPOFile.

  >>> browser.getControl(name='field.potemplatename').value = 'pkgconf-mozilla'
  >>> browser.getControl(name='field.language').value = ['es']
  >>> browser.getControl(name='field.actions.attach').click()
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'

And we get that entry approved and with a place where it will be imported

  >>> print browser.contents
  <...
  ...po/es.po...
  ...Mozilla Firefox Series...
  ...Approved...
  ...Sample Person...
  ...Spanish (es) translation of pkgconf-mozilla in Mozilla Firefox 1.0...


Removing from the import queue
------------------------------

Check the removal feature. For that, the user carlos is going to attach a new
entry

  >>> browser.addHeader('Authorization', 'Basic carlos@canonical.com:test')
  >>> browser.open('http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload')
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload'
  >>> upload = browser.getControl(name='file')
  >>> upload.add_file(cStringIO.StringIO('#foo\n'), 'text/x-gettext-translation-template', 'evolution.pot')
  >>> browser.getControl(name='UPLOAD').click()
  >>> 'Thank you for your upload. The file content will be imported soon' in browser.contents
  True

Now, the No Privileges Person will try to remove it, but will fail. We are getting
an Internal Server Error and that's fine as the user will not get a UI to do this
POST, if we get this POST is because it was created by hand or not using our forms.

  >>> print http(r"""
  ... POST /rosetta/imports HTTP/1.1
  ... Authorization: Basic bm8tcHJpdkBjYW5vbmljYWwuY29tOnRlc3Q=
  ... Content-Length: 45
  ... Content-Type: application/x-www-form-urlencoded
  ... Referer: http://localhost:9000/rosetta/imports
  ... 
  ... status-2=DELETED&handle_queue=Change%20Status""")
  HTTP/1.1 500 Internal Server Error
  ...
  ...UnexpectedFormData...
  ...

But Jordi, a Rosetta expert, will be allowed to remove it.

  >>> browser.addHeader('Authorization', 'Basic jordi@canonical.com:test')
  >>> browser.open('http://launchpad.dev/rosetta/imports')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'
  >>> browser.getControl(name='status-2').value = ['DELETED']
  >>> browser.getControl(name='handle_queue').click()
  >>> browser.url
  'http://launchpad.dev/rosetta/imports/+index'

  >>> print browser.contents
  <...
  ...po/evolution-2.2.pot...
  ...evolution in Ubuntu Hoary...
  ...status-2...
  ...selected="yes" value="DELETED"...
  ...Carlos Perelló Marín...
  ...Template "evolution-2.2" in Ubuntu Hoary package "evolution"...

We need a new entry imported to check that a Launchpad admin is always allowed
to remove it.

  >>> browser.addHeader('Authorization', 'Basic jordi@canonical.com:test')
  >>> browser.open('http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload')
  >>> browser.url
  'http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload'
  >>> upload = browser.getControl(name='file')
  >>> upload.add_file(cStringIO.StringIO('#foo\n'), 'text/x-gettext-translation-template', 'evolution.pot')
  >>> browser.getControl(name='UPLOAD').click()
  >>> 'Thank you for your upload. The file content will be imported soon' in browser.contents
  True

Foo Bar Person is a launchpad admin and he's allowed to remove the entry.

  >>> browser.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
  >>> browser.open('http://launchpad.dev/rosetta/imports')
  >>> browser.url
  'http://launchpad.dev/rosetta/imports'
  >>> browser.getControl(name='status-2').value = ['DELETED']
  >>> browser.getControl(name='handle_queue').click()
  >>> browser.url
  'http://launchpad.dev/rosetta/imports/+index'

  >>> print browser.contents
  <...
  ...po/evolution-2.2.pot...
  ...evolution in Ubuntu Hoary...
  ...status-2...
  ...selected="yes" value="DELETED"...
  ...Carlos Perelló Marín...
  ...Template "evolution-2.2" in Ubuntu Hoary package "evolution"...

And finally, we do another import to be sure that the importer is also allowed
to remove their own imports.

    >>> a52_owner = Browser()
    >>> a52_owner.addHeader('Authorization', 'Basic foo.bar@canonical.com:test')
    >>> a52_owner.open(
    ...     'http://launchpad.dev/products/a52dec/trunk/+translations-upload')
    >>> upload = a52_owner.getControl('File')
    >>> upload
    <Control name='file' type='file'>
    >>> upload.add_file(
    ...     cStringIO.StringIO('#foo'), 'text/x-gettext-translation-template',
    ...     'a52dec.pot')
    >>> a52_owner.getControl('Request Upload').click()
    >>> a52_owner.url
    'http://launchpad.dev/products/a52dec/trunk/+translations-upload'
    >>> print a52_owner.contents
    <...
    ...Upload new translation resources...
    ...Thank you for your upload. The file content will be reviewed soon...

Now, removing it:

    >>> a52_owner.open('http://launchpad.dev/rosetta/imports')
    >>> menu = a52_owner.getControl(name='status-3')
    >>> menu.value
    ['NEEDS_REVIEW']
    >>> menu.value = ['DELETED']
    >>> a52_owner.getControl('Change Status').click()

The entry now appears deleted.

    >>> print a52_owner.contents
    <...
    ...a52dec.pot...
    ...a52dec Series...
    ...status-3...
    ...selected="yes" value="DELETED"...
    ...Foo Bar...


Corner cases
------------

Let's check tar.bz2 uploads. They work ;-)

    >>> evo_owner = ff_owner
    >>> evo_owner.open('http://launchpad.dev/products/evolution/trunk/+translations-upload')
    >>> test_file_name = os.path.join(
    ...     os.path.dirname(canonical.launchpad.__file__),
    ...     'pagetests/standalone/xx-translation-import-queue.tar.bz2')
    >>> tarball = open(test_file_name)

    >>> upload = evo_owner.getControl('File')
    >>> upload
    <Control name='file' type='file'>
    >>> upload.add_file(tarball, 'application/x-bzip', test_file_name)
    >>> evo_owner.getControl('Request Upload').click()
    >>> evo_owner.url
    'http://launchpad.dev/products/evolution/trunk/+translations-upload'
    >>> print evo_owner.contents
    <...
    ...Thank you for your upload. 2 files from the tarball will be reviewed...

Let's try breaking the form by not supplying a file object. It give us a
decent error message:

  >>> browser.addHeader('Authorization', 'Basic jordi@canonical.com:test')
  >>> browser.open('http://launchpad.dev/distros/ubuntu/hoary/+source/evolution/+pots/evolution-2.2/+upload')
  >>> browser.getControl(name='UPLOAD').click()
  >>> 'Your upload was ignored because you didn\'t select a file. Please select a file and try again.' in browser.contents
  True
