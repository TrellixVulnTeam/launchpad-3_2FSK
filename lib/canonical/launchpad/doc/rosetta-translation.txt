
Rosetta Translation Objects
===========================

This test demonstrates the complete hierarchy of Rosetta translation objects,
from POTemplate down to POTranslation.

Get a PO template.

    >>> from canonical.launchpad.database import POTemplate
    >>> template = POTemplate.get(1)
    >>> template.name == 'evolution-2.2'
    True

Check that the PO template has a certain message ID.

    >>> from canonical.launchpad.database import POMsgID
    >>> pomsgid = POMsgID.byMsgid('evolution addressbook')
    >>> template.hasMessageID(pomsgid)
    True

Get a Spanish PO file for this PO template

    >>> pofile = template.getPOFileByLang('es')

Get a translation for a particular message and check it has a translation.

    >>> potmsgset = template.getPOTMsgSetByMsgIDText(u'evolution addressbook')
    >>> spanish = pofile.language
    >>> translationmessage = potmsgset.getCurrentTranslationMessage(spanish)
    >>> translationmessage.translations
    [u'libreta de direcciones de Evolution']
    >>> translationmessage.is_imported
    True

Get a person to create a translation with.

    >>> from canonical.launchpad.database import Person
    >>> person = Person.get(1)
    >>> pofile.canEditTranslations(person)
    True

Add a translation.

    >>> translations = { 0: u'foo' }
    >>> import datetime
    >>> import pytz
    >>> UTC = pytz.timezone('UTC')
    >>> message = potmsgset.updateTranslation(
    ...     pofile, person, translations, is_fuzzy=False, is_imported=True,
    ...     lock_timestamp=datetime.datetime.now(UTC))
    >>> from canonical.database.sqlbase import flush_database_caches
    >>> flush_database_caches()

Check that this submission is now the active one for this msgset/pluralform

    >>> potmsgset.getCurrentTranslationMessage(spanish) == message
    True
    >>> message.is_current
    True
    >>> message.msgstr0.translation == u'foo'
    True

Check that this submission is the published one

    >>> potmsgset.getImportedTranslationMessage(spanish) == message
    True
    >>> message.is_imported
    True

Test the origin enum column.

    >>> from canonical.launchpad.interfaces import RosettaTranslationOrigin
    >>> message.origin == RosettaTranslationOrigin.SCM
    True

Get a list of the translations again to check the new one has been added.

    >>> message.translations
    [u'foo']

Now we want to test the interaction of the "published" translations with the
"active translations". There are several things we want to be able to test.
First, let's setup some useful variables.

    >>> Pa = Person.get(50)
    >>> Pb = Person.get(46)
    >>> Pc = Person.get(16)

Pa, Pb and Pc are three useful Person's.

Let's pretend we've seen a new translation in the published PO files for
this project from Pa.

    >>> translations = { 0: u'bar' }
    >>> imported_message = potmsgset.updateTranslation(
    ...     pofile, Pa, translations, is_fuzzy=False, is_imported=True,
    ...     lock_timestamp=datetime.datetime.now(UTC))
    >>> flush_database_caches()

Make sure that the new submission is in fact from Pa.

    >>> imported_message.submitter == Pa
    True

Now let's test that this has become both active and published

    >>> imported_message.msgstr0.translation == u'bar'
    True

    >>> potmsgset.getImportedTranslationMessage(spanish) == imported_message
    True

Excellent. This shows that the code to make a new published translation
active as soon as we see it is working.

Now, let's add a translation from Pb, through the web.

    >>> translations = { 0: u'baz' }
    >>> message = potmsgset.updateTranslation(
    ...     pofile, Pb, translations, is_fuzzy=False, is_imported=False,
    ...     lock_timestamp=datetime.datetime.now(UTC))
    >>> flush_database_caches()
    >>> web_submission = potmsgset.getCurrentTranslationMessage(spanish)

Make sure the new submission is from Pb.

    >>> web_submission.submitter == Pb
    True

This submission should now be active, but not published. When we get a new
translation through the web, this updates the active selection but not the
published selection.

    >>> web_submission.msgstr0.translation == u'baz'
    True

    >>> potmsgset.getImportedTranslationMessage(spanish) == web_submission
    False

In fact, the published submission should still be the original one, from Pa:

    >>> potmsgset.getImportedTranslationMessage(spanish) == imported_message
    True

And the lasttranslator for this pofile should be the one who submitted the
current translation.

    >>> pofile.lasttranslator == Pb
    True

Now, let's see what happens if Pc submits exactly the same translation that
Pb just did. We don't want to record this, because we have decided not to
record a new submission of the EXISTING active or published record. In other
words, if the current active translation is 'baz', and someone else comes
along and says it's 'baz', we don't record anything new.

    >>> translations = { 0: u'baz' }
    >>> dummy = potmsgset.updateTranslation(
    ...     pofile, Pc, translations, is_fuzzy=False, is_imported=False,
    ...     lock_timestamp=datetime.datetime.now(UTC))
    >>> repeat_submission = potmsgset.getCurrentTranslationMessage(spanish)

Since that is exactly what Pb already said, let's see that the submission we
got back was the one from Pb not a new one for Pc:

    >>> repeat_submission.submitter == Pb
    True

In fact, it should be the same as before:

    >>> repeat_submission == web_submission
    True

Now, let's test the NonEditorTranslations. These are translations submitted by
people who do not have editorial rights on the pofile. We generally accept
these but don't make them active.

Here is our NonEditor:

    >>> Pn = Person.get(51)
    >>> Pn.name
    u'kreutzm'

Testing NoneEditorTranslations

Let's see if there are any suggestions for this potmsgset. We are not
expecting any.

    >>> potmsgset.getNewSubmissions(spanish)
    []

Let's make a submission from Pn  without editorial permissions, to the same
msgset and plural form as above. First we will try and make it a published
submission, and we expect to get an assertion error because we expect never
to see a non-editor published submission.

    >>> translations = { 0: u'bong' }
    >>> dummy = potmsgset.updateTranslation(
    ...     pofile, Pn, translations, is_fuzzy=False, is_imported=True,
    ...     lock_timestamp=datetime.datetime.now(UTC))
    Traceback (most recent call last):
    ...
    AssertionError: published translations are ALWAYS from an editor

Now let's try again, this time we are not using a public API, but we need it
to test the code more easily:

    >>> is_fuzzy = False
    >>> plural_form = 0
    >>> noneditor_submission = potmsgset._makeSubmission(
    ...    Pn, u'bong', is_fuzzy, plural_form, published=False)

This submission should come from the new non-editor person:

    >>> noneditor_submission.person == Pn
    True

And the lasttranslator for this POFile should not change, as this submission
is not from an editor:

    >>> pofile.lasttranslator == web_submission.submitter
    True

And now we need to cheat, just a little bit.  We need to pretend that the
noneditor submission was made a few seconds AFTER the other one. Since both
use the DEFAULT datecreated, which is NOW, and both are inside the same
transaction, they APPEAR to have happened simultaneously.  We need to change
that, so we bump up the noneditor_submission.datecreated by a whole 2
seconds.

    >>> import datetime
    >>> noneditor_submission.datecreated += datetime.timedelta(0,2,0)
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> flush_database_updates()
    >>> from zope.security.proxy import removeSecurityProxy

Let's make sure:

    >>> (noneditor_submission.datecreated >
    ...  potmsgset.getCurrentTranslationMessage(spanish).date_created)
    True

This new submission should not be active:

    >>> (potmsgset.getCurrentTranslationMessage(spanish) ==
    ...  noneditor_submission)
    False

And it should definitely not be published:

    >>> (potmsgset.getImportedTranslationMessage(spanish) ==
    ...  noneditor_submission)
    False

However, given NonEditorTranslations, this should be available as
a suggested translation.

    >>> len(potmsgset.getNewSubmissions(spanish))
    1

