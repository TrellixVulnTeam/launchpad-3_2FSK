  'martin-pitt' doesn't have a preferred email address. He can't login without
  first validating his email address.


  >>> print http(r"""
  ... POST /+login HTTP/1.1
  ... Content-Length: ...
  ... Content-Type: application/x-www-form-urlencoded
  ... 
  ... loginpage_email=martin.pitt%40canonical.com&loginpage_password=zeca&loginpage_submit_login=Log+In""")
  HTTP/1.1 200 Ok
  Content-Length: ...
  Content-Type: text/html;charset=utf-8
  ...
  ...The email address 'martin.pitt@canonical.com', which you're...
  ...trying to use to login has not yet been validated to use in Launchpad...
  ...We sent an email to that address with instructions on how to confirm...
  ...that it belongs to you...
  ...


  When this happens, we automatically send an email to that address so the
  user can validate it and login.

  >>> import email, re
  >>> from canonical.launchpad.mail import stub
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()

  Check if the email was sent to the right address.

  >>> to_addrs
  ['martin.pitt@canonical.com']

  Get the token from the email address, in order to confirm the email address
  and then be able to login.

  >>> msg = email.message_from_string(raw_msg)
  >>> body = msg.get_payload()
  >>> link = re.findall(r'http.*/token/.*', body)[0]
  >>> token = re.sub(r'.*token/', '', link)
  >>> base_path = '/token/%s' % token

  >>> path = "%s/+validateemail" % base_path
  >>> print http(r"""
  ... GET %s HTTP/1.1
  ... """ % path)
  HTTP/1.1 200 Ok
  Content-Length: ...
  Content-Type: text/html;charset=utf-8
  ...
  ...Confirm e-mail address...martin.pitt@canonical.com...
  ...

  >>> print http(r"""
  ... POST %s HTTP/1.1
  ... Content-Type: application/x-www-form-urlencoded
  ... 
  ... password=zeca&SUBMIT_CHANGES=Submit""" % path)
  HTTP/1.1 303 See Other
  ...
  Location: http://localhost:9000/people/martin-pitt
  ...
  ...informational message">Email address successfully confirmed...
  ...

  This is the first email 'martin-pitt' is validating, it must be set as the
  preferred one.

  >>> from canonical.launchpad.database import EmailAddressSet
  >>> [to_addr] = to_addrs
  >>> e = EmailAddressSet().getByEmail(to_addr)
  >>> e.statusname
  'Preferred Email Address'

