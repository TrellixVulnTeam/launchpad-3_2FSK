POMsgSet View
=============

On this section, we are going to test the view class for an IPOMsgSet object.

    >>> from zope.component import getView
    >>> from canonical.launchpad.database import POMsgSet
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> from canonical.launchpad.webapp import canonical_url
    >>> from canonical.launchpad.interfaces import TranslationConstants

All the tests will be submitted as comming from Kurem, an editor for the POFile
that we are going to edit.

    >>> login('kurem@debian.cz')


No plural forms
---------------

We are going to see what happens if we get an entry for a language
without the plural form information.

    >>> pomsgset = POMsgSet.get(1)
    >>> pofile_tlh = pomsgset.pofile.potemplate.getDummyPOFile('tlh')
    >>> pomsgset_tlh = pofile_tlh.getPOMsgSet(u'evolution addressbook')
    >>> SERVER_URL = '/'.join([canonical_url(pomsgset), '+translate'])
    >>> request = LaunchpadTestRequest(SERVER_URL=SERVER_URL)
    >>> pomsgset_page_view = getView(pomsgset_tlh, "+translate", request)
    >>> pomsgset_page_view.initialize()

Here we can see that it's lacking that information.

    >>> pomsgset_page_view.context.pofile.language.pluralforms is None
    True

And the view class detects it correctly.

    >>> pomsgset_page_view.has_plural_form_information
    False


Basic checks
------------

Now, we will use a objects that we have in our database, instead of
dummy ones.

    >>> pomsgset_page_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_page_view.initialize()

We have the plural form information for this language.

    >>> pomsgset_page_view.context.pofile.language.pluralforms is not None
    True

And thus, the view class should know that it doesn't lacks the plural forms
information.

    >>> pomsgset_page_view.has_plural_form_information
    True

Also, we should get the timestamp when we started so we can detect changes
done when we started this request. We cannot check for its concrete value
or we could introduce a time bomb in the system so we check that it's not
None.

    >>> pomsgset_page_view.lock_timestamp is None
    False


The subview: POMsgSetView
-------------------------

For the next tests, we grab the subview which is what holds information
that pertains to the POMsgSet rendering itself:

    >>> subview = pomsgset_page_view.pomsgset_view
    >>> subview.initialize()

The request didn't get any argument, and because that, we should get the
default values for the alternative language.

    >>> subview.sec_lang is None
    True

We are at the beginning because this subview is being used for the first
item.

    >>> subview.context.potmsgset.sequence == 1
    True

It does not have a plural msgid.

    >>> subview.msgid_plural is None
    True

And thus, it only has one translation.

    >>> subview.pluralform_indices
    [0]

Which is the one we wanted.

    >>> subview.getActiveTranslation(0)
    u'libreta de direcciones de Evolution'

As we didn't submit the form, the getTranslation method will return None.

    >>> subview.getTranslation(0) is None
    True

If we request a plural form that is not valid, we get an AssertionError.

    >>> subview.getActiveTranslation(1)
    Traceback (most recent call last):
    ...
    AssertionError: There is no plural form #1 for Spanish (es) language

    >>> subview.getTranslation(1)
    Traceback (most recent call last):
    ...
    AssertionError: There is no plural form #1 for Spanish (es) language


Web presentation
----------------

Some characters are presented specially in the Web interface, and there are
functions to determine whether to advise translators about their presence.

First, msg_id_has_tab() determines whether a message set contains any tabs.

    >>> subview.msgid_has_tab
    False

When we change the set to include a tab character, the function detects it.

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Foo\tBar', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_tab
    True

Similarly, msgid_has_newline() determines whether a message contains newlines.

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Foo Bar', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_newline
    False

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Foo\nBar', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_newline
    True

And msgid_has_leading_or_trailing_space() determines ... well, you can guess.

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Foo Bar', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    False

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u' Leading space', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'  Leading space', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Trailing space ', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Trailing space  ', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Leading\n Space  ', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Trailing \nSpace  ', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> subview.context.potmsgset.makeMessageIDSighting(
    ...     u'Trailing \r\nspace', TranslationConstants.SINGULAR_FORM , update=True)
    >>> subview.msgid_has_leading_or_trailing_space
    True

    >>> import transaction
    >>> transaction.commit()


Submitting translations
-----------------------

It's time to check the submission of translations and the IPOFile statistics
update.

But first, let's see current values.

    >>> pomsgset = POMsgSet.get(1)
    >>> pomsgset.pofile.updateStatistics()
    (7, 0, 1)
    >>> pomsgset.pofile.currentCount()
    7
    >>> pomsgset.pofile.updatesCount()
    0
    >>> pomsgset.pofile.rosettaCount()
    1

Now we do the submit.

    >>> SERVER_URL = '/'.join([canonical_url(pomsgset), '+translate'])
    >>> request = LaunchpadTestRequest(
    ...     SERVER_URL=SERVER_URL,
    ...     form={
    ...         'alt': None,
    ...         'msgset_1': None,
    ...         'msgset_1_es_translation_0_new_checkbox': True,
    ...         'msgset_1_es_translation_0_new': 'Foo',
    ...         'submit_translations': 'Save &amp; Continue'})
    >>> request.method = 'POST'
    >>> pomsgset_page_view = getView(pomsgset, "+translate", request)

And when we initialise the view class, we detect that we missed the timestamp
that allow us to know whether we are working with latest submitted value or
someone updated the database while we were working on those translations.

    >>> pomsgset_page_view.initialize()
    Traceback (most recent call last):
    ...
    UnexpectedFormData: We didn't find the timestamp...

We do a new submit, but this time including a lock_timestamp field.

    >>> request = LaunchpadTestRequest(
    ...     SERVER_URL=SERVER_URL,
    ...     form={
    ...         'lock_timestamp': '2006-11-28T13:00:00+00:00',
    ...         'alt': None,
    ...         'msgset_1': None,
    ...         'msgset_1_es_translation_0_radiobutton':
    ...             'msgset_1_es_translation_0_new',
    ...         'msgset_1_es_translation_0_new': 'Foo',
    ...         'submit_translations': 'Save &amp; Continue'})
    >>> request.method = 'POST'
    >>> pomsgset_page_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_page_view.initialize()
    >>> from canonical.database.sqlbase import flush_database_updates
    >>> transaction.commit()
    >>> flush_database_updates()

This time we didn't get any problem with the submission, and we can see that
statistics were updated accordly.

    >>> pomsgset = POMsgSet.get(1)
    >>> pomsgset.pofile.currentCount()
    7
    >>> pomsgset.pofile.updatesCount()
    1
    >>> pomsgset.pofile.rosettaCount()
    1

Now, let's see how the system prevents a submission that has a timestamp older
than when last active translation was submitted.

    >>> from zope.app import datetimeutils
    >>> from canonical.launchpad.interfaces import TranslationConstants
    >>> old_timestamp_text = '2006-11-28T12:30:00+00:00'
    >>> old_timestamp = datetimeutils.parseDatetimetz(old_timestamp_text)

We can see here that translation in pomsgset is newer than old_timestamp.

    >>> pomsgset.isNewerThan(old_timestamp)
    True

And current value

    >>> pomsgset.active_texts
    [u'Foo']

We do the submission with that lock_timestamp.

    >>> request = LaunchpadTestRequest(
    ...     SERVER_URL=SERVER_URL,
    ...     form={
    ...         'lock_timestamp': old_timestamp_text,
    ...         'alt': None,
    ...         'msgset_1': None,
    ...         'msgset_1_es_translation_0_radiobutton':
    ...             'msgset_1_es_translation_0_new',
    ...         'msgset_1_es_translation_0_new': 'Foos',
    ...         'submit_translations': 'Save &amp; Continue'})
    >>> request.method = 'POST'
    >>> pomsgset_page_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_page_view.initialize()
    >>> for notification in pomsgset_page_view.request.notifications:
    ...     notification.message
    'There is an error in the translation you provided. Please correct it before continuing.'
    >>> pomsgset_page_view.error
    u'Somebody else changed this translation since you started. To avoid accidentally reverting work done by others, we added your translations as suggestions, so please review current values.'
    >>> transaction.commit()

This submission is not saved because there is another modification, this
means that timestamps remain unchanged.

    >>> pomsgset.isNewerThan(old_timestamp)
    True

And active text too

    >>> pomsgset.active_texts
    [u'Foo']


Bogus translation submission
----------------------------

What would happen if we get a submit for another msgset that isn't being
considered?

    >>> request = LaunchpadTestRequest(
    ...     SERVER_URL=SERVER_URL,
    ...     form={
    ...         'lock_timestamp': '2006-11-28 13:00:00 UTC',
    ...         'alt': None,
    ...         'msgset_2': None,
    ...         'msgset_2_es_translation_0_new': 'Foo',
    ...         'msgset_2_es_translation_0_new_checkbox': True,
    ...         'submit_translations': 'Save &amp; Continue'})
    >>> request.method = 'POST'
    >>> pomsgset_page_view = getView(pomsgset, "+translate", request)
    >>> pomsgset_page_view.initialize()

The list of translations parsed will be empty because the submission is
ignored:

    >>> pomsgset_page_view.form_posted_translations
    {}

And since this was a POST, we don't even build the subview:

    >>> pomsgset_page_view.pomsgset_view is None
    True

