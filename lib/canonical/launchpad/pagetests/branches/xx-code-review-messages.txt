= Code Review Messages =

Set up required objects

    >>> # We need to be admin to add a landing target to a random branch
    >>> login('foo.bar@canonical.com')
    >>> merge_proposal = factory.makeBranchMergeProposal()
    >>> merge_proposal_url = canonical_url(merge_proposal)
    >>> logout()

    >>> nopriv_browser = setupBrowser(auth="Basic no-priv@canonical.com:test")
    >>> nopriv_browser.open(merge_proposal_url)
    >>> nopriv_browser.getLink('Add comment').click()
    >>> nopriv_browser.getControl('Vote').displayValue = ['Approve']
    >>> nopriv_browser.getControl('Subject').value = 'my subject'
    >>> nopriv_browser.getControl('Comment').value = 'my body'
    >>> nopriv_browser.getControl('Add').click()
    >>> message_url = nopriv_browser.url

Now, open its home page.

    >>> anon_browser.open(message_url)
    >>> def print_tag(tag_id, browser=None):
    ...     if browser is None:
    ...         browser = anon_browser
    ...     tag = find_tag_by_id(browser.contents, tag_id)
    ...     print extract_text(tag)
    >>> print anon_browser.title
    Code review comment
    >>> print_tag('comment-subject')
    my subject
    >>> print_tag('comment-body')
    my body
    >>> print_tag('comment-from')
    No Privileges Person
    >>> print_tag('comment-vote')
    Approve

Hmm.  Probably shouldn't display this...

    >>> anon_browser.getLink('Reply').click()
    Traceback (most recent call last):
    Unauthorized:...

We can reply to a comment.

    >>> nopriv_browser = setupBrowser(auth="Basic no-priv@canonical.com:test")
    >>> nopriv_browser.open(message_url)
    >>> nopriv_browser.getLink('Reply').click()
    >>> nopriv_browser.url == message_url + '/+reply'
    True
    >>> nopriv_browser.getControl('Subject').value = 'Subjects are nice.'
    >>> nopriv_browser.getControl('Comment').value = 'I like this'
    >>> nopriv_browser.getControl('Vote').displayValue = ['Abstain']
    >>> nopriv_browser.getControl('Add').click()

After this, we are taken to the view page for that comment.

    >>> print_tag('comment-subject', nopriv_browser)
    Subjects are nice.
    >>> print_tag('comment-body', nopriv_browser)
    I like this
    >>> print_tag('comment-vote', nopriv_browser)
    Abstain
