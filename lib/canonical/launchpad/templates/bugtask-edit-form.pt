<tal:process define="status view/process_form" />
<form
  action="#"
  tal:attributes="action string:${context/fmt:url}/+editstatus"
  method="post"
  enctype="multipart/form-data">
  <p
    tal:condition="view/getErrorMessage"
    class="error message"
    i18n:translate=""
    tal:content = "view/getErrorMessage"
  />

  <p tal:condition="not: context/required:launchpad.Edit" class="error message">
    You are not the bug assignee nor the maintainer of
    <tal:context replace="context/targetname">project</tal:context>,
    and therefore cannot edit this bug's status.
  </p>
  <div class="field">
    <table>
      <tal:distrotask
        condition="python:context.distribution or context.distrorelease"
      >
        <tr>
          <td>
            <label
              tal:attributes="for view/sourcepackagename_widget/name"
              tal:content="view/sourcepackagename_widget/label"
            >Source package name</label>
          </td>
        </tr>
        <tr>
          <td tal:define="widget nocall:view/sourcepackagename_widget">
            <metal:content
              use-macro="context/@@launchpad_widget_macros/display_raw_widget" />
          </td>
        </tr>
      </tal:distrotask>
      <tal:upstreamtask condition="python:context.product">
        <tr tal:condition="view/product_widget">
          <td colspan="2">
            <label style="font-weight: bold"
              tal:attributes="for view/product_widget/name"
              tal:content="view/product_widget/label"
            >Upstream project</label>
          </td>
        </tr>
        <tr tal:condition="view/product_widget">
          <td colspan="2" style="white-space: nowrap"
              tal:define="widget nocall:view/product_widget">
            <metal:content
              use-macro="context/@@launchpad_widget_macros/display_raw_widget" />
          </td>
        </tr>
      </tal:upstreamtask>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold"
            tal:attributes="for view/status_widget/name"
            tal:content="view/status_widget/label"
          >Status</label>
        </td>
        <td>
          <label style="font-weight: bold"
            tal:attributes="for view/importance_widget/name"
            tal:content="view/importance_widget/label"
          >Importance</label>
        </td>
        <td tal:condition="view/milestone_widget">
          <label style="font-weight: bold"
            tal:attributes="for view/milestone_widget/name"
            tal:content="view/milestone_widget/label"
          >Target</label>
        </td>
      </tr>
      <tr>
        <td tal:content="structure view/status_widget" />
        <td title="Editable only by the maintainer or bug contact of the project">
          <img tal:condition="not:view/userCanEditImportance" src="/@@/locked" />
          <span tal:content="structure view/importance_widget" />
        </td>
        <td tal:condition="view/milestone_widget"
            title="Editable only by the maintainer or bug contact of the project">
          <img tal:condition="not:view/userCanEditMilestone" src="/@@/locked" />
          <span tal:content="structure view/milestone_widget" />
        </td>
      </tr>
    </table>
    <table>
      <tr>
        <td>
          <label style="font-weight: bold"
            tal:attributes="for view/assignee_widget/name"
            tal:content="view/assignee_widget/label"
          />
        </td>
      </tr>
      <tr>
        <td nowrap tal:content="structure view/assignee_widget" colspan="2" />
      </tr>
    </table>
    <table tal:condition="not:context/target_uses_malone">
      <tr>
        <td>
          <label
            tal:attributes="for view/bugwatch_widget/name"
            style="white-space: nowrap"
          >Remote Watch</label>
        </td>
      </tr>
      <tr>
        <td nowrap tal:content="structure view/bugwatch_widget" colspan="2" />
      </tr>
      <tr>
        <td class="formHelp" colspan="2">
        The information about this bug in Launchpad is
        automatically pulled daily from the remote bug.
        <tal:has_bugwatch tal:condition="context/bugwatch">
          <tal:has_been_pulled 
              tal:condition="context/bugwatch/lastchecked">
            This information was last pulled
            <b
              tal:attributes="title context/bugwatch/lastchecked/fmt:datetime"
              tal:content="context/bugwatch/lastchecked/fmt:displaydate">
              3 minutes ago
            </b>.
          </tal:has_been_pulled>
          <tal:has_not_been_pulled 
              tal:condition="not:context/bugwatch/lastchecked">
            This information hasn't been pulled yet.
          </tal:has_not_been_pulled>
        </tal:has_bugwatch>
        </td>
      </tr>
    </table>
  </div>
  <div class="field">
    <label style="font-weight: bold" tal:attributes="for string:${view/prefix}.comment_on_change">Comment on most recent change</label>
    <div style="margin-top: 5px; margin-bottom: 1em">
      <i tal:content="python:context.statusexplanation or '(none)'" />
    </div>
  </div>
  <div class="field">
    <div>
      <label style="font-weight: bold" tal:attributes="for string:${view/prefix}.comment_on_change">Comment on this change (optional)</label>
      <textarea
        cols="62"
        rows="4"
        tal:content="request/comment_on_change|nothing"
        tal:attributes="id string:${view/prefix}.comment_on_change;
                        name string:${view/prefix}.comment_on_change"
      ></textarea>
    </div>
    <div tal:condition="python:not context.bug.isSubscribed(view.user)">
      <label style="font-weight: normal">
        <input type="checkbox" name="subscribe" id="subscribe"
               value="Subscribe" />
        E-mail me about changes to this bug report
      </label>
    </div>
  </div>
  <div class="actions" tal:condition="context/required:launchpad.Edit">
    <input
      type="submit"
      name="FORM_SUBMIT"
      value="Save Changes"
      i18n:attributes="value submit-button"
    />
  </div>
</form>
