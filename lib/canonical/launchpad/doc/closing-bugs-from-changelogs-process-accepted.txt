= Closing bugs from changelogs in process-accepted.py =

XXX: This file should be incorporated into
     closing-bugs-from-changelogs.txt, but it's not possible to do so
     due to some issues with transaction handling in Zopeless mode. When
     the following tests are in that file, the process-accepted.py won't
     see the database changes made here. Will try to resolve this before
     landing.

The closing of bugs are done in process-accepted.py, right after the
queue items have been processed.

    >>> changes_template = """
    ... Format: 1.7
    ... Launchpad-bugs-fixed: %s
    ... """
    >>> login('no-priv@canonical.com')
    >>> from canonical.launchpad.interfaces import (
    ...     CreateBugParams, IDistributionSet)
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> pmount_ubuntu = ubuntu.getSourcePackage('pmount')
    >>> bug_params = CreateBugParams(
    ...     getUtility(ILaunchBag).user, "Test bug", "Test bug.")
    >>> pmount_bug = pmount_ubuntu.createBug(bug_params)
    >>> pmount_bug_id = pmount_bug.id

    >>> from StringIO import StringIO
    >>> from canonical.launchpad.database import DistroReleaseQueue
    >>> from canonical.librarian.interfaces import ILibrarianClient
    >>> from canonical.lp.dbschema import (
    ...     DistroReleaseQueueStatus, PackagePublishingPocket)

    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> ubuntu_hoary = ubuntu.getRelease('hoary')
    >>> changes = changes_template % pmount_bug_id
    >>> changes_file = getUtility(ILibrarianClient).addFile(
    ...     'pmount.changes', len(changes), StringIO(changes), 'text/plain')
    >>> queue_item = DistroReleaseQueue(
    ...     status=DistroReleaseQueueStatus.ACCEPTED,
    ...     distrorelease=ubuntu_hoary,
    ...     pocket=PackagePublishingPocket.RELEASE,
    ...     changesfile=changes_file, signing_key=None)
    >>> queue_item_id = queue_item.id

    >>> from canonical.launchpad.database import (
    ...     DistroReleaseQueueSource, SourcePackageRelease)
    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> sabdfl = getUtility(IPersonSet).getByName('sabdfl')
    >>> pmount_release = SourcePackageRelease.get(20)
    >>> pmount_release.sourcepackagename.name
    u'pmount'
    >>> pmount_release.uploaddistrorelease.name
    u'hoary'
    >>> source_queue = DistroReleaseQueueSource(
    ...     distroreleasequeue=queue_item,
    ...     sourcepackagerelease=pmount_release)
    >>> import transaction
    >>> transaction.commit()

    >>> import os.path
    >>> import subprocess
    >>> import sys
    >>> from canonical.config import config
    >>> script = os.path.join(config.root, "scripts/process-accepted.py")
    >>> process = subprocess.Popen(
    ...     [sys.executable, script, "ubuntu"])
    ...     stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    >>> stdout, stderr = process.communicate()
    >>> process.returncode
    0

    # Need to flush the caches in order to see the changes made by the
    # script.
    >>> from canonical.database.sqlbase import flush_database_caches
    >>> transaction.abort()
    >>> flush_database_caches()

    >>> from canonical.launchpad.interfaces import IBugSet
    >>> pmount_bug = getUtility(IBugSet).get(pmount_bug_id)
    >>> [pmount_task] = pmount_bug.bugtasks
    >>> pmount_task.status.name
    'FIXRELEASED'
