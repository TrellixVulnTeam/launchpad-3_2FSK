= Launchpad Single-Signon Workflow: Authorize =

If a user has logged into Launchpad and then wants to log in to a
Launchpad-SSO web site, they are not prompted for a password.

First we will set up the helper view that lets us test the final
portion of the authentication process:

    >>> from openid.consumer.consumer import Consumer
    >>> from openid.consumer.discover import OPENID_1_1_TYPE
    >>> from openid.fetchers import setDefaultFetcher
    >>> from openid.sreg import SRegRequest, SRegResponse
    >>> from openid.store.memstore import MemoryStore
    >>> from canonical.launchpad.ftests.openidhelpers import (
    ...     complete_from_browser, install_consumer,
    ...     make_identifier_select_endpoint, uninstall_consumer,
    ...     PublisherFetcher)
    >>> install_consumer()
    >>> setDefaultFetcher(PublisherFetcher())

The authentication process is started by the relying party issuing a
checkid_setup request, sending the user to Launchpad.  We will
authenticate before starting the login procedure:

    >>> browser.addHeader('Authorization', 'Basic mark@hbd.com:test')

    >>> openid_store = MemoryStore()
    >>> consumer = Consumer(session={}, store=openid_store)

    >>> request = consumer.beginWithoutDiscovery(
    ...     make_identifier_select_endpoint(OPENID_1_1_TYPE))
    >>> browser.open(request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer'))

At this point, the user is presented with a form asking if they want
to authenticate to the relying party

    >>> print browser.title
    Authenticate to http://launchpad.dev/

By clicking the "Sign In" button, the user is returned to the relying
party with their identity URL:

    >>> browser.getControl('Sign In', index=0).click()
    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...
    >>> info = complete_from_browser(
    ...     consumer, browser, 'http://openid.launchpad.dev/+id/sabdfl_oid')
    >>> print info.status
    success
    >>> print info.endpoint.claimed_id
    http://openid.launchpad.dev/+id/sabdfl_oid


== Declining to Authenticate ==

Alternatively, the user could have declined to authenticate.  This
time, we will cancel the authentication request:

    >>> request = consumer.beginWithoutDiscovery(
    ...     make_identifier_select_endpoint(OPENID_1_1_TYPE))
    >>> browser.open(request.redirectURL(
    ...     'http://launchpad.dev/', 'http://launchpad.dev/+openid-consumer'))

    >>> print browser.title
    Authenticate to http://launchpad.dev/
    >>> browser.getControl("Not Now").click()
    >>> print browser.url
    http://launchpad.dev/+openid-consumer?...
    >>> info = complete_from_browser(
    ...     consumer, browser, 'http://openid.launchpad.dev/+id/sabdfl_oid')
    >>> print info.status
    cancel


== Cleanup ==

    >>> setDefaultFetcher(None)
    >>> uninstall_consumer()
