= Branch Visibility =

Most branches on launchpad are considered public branches, and are
visible to everybody, even people not logged in.

Some branches are also considered "private".  These are branches that
are only visible to the owner of the branch, and the subscribers.

    >>> from zope.component import getUtility
    >>> from canonical.launchpad.interfaces import IBranchSet, IPersonSet
    >>> person_set = getUtility(IPersonSet)
    >>> no_priv_person = person_set.getByName('no-priv')

    >>> branch = getUtility(IBranchSet).new(
    ...     name='test-branch', owner=no_priv_person, product=None,
    ...     url=None, title='Test branch')

Since many of the examples here are testing the ability of various users to
access branches, we don't want all the access to the branch to go through the
security proxy.  So we'll remove it.

    >>> from zope.security.proxy import removeSecurityProxy
    >>> branch = removeSecurityProxy(branch)

    >>> print branch.unique_name
    ~no-priv/+junk/test-branch
    >>> branch.private
    False


== Accessing branches ==

Branch access is controlled by the launchpad.View permission, and the
class AccessBranch is used to authenticate users for IBranch
for the launchpad.View permission.

    >>> from canonical.launchpad.security import AccessBranch
    >>> access = AccessBranch(branch)
    >>> access.checkUnauthenticated()
    True
    >>> access.checkAuthenticated(no_priv_person)
    True


== Private Branches ==

Branches that are private are accessible by the owner and subscribers.

    >>> branch.private = True
    >>> access.checkUnauthenticated()
    False
    >>> branch.owner == no_priv_person
    True
    >>> access.checkAuthenticated(no_priv_person)
    True

Mark is a launchpad administrator, and launchpad administrators are special.
Launchpad administrators often have a need to see private launchpad things
in order to fix up fubars by users.

    >>> sabdfl = person_set.getByName('sabdfl')
    >>> from canonical.launchpad.interfaces import ILaunchpadCelebrities
    >>> lp_admins = getUtility(ILaunchpadCelebrities).admin
    >>> sabdfl.inTeam(lp_admins)
    True
    >>> access.checkAuthenticated(sabdfl)
    True

David is not a Launchpad admin, nor is currently subscribed to our new branch.

    >>> ddaa = person_set.getByName('ddaa')
    >>> ddaa.inTeam(lp_admins)
    False
    >>> access.checkAuthenticated(ddaa)
    False


== Visibility due to subscription ==

Branches that are not public are viewable by members of the visibility_team
and to subscribers.

The Jeff Waugh is a member of the Ubuntu team, but not a Luanchpad admin.

    >>> jdub = person_set.getByName('jdub')
    >>> ubuntu_team = person_set.getByName('ubuntu-team')
    >>> jdub.inTeam(ubuntu_team)
    True
    >>> jdub.inTeam(lp_admins)
    False
    >>> access.checkAuthenticated(jdub)
    False

Subscribing the Ubuntu team will allow Jeff to have access to the branch.

    >>> from canonical.lp.dbschema import (
    ...     BranchSubscriptionNotificationLevel, BranchSubscriptionDiffSize)

    >>> branch.subscribe(ubuntu_team,
    ...     BranchSubscriptionNotificationLevel.NOEMAIL,
    ...     BranchSubscriptionDiffSize.NODIFF)
    <BranchSubscription ...>

    >>> access.checkAuthenticated(jdub)
    True
