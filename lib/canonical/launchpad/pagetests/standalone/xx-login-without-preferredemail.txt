This test ensures that a user cannot login without a preferred email
address.

First, we need to set the password to something I know

    >>> import transaction
    >>> from canonical.database.sqlbase import cursor
    >>> cursor().execute("""
    ...     UPDATE AccountPassword
    ...         SET password='K7Qmeansl6RbuPfulfcmyDQOzp70OxVh5Fcf'
    ...     FROM Person, Account
    ...     WHERE name='martin-pitt' AND Person.account = Account.id
    ...         AND Account.id = AccountPassword.account
    ...     """)
    >>> transaction.commit()
    >>> import time

'martin-pitt' doesn't have a preferred email address.
He can't login without first validating his email address.

  >>> browser.open('http://launchpad.dev/+login')
  >>> browser.getControl('E-mail', index=0).value = 'martin.pitt@canonical.com'
  >>> browser.getControl('Password').value = 'test'
  >>> browser.getControl('Log In').click()
  >>> print '\n' + browser.contents
  <BLANKLINE>
  ...
  ...The email address 'martin.pitt@canonical.com', which you're...
  ...trying to use to login has not yet been validated to use in Launchpad...
  ...We sent an email to that address with instructions on how to confirm...
  ...that it belongs to you...
  ...


  When this happens, we automatically send an email to that address so the
  user can validate it and login.

  >>> import email, re
  >>> from canonical.launchpad.mail import stub
  >>> from_addr, to_addrs, raw_msg = stub.test_emails.pop()

  Check if the email was sent to the right address.

  >>> to_addrs
  ['martin.pitt@canonical.com']

  Get the token from the email address, in order to confirm the email address
  and then be able to login.

  >>> msg = email.message_from_string(raw_msg)
  >>> body = msg.get_payload()
  >>> link = re.findall(r'http.*/token/.*', body)[0]
  >>> token = re.sub(r'.*token/', '', link)
  >>> base_path = 'http://launchpad.dev/token/%s' % token

  >>> path = "%s/+validateemail" % base_path
  >>> browser.open(path)
  >>> print '\n' + browser.contents
  <BLANKLINE>
  ...
  ...Confirm e-mail address...martin.pitt@canonical.com...
  ...

  >>> browser.getControl('Continue').click()
  >>> browser.url
  'http://launchpad.dev/~martin-pitt'
  >>> print '\n' + browser.contents
  <BLANKLINE>
  ...informational message">Email address successfully confirmed...
  ...

  This is the first email 'martin-pitt' is validating, it must be set as the
  preferred one.

  >>> from canonical.launchpad.database import EmailAddressSet
  >>> [to_addr] = to_addrs
  >>> e = EmailAddressSet().getByEmail(to_addr)
  >>> e.statusname
  'Preferred Email Address'

