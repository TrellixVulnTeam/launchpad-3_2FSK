<tal:bugtask
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  define="expandable view/canSeeTaskDetails;
          indent_task view/shouldIndentTask;
          is_conjoined_slave view/is_conjoined_slave;
          tasklink view/taskLink;
          row_id string:tasksummary${context/id};
          form_row_id string:task${context/id}">
  <tr tal:attributes="class view/getTaskRowCSSClass; id row_id">
    <td class="icon left right">
      <metal:expander
          metal:define-macro="expander"
          tal:define="expander_link_text expander_link_text|nothing">
        <a tal:condition="expandable"
           tal:attributes="
            href tasklink;
            onclick string:return toggleFormVisibility('${form_row_id}')">
          <img src="/@@/bug-status-expand" alt="[edit]" />
          <tal:link_text tal:replace="expander_link_text" />
        </a>
        <tal:no_expander tal:condition="not: expandable"
                         tal:replace="expander_link_text" />
      </metal:expander>
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em"
        tal:condition="indent_task"
        tal:define="series_targetname view/getSeriesTargetName">
      <img src="/@@/milestone" alt="Targeted to" />
      <tal:not-conjoined-task condition="not: is_conjoined_slave">
        <a
          tal:attributes="href context/target/fmt:url"
          tal:content="series_targetname"
        />
      </tal:not-conjoined-task>
    </td>
    <td tal:condition="not:indent_task">
      <img
        tal:condition="view/bugtask_icon"
        alt=""
        tal:attributes="src view/bugtask_icon"
      />
      <a tal:attributes="
            href context/target/fmt:url;
            title view/target_link_title"
        tal:content="context/bugtargetdisplayname"
      />
    </td>

    <tal:conjoined-task condition="is_conjoined_slave">
    <td colspan="5" style="vertical-align: middle">
      <span class="discreet lesser" style="font-size: 100%">
        Status tracked in
        <tal:master tal:replace="view/getConjoinedMasterName">
          Hoary
        </tal:master>
      </span>
    </td>
    </tal:conjoined-task>

    <tal:not-conjoined-task condition="not:is_conjoined_slave">
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content"
           style="width: 100%; float: left">
        <a href="+edit"
           tal:attributes="class string:value status${context/status/name}"
           style="float: left"
           tal:content="context/status/title" />
        <div style="float: right; margin-right: 0.5em">
          <a href="+edit">
            <img class="editicon" src="/@@/edit-grey" />
          </a>
        </div>
      </div>
    </td>

    <td tal:condition="view/user_can_edit_importance"
        style="width: 20%; vertical-align: middle">
      <div class="importance-content"
           style="width: 100%; float: left">
        <a href="+edit"
           tal:attributes="class string:value importance${context/importance/name}"
           style="float: left"
           tal:content="context/importance/title" />
        <div style="float: right; margin-right: 0.5em">
          <a href="+edit">
            <img class="editicon" src="/@@/edit-grey" />
          </a>
        </div>
      </div>
    </td>
    <td tal:condition="not: view/user_can_edit_importance"
        style="width: 15em; vertical-align: middle">
      <div class="importance-content"
           style="width: 100%; float: left">
        <span
           tal:attributes="class string:value importance${context/importance/name}"
           style="float: left"
           tal:content="context/importance/title" />
      </div>
    </td>


    <td colspan="2"
        style="margin: 0; padding: 0; 20%; vertical-align: middle"
        tal:condition="context/bugwatch">
        <div style="text-decoration: none; padding: 0.25em">
          <tal:bugtracker-active
              condition="context/bugwatch/bugtracker/active">
            <img tal:condition="not:context/bugwatch/last_error_type"
                 alt="Linked to " src="/@@/bug-remote" />
            <img tal:condition="context/bugwatch/last_error_type"
              alt="Error updating bug watch" src="/@@/warning" />
          </tal:bugtracker-active>
          <img tal:condition="not:context/bugwatch/bugtracker/active"
              tal:attributes="alt string:Bug watch updates for ${context/bugwatch/bugtracker/title} are disabled.; title string:Bug watch updates for ${context/bugwatch/bugtracker/title} are disabled."
              src="/@@/warning" />
          <a tal:replace="structure context/bugwatch/fmt:external-link">
            Zilla #123
          </a>
        </div>
    </td>
    <td colspan="2"
        style="width: 20%; vertical-align: middle"
        tal:condition="not: context/bugwatch">
      <div class="assignee-content"
           style="width: 100%; float: left">
        <span class="yui-activator-data-box">
          <a tal:condition="context/assignee"
             class="bg-image"
             href="+edit"
             tal:attributes="
               style string: float: left;;
               background-image: url( ${context/assignee/fmt:icon_url} )">
            <tal:person-name replace="context/assignee/fmt:displayname" />
          </a>
          <tal:nobody tal:condition="not: context/assignee">
            <span style="float: left; margin: 5px">
              Nobody
            </span>
          </tal:nobody>
        </span>
        <div style="float: right; margin-right: 0.5em; margin-top: 5px">
          <a href="+edit" class="yui-activator-act">
            <img class="editicon" src="/@@/edit-grey" />
          </a>
        </div>
        <div class="yui-activator-message-box yui-activator-hidden"/>
      </div>
    </td>

      <!--
      <tal:milestoned condition="context/milestone">
      <td class="icon left right">
        <metal:expander metal:use-macro="template/macros/expander" />
      <a tal:attributes="href context/milestone/fmt:url"
         tal:content="context/milestone/name">1.0</a>
      </td>
      </tal:milestoned>
      <td tal:condition="not:context/milestone"></td>
      -->
      <td style="width: 20%; vertical-align: middle">
        <div class="milestone-content"
             style="width: 100%; float: left">
          <tal:milestoned condition="context/milestone">             
            <a href="+edit"
               style="float: left"
               tal:content="context/milestone/name" />
            <div style="float: right; margin-right: 0.5em">
              <a href="+edit">
                <img class="editicon" src="/@@/edit-grey" />
              </a>
            </div>
          </tal:milestoned>
          <tal:not-milestoned condition="not: context/milestone">
            <span style="float: left">None</span>
            <div style="float: right; margin-right: 0.5em">
              <a href="+edit">
                <img class="editicon" src="/@@/edit-grey" />
              </a>
            </div>
          </tal:not-milestoned>
        </div>
      </td>

    </tal:not-conjoined-task>
  </tr>
  <script type="text/javascript"
    tal:define="milestone_value python: context.milestone and context.milestone.name or ''"
    tal:content="string:
    YUI().use('event', 'bugs.bugtask_index', function(Y) {
        Y.on('load',
             function(e) {
                 Y.bugs.setup_bugtask_row('${row_id}',
                                          '${context/fmt:url}',
                                          ${view/status_widget_items},
                                          '${context/status/title}',
                                          ${view/importance_widget_items},
                                          '${context/importance/title}',
                                          ${view/user_can_edit_importance_json},
                                          ${view/milestone_widget_items},
                                          '${milestone_value}');
             },
             window);
    });
  "/>
  <tal:form condition="view/displayEditForm">
    <tr
      tal:attributes="id form_row_id"
      tal:condition="expandable"
      style="display: none"
    >
     <td colspan="7" tal:content="structure view/edit_view" />
    </tr>
  </tal:form>
</tal:bugtask>
