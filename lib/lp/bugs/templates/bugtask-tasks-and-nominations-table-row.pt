<tal:bugtask
  xmlns:tal="http://xml.zope.org/namespaces/tal"
  xmlns:metal="http://xml.zope.org/namespaces/metal"
  define="expandable view/canSeeTaskDetails;
          indent_task view/shouldIndentTask;
          is_conjoined_slave view/is_conjoined_slave;
          tasklink view/taskLink;
          row_id string:tasksummary${context/id};
          form_row_id string:task${context/id}">
  <tr tal:define="editstatus_url string:${context/fmt:url}/+editstatus"
      tal:attributes="class view/getTaskRowCSSClass; id row_id">
    <td>
      <metal:expander
          metal:define-macro="expander"
          tal:define="expander_link_text expander_link_text|nothing">
        <a tal:condition="expandable"
           tal:attributes="href tasklink" class="bugtask-expander">
          <tal:link_text tal:replace="expander_link_text" />
          &nbsp;
        </a>
        <tal:no_expander tal:condition="not: expandable"
                         tal:replace="expander_link_text" />
      </metal:expander>
    </td>
    <td style="padding: 0.3em 0em 0.3em 1.5em"
        tal:condition="indent_task"
        tal:define="series_targetname view/getSeriesTargetName">
      <span class="sprite milestone"></span>
      <tal:not-conjoined-task condition="not: is_conjoined_slave">
        <a
          tal:attributes="href context/target/fmt:url"
          tal:content="series_targetname"
        />
      </tal:not-conjoined-task>
    </td>
    <td tal:condition="not:indent_task">
      <span tal:attributes="id string:bugtarget-picker-${row_id}">
        <span class="yui3-activator-data-box">
          <span title="This project&rsquo;s license has not been specified.">
            <a tal:attributes="href context/target/fmt:url;
                               title view/target_link_title;
                               class context/target/image:sprite_css"
               tal:content="context/bugtargetdisplayname" />
          </span>
        </span>
        <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
          Edit
        </button>
        <div class="yui3-activator-message-box yui3-activator-hidden"></div>
      </span>
    </td>

    <tal:conjoined-task condition="is_conjoined_slave">
    <td colspan="5" style="vertical-align: middle">
      <span class="discreet lesser" style="font-size: 100%">
        Status tracked in
        <tal:master tal:replace="view/getConjoinedMasterName">
          Hoary
        </tal:master>
      </span>
    </td>
    </tal:conjoined-task>

    <tal:not-conjoined-task condition="not:is_conjoined_slave">
    <td style="width: 20%; vertical-align: middle">
      <div class="status-content"
           style="width: 100%; float: left">
        <a href="+editstatus"
           tal:attributes="class string:value status${context/status/name};
                           href editstatus_url"
           style="float: left"
           tal:content="context/status/title" />
        <a href="+editstatus" style="margin-left: 3px"
           tal:attributes="href editstatus_url">
          <img class="editicon" src="/@@/edit" />
        </a>
      </div>
    </td>

    <td tal:condition="view/user_can_edit_importance"
        style="width: 20%; vertical-align: middle">
      <div class="importance-content"
           style="width: 100%; float: left">
        <a href="+editstatus"
           tal:attributes="class string:value importance${context/importance/name};
                           href editstatus_url"
           style="float: left"
           tal:content="context/importance/title" />
        <a href="+editstatus" style="margin-left: 3px"
           tal:attributes="href editstatus_url">
          <img class="editicon" src="/@@/edit" />
        </a>
      </div>
    </td>
    <td tal:condition="not: view/user_can_edit_importance"
        style="width: 15em; vertical-align: middle">
      <div class="importance-content"
           style="width: 100%; float: left">
        <span
           tal:attributes="class string:value importance${context/importance/name}"
           style="float: left"
           tal:content="context/importance/title" />
      </div>
    </td>

    <td style="width:20%; margin: 0; padding: 0;
               vertical-align: middle; padding-left: 0.5em">
      <tal:has_watch condition="context/bugwatch">
        <div style="text-decoration: none; padding: 0.25em">
          <tal:bugtracker-active
              condition="context/bugwatch/bugtracker/active">
            <span tal:condition="not:context/bugwatch/last_error_type"
                  class="sprite bug-remote"></span>
            <a tal:condition="context/bugwatch/last_error_type"
                tal:attributes="href view/bug_watch_error_message/help_url"
                target="help"
                class="icon help">
              <span class="sprite warning-icon"
                    tal:attributes="title view/bug_watch_error_message/message"
                    id="bugwatch-error-sprite"></span>
            </a>
          </tal:bugtracker-active>
          <span tal:condition="not:context/bugwatch/bugtracker/active"
                class="sprite warning-icon"></span>
          <a tal:replace="structure context/bugwatch/fmt:external-link" />
        </div>
      </tal:has_watch>

      <tal:has_no_watch condition="not: context/bugwatch">
        <span tal:attributes="id string:assignee-picker-${row_id}">
          <span class="yui3-activator-data-box">
            <a tal:condition="context/assignee"
               tal:attributes="href context/assignee/fmt:url;
                               class context/assignee/image:sprite_css"
               tal:content="context/assignee/fmt:displayname" />
            <tal:unassigned condition="not: context/assignee">
              Unassigned
            </tal:unassigned>
          </span>
          <button class="lazr-btn yui3-activator-act yui3-activator-hidden">
            Edit
          </button>
          <div class="yui3-activator-message-box yui3-activator-hidden"></div>
        </span>
      </tal:has_no_watch>
    </td>

    <td style="width: 20%; vertical-align: middle">
      <div class="milestone-content"
           tal:condition="view/target_has_milestones"
           style="width: 100%; float: left">
        <a tal:condition="view/user_can_edit_milestone"
           class="nulltext addicon js-action sprite add"
           tal:attributes="href editstatus_url;
                           style view/style_for_add_milestone">
          Target to milestone
        </a>
        <a class="value"
           tal:attributes="href context/milestone/fmt:url | nothing"
           tal:content="context/milestone/title | nothing" />
        <a tal:condition="view/user_can_edit_milestone"
           tal:attributes="href editstatus_url"
          ><img class="editicon" src="/@@/edit"
                tal:attributes="style view/style_for_edit_milestone"
          /></a>
      </div>
    </td>

    </tal:not-conjoined-task>
  </tr>
  <script type="text/javascript"
          class="bugtasks-table-row-init-script"
          tal:condition="not:view/many_bugtasks"
          tal:content="string:
    LPS.use('event', 'lp.bugs.bugtask_index', 'lp.app.widgets.expander',
            function(Y) {
        Y.on('domready', function() {
          Y.lp.bugs.bugtask_index.setup_bugtask_row(${view/js_config});

          // Set-up the expander on the bug task summary row.
          var icon_node = Y.one('tr#${row_id} a.bugtask-expander');
          var row_node = Y.one('tr#${form_row_id}');
          var content_node = row_node.one('td form');
          var expander = new Y.lp.app.widgets.expander.Expander(
            icon_node, row_node, { animate_node: content_node });
          expander.setUp();
        });
    });
  "/>

  <tal:form condition="view/displayEditForm">
    <tr
      tal:attributes="id form_row_id"
      tal:condition="expandable"
      class="bugtask-collapsible-content unseen"
    >
     <td colspan="7" tal:content="structure view/edit_view" />
    </tr>
  </tal:form>
</tal:bugtask>
