
Let's test now the class RosettaWriteTarFile

First, define a function we are going to use:

    >>> def examine_tarfile(tarfile):
    ...     names = tarfile.getnames()
    ...     # Calculate the length of the longest name.
    ...     max_length = len(sorted(names, key=len)[-1])
    ...     # Use this length to generate an appropriate format string.
    ...     format = '%%-%ds | %%s' % max_length
    ...
    ...     for name in names:
    ...         file = tarfile.extractfile(name)
    ...
    ...         if file is not None:
    ...             print format % (name, file.read())
    ...         else:
    ...             print format % (name, '')

Start off by creating a blank archive.

We'll need a filehandle to store it in.

    >>> from StringIO import StringIO
    >>> buffer = StringIO()

    >>> from canonical.launchpad.components.poexport import RosettaWriteTarFile
    >>> archive = RosettaWriteTarFile(buffer)

We can add files individually.

    >>> archive.add_file('foo', '1')

Or add many files simultaneosly.

    >>> archive.add_files({'bar': '2', 'baz': '3'})

Now we're done.

    >>> archive.close()

Let's take a peek inside.

    >>> import tarfile
    >>> buffer.seek(0)
    >>> archive = tarfile.open('', 'r', buffer)
    >>> examine_tarfile(archive)
    foo | 1
    bar | 2
    baz | 3

There are also some convenience methods for getting directly from a list
of files to a stream...

If we have a list of files:

    >>> files = {
    ...     'eins': 'zwei',
    ...     'drei': 'vier'
    ... }

...then we can easily turn it into a tarfile...

    >>> archive = RosettaWriteTarFile.files_to_tarfile(files)
    >>> examine_tarfile(archive)
    drei | vier
    eins | zwei

...or a stream...

    >>> stream = RosettaWriteTarFile.files_to_stream(files)
    >>> archive = tarfile.open('', 'r', stream)
    >>> examine_tarfile(archive)
    drei | vier
    eins | zwei

...or a data string.

    >>> data = RosettaWriteTarFile.files_to_string(files)
    >>> archive = tarfile.open('', 'r', StringIO(data))
    >>> examine_tarfile(archive)
    drei | vier
    eins | zwei

If a filename contains slashes, containing directories are automatically created.

    >>> archive = RosettaWriteTarFile.files_to_tarfile({
    ...     'uno/dos/tres/cuatro': 'blah'
    ...     })
    >>> examine_tarfile(archive)
    uno/                | 
    uno/dos/            | 
    uno/dos/tres/       | 
    uno/dos/tres/cuatro | blah

Test exporting a single PO template.

Get hold of a template, and a language to export a PO file for.

  >>> from canonical.launchpad.database import POTemplate, LanguageSet
  >>> template = POTemplate.get(1)
  >>> language = LanguageSet()['es']

Adapt the template with to exporter.

  >>> from canonical.launchpad.components.poexport import POTemplateExporter
  >>> exporter = POTemplateExporter(template)

Then get the PO file from the exporter.

  >>> pofile = exporter.export_pofile(language)
  >>> print pofile
  # traducción de es.po al Spanish
  # translation of es.po to Spanish
  # translation of evolution.HEAD to Spanish
  # Copyright © 2000-2002 Free Software Foundation, Inc.
  # This file is distributed under the same license as the evolution package.
  # Carlos Perelló Marín <carlos@gnome-db.org>, 2000-2001.
  # Héctor García Álvarez <hector@scouts-es.org>, 2000-2002.
  # Ismael Olea <Ismael@olea.org>, 2001, (revisiones) 2003.
  # Eneko Lacunza <enlar@iname.com>, 2001-2002.
  # Héctor García Álvarez <hector@scouts-es.org>, 2002.
  # Pablo Gonzalo del Campo <pablodc@bigfoot.com>,2003 (revisión).
  # Francisco Javier F. Serrador <serrador@cvs.gnome.org>, 2003, 2004.
  #
  #
  #, fuzzy
  msgid ""
  msgstr ""
  "Project-Id-Version: es\n"
  "POT-Creation-Date: 2005-08-25 14:56+0200\n"
  "PO-Revision-Date: 2005-06-06 20:08+0000\n"
  "Last-Translator: Mark Shuttleworth <mark@hbd.com>\n"
  "Language-Team: Spanish <traductores@es.gnome.org>\n"
  "MIME-Version: 1.0\n"
  "Content-Type: text/plain; charset=UTF-8\n"
  "Content-Transfer-Encoding: 8bit\n"
  "Report-Msgid-Bugs-To: serrador@hispalinux.es\n"
  "Plural-Forms: nplurals=2; plural=(n != 1);\n"
  "X-Rosetta-Export-Date: ...-...-... ...:...+...\n"
  <BLANKLINE>
  #: a11y/addressbook/ea-addressbook-view.c:94
  #: a11y/addressbook/ea-addressbook-view.c:103
  #: a11y/addressbook/ea-minicard-view.c:119
  msgid "evolution addressbook"
  msgstr "libreta de direcciones de Evolution"
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:101
  msgid "current addressbook folder"
  msgstr "carpeta de libretas de direcciones actual"
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:102
  #, fuzzy
  msgid "have "
  msgstr "tiene "
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:102
  msgid "has "
  msgstr ""
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:104
  msgid " cards"
  msgstr " tarjetas"
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:104
  msgid " card"
  msgstr ""
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard-view.c:105
  msgid "contact's header: "
  msgstr ""
  <BLANKLINE>
  #: a11y/addressbook/ea-minicard.c:166
  msgid "evolution minicard"
  msgstr ""
  <BLANKLINE>
  #: addressbook/addressbook-errors.xml.h:2
  msgid "This addressbook could not be opened."
  msgstr ""
  <BLANKLINE>
  #: addressbook/addressbook-errors.xml.h:4
  msgid ""
  "This addressbook server might unreachable or the server name may be "
  "misspelled or your network connection could be down."
  msgstr ""
  <BLANKLINE>
  #: addressbook/addressbook-errors.xml.h:6
  msgid "Failed to authenticate with LDAP server."
  msgstr ""
  <BLANKLINE>
  #: addressbook/addressbook-errors.xml.h:8
  msgid ""
  "Check to make sure your password is spelled correctly and that you are using "
  "a supported login method. Remember that many passwords are case sensitive; "
  "your caps lock might be on."
  msgstr ""
  <BLANKLINE>
  #: addressbook/gui/component/addressbook-migrate.c:124
  #: calendar/gui/migration.c:188 mail/em-migrate.c:1201
  #, c-format
  msgid "Migrating `%s':"
  msgstr ""
  <BLANKLINE>
  #: addressbook/gui/component/addressbook-migrate.c:1123
  msgid ""
  "The location and hierarchy of the Evolution contact folders has changed "
  "since Evolution 1.x.\n"
  "\n"
  "Please be patient while Evolution migrates your folders..."
  msgstr ""
  "La ubicación y jerarquía de las carpetas de contactos de Evolution ha "
  "cambiado desde Evolution 1.x.\n"
  "\n"
  "Tenga paciencia mientras Evolution migra sus carpetas..."
  <BLANKLINE>
  #: addressbook/gui/widgets/e-addressbook-model.c:151
  #, c-format
  msgid "%d contact"
  msgid_plural "%d contacts"
  msgstr[0] "%d contacto"
  msgstr[1] "%d contactos"
  <BLANKLINE>
  #: addressbook/gui/widgets/eab-gui-util.c:275
  #, c-format
  msgid ""
  "Opening %d contact will open %d new window as well.\n"
  "Do you really want to display this contact?"
  msgid_plural ""
  "Opening %d contacts will open %d new windows as well.\n"
  "Do you really want to display all of these contacts?"
  msgstr[0] ""
  "Abrir %d contacto abrirá %d ventanas nuevas también.\n"
  "¿Quiere realmente mostrar este contacto?"
  msgstr[1] ""
  "Abrir %d contactos abrirá %d ventanas nuevas también.\n"
  "¿Quiere realmente mostrar todos estos contactos?"
  <BLANKLINE>
  #: addressbook/gui/widgets/foo.c:345
  #, fuzzy
  msgid "%d foo"
  msgid_plural "%d bars"
  msgstr[0] "%d foo"
  msgstr[1] ""
  <BLANKLINE>
  # start po-group: common
  #: encfs/FileUtils.cpp:1044
  msgid "EncFS Password: "
  msgstr "Contraseña de EncFS: "
  <BLANKLINE>
  #: encfs/main.cpp:340
  msgid ""
  "When specifying daemon mode, you must use absolute paths (beginning with '/')"
  msgstr ""
  <BLANKLINE>
  #: encfs/FileUtils.cpp:535
  #, c-format
  msgid ""
  "Please select a key size in bits.  The cipher you have chosen\n"
  "supports sizes from %i to %i bits in increments of %i bits.\n"
  "For example: "
  msgstr ""
  <BLANKLINE>
  #: modules/aggregator.module:15
  msgid ""
  "\n"
  "      <p>Thousands of sites (particularly news sites and weblogs) publish "
  "their latest headlines and/or stories in a machine-readable format so that "
  "other sites can easily link to them. This content is usually in the form of "
  "an <a href=\"http://blogs.law.harvard.edu/tech/rss\">RSS</a> feed (which is "
  "an XML-based syndication standard).</p>\n"
  "      <p>You can read aggregated content from many sites using RSS feed "
  "readers, such as <a "
  "href=\"http://www.disobey.com/amphetadesk/\">Amphetadesk</a>.</p>\n"
  "      <p>Drupal provides the means to aggregate feeds from many sites and "
  "display these aggregated feeds to your site's visitors. To do this, enable "
  "the aggregator module in site administration and then go to the aggregator "
  "configuration page, where you can subscribe to feeds and set up other "
  "options.</p>\n"
  "      <h3>How do I find RSS feeds to aggregate?</h3>\n"
  "      <p>Many web sites (especially weblogs) display small XML icons or "
  "other obvious links on their home page. You can follow these to obtain the "
  "web address for the RSS feed. Common extensions for RSS feeds are .rss, .xml "
  "and .rdf. For example: <a href=\"http://slashdot.org/slashdot.rdf\">Slashdot "
  "RSS</a>.</p>\n"
  "      <p>If you can't find a feed for a site, or you want to find several "
  "feeds on a given topic, try an RSS syndication directory such as <a "
  "href=\"http://www.syndic8.com/\">Syndic8</a>.</p>\n"
  "      <p>To learn more about RSS, read Mark Pilgrim's <a "
  "href=\"http://www.xml.com/pub/a/2002/12/18/dive-into-xml.html\">What is "
  "RSS</a> and WebReference.com's <a "
  "href=\"http://www.webreference.com/authoring/languages/xml/rss/1/\">The "
  "Evolution of RSS</a> articles.</p>\n"
  "      <p>NOTE: Enable your site's XML syndication button by turning on the "
  "Syndicate block in block management.</p>\n"
  "      <h3>How do I add a news feed?</h3>\n"
  "      <p>To subscribe to an RSS feed on another site, use the <a href=\"% "
  "admin-news\">aggregation page</a>.</p>\n"
  "      <p>Once there, click the <a href=\"%new-feed\">new feed</a> tab. "
  "Drupal will then ask for the following:</p>\n"
  "      <ul>\n"
  "       <li><strong>Title</strong> -- The text entered here will be used in "
  "your news aggregator, within the administration configuration section, and "
  "as a title for the news feed block. As a general rule, use the web site name "
  "from which the feed originates.</li>\n"
  "       <li><strong>URL</strong> -- Here you'll enter the fully-qualified web "
  "address for the feed you wish to subscribe to.</li>\n"
  "       <li><strong>Update interval</strong> -- This is how often Drupal will "
  "scan the feed for new content. This defaults to every hour. Checking a feed "
  "more frequently that this is typically a waste of bandwidth and is "
  "considered somewhat impolite. For automatic updates to work, cron.php must "
  "be called regularly. If it is not, you'll have to manually update the feeds "
  "one at a time within the news aggregation administration page by using <a "
  "href=\"%update-items\">update items</a>.</li>\n"
  "       <li><strong>Latest items block</strong> -- The number of items "
  "selected here will determine how many of the latest items from the feed will "
  "appear in a block which may be enabled and placed in the <a "
  "href=\"%block\">blocks</a> administration page.</li>\n"
  "       <li><strong>Automatically file items</strong> -- As items are "
  "received from a feed they will be put in any categories you have selected "
  "here.</li>\n"
  "      </ul>\n"
  "      <p>Once you have submitted the new feed, check to make sure it is "
  "working properly by selecting <a href=\"%update-items\">update items</a> on "
  "the <a href=\"%admin-news\">aggregation page</a>. If you do not see any "
  "items listed for that feed, edit the feed and make sure that the URL was "
  "entered correctly.</p>\n"
  "      <h3>Adding categories</h3>\n"
  "      <p>News items can be filed into categories. To create a category, "
  "start at the <a href=\"%admin-news\">aggregation page</a>.</p>\n"
  "      <p>Once there, select <a href=\"%new-category\">new category</a> from "
  "the menu. Drupal will then ask for the following:</p>\n"
  "      <ul>\n"
  "       <li><strong>Title</strong> -- The title will be used in the <em>news "
  "by topics</em> listing in your news aggregator and for the block created for "
  "the bundle.</li>\n"
  "       <li><strong>Description</strong> -- A short description of the "
  "category to tell users more details about what news items they might find in "
  "the category.</li>\n"
  "       <li><strong>Latest items block</strong> -- The number of items "
  "selected here will determine how many of the latest items from the category "
  "will appear in a block which may be enabled and placed in the <a "
  "href=\"%block\">blocks</a> administration page.</li>\n"
  "      </ul>\n"
  "      <h3>Using the news aggregator</h3>\n"
  "      <p>The news aggregator has a number of ways that it displays your "
  "subscribed content:</p>\n"
  "      <ul>\n"
  "       <li><strong><a href=\"%news-aggregator\">News aggregator</a></strong> "
  "(latest news) -- Displays all incoming items in the order in which they were "
  "received.</li>\n"
  "       <li><strong><a href=\"%sources\">Sources</a></strong> -- Organizes "
  "incoming content by feed, displaying feed titles (each of which links to a "
  "page with the latest items from that feed) and item titles (which link to "
  "that item's actual story/article).</li>\n"
  "       <li><strong><a href=\"%categories\">Categories</a></strong> -- "
  "Organizes incoming content by category, displaying category titles (each of "
  "which links to a page with the latest items from that category) and item "
  "titles (which link to that item's actual story/article).</li>\n"
  "      </ul>\n"
  "      <p>Pages that display items (for sources, categories, etc.) display "
  "the following for each item:\n"
  "      <ul>\n"
  "       <li>The title of the item (its headline).</li>\n"
  "       <li>The categories that the item belongs to, each of which links to "
  "that particular category page as detailed above.</li>\n"
  "       <li>A description containing the first few paragraphs or a summary of "
  "the item (if available).</li>\n"
  "       <li>The name of the feed, which links to the individual feed's page, "
  "listing information about that feed and items for that feed only. This is "
  "not shown on feed pages (they would link to the page you're currently "
  "on).</li>\n"
  "      </ul>\n"
  "      <p>Additionally, users with the <em>administer news feeds "
  "permission</em> will see a link to categorize the news items. Clicking this "
  "will allow them to select which category(s) each news item is in.</p>\n"
  "      <h3>Technical details</h3>\n"
  "      <p>Drupal automatically generates an OPML feed file that is available "
  "by selecting the XML icon on the News Sources page.</p>\n"
  "      <p>When fetching feeds Drupal supports conditional GETs, this reduces "
  "the bandwidth usage for feeds that have not been updated since the last "
  "check.</p>\n"
  "      <p>If a feed is permanently moved to a new location Drupal will "
  "automatically update the feed URL to the new address.</p>"
  msgstr ""
  <BLANKLINE>
  #: lib/getopt.c:629 lib/getopt.c:641
  #, c-format
  msgid "%s: option `%s' is ambiguous\n"
  msgstr ""
  <BLANKLINE>
  #~ msgid "_Add Group"
  #~ msgstr "_Añadir grupo"

The value at X-Rosetta-Export-Date cannot be tested directly because it would
be a time bomb in our tests, so we parse the file again with our parser and
try to get a datetime object of its value.

  >>> from canonical.launchpad.components.poparser import POParser
  >>> parser = POParser()
  >>> parser.write(pofile)
  >>> parser.finish()
  >>> type(parser.header.getRosettaExportDate())
  <type 'datetime.datetime'>

We need to test also the feature that exports a po file without any obsolete
message

  >>> pofile = exporter.export_pofile(language, included_obsolete=False)
  >>> print pofile
  # traducción de es.po al Spanish
  ...
  msgid "evolution minicard"
  msgstr ""
  <BLANKLINE>
  #: addressbook/addressbook-errors.xml.h:2
  msgid "This addressbook could not be opened."
  ...
  #, c-format
  msgid "%s: option `%s' is ambiguous\n"
  msgstr ""

Now, we should check that languages that its pluralform is 1, export the
translations as expected.

  >>> template = POTemplate.get(4)
  >>> language = LanguageSet()['ja']

Adapt the template with to exporter.

  >>> from canonical.launchpad.components.poexport import POTemplateExporter
  >>> exporter = POTemplateExporter(template)

Then get the PO file from the exporter.

  >>> pofile = exporter.export_pofile(language)
  >>> print pofile
  # Japanese translation for evolution
  ...
  "Plural-Forms: nplurals=1; plural=(0);\n"
  ...
  #, c-format
  msgid "%d contact"
  msgid_plural "%d contacts"
  msgstr[0] "%d foo"
  <BLANKLINE>
  #: addressbook/gui/widgets/eab-gui-util.c:275
  ...

We had a bug that produce that a pofile export without variant, exports too
any other variant file because we forgot 'WHERE variant IS NULL' clause

  >>> from canonical.launchpad.database import POTemplate, LanguageSet
  >>> template = POTemplate.get(2)
  >>> language = LanguageSet()['es']

Adapt the template with to exporter.

  >>> from canonical.launchpad.components.poexport import POTemplateExporter
  >>> exporter = POTemplateExporter(template)

Then get the PO file from the exporter.

  >>> pofile = exporter.export_pofile(language)
  >>> print pofile
  # Spanish translation for mount removable devices as normal user
  ...
  msgid "Internal error: could not change effective group id to real group id"
  msgstr "Error interno: no es posible cambiar desde gid al gid real"

