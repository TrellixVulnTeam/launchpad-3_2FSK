= Resetting stores at the end of requests =

Storm allows objects to be used across transaction boundaries, but that
doesn't play well with Launchpad because we already have plenty of code
out there that cache things in instance variables, so if we don't reset
the stores these caches may end up being carried from one request to
another.

In tests, though, it's good to be able to use an object after we've
committed a transaction, so we decided not to reset stores when running
the test suite.

Since the web app is not run in the main thread (unlike the test suite)
we rely on that to find out whether or not to reset stores.

    >>> import threading
    >>> from storm.zope.interfaces import IZStorm
    >>> from canonical.launchpad.testing.pages import UnstickyCookieHTTPCaller
    >>> logout()
    >>> alive_items = None
    >>> thread_name = None
    >>> def request_salgados_homepage():
    ...     global alive_items
    ...     global thread_name
    ...     thread_name = threading.currentThread().getName()
    ...     http = UnstickyCookieHTTPCaller(port=9000)
    ...     http("GET /~salgado HTTP/1.1")
    ...     alive_items = len(getUtility(IZStorm).get("main")._alive)

    >>> request_salgados_homepage()
    >>> print thread_name
    MainThread
    >>> print alive_items > 0
    True

    >>> from threading import Thread
    >>> thread = Thread(target=request_salgados_homepage)
    >>> thread.start()
    >>> thread.join()
    >>> print thread_name != 'MainThread'
    True
    >>> print alive_items
    0
