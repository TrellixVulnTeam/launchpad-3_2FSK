Support Tracker Pages
=====================

Several views are used to handle the various operations on a ticket.

    >>> from zope.component import getView
    >>> from canonical.launchpad.webapp.servers import LaunchpadTestRequest
    >>> from canonical.launchpad.interfaces import IDistributionSet
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> ticket_three = ubuntu.getTicket(3)

TicketSubscriptionView
----------------------

This view is used to subscribe and unsubscribe from a ticket.
Subscription is done when the user click on the 'Subscribe' button.
    >>> login('test@canonical.com')
    >>> request = LaunchpadTestRequest(form={'subscribe': 'Subscribe'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+subscribe', request)
    >>> view.initialize()
    >>> ticket_three.isSubscribed(getUtility(ILaunchBag).user)
    True

A notification message is displayed and the view redirect to the ticket
view page.

    >>> for notice in request.notifications:
    ...     print notice.message
    You have subscribed to this request.
    >>> request.response.getHeader('Location')
    '.../+ticket/3'

Unsubscription works in a similar manner.

    >>> request = LaunchpadTestRequest(form={'subscribe': 'Unsubscribe'})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+subscribe', request)
    >>> view.initialize()
    >>> ticket_three.isSubscribed(getUtility(ILaunchBag).user)
    False
    >>> for notice in request.notifications:
    ...     print notice.message
    You have unsubscribed from this request.
    >>> request.response.getHeader('Location')
    '.../+ticket/3'

These two actions didn't generate any notification mails:

    >>> from canonical.launchpad.mail import stub
    >>> import transaction
    >>> transaction.commit()
    >>> len(stub.test_emails)
    0

TicketWorkflowView
------------------

However, if we reopen a request, it will cause a notification to be
sent:

    >>> login('foo.bar@canonical.com')
    >>> request = LaunchpadTestRequest(form={'reopen': ''})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+reopen', request)
    >>> view.initialize()
    >>> for notice in request.notifications:
    ...     print notice.message
    You have reopened this request.

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> import email
    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Status: Invalid => Open
    <BLANKLINE>

    >>> stub.test_emails = []

As well as if we reject it:

    >>> login('foo.bar@canonical.com')
    >>> request = LaunchpadTestRequest(form={'reject': ''})
    >>> request.method = 'POST'
    >>> view = getView(ticket_three, '+reject', request)
    >>> view.initialize()
    >>> for notice in request.notifications:
    ...     print notice.message
    You have rejected this request.

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Status: Open => Invalid
    <BLANKLINE>

    >>> stub.test_emails = []

Lastly, let's take a look at +addmessage. It's used to add a comment to
the ticket, as well as changing it's state to Answered, which only the
submitter can do.

It needs to be open, for us to changed it to Answered:

    >>> ticket_three.reopen(getUtility(ILaunchBag).user)
    <TicketReopening...>

And now we can change the status to Answered:

    >>> request = LaunchpadTestRequest(form={
    ...     'UPDATE_SUBMIT': '',
    ...     'field.subject': 'Re: Better Title',
    ...     'field.content': 'Thanks!',
    ...     'field.resolved': 'on'})
    >>> request.method = 'POST'
    >>> index = getView(ticket_three, '+addmessage', request)
    >>> index.update()
    ''
    >>> ticket_three.status.title
    'Answered'

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Status: Open => Answered
    <BLANKLINE>
    Comment:
    Thanks!

    >>> stub.test_emails = []

TicketMakeBugView
-----------------

The TicketMakeBugView is used to handle the creation of a bug from a
ticket. In addition to creating a bug, this operation will also link
the bug to the ticket.

If the user cancels a bug creation request, the user is redirected back
the ticket page.

    >>> request = LaunchpadTestRequest(form={'cancel': 'cancel'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> makebug.process_form()
    ''
    >>> list(ticket_three.bugs)
    []

If the user creates a bug, a "Linked to bug" notification is sent and
the user is subscribed to the bug.

    >>> request = LaunchpadTestRequest(
    ...     form={'create': 'create',
    ...           'field.title': 'Bug title',
    ...           'field.description': 'Bug description.'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> makebug.process_form()
    >>> sorted(bug.id for bug in ticket_three.bugs)
    [11L]
    >>> print ticket_three.bugs[0].title
    Bug title
    >>> print ticket_three.bugs[0].description
    Bug description.
    >>> print makebug.user.name
    name16
    >>> ticket_three.bugs[0].isSubscribed(makebug.user)
    True
    >>> [n.message for n in request.notifications]
    [u'Thank you! Bug #11 created.']

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
        Linked to bug: #11
    ...

    >>> stub.test_emails = []

If the ticket already has bugs linked to it, no new bug can be created.

    >>> request = LaunchpadTestRequest(form={'create': 'create'})
    >>> request.method = 'POST'
    >>> makebug = getView(ticket_three, '+makebug', request)
    >>> makebug.initialize()
    >>> for n in request.notifications:
    ...     print n.message
    You cannot create a bug report...

BugLinkView and BugsUnlinkView
------------------------------

Linking bug (+linkbug) to the ticket is managed through the BugLinkView
Unlinking bugs from the ticket is managed through the BugsUnlinkView.
See 'buglinktarget-pages.txt' for their documentation. The notifications
sent along linking and unlinking bugs can be found in
'support-tracker-notifications.txt'.

TicketEditView
--------------

To edit the title and description of a bug, +edit is used.

    >>> request = LaunchpadTestRequest(form={
    ...     'field.actions.change': 'Continue',
    ...     'field.title': 'Better Title',
    ...     'field.description': 'A better description.'})
    >>> request.method = 'POST'
    >>> index = getView(ticket_three, '+edit', request)
    >>> index.initialize()
    >>> ticket_three.title
    u'Better Title'
    >>> ticket_three.description
    u'A better description.'

    >>> transaction.commit()
    >>> len(stub.test_emails)
    1

    >>> notifications = [
    ...     email.message_from_string(raw_message)
    ...     for from_addr, to_addrs, raw_message in sorted(stub.test_emails)
    ...     ]
    >>> print notifications[0].get_payload(decode=True)
    Support request #3...
    ...
    Summary changed to:
    Better Title
    <BLANKLINE>
    Description changed to:
    A better description.
    <BLANKLINE>

    >>> stub.test_emails = []
