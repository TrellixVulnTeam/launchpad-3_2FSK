= Profiling support =

Launchpad supports two modes of profiling.

== Profiling requests in pagetests ==

Our testing framework has support for profiling requests made in
pagetests.  When the PROFILE_PAGETESTS_REQUESTS environment variable is
set, it will save profiling information in the file specified in that
variable.

The pagetests profiler is created at module initialization time by the
init_profiler() function.

    >>> import canonical.launchpad.testing.pages as pagetests_framework

(Save the existing one.)

    >>> import os
    >>> import tempfile

    >>> old_pagetests_profiler = pagetests_framework.profiler
    >>> old_profile_environ = os.environ.get(
    ...     'PROFILE_PAGETESTS_REQUESTS', '')

    >>> pagetests_profile_dir = tempfile.mkdtemp(prefix='pagetests_profile')
    >>> pagetests_profile = os.path.join(
    ...     pagetests_profile_dir, 'pagetests.prof')
    >>> os.environ['PROFILE_PAGETESTS_REQUESTS'] = pagetests_profile

    >>> pagetests_framework.init_profiler()
    >>> pagetests_framework.profiler
    <...Profile...>
    >>> len(pagetests_framework.profiler.getstats())
    0

Once there is a profiler configured, any call made using the
ProfiledHTTPCaller will be profiled.

    >>> from canonical.launchpad.testing.pages import ProfiledHTTPCaller

    # We need to close the default interaction.
    >>> logout()

    >>> http = ProfiledHTTPCaller()
    >>> response = http('GET / HTTP/1.0')
    >>> profile_count = len(pagetests_framework.profiler.getstats())
    >>> profile_count > 0
    True

Requests made with a testbrowser configured through setupBrowser will
also be profiled.

    >>> from canonical.launchpad.testing.pages import setupBrowser
    >>> browser = setupBrowser()
    >>> browser.open('http://launchpad.dev/')
    >>> len(pagetests_framework.profiler.getstats()) > profile_count
    True

At program exit, the write_profiler_stats() function is called that will
save the profile data in the requested file.

    >>> pagetests_framework.write_profiler_stats()
    >>> import pstats2
    >>> stats = pstats2.Stats(pagetests_profile)
    >>> os.remove(pagetests_profile)

When the environment isn't set, no profile is created.

    >>> del os.environ['PROFILE_PAGETESTS_REQUESTS']

    >>> pagetests_framework.init_profiler()
    >>> print pagetests_framework.profiler
    None

And no stats file is written at the program exit.

    >>> pagetests_framework.write_profiler_stats()
    >>> os.path.exists(pagetests_profile)
    False


== Profiling request in the app server ==

It is also possible to get a profile of each request served by the app
server.

This is controlled by the [profiling] config section. Profiling is
controlled by the profile_requests configuration variable. When this is
True, each request will create a pstats file for the request in the
directory specified in the profile_dir variable.

By default profiling is turned off.

    >>> from canonical.config import config
    >>> config.profiling.profile_requests
    False

(Set the profile directory.)

    >>> from textwrap import dedent
    >>> profile_dir = tempfile.mkdtemp(prefix='profile')
    >>> config.push('profile_dir', dedent("""
    ...     [profiling]
    ...     profile_dir: %s""" % profile_dir))

So when making a request, no profile information is created.

    >>> response = http('GET / HTTP/1.0')

    >>> list(os.listdir(profile_dir))
    []

But if profiling is turned on, profiling data will be created in the
directory for the request.

    >>> config.push('profile_on', dedent("""\
    ...     [profiling]
    ...     profile_requests: True"""))

    >>> response = http('GET / HTTP/1.0')

The profile is named on the time of the request start, the pageid, and
the thread that processed it.

    >>> profiles = os.listdir(profile_dir)
    >>> print "\n".join(profiles)
    20...-RootObject:index.html-MainThread.prof

These profile can be loaded using the pstats2 module.

    >>> import pstats2
    >>> stats = pstats2.Stats(os.path.join(profile_dir, profiles[0]))

Making another request will create another profile.

    >>> response = http('GET / HTTP/1.0')

    >>> profiles = os.listdir(profile_dir)
    >>> print "\n".join(profiles)
    20...-RootObject:index.html-MainThread.prof
    20...-RootObject:index.html-MainThread.prof


== Clean up ==

    >>> import shutil

    >>> os.environ['PROFILE_PAGETESTS_REQUESTS'] = old_profile_environ
    >>> pagetests_framework.profiler = old_pagetests_profiler

    >>> shutil.rmtree(pagetests_profile_dir)
    >>> shutil.rmtree(profile_dir)

    >>> old_config = config.pop('profile_dir')
