= TranslationsOverview =

This class provides a basic overview of the Launchpad Translations component.
It includes data such as projects which have so far received most translations
and provides an easy way to figure out projects a certain person has most
translated for.

In order to be able to update KarmaCache table *and* to be able to do the
regular queries (without slowing down the test by running
cronscripts/foaf-update-karma-cache.py directly), we need to be logged in
as a 'testadmin'.

    >>> from canonical.launchpad.ftests.harness import (
    ...     LaunchpadFunctionalTestSetup)
    >>> LaunchpadFunctionalTestSetup(dbuser='testadmin').setUp()

We carry on the basic set-up as well, preparing commonly used utilities.

    >>> from canonical.database.sqlbase import flush_database_updates
    >>> from canonical.launchpad.database import (
    ...     KarmaCache, KarmaCategory, SourcePackageName)
    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet, IKarmaCache, IKarmaCacheManager, IPersonSet,
    ...     IProductSet, ITranslationsOverview)
    >>> karmacachemanager = getUtility(IKarmaCacheManager)
    >>> person_set = getUtility(IPersonSet)
    >>> product_set = getUtility(IProductSet)

    >>> overview = getUtility(ITranslationsOverview)

ITranslationOverview defines two constants regulating minimum and maximum
contribution weights.

    >>> overview.MINIMUM_SIZE
    10
    >>> overview.MAXIMUM_SIZE
    18

== _normalizeSizes ==

This private method accepts a list of tuples (object, size) and
normalizes `size` values into the range [MINIMUM_SIZE, MAXIMUM_SIZE].

    >>> test_list = [('one', 3), ('two', 0), ('three', 1)]
    >>> from zope.security.proxy import removeSecurityProxy
    >>> result = removeSecurityProxy(overview)._normalizeSizes(test_list, 0, 3)
    >>> for pillar in result:
    ...     print "%s: %d" % (pillar['pillar'], pillar['font_size'])
    one: 18
    two: 10
    three: 13

== getMostTranslatedPillars ==

Returns a list of dicts listing pillars with most translations karma so far,
along with a relative weight for each of the pillars in the range of
[overview.MINIMUM_SIZE, overview.MAXIMUM_SIZE].

    >>> def display_pillars(pillars):
    ...     for pillar in pillars:
    ...         print "%s: %d" % (
    ...             pillar['pillar'].displayname, pillar['font_size'])
    >>> display_pillars(overview.getMostTranslatedPillars())
    ...     print "%s: %d" % (pillar['pillar'].displayname, pillar['font_size'])
    Evolution: 14

We are adding some translations karma attributed to Carlos for alsa-utils

    >>> carlos = person_set.getByName('carlos')
    >>> translations = KarmaCategory.byName('translations')
    >>> alsa_utils = product_set.getByName('alsa-utils')

    >>> cache_entry = karmacachemanager.new(
    ...     120, carlos.id, translations.id, product_id=alsa_utils.id)

This will make alsa-utils displayed among the top translated pillars as well.

    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 10
    Evolution: 18

When karma is increased for alsa-utils, it will get more weight than
Evolution.

    >>> cache_entry = karmacachemanager.updateKarmaValue(
    ...     1020, carlos.id, translations.id, product_id=alsa_utils.id)
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 18
    Evolution: 10

Adding a little bit of karma to upstart will put it in the list as well.

    >>> upstart = product_set.getByName('upstart')
    >>> removeSecurityProxy(upstart).official_rosetta = True
    >>> flush_database_updates()
    >>> cache_entry = karmacachemanager.new(
    ...     50, carlos.id, translations.id, product_id=upstart.id)
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 18
    Evolution: 13
    Upstart: 10

Distributions with a lot of translation contributions show in the same
list as well.

    >>> ubuntu = getUtility(IDistributionSet).getByName("ubuntu")
    >>> evolution_sourcepackagename = SourcePackageName.byName("evolution")
    >>> cache_entry = karmacachemanager.new(
    ...     5150, carlos.id, translations.id, distribution_id=ubuntu.id,
    ...     sourcepackagename_id=evolution_sourcepackagename.id)
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 15
    Evolution: 12
    Ubuntu: 18
    Upstart: 10

Changing the range of the contribution weights relative project weights will
automatically adjust as well.

    >>> removeSecurityProxy(overview).MINIMUM_SIZE = 20
    >>> removeSecurityProxy(overview).MAXIMUM_SIZE = 24
    >>> display_pillars(overview.getMostTranslatedPillars())
    alsa-utils: 23
    Evolution: 21
    Ubuntu: 24
    Upstart: 20
