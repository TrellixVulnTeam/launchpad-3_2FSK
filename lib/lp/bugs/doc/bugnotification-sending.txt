= Sending the Bug Notifications =

As explained in bugnotifications.txt, a change to a bug causes a bug
notification to be added. These notifications should be assembled into
an email notification, and sent to the appropriate people.

Before we start, let's ensure that there are no pending notifications to
be sent:

    >>> import pytz
    >>> from datetime import datetime, timedelta
    >>> now = datetime.now(pytz.timezone('UTC'))
    >>> ten_minutes_ago = now - timedelta(minutes=10)
    >>> from canonical.launchpad.interfaces import IBugNotificationSet
    >>> len(getUtility(IBugNotificationSet).getNotificationsToSend())
    0

And let's define functions to make printing out the notifications
easier.

    >>> def print_notification_headers(email_notification):
    ...     for header in ['To', 'From', 'Subject',
    ...                    'X-Launchpad-Message-Rationale']:
    ...         print "%s: %s" % (header, email_notification[header])

    >>> def print_notification(email_notification):
    ...     print_notification_headers(email_notification)
    ...     print
    ...     print email_notification.get_payload(decode=True)
    ...     print "-" * 70

You'll note that we are printing out an X-Launchpad-Message-Rationale
header. This header is a simple string that allows people to filter
bugmail according to the reason they are getting emailed. For instance,
the person may want to specially filter mail for bugs which they are
assigned to.

Anyway, let's start our demonstration by adding a comment to a bug:

    >>> login('test@canonical.com')
    >>> from canonical.launchpad.interfaces import IBugSet, IMessageSet
    >>> bug_one = getUtility(IBugSet).get(1)
    >>> sample_person = getUtility(ILaunchBag).user
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)

    >>> notifications = getUtility(IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    1

If we pass these notifications to get_email_notifications, we get a
list of emails to send:

    >>> from lp.bugs.scripts.bugnotification import (
    ...     get_email_notifications)
    >>> email_notifications = get_email_notifications(notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Subscriber (mozilla-firefox in ubuntu)
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    ...
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: mark@example.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Assignee
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    ...
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a bug assignee.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    ...
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

You can see that the message above contains the bug's initial comment's
message id as its reference, in order to make it thread properly in the
email client.

    >>> print bug_one.initial_message.rfc822msgid
    sdsdfsfd

The notification is still pending to be sent, since date_emailed is
still None:

    >>> notifications[0].date_emailed is None
    True
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> list(pending_notifications) == list(notifications)
    True

Setting date_emailed to some date causes it not to be pending anymore:

    >>> from canonical.database.sqlbase import flush_database_updates
    >>> notifications[0].date_emailed = datetime.now(pytz.timezone('UTC'))
    >>> flush_database_updates()
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    0

Let's define a helper function to do that for all pending notifications:

    >>> def flush_notifications():
    ...     utc_now = datetime.now(pytz.timezone('UTC'))
    ...     pending_notifications = getUtility(
    ...         IBugNotificationSet).getNotificationsToSend()
    ...     for notification in pending_notifications:
    ...         notification.date_emailed = utc_now
    ...     flush_database_updates()


To every message that gets sent out, [Bug $bugid] is prefixed to the
subject. It gets prefixed only if it's not already present in the
subject, though, which is often the case when someone replies via email.

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'Re: [Bug 1] subject', 'a new comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: Re: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a new comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

    >>> flush_notifications()

Let's add a few changes and see how it looks like:

    >>> bug_one.addChangeNotification(
    ...     '** Summary changed to: New summary.', sample_person,
    ...     when=ten_minutes_ago)
    >>> bug_one.addChangeNotification(
    ...     '** Visibility changed to: Private.', sample_person,
    ...     when=ten_minutes_ago)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    2

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    ** Summary changed to: New summary.
    <BLANKLINE>
    ** Visibility changed to: Private.
    <BLANKLINE>
    ...
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

If we insert a comment and some more changes, they will be included in
the constructed email:

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a new comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> bug_one.addChangeNotification(
    ...     '** Summary changed to: Another summary.', sample_person,
    ...     when=ten_minutes_ago)
    >>> bug_one.addChangeNotification(
    ...     '** Visibility changed to: Public.', sample_person,
    ...     when=ten_minutes_ago)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    5

Notice how the comment is in the top of the email, and the changes are
in the order they were added:

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a new comment.
    <BLANKLINE>
    ** Summary changed to: New summary.
    <BLANKLINE>
    ** Visibility changed to: Private.
    <BLANKLINE>
    ** Summary changed to: Another summary.
    <BLANKLINE>
    ** Visibility changed to: Public.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

If we insert yet another comment, it will be sent as a separate email.

    >>> new_comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'another comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(new_comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    6

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a new comment.
    <BLANKLINE>
    ** Summary changed to: New summary.
    <BLANKLINE>
    ** Visibility changed to: Private.
    <BLANKLINE>
    ** Summary changed to: Another summary.
    <BLANKLINE>
    ** Visibility changed to: Public.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    another comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

    >>> flush_notifications()

If we add three comments, three notifications will be sent:

    >>> new_comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(new_comment)
    >>> new_comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'another comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(new_comment)
    >>> new_comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'yet another comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(new_comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    3

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    another comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    yet another comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

    >>> flush_notifications()

If Sample Person does a few changes, and Foo Bar steps in and does a
change in between, three notifications will be sent:

    >>> from canonical.launchpad.interfaces import IPersonSet
    >>> foo_bar = getUtility(IPersonSet).getByEmail('foo.bar@canonical.com')
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> bug_one.addChangeNotification(
    ...     '** Summary changed to: New summary.', foo_bar,
    ...     when=ten_minutes_ago)
    >>> bug_one.addChangeNotification(
    ...     '** Visibility changed to: Private.', sample_person,
    ...     when=ten_minutes_ago)

    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    3

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    ** Summary changed to: New summary.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    To: foo.bar@canonical.com
    ...
    To: mark@example.com
    ...
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    ** Visibility changed to: Private.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...

    >>> flush_notifications()

We send the notification only if the user hasn't done any other changes
for the last 5 minutes:

    >>> now = datetime.now(pytz.timezone('UTC'))
    >>> for minutes_ago in reversed(range(10)):
    ...     bug_one.addChangeNotification(
    ...         '** Visibility changed to: Private.', sample_person,
    ...         when=now - timedelta(minutes=minutes_ago))
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    0

    >>> flush_notifications()

A more complicated example, Sample Person does a change every minute,
but Foo Bar does a change in between:

    >>> now = datetime.now(pytz.timezone('UTC'))
    >>> for minutes_ago in reversed(range(10)):
    ...     if minutes_ago == 6:
    ...         bug_one.addChangeNotification(
    ...             '** Visibility changed to: Public.', foo_bar,
    ...             when=now - timedelta(minutes=minutes_ago))
    ...     bug_one.addChangeNotification(
    ...         '** Visibility changed to: Private.', sample_person,
    ...         when=now - timedelta(minutes=minutes_ago))
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    4
    >>> for notification in pending_notifications:
    ...     print notification.id, notification.message.owner.displayname
    25 Sample Person
    26 Sample Person
    27 Sample Person
    28 Foo Bar

    >>> flush_notifications()

Let's take a more complete example, where we edit different bugs as
well:

    >>> bug_two = getUtility(IBugSet).get(2)
    >>> long_comment = getUtility(IMessageSet).fromText(
    ...     'subject',
    ...     'This is a long comment, which is longer than 72 characters.'
    ...     ' This should result in the lined being wrapped, so that it'
    ...     " won't be displayed as a single long line. Let's add another"
    ...     ' sentence just to make it longer.'
    ...     '\r\n\r\n'
    ...     "Let's add another paragraph to the comment as well, separating"
    ...     " it with dos-style line endings.",
    ...     foo_bar, datecreated=now - timedelta(minutes=6))
    >>> for minutes_ago in reversed(range(10)):
    ...     if minutes_ago == 6:
    ...         bug_one.addChangeNotification(
    ...             '** Visibility changed to: Public.', foo_bar,
    ...             when=now - timedelta(minutes=minutes_ago))
    ...         bug_one.addCommentNotification(long_comment)
    ...         bug_two.addChangeNotification(
    ...             '** Visibility changed to: Public.', foo_bar,
    ...             when=now - timedelta(minutes=minutes_ago))
    ...     bug_one.addChangeNotification(
    ...         '** Visibility changed to: Private.', sample_person,
    ...         when=now - timedelta(minutes=minutes_ago))
    ...     bug_two.addChangeNotification(
    ...         '** Visibility changed to: Private.', sample_person,
    ...         when=now - timedelta(minutes=minutes_ago))
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    9

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification_headers(message)
    ...         print
    To: mark@example.com
    From: Sample Person <2@bugs.launchpad.net>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Registrant (Debian)
    <BLANKLINE>
    To: support@ubuntu.com
    From: Sample Person <2@bugs.launchpad.net>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Registrant (Tomcat) @ubuntu-team
    <BLANKLINE>
    To: test@canonical.com
    From: Sample Person <2@bugs.launchpad.net>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Assignee
    <BLANKLINE>
    To: mark@example.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Registrant (Debian)
    <BLANKLINE>
    To: support@ubuntu.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Registrant (Tomcat) @ubuntu-team
    <BLANKLINE>
    To: test@canonical.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 2] Re: Blackhole Trash folder
    X-Launchpad-Message-Rationale: Assignee
    <BLANKLINE>
    To: foo.bar@canonical.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Subscriber (mozilla-firefox in ubuntu)
    <BLANKLINE>
    To: mark@example.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Assignee
    <BLANKLINE>
    To: support@ubuntu.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    To: test@canonical.com
    From: Sample Person <1@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>
    To: foo.bar@canonical.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Subscriber (mozilla-firefox in ubuntu)
    <BLANKLINE>
    To: mark@example.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Assignee
    <BLANKLINE>
    To: support@ubuntu.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    To: test@canonical.com
    From: Foo Bar <foo.bar@canonical.com>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>

There's a blank line before the signature, and the signature marker has
a trailing space.

    >>> message.get_payload(decode=True).splitlines()
    ['This is a long comment, which is longer than 72 characters. This should',
     "result in the lined being wrapped, so that it won't be displayed as a",
     "single long line. Let's add another sentence just to make it longer.",
     '',
     "Let's add another paragraph to the comment as well, separating it with",
     'dos-style line endings.',
     '',
     '** Visibility changed to: Public.',
     '',
     '-- ',
     'Firefox does not support SVG',
     'http://bugs.launchpad.dev/bugs/1',
     'You received this bug notification because you are a direct subscriber',
     'of the bug.']

    >>> flush_notifications()

If a team without a contact address is subscribed to the bug, the
notification will be sent to all members individually.

    >>> shipit_admins = getUtility(IPersonSet).getByName('shipit-admins')
    >>> shipit_admins.preferredemail is None
    True
    >>> for member in shipit_admins.activemembers:
    ...     print member.preferredemail.email
    marilize@hbd.com

    >>> bug_one.subscribe(shipit_admins, shipit_admins)
    <...>

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(pending_notifications)
    1

    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print message['To']
    foo.bar@canonical.com
    marilize@hbd.com
    mark@example.com
    support@ubuntu.com
    test@canonical.com

    >>> flush_notifications()


== Duplicates ==

We will need some helper functions.

    >>> from canonical.config import config
    >>> from canonical.database.sqlbase import commit
    >>> from canonical.testing import LaunchpadZopelessLayer

    >>> def switch_db_to_launchpad():
    ...     commit()
    ...     LaunchpadZopelessLayer.switchDbUser('launchpad')

    >>> def switch_db_to_bugnotification():
    ...     commit()
    ...     LaunchpadZopelessLayer.switchDbUser(
    ...         config.malone.bugnotification_dbuser)

We will also need a fresh new bug.

    >>> from canonical.launchpad.interfaces import (
    ...     IDistributionSet, CreateBugParams)
    >>> ubuntu = getUtility(IDistributionSet).getByName('ubuntu')
    >>> description = getUtility(IMessageSet).fromText(
    ...     'subject', 'a description of the bug.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> params = CreateBugParams(
    ...     msg=description, owner=sample_person, title='new bug')

    >>> switch_db_to_launchpad()
    >>> new_bug = ubuntu.createBug(params)
    >>> switch_db_to_bugnotification()
    >>> flush_notifications()

If a bug is a duplicate of another bug, a marker gets inserted at the
top of the email:

    >>> switch_db_to_launchpad()
    >>> new_bug.markAsDuplicate(bug_one)
    >>> switch_db_to_bugnotification()
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> new_bug.addCommentNotification(comment)
    >>> notifications = getUtility(IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    1

    >>> for bug_notifications, messages in get_email_notifications(notifications):
    ...     for message in messages:
    ...         print_notification(message)
    To: support@ubuntu.com
    From: Sample Person <16@bugs.launchpad.net>
    Subject: [Bug 16] subject
    X-Launchpad-Message-Rationale: Registrant (Ubuntu) @ubuntu-team
    <BLANKLINE>
    *** This bug is a duplicate of bug 1 ***
        http://bugs.launchpad.dev/bugs/1
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    --
    new bug
    http://bugs.launchpad.dev/bugs/16
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    From: Sample Person <16@bugs.launchpad.net>
    Subject: [Bug 16] subject
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>
    *** This bug is a duplicate of bug 1 ***
        http://bugs.launchpad.dev/bugs/1
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    --
    new bug
    http://bugs.launchpad.dev/bugs/16
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

    >>> flush_notifications()


== Security Vulnerabilities ==

When a new security related bug is filed, a small notification is
inserted at the top of the message body.

    >>> sec_vuln_description = getUtility(IMessageSet).fromText(
    ...     'Zero-day on Frobulator', 'Woah.', sample_person,
    ...     datecreated=ten_minutes_ago)

    >>> switch_db_to_launchpad()
    >>> sec_vuln_bug = ubuntu.createBug(CreateBugParams(
    ...         msg=sec_vuln_description, owner=sample_person,
    ...         title='Zero-day on Frobulator',
    ...         security_related=True, private=True))
    >>> switch_db_to_bugnotification()

    >>> sec_vuln_bug.security_related
    True
    >>> sec_vuln_bug.private
    True

    >>> notifications = (
    ...     getUtility(IBugNotificationSet).getNotificationsToSend())
    >>> email_notifications = get_email_notifications(notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: support@ubuntu.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug ...] [NEW] Zero-day on Frobulator
    X-Launchpad-Message-Rationale: Subscriber @ubuntu-team
    <BLANKLINE>
    *** This bug is a security vulnerability ***
    <BLANKLINE>
    ...

    >>> flush_notifications()

The message is only inserted for new bugs, not for modified bugs:

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> sec_vuln_bug.addCommentNotification(comment)

    >>> notifications = (
    ...     getUtility(IBugNotificationSet).getNotificationsToSend())
    >>> email_notifications = get_email_notifications(notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: support@ubuntu.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug ...] subject
    X-Launchpad-Message-Rationale: Subscriber @ubuntu-team
    <BLANKLINE>
    a comment.
    <BLANKLINE>
    ...

    >>> flush_notifications()


== The cronscript ==

There's a cronsript which does the sending of the email. Let's add a
few notifications to show that it works.

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> bug_one.addChangeNotification(
    ...     '** Summary changed to: New summary.', sample_person,
    ...     when=ten_minutes_ago)
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'another comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> bug_one.addChangeNotification(
    ...     '** Summary changed to: Old summary.', sample_person,
    ...     when=ten_minutes_ago)

    >>> bug_two = getUtility(IBugSet).get(2)
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_two.addCommentNotification(comment)
    >>> bug_two.addChangeNotification(
    ...     '** Summary changed to: New summary.', sample_person,
    ...     when=ten_minutes_ago)

    >>> notifications = getUtility(IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    6

We need to commit the transaction so that the cronscript will see the
notifications.

    >>> import transaction
    >>> transaction.commit()

Now, let's run the cronscript and look at the output. Passing -v to it
makes it write out the emails it sends.

    >>> import subprocess
    >>> process = subprocess.Popen(
    ...     'cronscripts/send-bug-notifications.py -v', shell=True,
    ...     stdin=subprocess.PIPE, stdout=subprocess.PIPE,
    ...     stderr=subprocess.PIPE)
    >>> (out, err) = process.communicate()
    >>> process.returncode
    0
    >>> print err
    INFO    Creating lockfile: /var/lock/launchpad-send-bug-notifications.lock
    INFO    Notifying mark@example.com about bug 2.
    ...
    INFO    Notifying support@ubuntu.com about bug 2.
    ...
    INFO    Notifying test@canonical.com about bug 2.
    ...
    From: Sample Person <...@bugs.launchpad.net>
    To: test@canonical.com
    Reply-To: Bug 2 <2@bugs.launchpad.net>
    ...
    References: foo@example.com-332342--1231
    ...
    X-Launchpad-Message-Rationale: Assignee
    ...
    INFO    Notifying foo.bar@canonical.com about bug 1.
    ...
    From: Sample Person <...@bugs.launchpad.net>
    To: foo.bar@canonical.com
    Reply-To: Bug 1 <1@bugs.launchpad.net>
    ...
    References: sdsdfsfd
    ...
    X-Launchpad-Message-Rationale: Subscriber (mozilla-firefox in ubuntu)
    ...
    INFO    Notifying marilize@hbd.com about bug 1.
    ...
    INFO    Notifying mark@example.com about bug 1.
    ...
    INFO    Notifying support@ubuntu.com about bug 1.
    ...
    INFO    Notifying test@canonical.com about bug 1.
    ...
    INFO    Notifying foo.bar@canonical.com about bug 1.
    ...
    From: Sample Person <...@bugs.launchpad.net>
    To: foo.bar@canonical.com
    Reply-To: Bug 1 <1@bugs.launchpad.net>
    ...
    References: sdsdfsfd
    ...
    X-Launchpad-Message-Rationale: Subscriber (mozilla-firefox in ubuntu)
    Errors-To: bounces@canonical.com
    Return-Path: bounces@canonical.com
    Precedence: bulk
    ...
    <BLANKLINE>
    another comment.
    <BLANKLINE>
    ** Summary changed to: Old summary.
    <BLANKLINE>
    -- =
    <BLANKLINE>
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    INFO    Notifying marilize@hbd.com about bug 1.
    ...
    INFO    Notifying mark@example.com about bug 1.
    ...
    INFO    Notifying support@ubuntu.com about bug 1.
    ...
    INFO    Notifying test@canonical.com about bug 1.
    ...

    >>> flush_notifications()


== The X-Launchpad-Bug header ==

When a notification is sent out about a bug, the X-Launchpad-Bug header is
filled with data about that bug:

    >>> bug_three = getUtility(IBugSet).get(3)
    >>> subscription = bug_three.subscribe(sample_person, sample_person)

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a short comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_three.addCommentNotification(comment)
    >>> notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    1

If we take a closer look at a notification, we can see that
X-Launchpad-Bug headers were added:

    >>> email_notifications = get_email_notifications(notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         sorted(message.get_all('X-Launchpad-Bug'))
    [u'distribution=debian; distroseries=sarge;... milestone=3.1;...',
     u'distribution=debian; distroseries=woody;...',
     u'distribution=debian; sourcepackage=mozilla-firefox; component=...']

The milestone field in X-Launchpad-Bug won't be filled where no milestone is
specified:

    >>> for line in sorted(message.get_all('X-Launchpad-Bug')):
    ...     'milestone' in line
    True
    False
    False


== The X-Launchpad-Bug-Tags header ==

First, a helper function that triggers notifications by adding a
comment to a given bug, another that returns a sorted list of new
email messages, and a third that combines the first two.

    >>> def trigger_notifications(bug):
    ...     comment = getUtility(IMessageSet).fromText(
    ...         'subject', 'a short comment.', sample_person,
    ...         datecreated=ten_minutes_ago)
    ...     bug.addCommentNotification(comment)
    ...     return getUtility(
    ...         IBugNotificationSet).getNotificationsToSend()

    >>> def get_email_messages(notifications):
    ...     messages = (message
    ...         for bug_notifications, messages in
    ...             get_email_notifications(notifications)
    ...         for message in messages)
    ...     return sorted(messages, key=lambda message: message['To'])

    >>> def trigger_and_get_email_messages(bug):
    ...     flush_notifications()
    ...     notifications = trigger_notifications(bug)
    ...     return get_email_messages(notifications)

If a bug is tagged, those tags will be included in the message in the
X-Launchpad-Bug-Tags header.

    >>> bug_three.tags
    [u'layout-test']

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     message.get_all('X-Launchpad-Bug-Tags')
    [u'layout-test']
    [u'layout-test']

If we add a tag to bug three that will also be included in the header.
The tags will be space-separated to allow the list to be wrapped if it
gets over-long.

    >>> switch_db_to_launchpad()

    >>> bug_three.unsubscribe(sample_person, sample_person)
    >>> bug_three.tags = [u'layout-test', u'another-tag', u'yet-another']

    >>> switch_db_to_bugnotification()

    >>> bug_three = getUtility(IBugSet).get(3)
    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     message.get_all('X-Launchpad-Bug-Tags')
    [u'another-tag layout-test yet-another']

If we remove the tags from the bug, the X-Launchpad-Bug-Tags header
won't be included.

    >>> switch_db_to_launchpad()
    >>> bug_three.tags = []
    >>> switch_db_to_bugnotification()

    >>> bug_three = getUtility(IBugSet).get(3)
    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     message.get_all('X-Launchpad-Bug-Tags')


== The X-Launchpad-Bug-Private header ==

When a notification is sent out about a bug, the
X-Launchpad-Bug-Private header shows if the bug is marked as
private. It can have the value "yes" or "no".

    >>> bug_three.private
    False

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message['To'], message.get_all('X-Launchpad-Bug-Private')
    mark@example.com ['no']

Predictably, private bugs are sent with a slightly different header:

    >>> bug_three.setPrivate(True, sample_person)
    True
    >>> bug_three.private
    True

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message['To'], message.get_all('X-Launchpad-Bug-Private')
    mark@example.com ['yes']


== The X-Launchpad-Bug-Security-Vulnerability header ==

When a notification is sent out about a bug, the
X-Launchpad-Bug-Security-Vulnerability header records if the bug is a
security vulnerability. It can have the value "yes" or "no".

    >>> bug_three.security_related
    False

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message['To'], (
    ...         message.get_all('X-Launchpad-Bug-Security-Vulnerability'))
    mark@example.com ['no']

The presence of the security flag on a bug is, surprise, denoted by a
simple "yes":

    >>> bug_three.setSecurityRelated(True)
    True
    >>> bug_three.security_related
    True

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message['To'], (
    ...         message.get_all('X-Launchpad-Bug-Security-Vulnerability'))
    mark@example.com ['yes']


== The X-Launchpad-Bug-Commenters header ==

The X-Launchpad-Bug-Recipient-Commented header lists all user IDs of
people who have ever commented on the bug. It's a space-separated
list.

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message.get('X-Launchpad-Bug-Commenters')
    name12

    >>> from lp.bugs.interfaces.bugmessage import IBugMessageSet
    >>> getUtility(IBugMessageSet).createMessage(
    ...     'Hungry', bug_three, foo_bar, "Make me a sandwich.")
    <BugMessage ...>

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message.get('X-Launchpad-Bug-Commenters')
    name12 name16

It only lists each user once, no matter how many comments they've
made.

    >>> getUtility(IBugMessageSet).createMessage(
    ...     'Hungry', bug_three, foo_bar, "Make me a sandwich.")
    <BugMessage ...>

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message.get('X-Launchpad-Bug-Commenters')
    name12 name16


== The X-Launchpad-Bug-Reporter header ==

The X-Launchpad-Bug-Reporter header contains information about the Launchpad
user who originally reported the bug and opened the bug's first bug task.

    >>> for message in trigger_and_get_email_messages(bug_three):
    ...     print message.get('X-Launchpad-Bug-Reporter')
    Foo Bar (name16)


== Verbose bug notifications ==

It is possible for users to have all the bug notifications which they
receive include the bug description and status. This helps in those
cases where the user doesn't save bug notifications, which can make
subsequent notifications seem somewhat obscure.

To demonstrate verbose notifications, we'll create a bug, and subscribe
some very picky users to it. Verbose Person wants verbose emails, while
Concise Person does not. We'll also create teams and give them members
with different verbose_bugnotifications settings.

    >>> switch_db_to_launchpad()
    >>> bug = factory.makeBug(
    ...     product=factory.makeProduct(title='Foo'), title='Foo is broken',
    ...     description='desc')

    >>> verbose_person = factory.makePerson(
    ...     displayname='Verbose Person', email='verbose@example.com')
    >>> verbose_person.verbose_bugnotifications = True
    >>> bug.subscribe(verbose_person, verbose_person)
    <BugSubscription...>

    >>> concise_person = factory.makePerson(
    ...     displayname='Concise Person', email='concise@example.com')
    >>> concise_person.verbose_bugnotifications = False
    >>> bug.subscribe(concise_person, concise_person)
    <BugSubscription...>


Concise Team doesn't want verbose notifications, while Concise Team
Person, a member, does.

    >>> concise_team = factory.makeTeam(
    ...     name='conciseteam', displayname='Concise Team')
    >>> concise_team.verbose_bugnotifications = False
    >>> concise_team_person = factory.makePerson(
    ...     displayname='Concise Team Person',
    ...     email='conciseteam@example.com')
    >>> concise_team_person.verbose_bugnotifications = True
    >>> ignored = concise_team.addMember(
    ...     concise_team_person, concise_team_person)
    >>> bug.subscribe(concise_team, concise_team_person)
    <BugSubscription...>

Verbose Team wants verbose notifications, while Verbose Team Person, a
member, does not.

    >>> verbose_team = factory.makeTeam(
    ...     name='verboseteam', displayname='Verbose Team')
    >>> verbose_team.verbose_bugnotifications = True
    >>> verbose_team_person = factory.makePerson(
    ...     displayname='Verbose Team Person',
    ...     email='verboseteam@example.com')
    >>> verbose_team_person.verbose_bugnotifications = False
    >>> ignored = verbose_team.addMember(
    ...     verbose_team_person, verbose_team_person)
    >>> bug.subscribe(verbose_team, verbose_team_person)
    <BugSubscription...>

We'll expire all existing notifications since we're not interested in
them:

    >>> switch_db_to_bugnotification()
    >>> notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    1

    >>> from canonical.launchpad.ftests import syncUpdate
    >>> for notification in notifications:
    ...     notification.date_emailed = datetime.now(pytz.timezone('UTC'))
    ...     syncUpdate(notification)


If we then add a comment to the bug, the subscribers will receive
notifications containing that comment.

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'a really simple comment.', verbose_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug.addCommentNotification(comment)

    >>> notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> len(notifications)
    1

If we pass this notifcation to get_email_notifications we can see that
Verbose Person and Team Person will receive notifications which contain
the bug description and the status in all of its targets. All other
subscribers will receive standard notifications that don't include the
bug description. To help with demonstrating this, we'll define a helper
function.

    >>> def collate_messages_by_recipient(messages):
    ...     messages_by_recipient = {}
    ...     for message in messages:
    ...         recipient = message['To']
    ...         if recipient in messages_by_recipient:
    ...             messages_by_recipient[recipient].append(message)
    ...         else:
    ...             messages_by_recipient[recipient] = [message]
    ...     return messages_by_recipient

    >>> from itertools import chain
    >>> collated_messages = collate_messages_by_recipient(
    ...     chain(*(messages for bug_notifications, messages in
    ...             get_email_notifications(notifications))))

We can see that Concise Person doesn't receive verbose notifications:

    >>> print_notification(collated_messages['concise@example.com'][0])
    To: concise@example.com
    From: Verbose Person <verbose@example.com>
    Subject: [Bug ...] subject
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>
    a really simple comment.
    <BLANKLINE>
    --
    Foo is broken
    http://bugs.launchpad.dev/bugs/...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

Neither does Verbose Team Person - while the team wants verbose emails,
he wants concise ones.

    >>> print_notification(collated_messages['verboseteam@example.com'][0])
    To: verboseteam@example.com
    From: Verbose Person <verbose@example.com>
    Subject: [Bug ...] subject
    X-Launchpad-Message-Rationale: Subscriber @verboseteam
    <BLANKLINE>
    a really simple comment.
    <BLANKLINE>
    --
    Foo is broken
    http://bugs.launchpad.dev/bugs/...
    You received this bug notification because you are a member of Verbose
    Team, which is a direct subscriber.
    <BLANKLINE>
    ----------------------------------------------------------------------

Whereas Verbose Person does get the description and task status:

    >>> print_notification(collated_messages['verbose@example.com'][0])
    To: verbose@example.com
    From: Verbose Person <verbose@example.com>
    Subject: [Bug ...] subject
    X-Launchpad-Message-Rationale: Subscriber
    <BLANKLINE>
    a really simple comment.
    <BLANKLINE>
    --
    Foo is broken
    http://bugs.launchpad.dev/bugs/...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    Status in Foo: New
    <BLANKLINE>
    Bug description:
    desc
    <BLANKLINE>
    To unsubscribe from this bug, go to:
    http://bugs.launchpad.dev/.../+bug/.../+subscribe
    <BLANKLINE>
    ----------------------------------------------------------------------

And Concise Team Person does too, even though his team doesn't want them: 

    >>> print_notification(collated_messages['conciseteam@example.com'][0])
    To: conciseteam@example.com
    From: Verbose Person <verbose@example.com>
    Subject: [Bug ...] subject
    X-Launchpad-Message-Rationale: Subscriber @conciseteam
    <BLANKLINE>
    a really simple comment.
    <BLANKLINE>
    --
    Foo is broken
    http://bugs.launchpad.dev/bugs/...
    You received this bug notification because you are a member of Concise
    Team, which is a direct subscriber.
    <BLANKLINE>
    Status in Foo: New
    <BLANKLINE>
    Bug description:
    desc
    <BLANKLINE>
    ----------------------------------------------------------------------

== Notification Recipients ==

Bug notifications are sent to direct subscribers of a bug as well as to
structural subscribers. Structural subcribers can select the
notification level of the subscription.

    >>> flush_notifications()
    >>> switch_db_to_launchpad()

    >>> from lp.registry.enum import BugNotificationLevel
    >>> from lp.registry.interfaces.product import IProductSet
    >>> firefox = getUtility(IProductSet).getByName('firefox')
    >>> mr_no_privs = getUtility(IPersonSet).getByName('no-priv')
    >>> subscription_no_priv = firefox.addBugSubscription(
    ...     mr_no_privs, mr_no_privs)

    >>> switch_db_to_bugnotification()

The notifications generated by addCommentNotification() are sent only to
structural subscribers with the notification level COMMENTS or higher.
The notification level of Sample Person is COMMENTS, hence he receives
these notifications.

    >>> print subscription_no_priv.bug_notification_level.name
    COMMENTS
    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'another comment.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: marilize@hbd.com
    ...
    You received this bug notification because you are a member of ShipIt
    Administrators, which is a direct subscriber.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: mark@example.com
    ...
    You received this bug notification because you are a bug assignee.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: no-priv@canonical.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Subscriber (Mozilla Firefox)
    <BLANKLINE>
    another comment.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are subscribed to Mozilla
    Firefox.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: support@ubuntu.com
    ...
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

If Sample Person's notification level is set to METADATA, he receives
no comment notifications.

    >>> flush_notifications()
    >>> switch_db_to_launchpad()
    >>> subscription_no_priv.bug_notification_level = (
    ...     BugNotificationLevel.METADATA)
    >>> switch_db_to_bugnotification()

    >>> comment = getUtility(IMessageSet).fromText(
    ...     'subject', 'no comment for no-priv.', sample_person,
    ...     datecreated=ten_minutes_ago)
    >>> bug_one.addCommentNotification(comment)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: marilize@hbd.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Subscriber @shipit-admins
    <BLANKLINE>
    no comment for no-priv.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of ShipIt
    Administrators, which is a direct subscriber.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: mark@example.com
    ...
    You received this bug notification because you are a bug assignee.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: support@ubuntu.com
    ...
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

The notifications generated by addChangeNotification() are sent only to
structural subscribers with the notification level METADATA or higher.
The notification level of Sample Person is currently METADATA, hence he
receives these notifications.

    >>> bug_one.addChangeNotification('** Summary changed to: whatever.',
    ...     sample_person, when=ten_minutes_ago)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: marilize@hbd.com
    ...
    You received this bug notification because you are a member of ShipIt
    Administrators, which is a direct subscriber.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: mark@example.com
    ...
    You received this bug notification because you are a bug assignee.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: no-priv@canonical.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug 1] subject
    X-Launchpad-Message-Rationale: Subscriber (Mozilla Firefox)
    <BLANKLINE>
    no comment for no-priv.
    <BLANKLINE>
    ** Summary changed to: whatever.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are subscribed to Mozilla
    Firefox.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: support@ubuntu.com
    ...
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------

If Sample Person sets his notification level to LIFECYCLE, he receives
no notifications created by addChangeNotification().

    >>> flush_notifications()
    >>> switch_db_to_launchpad()
    >>> subscription_no_priv.bug_notification_level = (
    ...     BugNotificationLevel.LIFECYCLE)
    >>> switch_db_to_bugnotification()

    >>> bug_one.addChangeNotification('** Summary changed to: something.',
    ...     sample_person, when=ten_minutes_ago)
    >>> pending_notifications = getUtility(
    ...     IBugNotificationSet).getNotificationsToSend()
    >>> email_notifications = get_email_notifications(pending_notifications)
    >>> for bug_notifications, messages in email_notifications:
    ...     for message in messages:
    ...         print_notification(message)
    To: foo.bar@canonical.com
    ...
    You received this bug notification because you are subscribed to
    mozilla-firefox in ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: marilize@hbd.com
    From: Sample Person <...@bugs.launchpad.net>
    Subject: [Bug 1] Re: Firefox does not support SVG
    X-Launchpad-Message-Rationale: Subscriber @shipit-admins
    <BLANKLINE>
    ** Summary changed to: something.
    <BLANKLINE>
    --
    Firefox does not support SVG
    http://bugs.launchpad.dev/bugs/1
    You received this bug notification because you are a member of ShipIt
    Administrators, which is a direct subscriber.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: mark@example.com
    ...
    You received this bug notification because you are a bug assignee.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: support@ubuntu.com
    ...
    You received this bug notification because you are a member of Ubuntu
    Team, which is the registrant for Ubuntu.
    <BLANKLINE>
    ----------------------------------------------------------------------
    To: test@canonical.com
    ...
    You received this bug notification because you are a direct subscriber
    of the bug.
    <BLANKLINE>
    ----------------------------------------------------------------------
